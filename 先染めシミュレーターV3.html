<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>先染めシミュレーター V3 | 色织模拟器</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', 'Noto Sans JP', 'Noto Sans SC', -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    /* 背景のファブリックパターン */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      opacity: 0.03;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 14px, rgba(255,255,255,0.5) 14px, rgba(255,255,255,0.5) 15px),
        repeating-linear-gradient(90deg, transparent, transparent 14px, rgba(255,255,255,0.5) 14px, rgba(255,255,255,0.5) 15px);
    }
    /* グラスモーフィズムカード */
    .glass {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.12);
    }
    .glass-light {
      background: rgba(51, 65, 85, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }
    /* ヘッダーアクセント */
    .header-accent {
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #a78bfa);
      background-size: 200% auto;
      animation: shimmer 3s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    /* ボタンスタイル */
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .btn-primary:hover {
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.5);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: rgba(148, 163, 184, 0.1);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.15);
      transition: all 0.2s ease;
    }
    .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.3);
    }
    .btn-ghost.active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    /* タブ */
    .tab-bar {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }
    .tab-item {
      color: #94a3b8;
      transition: all 0.25s ease;
      position: relative;
    }
    .tab-item:hover { color: #e2e8f0; }
    .tab-item.active {
      color: white;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    /* カラースウォッチ */
    .color-swatch {
      transition: all 0.15s ease;
      border: 2px solid rgba(255,255,255,0.1);
    }
    .color-swatch:hover {
      transform: scale(1.2);
      border-color: rgba(255,255,255,0.4);
      box-shadow: 0 0 12px rgba(255,255,255,0.2);
    }
    /* インフォカード */
    .info-card {
      background: rgba(51, 65, 85, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.08);
      border-radius: 12px;
      padding: 12px;
    }
    /* セレクト */
    select {
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }
    /* レンジスライダー */
    input[type="range"] {
      -webkit-appearance: none;
      height: 6px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 3px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
    }
    /* インプットカラー */
    input[type="color"] {
      -webkit-appearance: none;
      border: none;
      cursor: pointer;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 6px; }
    /* スクロールバー */
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.5); }
    /* ツールチップ */
    .tooltip { position: relative; }
    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 50;
      max-width: 220px;
      border: 1px solid rgba(148,163,184,0.15);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    /* モーダル */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modal-content {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(148, 163, 184, 0.12);
    }
    /* 糸スレッド */
    .yarn-thread { filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
    /* アニメーション */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeIn 0.3s ease forwards; }
    /* 輝くボーダー */
    .glow-border {
      position: relative;
    }
    .glow-border::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #6366f1);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.5;
    }
    /* プリント */
    @media print { .no-print { display: none !important; } body { background: white; color: black; } }
    /* フッター */
    .footer-gradient {
      background: linear-gradient(180deg, transparent 0%, rgba(15, 23, 42, 0.8) 100%);
    }
    /* ===== Improvement #5: アクセシビリティ ===== */
    :focus-visible {
      outline: 2px solid #818cf8;
      outline-offset: 2px;
    }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
    [role="dialog"] { outline: none; }
    /* ===== Improvement #6: モバイル強化 ===== */
    @media (max-width: 640px) {
      body { font-size: 14px; }
      .tab-item { padding: 8px 12px; font-size: 12px; min-height: 44px; }
      .btn-ghost, .btn-primary { min-height: 44px; min-width: 44px; }
      .color-swatch { width: 32px; height: 32px; min-width: 32px; min-height: 32px; }
      .modal-content { max-width: 100%; margin: 8px; border-radius: 16px; max-height: calc(100vh - 16px); }
      .info-card { padding: 8px; }
      select { min-height: 44px; font-size: 16px; /* prevent iOS zoom */ }
      input[type="range"] { height: 8px; }
      input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
      input[type="number"] { min-height: 44px; font-size: 16px; }
    }
    @media (max-width: 380px) {
      .tab-item { padding: 6px 8px; font-size: 11px; }
    }
    /* ===== Improvement #8: Tailwind CDN fallback (critical layout) ===== */
    .flex { display: flex; }
    .grid { display: grid; }
    .hidden { display: none; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .fixed { position: fixed; }
    .inset-0 { top:0;right:0;bottom:0;left:0; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .flex-wrap { flex-wrap: wrap; }
    .flex-1 { flex: 1 1 0%; }
    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .w-full { width: 100%; }
    .overflow-hidden { overflow: hidden; }
    .overflow-y-auto { overflow-y: auto; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-2xl { border-radius: 1rem; }
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .font-medium { font-weight: 500; }
    .font-bold { font-weight: 700; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-4 { margin-top: 1rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .border { border-width: 1px; border-style: solid; }
    .z-10 { z-index: 10; }
    .z-20 { z-index: 20; }
    .z-50 { z-index: 50; }
  </style>
</head>
<body class="min-h-screen">
<a href="#canvas" class="sr-only" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:999" onfocus="this.style.position='static';this.style.width='auto';this.style.height='auto'" onblur="this.style.position='absolute';this.style.left='-9999px';this.style.width='1px';this.style.height='1px'">Skip to preview</a>
<div id="app" class="max-w-7xl mx-auto px-4 py-6 relative z-10" role="application" aria-label="Yarn-Dyed Fabric Simulator"></div>

<script>
// ============================================================
// V3: 物理計算ベースの先染めシミュレーター
// Improvements applied:
//   #1 Code organization (clear sections, no duplicates)
//   #2 Rendering optimization (requestAnimationFrame debounce)
//   #3 Canvas performance (offscreen tile + createPattern cache)
//   #4 Error handling (localStorage, URL validation, null safety)
//   #5 Accessibility (aria-labels, role=dialog, keyboard nav, focus)
//   #6 Mobile (touch targets 44px, fluid canvas, popup fixes)
//   #7 Pantone database expanded (24 → 150+ colors)
//   #8 Tailwind CDN fallback (critical CSS inlined)
//   #9 Cost calculation (fiber-based realistic USD/kg pricing)
//   #10 Section organization headers throughout
// ============================================================

// ============================================================
// SECTION 1: 繊維の物理定数
// ============================================================

// 繊維の物理定数
const FIBER_CONSTANTS = {
  cotton:    { density: 1.54, shrinkage: 0.05, pilling: 2, name: { ja: '綿', zh: '棉' } },
  linen:     { density: 1.50, shrinkage: 0.08, pilling: 1, name: { ja: '麻', zh: '麻' } },
  ramie:     { density: 1.51, shrinkage: 0.06, pilling: 1, name: { ja: 'ラミー', zh: '苎麻' } },
  wool:      { density: 1.32, shrinkage: 0.10, pilling: 4, name: { ja: 'ウール', zh: '羊毛' } },
  cashmere:  { density: 1.30, shrinkage: 0.08, pilling: 3, name: { ja: 'カシミヤ', zh: '羊绒' } },
  silk:      { density: 1.34, shrinkage: 0.03, pilling: 1, name: { ja: 'シルク', zh: '丝绸' } },
  polyester: { density: 1.38, shrinkage: 0.01, pilling: 3, name: { ja: 'ポリエステル', zh: '涤纶' } },
  nylon:     { density: 1.14, shrinkage: 0.02, pilling: 3, name: { ja: 'ナイロン', zh: '尼龙' } },
  viscose:   { density: 1.52, shrinkage: 0.12, pilling: 2, name: { ja: 'レーヨン', zh: '粘胶' } },
  lyocell:   { density: 1.50, shrinkage: 0.04, pilling: 2, name: { ja: 'テンセル', zh: '天丝' } },
  modal:     { density: 1.52, shrinkage: 0.05, pilling: 2, name: { ja: 'モダール', zh: '莫代尔' } },
  spandex:   { density: 1.20, shrinkage: 0.02, pilling: 1, name: { ja: 'スパンデックス', zh: '氨纶' } },
  acrylic:   { density: 1.17, shrinkage: 0.02, pilling: 4, name: { ja: 'アクリル', zh: '腈纶' } },
  ptt:       { density: 1.35, shrinkage: 0.02, pilling: 2, name: { ja: 'PTT', zh: 'PTT' } },
  polyurethane: { density: 1.20, shrinkage: 0.01, pilling: 1, name: { ja: 'ポリウレタン', zh: '聚氨酯' } },
  polypropylene: { density: 0.91, shrinkage: 0.01, pilling: 2, name: { ja: 'ポリプロピレン', zh: '丙纶' } },
  pbt:       { density: 1.31, shrinkage: 0.01, pilling: 2, name: { ja: 'PBT', zh: 'PBT' } },
  aramid:    { density: 1.44, shrinkage: 0.00, pilling: 1, name: { ja: 'アラミド', zh: '芳纶' } },
  cupro:     { density: 1.52, shrinkage: 0.06, pilling: 1, name: { ja: 'キュプラ', zh: '铜氨' } },
  paper:     { density: 0.80, shrinkage: 0.03, pilling: 1, name: { ja: '紙', zh: '纸' } },
};

// ============================================================
// SECTION 3: 糸の物理計算（コア機能）
// ============================================================

// Ne番手から糸直径(mm)を計算
// 公式: d(mm) = 0.9065 / √(Ne × ρ)  ※ρ=繊維比重
function calcYarnDiameter(ne, fiberDensity = 1.54) {
  if (ne <= 0) return 0.5;
  // Ashenhurst公式ベース
  const d = 0.9065 / Math.sqrt(ne * fiberDensity);
  return Math.max(0.05, Math.min(1.5, d)); // 0.05mm〜1.5mmの範囲
}

// Ne番手からTex（1000mあたりのグラム数）
function neToTex(ne) {
  return 590.5 / ne;
}

// カバーファクター計算
// 経糸CF = EPI × √Tex / 28.35
// 緯糸CF = PPI × √Tex / 28.35
function calcCoverFactor(density, ne) {
  const tex = neToTex(ne);
  return density * Math.sqrt(tex) / 28.35;
}

// 限界密度計算（理論最大値）
// 糸が物理的に入る最大本数
function calcMaxDensity(ne, fiberDensity = 1.54) {
  const d_mm = calcYarnDiameter(ne, fiberDensity);
  const d_inch = d_mm / 25.4;
  // 理論最大 = 1インチ / 糸直径、実用上は80%程度
  return Math.floor((1 / d_inch) * 0.85);
}

// GSM計算（正確版）
// GSM = (EPI × Tex_warp + PPI × Tex_weft) × 0.03937 × 織り縮み係数
function calcGSMAccurate(epi, ppi, warpNe, weftNe, weaveMultiplier = 1.0, crimp = 1.08) {
  const texWarp = neToTex(warpNe);
  const texWeft = neToTex(weftNe);
  // 0.03937 = 1/25.4 (インチをメートルに変換)
  const gsm = (epi * texWarp + ppi * texWeft) * 0.03937 * crimp * weaveMultiplier;
  return Math.round(gsm);
}

// 生地の厚み推定(mm)
function calcFabricThickness(warpNe, weftNe, weaveType, fiberDensity = 1.54) {
  const dWarp = calcYarnDiameter(warpNe, fiberDensity);
  const dWeft = calcYarnDiameter(weftNe, fiberDensity);
  // 基本厚み = 経糸直径 + 緯糸直径（交差部）
  let base = dWarp + dWeft;
  // 織り組織による補正
  const multipliers = {
    plain: 1.0, oxford: 1.1, twill: 1.05, satin: 0.95,
    dobby: 1.1, pile: 2.0, jacquard: 1.15, special: 1.2
  };
  return base * (multipliers[weaveType] || 1.0);
}

// ============================================================
// SECTION 2: Pantoneデータベース (Improvement #7: 150+色に拡充)
// ============================================================
const PANTONE_DB = [
  // Whites & Off-Whites
  { code: '11-0601', name: 'Bright White', hex: '#f4f5f0' },
  { code: '11-0602', name: 'Snow White', hex: '#f0efe2' },
  { code: '11-4800', name: 'Blanc de Blanc', hex: '#e8e5d7' },
  { code: '11-4302', name: 'Marshmallow', hex: '#f0ece3' },
  { code: '11-0103', name: 'Egret', hex: '#f5f0e1' },
  { code: '12-0304', name: 'Antique White', hex: '#efe1ce' },
  { code: '11-0507', name: 'Winter White', hex: '#f4f1e0' },
  { code: '13-0002', name: 'White Sand', hex: '#dbd5c5' },
  // Grays
  { code: '14-4002', name: 'Glacier Gray', hex: '#c5c6c7' },
  { code: '15-4003', name: 'Storm Gray', hex: '#a5a8ab' },
  { code: '17-5104', name: 'Ultimate Gray', hex: '#939597' },
  { code: '16-3802', name: 'Ash', hex: '#a09d9c' },
  { code: '18-0201', name: 'Castlerock', hex: '#5f5e62' },
  { code: '18-0403', name: 'Dark Gull Gray', hex: '#625d5d' },
  { code: '19-0201', name: 'Asphalt', hex: '#3d3c3a' },
  { code: '19-4006', name: 'Phantom', hex: '#2f2f30' },
  // Blacks
  { code: '19-0303', name: 'Jet Black', hex: '#2b2926' },
  { code: '19-4005', name: 'Black Beauty', hex: '#26262a' },
  { code: '19-0508', name: 'Peat', hex: '#393432' },
  { code: '19-4004', name: 'Black Onyx', hex: '#2a2b2e' },
  // Beiges & Tans
  { code: '13-1015', name: 'Almond Cream', hex: '#e5d3b3' },
  { code: '14-1012', name: 'Pebble', hex: '#cab698' },
  { code: '15-1116', name: 'Safari', hex: '#c1a882' },
  { code: '16-1120', name: 'Latte', hex: '#b89e7e' },
  { code: '14-1118', name: 'Beige', hex: '#c8aa80' },
  { code: '15-1225', name: 'Sand', hex: '#d4a574' },
  { code: '13-1023', name: 'Peach Fuzz', hex: '#ffbe98' },
  // Browns
  { code: '17-1044', name: 'Chipmunk', hex: '#a0623b' },
  { code: '18-1048', name: 'Caramel Cafe', hex: '#864c24' },
  { code: '19-1118', name: 'Chocolate Brown', hex: '#5c3a2d' },
  { code: '18-1142', name: 'Cognac', hex: '#9a5a2f' },
  { code: '17-1134', name: 'Tobacco Brown', hex: '#9b7340' },
  { code: '18-1130', name: 'Aztec', hex: '#7b5941' },
  { code: '19-1015', name: 'Bracken', hex: '#4e3629' },
  { code: '18-0930', name: 'Coffee Liqueur', hex: '#72593b' },
  // Reds
  { code: '19-1664', name: 'True Red', hex: '#bf1932' },
  { code: '18-1662', name: 'Flame Scarlet', hex: '#cd212a' },
  { code: '18-1750', name: 'Viva Magenta', hex: '#be3455' },
  { code: '17-1456', name: 'Tigerlily', hex: '#e2583e' },
  { code: '19-1557', name: 'Chili Pepper', hex: '#9b1b30' },
  { code: '18-1555', name: 'Lollipop', hex: '#c1282d' },
  { code: '18-1549', name: 'Tomato', hex: '#cf3a36' },
  { code: '19-1540', name: 'Syrah', hex: '#7b2838' },
  { code: '19-1525', name: 'Port', hex: '#6c2831' },
  { code: '19-1652', name: 'Rhubarb', hex: '#7b2d3f' },
  { code: '18-1438', name: 'Marsala', hex: '#955251' },
  { code: '17-1463', name: 'Tangerine Tango', hex: '#dd4124' },
  { code: '16-1546', name: 'Living Coral', hex: '#ff6f61' },
  // Pinks
  { code: '15-1520', name: 'Rose Quartz', hex: '#f7cac9' },
  { code: '16-1731', name: 'Strawberry Ice', hex: '#e78b90' },
  { code: '17-1930', name: 'Rapture Rose', hex: '#c64b6c' },
  { code: '18-2043', name: 'Pink Peacock', hex: '#c62168' },
  { code: '16-2126', name: 'Pink Carnation', hex: '#e06b8b' },
  { code: '13-2010', name: 'Pink Lady', hex: '#f5c3c2' },
  { code: '14-1911', name: 'Quartz Pink', hex: '#eab4b4' },
  { code: '15-1624', name: 'Conch Shell', hex: '#e8a0a0' },
  { code: '17-2034', name: 'Hot Pink', hex: '#d63384' },
  { code: '18-1741', name: 'Honeysuckle', hex: '#d94f70' },
  // Oranges
  { code: '15-1247', name: 'Apricot', hex: '#f5b895' },
  { code: '16-1350', name: 'Coral', hex: '#f27059' },
  { code: '16-1359', name: 'Orange Peel', hex: '#fa7a35' },
  { code: '17-1350', name: 'Celosia Orange', hex: '#f37338' },
  { code: '16-1448', name: 'Burnt Orange', hex: '#cc5500' },
  { code: '15-1164', name: 'Bright Marigold', hex: '#faa54a' },
  { code: '16-1341', name: 'Mango', hex: '#e8823a' },
  { code: '14-1228', name: 'Peach Nectar', hex: '#f7b28b' },
  { code: '17-1145', name: 'Autumn Maple', hex: '#c46f41' },
  // Yellows
  { code: '13-0647', name: 'Illuminating', hex: '#f5df4d' },
  { code: '14-0756', name: 'Primrose Yellow', hex: '#f6d155' },
  { code: '13-0755', name: 'Lemon', hex: '#fde74c' },
  { code: '14-0848', name: 'Mimosa', hex: '#f0c05a' },
  { code: '14-0941', name: 'Banana', hex: '#fce373' },
  { code: '15-0953', name: 'Lemon Chrome', hex: '#e8b838' },
  { code: '15-0850', name: 'Citrus', hex: '#e8b028' },
  { code: '13-0858', name: 'Vibrant Yellow', hex: '#fce300' },
  { code: '14-0837', name: 'Misted Yellow', hex: '#dab965' },
  // Greens
  { code: '15-0343', name: 'Greenery', hex: '#88b04b' },
  { code: '17-5641', name: 'Emerald', hex: '#009473' },
  { code: '17-5722', name: 'Ultramarine Green', hex: '#006b54' },
  { code: '16-5938', name: 'Mint', hex: '#00a170' },
  { code: '15-6442', name: 'Island Green', hex: '#2bae66' },
  { code: '17-5528', name: 'Greenlake', hex: '#0d7963' },
  { code: '19-5420', name: 'Forest Green', hex: '#2c5e4b' },
  { code: '18-0135', name: 'Treetop', hex: '#476a30' },
  { code: '16-6340', name: 'Kelly Green', hex: '#29ab87' },
  { code: '15-5519', name: 'Turquoise', hex: '#45b5aa' },
  { code: '14-6316', name: 'Jade', hex: '#65b89f' },
  { code: '18-5338', name: 'Verdant Green', hex: '#10654d' },
  { code: '17-0330', name: 'Peridot', hex: '#85913b' },
  { code: '16-0230', name: 'Tendril', hex: '#9fc088' },
  { code: '17-5430', name: 'Shady Glade', hex: '#008c69' },
  { code: '19-5406', name: 'Pine Grove', hex: '#2e4a3e' },
  // Teals & Aquas
  { code: '14-4811', name: 'Aqua Sky', hex: '#7bc4c4' },
  { code: '16-5127', name: 'Biscay Bay', hex: '#097988' },
  { code: '17-4919', name: 'Teal', hex: '#3f888f' },
  { code: '15-5217', name: 'Aqua Haze', hex: '#86c5c2' },
  { code: '18-4726', name: 'Tile Blue', hex: '#1a7a8a' },
  { code: '17-5029', name: 'Columbia', hex: '#2a8d8d' },
  // Blues
  { code: '19-4052', name: 'Classic Blue', hex: '#0f4c81' },
  { code: '18-4548', name: 'Ibiza Blue', hex: '#2a6fa1' },
  { code: '15-3919', name: 'Serenity', hex: '#92a8d1' },
  { code: '19-4024', name: 'Navy Blazer', hex: '#282d3c' },
  { code: '19-4028', name: 'Dress Blues', hex: '#2a3756' },
  { code: '19-4340', name: 'Galaxy Blue', hex: '#1a4472' },
  { code: '18-4244', name: 'Director Blue', hex: '#286aab' },
  { code: '17-4041', name: 'Marina', hex: '#4f84c4' },
  { code: '15-3920', name: 'Cerulean', hex: '#98b4d4' },
  { code: '16-4132', name: 'Little Boy Blue', hex: '#6c99c6' },
  { code: '17-4028', name: 'Riviera', hex: '#4878a8' },
  { code: '19-4150', name: 'Princess Blue', hex: '#00539c' },
  { code: '15-4020', name: 'Cerulean Blue', hex: '#7eb0d4' },
  { code: '14-4318', name: 'Sky Blue', hex: '#78b7c5' },
  { code: '18-4225', name: 'Copen Blue', hex: '#407899' },
  { code: '17-4139', name: 'Azure', hex: '#3f7cb6' },
  { code: '18-4041', name: 'Star Sapphire', hex: '#2c5f9e' },
  { code: '19-3925', name: 'Blue Depths', hex: '#263056' },
  // Indigos
  { code: '19-3928', name: 'Navy Blue', hex: '#2a3244' },
  { code: '19-3832', name: 'Medieval Blue', hex: '#2a2b5f' },
  { code: '19-3938', name: 'Blue Ribbon', hex: '#003594' },
  { code: '19-3847', name: 'Spectrum Blue', hex: '#3d3c8e' },
  // Purples & Violets
  { code: '18-3838', name: 'Ultra Violet', hex: '#5f4b8b' },
  { code: '18-3943', name: 'Blue Iris', hex: '#5a5b9f' },
  { code: '19-3536', name: 'Crown Jewel', hex: '#583780' },
  { code: '18-3737', name: 'Royal Purple', hex: '#7851a9' },
  { code: '17-3640', name: 'Hyacinth', hex: '#7f6ead' },
  { code: '17-3834', name: 'Aster Purple', hex: '#755c9b' },
  { code: '18-3520', name: 'Purple Reign', hex: '#683b75' },
  { code: '16-3823', name: 'Purple Rose', hex: '#a48bbf' },
  { code: '15-3817', name: 'Lavender', hex: '#b4a7d6' },
  { code: '14-3812', name: 'Orchid Bloom', hex: '#c3a6cc' },
  { code: '17-3313', name: 'Grape Jam', hex: '#7a4a6d' },
  // Burgundy & Wine
  { code: '19-1724', name: 'Tawny Port', hex: '#6b2842' },
  { code: '19-1627', name: 'Port Royale', hex: '#5b253e' },
  { code: '19-1726', name: 'Cabernet', hex: '#69293b' },
  { code: '18-1631', name: 'Burgundy', hex: '#823b4b' },
  { code: '18-1619', name: 'Maroon', hex: '#7b4259' },
  // Khaki & Olive
  { code: '15-0318', name: 'Sage', hex: '#9caf88' },
  { code: '16-0526', name: 'Khaki', hex: '#a89968' },
  { code: '18-0622', name: 'Olive Night', hex: '#5f5a40' },
  { code: '18-0521', name: 'Burnt Olive', hex: '#5e5930' },
  { code: '17-0525', name: 'Loden Green', hex: '#6d7553' },
  { code: '18-0420', name: 'Four Leaf Clover', hex: '#566048' },
  // Corals & Salmon
  { code: '16-1543', name: 'Fusion Coral', hex: '#f96714' },
  { code: '14-1323', name: 'Salmon', hex: '#f5a688' },
  { code: '15-1530', name: 'Peach Pink', hex: '#f0908d' },
  // Metallics & Special
  { code: '16-1324', name: 'Copper Tan', hex: '#c28868' },
  { code: '16-0836', name: 'Rich Gold', hex: '#b08c42' },
  { code: '15-0927', name: 'Pale Gold', hex: '#c8a951' },
  { code: '17-3911', name: 'Silver', hex: '#8e8e90' },
  // Denim-specific
  { code: '18-4220', name: 'Provincial Blue', hex: '#4c6a92' },
  { code: '18-3910', name: 'Blue Indigo', hex: '#5a5b7e' },
  { code: '19-4118', name: 'Dark Denim', hex: '#34495e' },
  { code: '17-4131', name: 'Cendre Blue', hex: '#5084a7' },
];

// 2025年トレンドカラー
const TREND_COLORS_2025 = {
  ss: [
    { hex: '#ffbe98', name: { ja: 'ピーチファズ', zh: '蜜桃色' }, pantone: '13-1023' },
    { hex: '#7bc4c4', name: { ja: 'アクアスカイ', zh: '水蓝色' }, pantone: '14-4811' },
    { hex: '#f5df4d', name: { ja: 'イルミネイティング', zh: '亮黄色' }, pantone: '13-0647' },
    { hex: '#88b04b', name: { ja: 'グリーナリー', zh: '草木绿' }, pantone: '15-0343' },
    { hex: '#f7cac9', name: { ja: 'ローズクォーツ', zh: '粉晶色' }, pantone: '15-1520' },
    { hex: '#92a8d1', name: { ja: 'セレニティ', zh: '宁静蓝' }, pantone: '15-3919' },
  ],
  aw: [
    { hex: '#955251', name: { ja: 'マルサラ', zh: '玛萨拉酒红' }, pantone: '18-1438' },
    { hex: '#5f4b8b', name: { ja: 'ウルトラバイオレット', zh: '紫外光色' }, pantone: '18-3838' },
    { hex: '#009473', name: { ja: 'エメラルド', zh: '祖母绿' }, pantone: '17-5641' },
    { hex: '#282d3c', name: { ja: 'ネイビーブレザー', zh: '海军蓝' }, pantone: '19-4024' },
    { hex: '#be3455', name: { ja: 'ビバマゼンタ', zh: '非凡洋红' }, pantone: '18-1750' },
    { hex: '#939597', name: { ja: 'アルティメットグレー', zh: '极致灰' }, pantone: '17-5104' },
  ]
};

// ============================================================
// 用語辞典
// ============================================================
const GLOSSARY = {
  ja: {
    '経糸': '織機に縦方向に張られる糸。英語ではWarp。密度はEPI（1インチあたりの本数）で表す。',
    '緯糸': '織機で左右に打ち込まれる糸。英語ではWeft/Filling。密度はPPI（1インチあたりの本数）で表す。',
    '平織': '経糸と緯糸が1本ずつ交互に交差する最も基本的な織り方。丈夫で通気性が良い。',
    '綾織': '経糸または緯糸が2本以上連続して浮く織り方。斜めの畝（ツイル）が特徴。',
    '朱子織': '経糸または緯糸が長く浮いて光沢を出す織り方。サテンとも呼ばれる。',
    'EPI': 'Ends Per Inch。1インチあたりの経糸本数。数値が大きいほど高密度。',
    'PPI': 'Picks Per Inch。1インチあたりの緯糸本数。数値が大きいほど高密度。',
    'GSM': 'Grams per Square Meter。1平方メートルあたりのグラム数。生地の厚さ・重さの指標。',
    '番手': '糸の太さを表す単位。綿はNe（英式番手）を使用。数値が大きいほど細い。例:20Neは40Neより太い。',
    'カバーファクター': '生地の詰まり具合を示す数値。経緯合計で20-28が標準的。',
    '限界密度': '糸の太さに対して物理的に入る最大本数。これを超えると織れない。',
    'コーマ糸': '短繊維を除去した高品質な糸。毛羽が少なく光沢がある。',
    'カード糸': '標準的な紡績方法で作られた糸。コーマ糸より安価。',
  },
  zh: {
    '经纱': '织机上纵向张紧的纱线，英文为Warp。密度用EPI（每英寸根数）表示。',
    '纬纱': '织机上横向打入的纱线，英文为Weft。密度用PPI（每英寸根数）表示。',
    '平纹': '经纬纱一上一下交替交织的最基本织法，结实透气。',
    '斜纹': '经纱或纬纱连续浮起2根以上的织法，表面呈斜向纹路。',
    '缎纹': '经纱或纬纱长浮线形成光泽的织法，也叫色丁。',
    'EPI': 'Ends Per Inch，每英寸经纱根数，数值越大密度越高。',
    'PPI': 'Picks Per Inch，每英寸纬纱根数，数值越大密度越高。',
    'GSM': 'Grams per Square Meter，每平方米克重，表示面料厚度和重量。',
    '支数': '表示纱线粗细的单位，棉用英支Ne。数值越大越细。例:20Ne比40Ne粗。',
    '紧度': '表示面料紧密程度的数值。经纬合计20-28为标准。',
    '极限密度': '纱线粗细能容纳的最大根数。超过则无法织造。',
    '精梳纱': '去除短纤维的高品质纱线，毛羽少有光泽。',
    '普梳纱': '标准纺纱方法生产的纱线，比精梳纱便宜。',
  }
};

// ============================================================
// 類似生地データベース（後方互換）
// ============================================================
const SIMILAR_FABRICS = [
  { name: { ja: 'オックスフォードシャツ地', zh: '牛津衬衫布' }, weave: 'oxford', yarn: 'cotton', epiRange: [80, 120], gsmRange: [120, 180], neRange: [30, 50] },
  { name: { ja: 'ブロードクロス', zh: '府绸' }, weave: 'plain', yarn: 'cotton', epiRange: [100, 140], gsmRange: [100, 150], neRange: [40, 60] },
  { name: { ja: 'デニム 12oz', zh: '12盎司牛仔布' }, weave: 'denim', yarn: 'cotton', epiRange: [60, 80], gsmRange: [350, 420], neRange: [7, 12] },
  { name: { ja: 'デニム 8oz', zh: '8盎司牛仔布' }, weave: 'denim', yarn: 'cotton', epiRange: [70, 90], gsmRange: [250, 300], neRange: [10, 16] },
  { name: { ja: 'ギャバジン', zh: '华达呢' }, weave: 'gabardine', yarn: 'wool', epiRange: [80, 120], gsmRange: [200, 280], neRange: [24, 40] },
  { name: { ja: 'サテン', zh: '色丁' }, weave: 'satin_5', yarn: 'silk', epiRange: [150, 200], gsmRange: [80, 150], neRange: [40, 80] },
  { name: { ja: 'ポロピケ', zh: '珠地Polo布' }, weave: 'pique', yarn: 'cotton', epiRange: [60, 80], gsmRange: [180, 220], neRange: [20, 32] },
  { name: { ja: 'ツイルチノ', zh: '斜纹卡其布' }, weave: 'twill_2_1', yarn: 'cotton', epiRange: [100, 130], gsmRange: [200, 280], neRange: [16, 30] },
  { name: { ja: 'ヘリンボーンジャケット地', zh: '人字纹夹克布' }, weave: 'herringbone', yarn: 'wool', epiRange: [70, 100], gsmRange: [250, 350], neRange: [20, 36] },
  { name: { ja: 'シアサッカー', zh: '泡泡纱' }, weave: 'seersucker', yarn: 'cotton', epiRange: [80, 100], gsmRange: [100, 150], neRange: [40, 60] },
];

// ============================================================
// 生地名判定データベース (FABRIC_NAME_DB)
// 糸種・番手・織り方・密度・GSMから正確な生地名を特定
// ============================================================
const FABRIC_NAME_DB = [
  // ═══════ 綿・平織系 ═══════
  { id: 'lawn', name: { ja: 'ローン', zh: '细平布/巴里纱' },
    fibers: ['cotton'], weaves: ['plain','broadcloth'], neRange: [60, 150], gsmRange: [50, 100], epiRange: [80, 180],
    desc: { ja: '極細番手の薄地平織。透け感があり、ハンカチやブラウスに使用', zh: '极细支薄平纹，有透感，用于手帕和女衬衫' } },
  { id: 'voile', name: { ja: 'ボイル', zh: '巴里纱' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [60, 120], gsmRange: [40, 90], epiRange: [50, 90],
    desc: { ja: '粗い密度の薄手平織。通気性に優れカーテンや夏物に使用', zh: '稀密度薄平纹，透气性好，用于窗帘和夏装' } },
  { id: 'organdy', name: { ja: 'オーガンジー', zh: '玻璃纱' },
    fibers: ['cotton','silk','polyester'], weaves: ['plain'], neRange: [80, 200], gsmRange: [25, 60], epiRange: [60, 140],
    desc: { ja: '糊付けした極薄平織。張り感があり装飾用途に', zh: '上浆极薄平纹，有挺括感，装饰用途' } },
  { id: 'muslin', name: { ja: 'モスリン', zh: '平纹细布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [30, 60], gsmRange: [70, 130], epiRange: [50, 90],
    desc: { ja: '中番手のやや粗い平織。仮縫い用途としても使われる', zh: '中支较稀平纹，也用于试样制作' } },
  { id: 'broadcloth_cotton', name: { ja: 'ブロード', zh: '府绸' },
    fibers: ['cotton'], weaves: ['plain','broadcloth'], neRange: [40, 120], gsmRange: [80, 150], epiRange: [100, 180],
    desc: { ja: '経密度＞緯密度の密な平織。ドレスシャツの定番', zh: '经密度大于纬密度的密平纹，正装衬衫经典面料' } },
  { id: 'poplin', name: { ja: 'ポプリン', zh: '府绸' },
    fibers: ['cotton','polyester'], weaves: ['plain','broadcloth'], neRange: [30, 80], gsmRange: [80, 160], epiRange: [90, 160],
    desc: { ja: '細い横畝のある平織。ブロードの別名としても使用', zh: '有细横棱的平纹，也作府绸的别名' } },
  { id: 'percale', name: { ja: 'パーケル', zh: '高支密平纹' },
    fibers: ['cotton'], weaves: ['plain','broadcloth'], neRange: [60, 120], gsmRange: [90, 140], epiRange: [120, 200],
    desc: { ja: '高番手・高密度の上質平織。高級シーツに使用', zh: '高支高密优质平纹，用于高级床单' } },
  { id: 'cambric', name: { ja: 'キャンブリック', zh: '细平布' },
    fibers: ['cotton','linen'], weaves: ['plain'], neRange: [50, 100], gsmRange: [60, 120], epiRange: [90, 160],
    desc: { ja: '片面に光沢加工した細番手平織。ハンカチやワイシャツに', zh: '单面上光的细支平纹，用于手帕和衬衫' } },
  { id: 'sheeting', name: { ja: 'シーチング', zh: '粗平布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [16, 40], gsmRange: [100, 180], epiRange: [60, 100],
    desc: { ja: '中厚の標準的な平織。シーツやパッチワークに', zh: '中厚标准平纹，用于床单和拼布' } },
  { id: 'calico', name: { ja: 'カリコ（金巾）', zh: '卡利科/白坯布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 40], gsmRange: [100, 160], epiRange: [60, 90],
    desc: { ja: '未晒しの中厚平織。仮縫い・裏地にも使用', zh: '未漂白中厚平纹，也用于试样和里布' } },
  { id: 'oxford_cloth', name: { ja: 'オックスフォード', zh: '牛津布' },
    fibers: ['cotton'], weaves: ['oxford'], neRange: [20, 50], gsmRange: [120, 200], epiRange: [60, 120],
    desc: { ja: '2本の経糸と2本の緯糸で交差する変わり平織。BDシャツの定番', zh: '两根经纱和两根纬纱交替的变化平纹，BD衬衫经典面料' } },
  { id: 'pinpoint_oxford', name: { ja: 'ピンポイントオックスフォード', zh: '细牛津布' },
    fibers: ['cotton'], weaves: ['oxford'], neRange: [40, 80], gsmRange: [100, 160], epiRange: [80, 140],
    desc: { ja: '細番手のオックスフォード。ドレスダウンにも使える', zh: '细支牛津布，也适合正装场合' } },
  { id: 'royal_oxford', name: { ja: 'ロイヤルオックスフォード', zh: '皇家牛津布' },
    fibers: ['cotton'], weaves: ['oxford'], neRange: [60, 120], gsmRange: [100, 160], epiRange: [100, 160],
    desc: { ja: '極細番手の上質オックスフォード。最高級シャツ地', zh: '极细支优质牛津布，最高级衬衫面料' } },
  { id: 'canvas_cotton', name: { ja: '帆布（キャンバス）', zh: '帆布' },
    fibers: ['cotton'], weaves: ['plain','canvas'], neRange: [2, 16], gsmRange: [250, 600], epiRange: [40, 80],
    desc: { ja: '太番手の厚地平織。バッグ・テント・ワークウェアに', zh: '粗支厚平纹，用于包、帐篷和工装' } },
  { id: 'duck', name: { ja: 'ダック', zh: '帆布/鸭布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [4, 16], gsmRange: [200, 500], epiRange: [50, 80],
    desc: { ja: '緻密な厚地平織。帆布より柔らかい', zh: '致密厚平纹，比帆布柔软' } },
  { id: 'gingham', name: { ja: 'ギンガム', zh: '色织格子布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 60], gsmRange: [80, 160], epiRange: [60, 120],
    desc: { ja: '先染め糸の格子柄平織。カジュアルシャツの定番', zh: '色织格子平纹，休闲衬衫经典' } },
  { id: 'chambray', name: { ja: 'シャンブレー', zh: '青年布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 50], gsmRange: [100, 180], epiRange: [60, 120],
    desc: { ja: '色経×白緯の平織。デニムに似た外観で軽い', zh: '色经×白纬平纹，外观似牛仔但轻薄' } },
  { id: 'seersucker_fabric', name: { ja: 'シアサッカー', zh: '泡泡纱' },
    fibers: ['cotton'], weaves: ['seersucker'], neRange: [30, 60], gsmRange: [90, 160], epiRange: [60, 120],
    desc: { ja: '表面に凹凸のある夏向け生地。ノーアイロンで着用可', zh: '表面有凹凸的夏季面料，免熨烫可穿' } },
  // ═══════ 綿・ツイル系 ═══════
  { id: 'chino', name: { ja: 'チノクロス', zh: '卡其布/斜纹棉' },
    fibers: ['cotton'], weaves: ['twill_2_1','twill_2_2'], neRange: [14, 32], gsmRange: [180, 320], epiRange: [80, 130],
    desc: { ja: '綾織の中厚地。チノパンの由来。丈夫でカジュアル', zh: '斜纹中厚面料，卡其裤的来源，结实休闲' } },
  { id: 'denim_heavy', name: { ja: 'デニム（厚地）', zh: '牛仔布（厚）' },
    fibers: ['cotton'], weaves: ['denim'], neRange: [4, 12], gsmRange: [320, 500], epiRange: [50, 80],
    desc: { ja: '厚手の3/1ツイル。10oz以上のジーンズ用', zh: '厚3/1斜纹，10盎司以上牛仔裤用' } },
  { id: 'denim_medium', name: { ja: 'デニム（中厚）', zh: '牛仔布（中厚）' },
    fibers: ['cotton'], weaves: ['denim'], neRange: [10, 20], gsmRange: [220, 340], epiRange: [60, 90],
    desc: { ja: '中厚のデニム。8oz前後のシャツデニムにも', zh: '中厚牛仔布，8盎司左右也可作衬衫' } },
  { id: 'denim_light', name: { ja: 'デニム（薄地）', zh: '牛仔布（薄）' },
    fibers: ['cotton'], weaves: ['denim'], neRange: [16, 40], gsmRange: [120, 240], epiRange: [70, 110],
    desc: { ja: '薄手のデニム。6oz以下のワンピースやシャツに', zh: '薄牛仔布，6盎司以下连衣裙和衬衫用' } },
  { id: 'dungaree', name: { ja: 'ダンガリー', zh: '丹宁布' },
    fibers: ['cotton'], weaves: ['denim','twill_2_1'], neRange: [10, 30], gsmRange: [150, 280], epiRange: [60, 100],
    desc: { ja: '白経×色緯の綾織。デニムの逆配色', zh: '白经×色纬斜纹，牛仔布的反色' } },
  { id: 'drill', name: { ja: 'ドリル', zh: '斜纹布' },
    fibers: ['cotton'], weaves: ['twill_2_1','twill_2_2'], neRange: [10, 24], gsmRange: [200, 360], epiRange: [70, 110],
    desc: { ja: '中厚から厚手の綾織。ワークウェアやユニフォームに', zh: '中厚到厚斜纹布，用于工装和制服' } },
  { id: 'tweed_cotton', name: { ja: 'コットンツイード', zh: '棉花呢' },
    fibers: ['cotton'], weaves: ['twill_2_2','herringbone'], neRange: [6, 16], gsmRange: [250, 400], epiRange: [50, 90],
    desc: { ja: '太番手綿のツイード調。ジャケットやコートに', zh: '粗支棉花呢风格，用于夹克和大衣' } },
  // ═══════ 綿・朱子系 ═══════
  { id: 'sateen_cotton', name: { ja: 'コットンサテン', zh: '棉贡缎' },
    fibers: ['cotton'], weaves: ['sateen','satin_5'], neRange: [40, 100], gsmRange: [120, 220], epiRange: [120, 200],
    desc: { ja: '綿の朱子織。シーツやジャケット裏地に', zh: '棉缎纹织物，用于床单和夹克里布' } },
  // ═══════ 麻系 ═══════
  { id: 'linen_plain', name: { ja: 'リネン平織', zh: '亚麻平纹' },
    fibers: ['linen','ramie'], weaves: ['plain'], neRange: [10, 60], gsmRange: [100, 300], epiRange: [40, 110],
    desc: { ja: '麻100%の平織。独特のシャリ感と涼感', zh: '100%亚麻平纹，独特的凉爽触感' } },
  { id: 'linen_cambric', name: { ja: 'リネンキャンブリック', zh: '亚麻细平布' },
    fibers: ['linen'], weaves: ['plain'], neRange: [40, 80], gsmRange: [60, 130], epiRange: [80, 140],
    desc: { ja: '高番手リネンの薄地平織。ハンカチ・ブラウスに', zh: '高支亚麻薄平纹，用于手帕和女衬衫' } },
  { id: 'linen_canvas', name: { ja: 'リネンキャンバス', zh: '亚麻帆布' },
    fibers: ['linen','ramie'], weaves: ['plain','canvas'], neRange: [4, 16], gsmRange: [250, 500], epiRange: [30, 60],
    desc: { ja: '太番手リネンの厚地平織。バッグや家具に', zh: '粗支亚麻厚平纹，用于包和家具' } },
  // ═══════ 綿麻ブレンド ═══════
  { id: 'cotton_linen', name: { ja: '綿麻（コットンリネン）', zh: '棉麻' },
    fibers: ['cotton','linen'], weaves: ['plain','twill_2_1','twill_2_2'], neRange: [16, 50], gsmRange: [100, 250], epiRange: [50, 120],
    desc: { ja: '綿と麻の混紡。両素材の良いところを兼ね備える', zh: '棉麻混纺，兼具两种纤维的优点' }, isBlend: true },
  // ═══════ 毛織物・平織系 ═══════
  { id: 'tropical_wool', name: { ja: 'トロピカルウール', zh: '凉爽毛料' },
    fibers: ['wool'], weaves: ['plain'], neRange: [30, 60], gsmRange: [150, 230], epiRange: [60, 110],
    desc: { ja: '高番手の薄手平織毛織物。春夏スーツに最適', zh: '高支薄平纹毛料，最适合春夏西装' } },
  { id: 'fresco_wool', name: { ja: 'フレスコ', zh: '清凉毛料' },
    fibers: ['wool'], weaves: ['plain'], neRange: [40, 80], gsmRange: [180, 260], epiRange: [70, 120],
    desc: { ja: '強撚糸使用の通気性に優れた毛織物。夏のビジネスに', zh: '使用强捻纱的透气毛料，夏季商务用' } },
  // ═══════ 毛織物・ツイル系 ═══════
  { id: 'serge', name: { ja: 'サージ', zh: '哔叽' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [24, 48], gsmRange: [200, 320], epiRange: [70, 120],
    desc: { ja: '梳毛糸の2/2ツイル。スーツ・制服の定番', zh: '精纺2/2斜纹，西装和制服经典面料' } },
  { id: 'gabardine_wool', name: { ja: 'ギャバジン', zh: '华达呢' },
    fibers: ['wool'], weaves: ['gabardine','twill_2_1','twill_2_2'], neRange: [24, 60], gsmRange: [200, 340], epiRange: [80, 140],
    desc: { ja: '経密度が高い急角度ツイル。コートやスラックスに', zh: '经密度高的急角度斜纹，用于大衣和西裤' } },
  { id: 'doeskin', name: { ja: 'ドスキン', zh: '克罗丁' },
    fibers: ['wool'], weaves: ['satin_5','sateen'], neRange: [30, 60], gsmRange: [250, 400], epiRange: [80, 140],
    desc: { ja: '朱子織の毛織物。起毛・プレスで鹿皮のような手触り', zh: '缎纹毛料，起毛和压平后有鹿皮般触感' } },
  { id: 'flannel_wool', name: { ja: 'フランネル', zh: '法兰绒' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [8, 24], gsmRange: [200, 380], epiRange: [50, 100],
    desc: { ja: '紡毛糸の起毛仕上げ。温かみのある秋冬素材', zh: '粗纺纱起毛整理，温暖的秋冬面料' } },
  { id: 'tweed_wool', name: { ja: 'ツイード', zh: '花呢' },
    fibers: ['wool'], weaves: ['plain','twill_2_2','herringbone'], neRange: [4, 14], gsmRange: [280, 500], epiRange: [40, 80],
    desc: { ja: '紡毛の厚地織物。ハリスツイード等が有名', zh: '粗纺厚织物，哈里斯花呢等著名' } },
  { id: 'herringbone_wool', name: { ja: 'ヘリンボーンツイード', zh: '人字纹花呢' },
    fibers: ['wool'], weaves: ['herringbone'], neRange: [6, 24], gsmRange: [250, 450], epiRange: [50, 100],
    desc: { ja: '杉綾模様のツイード。ジャケットの定番', zh: '人字纹花呢，夹克经典面料' } },
  { id: 'melton', name: { ja: 'メルトン', zh: '麦尔登呢' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [4, 14], gsmRange: [350, 600], epiRange: [40, 80],
    desc: { ja: '縮絨・起毛で組織が見えない厚地。ピーコートに', zh: '缩绒起毛看不到织纹的厚料，用于大衣' } },
  { id: 'worsted_suiting', name: { ja: 'ウーステッド（梳毛スーティング）', zh: '精纺毛料' },
    fibers: ['wool'], weaves: ['twill_2_2','plain'], neRange: [28, 80], gsmRange: [180, 300], epiRange: [70, 140],
    desc: { ja: '梳毛糸の滑らかなスーツ地。光沢とドレープ性', zh: '精纺纱光滑西装面料，有光泽和垂感' } },
  { id: 'cashmere_fabric', name: { ja: 'カシミヤ織物', zh: '羊绒面料' },
    fibers: ['cashmere'], weaves: ['plain','twill_2_2'], neRange: [20, 60], gsmRange: [150, 400], epiRange: [50, 120],
    desc: { ja: 'カシミヤ100%の高級織物。極上の肌触り', zh: '100%羊绒高级织物，极致触感' } },
  { id: 'houndstooth_fabric', name: { ja: '千鳥格子', zh: '千鸟格' },
    fibers: ['wool'], weaves: ['houndstooth','twill_2_2'], neRange: [16, 48], gsmRange: [200, 380], epiRange: [60, 120],
    desc: { ja: '千鳥模様のツイル。ジャケット・コートに', zh: '千鸟格斜纹，用于夹克和大衣' } },
  // ═══════ 絹織物 ═══════
  { id: 'habotai', name: { ja: '羽二重（ハブタエ）', zh: '电力纺' },
    fibers: ['silk'], weaves: ['plain'], neRange: [80, 300], gsmRange: [30, 80], epiRange: [80, 200],
    desc: { ja: '生糸の薄手平織。裏地やスカーフに', zh: '生丝薄平纹，用于里布和丝巾' } },
  { id: 'taffeta_silk', name: { ja: 'タフタ', zh: '塔夫绸' },
    fibers: ['silk','polyester'], weaves: ['plain'], neRange: [40, 200], gsmRange: [60, 140], epiRange: [100, 200],
    desc: { ja: '密な平織。独特のシャリ感とハリ', zh: '密平纹，独特的脆感和挺括性' } },
  { id: 'crepe_de_chine', name: { ja: 'クレープデシン', zh: '双绉' },
    fibers: ['silk'], weaves: ['plain'], neRange: [40, 120], gsmRange: [60, 130], epiRange: [80, 160],
    desc: { ja: '強撚糸を使ったシボのある平織。ドレスやブラウスに', zh: '使用强捻纱的皱平纹，用于礼服和女衬衫' } },
  { id: 'satin_silk', name: { ja: 'シルクサテン', zh: '丝缎' },
    fibers: ['silk'], weaves: ['satin_5','sateen'], neRange: [40, 200], gsmRange: [60, 180], epiRange: [120, 250],
    desc: { ja: '絹の朱子織。最高の光沢とドレープ', zh: '丝绸缎纹，最好的光泽和垂感' } },
  { id: 'twill_silk', name: { ja: 'シルクツイル', zh: '丝斜纹' },
    fibers: ['silk'], weaves: ['twill_2_2','twill_2_1'], neRange: [30, 120], gsmRange: [60, 160], epiRange: [80, 180],
    desc: { ja: '絹の綾織。スカーフやネクタイに多用', zh: '丝绸斜纹，常用于丝巾和领带' } },
  // ═══════ ポリエステル系 ═══════
  { id: 'polyester_taffeta', name: { ja: 'ポリエステルタフタ', zh: '涤塔夫' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [30, 200], gsmRange: [40, 120], epiRange: [80, 200],
    desc: { ja: 'ポリエステルの密な平織。裏地やエコバッグに', zh: '涤纶密平纹，用于里布和环保袋' } },
  { id: 'polyester_twill', name: { ja: 'ポリエステルツイル', zh: '涤纶斜纹' },
    fibers: ['polyester'], weaves: ['twill_2_1','twill_2_2'], neRange: [20, 100], gsmRange: [120, 280], epiRange: [60, 140],
    desc: { ja: 'ポリエステルの綾織。ユニフォームやアウトドアに', zh: '涤纶斜纹，用于制服和户外' } },
  { id: 'polyester_satin', name: { ja: 'ポリエステルサテン', zh: '涤纶色丁' },
    fibers: ['polyester'], weaves: ['satin_5','sateen'], neRange: [30, 150], gsmRange: [80, 200], epiRange: [100, 200],
    desc: { ja: 'ポリエステルの朱子織。コスチュームや裏地に', zh: '涤纶缎纹，用于服装和里布' } },
  { id: 'microfiber_fabric', name: { ja: 'マイクロファイバー', zh: '超细纤维布' },
    fibers: ['polyester','nylon'], weaves: ['plain','twill_2_2'], neRange: [60, 200], gsmRange: [80, 180], epiRange: [100, 200],
    desc: { ja: '極細繊維の高密度織物。ピーチスキンの手触り', zh: '超细纤维高密度织物，桃皮绒触感' } },
  // ═══════ ナイロン系 ═══════
  { id: 'ripstop', name: { ja: 'リップストップ', zh: '防撕裂布' },
    fibers: ['nylon','polyester'], weaves: ['plain'], neRange: [40, 150], gsmRange: [30, 120], epiRange: [60, 150],
    desc: { ja: '格子状に補強糸を入れた薄地。アウトドア・ミリタリー', zh: '格子状加强纱的薄面料，户外和军用' } },
  { id: 'nylon_taffeta', name: { ja: 'ナイロンタフタ', zh: '尼龙塔夫' },
    fibers: ['nylon'], weaves: ['plain'], neRange: [40, 200], gsmRange: [30, 100], epiRange: [80, 180],
    desc: { ja: 'ナイロンの薄手平織。防風ジャケットやパラシュートに', zh: '尼龙薄平纹，用于防风夹克和降落伞' } },
  { id: 'cordura_fabric', name: { ja: 'コーデュラ', zh: 'CORDURA面料' },
    fibers: ['nylon'], weaves: ['plain','twill_2_2'], neRange: [4, 30], gsmRange: [200, 500], epiRange: [40, 100],
    desc: { ja: '高強力ナイロン。バッグ・ミリタリーウェアに', zh: '高强力尼龙，用于包和军用服装' } },
  // ═══════ TC/CVC混紡 ═══════
  { id: 'tc_plain', name: { ja: 'TC平織', zh: 'TC平纹' },
    fibers: ['polyester','cotton'], weaves: ['plain','broadcloth'], neRange: [20, 60], gsmRange: [90, 200], epiRange: [70, 140],
    desc: { ja: 'ポリエステル綿混の平織。シャツ・ブラウスに', zh: '涤棉混纺平纹，用于衬衫和女衬衫' }, isBlend: true },
  { id: 'tc_twill', name: { ja: 'TCツイル', zh: 'TC斜纹' },
    fibers: ['polyester','cotton'], weaves: ['twill_2_1','twill_2_2'], neRange: [16, 45], gsmRange: [150, 300], epiRange: [70, 130],
    desc: { ja: 'ポリエステル綿混の綾織。ワークウェアやユニフォーム', zh: '涤棉混纺斜纹，用于工装和制服' }, isBlend: true },
  // ═══════ レーヨン系 ═══════
  { id: 'rayon_challis', name: { ja: 'レーヨンシャリス', zh: '粘胶绉布' },
    fibers: ['viscose'], weaves: ['plain'], neRange: [20, 50], gsmRange: [80, 160], epiRange: [50, 100],
    desc: { ja: 'レーヨンの柔らかい平織。ドレープ性に優れる', zh: '粘胶柔软平纹，悬垂性好' } },
  { id: 'tencel_twill', name: { ja: 'テンセルツイル', zh: '天丝斜纹' },
    fibers: ['lyocell'], weaves: ['twill_2_1','twill_2_2'], neRange: [20, 60], gsmRange: [120, 250], epiRange: [60, 130],
    desc: { ja: 'テンセルの綾織。シルクのような光沢と落ち感', zh: '天丝斜纹，有丝绸般光泽和垂感' } },
  // ═══════ ドビー・ジャカード系 ═══════
  { id: 'pique_fabric', name: { ja: 'ピケ', zh: '珠地布' },
    fibers: ['cotton','polyester'], weaves: ['pique'], neRange: [16, 40], gsmRange: [150, 260], epiRange: [50, 100],
    desc: { ja: '凹凸のある変化織。ポロシャツの定番', zh: '有凹凸的变化织，Polo衫经典面料' } },
  { id: 'waffle_cloth', name: { ja: 'ワッフル', zh: '华夫格布' },
    fibers: ['cotton'], weaves: ['waffle'], neRange: [10, 30], gsmRange: [180, 320], epiRange: [40, 80],
    desc: { ja: '格子状の凹凸。タオルやカットソーに', zh: '格子状凹凸，用于毛巾和T恤' } },
  { id: 'damask_fabric', name: { ja: 'ダマスク', zh: '锦缎' },
    fibers: ['cotton','silk','polyester'], weaves: ['damask'], neRange: [30, 100], gsmRange: [150, 350], epiRange: [80, 200],
    desc: { ja: '平織と朱子織の組み合わせで模様を出す。テーブルクロス', zh: '平纹和缎纹组合的提花，用于桌布' } },
  // ═══════ パイル系 ═══════
  { id: 'velvet_fabric', name: { ja: 'ベルベット', zh: '丝绒' },
    fibers: ['silk','polyester','cotton'], weaves: ['velvet'], neRange: [20, 100], gsmRange: [200, 400], epiRange: [80, 160],
    desc: { ja: 'パイルを起こした光沢ある織物。ドレスやカーテンに', zh: '立起绒毛的光泽织物，用于礼服和窗帘' } },
  { id: 'corduroy_fabric', name: { ja: 'コーデュロイ', zh: '灯芯绒' },
    fibers: ['cotton'], weaves: ['corduroy'], neRange: [10, 30], gsmRange: [200, 400], epiRange: [60, 120],
    desc: { ja: '縦畝のある起毛織物。パンツやジャケットに', zh: '有纵条纹的起毛织物，用于裤子和夹克' } },
  { id: 'terry_cloth', name: { ja: 'テリー（タオル地）', zh: '毛圈布' },
    fibers: ['cotton'], weaves: ['terry'], neRange: [8, 20], gsmRange: [250, 600], epiRange: [40, 80],
    desc: { ja: 'ループパイルの吸水織物。タオル・バスローブ', zh: '毛圈吸水织物，用于毛巾和浴袍' } },
  // ═══════ 二重織系 ═══════
  { id: 'double_cloth_fabric', name: { ja: '二重織', zh: '双层织物' },
    fibers: ['wool','cotton','polyester'], weaves: ['double_cloth'], neRange: [10, 40], gsmRange: [300, 600], epiRange: [60, 120],
    desc: { ja: '二層構造の厚地。コートやブランケットに', zh: '双层结构厚面料，用于大衣和毯子' } },
  // ═══════ ウールポリ ═══════
  { id: 'wool_poly_suiting', name: { ja: 'ウールポリスーティング', zh: '毛涤西装面料' },
    fibers: ['wool','polyester'], weaves: ['twill_2_2','plain'], neRange: [20, 50], gsmRange: [180, 320], epiRange: [60, 130],
    desc: { ja: 'ウールとポリの混紡スーツ地。耐久性と着心地の両立', zh: '毛涤混纺西装面料，耐用与舒适兼具' }, isBlend: true },

  // ═══════ 綿織物 追加 ═══════
  { id: 'batiste', name: { ja: 'バティスト', zh: '细薄平纹' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [60, 140], gsmRange: [40, 90], epiRange: [80, 160],
    desc: { ja: '極薄の上質平織。ハンカチやベビー服に', zh: '极薄优质平纹，用于手帕和婴儿服' } },
  { id: 'dimity', name: { ja: 'ディミティ', zh: '条纹薄棉布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [40, 80], gsmRange: [60, 120], epiRange: [70, 130],
    desc: { ja: '縦方向の畝がある薄手平織。カーテンやブラウスに', zh: '有纵向凸条的薄平纹，用于窗帘和女衬衫' } },
  { id: 'madras', name: { ja: 'マドラスチェック', zh: '马德拉斯格子' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 50], gsmRange: [80, 160], epiRange: [50, 100],
    desc: { ja: 'インド・マドラス地方の先染め格子柄。退色が特徴', zh: '印度马德拉斯产地色织格子，褪色为特色' } },
  { id: 'cheese_cloth', name: { ja: 'チーズクロス（寒冷紗）', zh: '纱布/稀松布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 40], gsmRange: [20, 60], epiRange: [20, 50],
    desc: { ja: '極めて粗い平織。チーズ包装やガーデニングに', zh: '极稀松平纹，用于奶酪包装和园艺' } },
  { id: 'gauze_cotton', name: { ja: 'ガーゼ', zh: '纱布' },
    fibers: ['cotton'], weaves: ['plain','leno'], neRange: [30, 60], gsmRange: [20, 80], epiRange: [30, 70],
    desc: { ja: '粗い平織またはもじり織。医療用やベビー用品', zh: '稀松平纹或纱罗，医用和婴儿用品' } },
  { id: 'indian_cotton', name: { ja: 'インド綿', zh: '印度棉布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [10, 30], gsmRange: [100, 200], epiRange: [40, 80],
    desc: { ja: 'インド産の手紡ぎ風綿布。独特の風合い', zh: '印度产手纺风格棉布，独特质感' } },
  { id: 'twill_cotton', name: { ja: '綿ツイル', zh: '棉斜纹' },
    fibers: ['cotton'], weaves: ['twill_2_1','twill_2_2'], neRange: [16, 40], gsmRange: [150, 280], epiRange: [70, 120],
    desc: { ja: '綿100%の綾織。パンツやジャケットに', zh: '100%棉斜纹，用于裤子和夹克' } },
  { id: 'cotton_gabardine', name: { ja: 'コットンギャバジン', zh: '棉华达呢' },
    fibers: ['cotton'], weaves: ['gabardine','twill_2_2'], neRange: [20, 40], gsmRange: [200, 340], epiRange: [80, 130],
    desc: { ja: '綿の高密度ツイル。コートやスラックスに', zh: '棉高密度斜纹，用于大衣和西裤' } },
  { id: 'moleskin', name: { ja: 'モールスキン', zh: '鼹鼠皮布' },
    fibers: ['cotton'], weaves: ['sateen','satin_5'], neRange: [10, 24], gsmRange: [250, 450], epiRange: [80, 130],
    desc: { ja: '厚手の朱子織を起毛した綿生地。ワークウェアに', zh: '厚缎纹起毛棉面料，用于工装' } },
  { id: 'denim_stretch', name: { ja: 'ストレッチデニム', zh: '弹力牛仔布' },
    fibers: ['cotton','polyester','pu'], weaves: ['denim'], neRange: [8, 20], gsmRange: [250, 400], epiRange: [55, 90],
    desc: { ja: 'ストレッチ素材入りのデニム。スキニーパンツに', zh: '含弹力材料的牛仔布，用于紧身裤' }, isBlend: true },
  { id: 'hickory_stripe', name: { ja: 'ヒッコリーストライプ', zh: '条纹工装布' },
    fibers: ['cotton'], weaves: ['twill_2_1'], neRange: [8, 20], gsmRange: [200, 340], epiRange: [60, 100],
    desc: { ja: '先染めストライプのワーク生地。オーバーオールに', zh: '色织条纹工装面料，用于工装裤' } },
  { id: 'sailcloth', name: { ja: 'セールクロス', zh: '帆布' },
    fibers: ['cotton','polyester'], weaves: ['plain'], neRange: [4, 12], gsmRange: [300, 600], epiRange: [40, 70],
    desc: { ja: '帆船の帆に使われた高密度厚地。バッグやシューズに', zh: '帆船帆用高密度厚面料，用于包和鞋' } },
  { id: 'cotton_crepe', name: { ja: '楊柳（ようりゅう）', zh: '棉绉布' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [20, 50], gsmRange: [80, 160], epiRange: [50, 100],
    desc: { ja: '強撚糸で縦方向のシボ。夏の和装や甚平に', zh: '强捻纱产生纵向皱纹，用于夏季和服' }, twist: ['high'] },
  { id: 'cotton_dobby', name: { ja: 'コットンドビー', zh: '棉多臂织' },
    fibers: ['cotton'], weaves: ['dobby','pique'], neRange: [20, 60], gsmRange: [100, 200], epiRange: [60, 120],
    desc: { ja: 'ドビー織機による小柄織。シャツやブラウスに', zh: '多臂织机织的小花纹，用于衬衫和女衬衫' } },
  { id: 'cotton_jacquard', name: { ja: 'コットンジャカード', zh: '棉提花' },
    fibers: ['cotton'], weaves: ['damask','jacquard'], neRange: [20, 60], gsmRange: [120, 280], epiRange: [60, 140],
    desc: { ja: 'ジャカード織の綿。テーブルリネンやインテリアに', zh: '棉提花织物，用于桌布和室内装饰' } },
  { id: 'cotton_flannel', name: { ja: 'コットンフランネル（ネル）', zh: '棉法兰绒' },
    fibers: ['cotton'], weaves: ['twill_2_1','twill_2_2','plain'], neRange: [10, 30], gsmRange: [140, 300], epiRange: [50, 100],
    desc: { ja: '綿の起毛仕上げ生地。パジャマやシーツに', zh: '棉起毛面料，用于睡衣和床单' } },
  { id: 'waist_cloth', name: { ja: 'ウエストクロス（腰裏）', zh: '腰衬布' },
    fibers: ['cotton','polyester'], weaves: ['plain','twill_2_1'], neRange: [20, 40], gsmRange: [100, 180], epiRange: [60, 100],
    desc: { ja: 'パンツの腰裏に使う裏地。吸湿性重視', zh: '裤子腰部里布，注重吸湿性' } },

  // ═══════ 綿 産地・ブランド綿 ═══════
  { id: 'supima', name: { ja: 'スーピマ綿', zh: '皮马棉' },
    fibers: ['cotton'], weaves: ['plain','twill_2_2','sateen'], neRange: [40, 120], gsmRange: [80, 200], epiRange: [80, 180],
    desc: { ja: '米国産超長綿。光沢と強度に優れたシャツ地', zh: '美国产超长绒棉，有光泽和强度的衬衫面料' } },
  { id: 'sea_island', name: { ja: 'シーアイランドコットン', zh: '海岛棉' },
    fibers: ['cotton'], weaves: ['plain','broadcloth'], neRange: [80, 200], gsmRange: [60, 140], epiRange: [100, 200],
    desc: { ja: '世界最高級の超長綿。絹のような光沢', zh: '世界最高级超长绒棉，丝绸般光泽' } },

  // ═══════ 麻織物 追加 ═══════
  { id: 'ramie_plain', name: { ja: 'ラミー平織（からむし）', zh: '苎麻平纹' },
    fibers: ['ramie'], weaves: ['plain'], neRange: [10, 50], gsmRange: [100, 250], epiRange: [40, 100],
    desc: { ja: '苧麻の平織。張りがあり涼感に優れる', zh: '苎麻平纹，挺括凉爽' } },
  { id: 'hemp_canvas', name: { ja: 'ヘンプキャンバス', zh: '大麻帆布' },
    fibers: ['hemp'], weaves: ['plain','canvas'], neRange: [4, 14], gsmRange: [300, 600], epiRange: [30, 60],
    desc: { ja: '大麻の厚地平織。エコロジー素材として注目', zh: '大麻厚平纹，作为生态材料受关注' } },
  { id: 'linen_twill', name: { ja: 'リネンツイル', zh: '亚麻斜纹' },
    fibers: ['linen'], weaves: ['twill_2_1','twill_2_2'], neRange: [10, 40], gsmRange: [150, 300], epiRange: [50, 100],
    desc: { ja: '麻の綾織。パンツやジャケットに', zh: '亚麻斜纹，用于裤子和夹克' } },
  { id: 'linen_gauze', name: { ja: 'リネンガーゼ', zh: '亚麻纱布' },
    fibers: ['linen'], weaves: ['plain','leno'], neRange: [30, 60], gsmRange: [40, 100], epiRange: [30, 70],
    desc: { ja: '麻の薄手透け生地。ストールやカーテンに', zh: '亚麻薄透面料，用于围巾和窗帘' } },
  { id: 'linen_chambray', name: { ja: 'リネンシャンブレー', zh: '亚麻青年布' },
    fibers: ['linen'], weaves: ['plain'], neRange: [20, 50], gsmRange: [100, 200], epiRange: [50, 100],
    desc: { ja: '色経×白緯のリネン平織', zh: '色经×白纬的亚麻平纹' } },
  { id: 'near_linen', name: { ja: 'ニアーリネン（リネン風合成）', zh: '仿麻面料' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [20, 50], gsmRange: [100, 200], epiRange: [50, 100],
    desc: { ja: 'ポリエステルで麻風合いを再現', zh: '涤纶模仿亚麻质感' } },

  // ═══════ 毛織物 追加 ═══════
  { id: 'saxony', name: { ja: 'サキソニー', zh: '萨克森呢' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [20, 40], gsmRange: [240, 380], epiRange: [60, 110],
    desc: { ja: '梳毛のソフトツイル。ビジネススーツの定番', zh: '精纺柔软斜纹，商务西装经典' } },
  { id: 'cheviot', name: { ja: 'シェビオット', zh: '雪维特呢' },
    fibers: ['wool'], weaves: ['twill_2_2','plain'], neRange: [8, 20], gsmRange: [280, 420], epiRange: [50, 90],
    desc: { ja: 'ザックリした紡毛織物。コートやジャケットに', zh: '粗犷的粗纺织物，用于大衣和夹克' } },
  { id: 'covert_cloth', name: { ja: 'カバートクロス', zh: '隐条呢' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [16, 36], gsmRange: [250, 400], epiRange: [60, 110],
    desc: { ja: '2色の撚り合わせ糸のツイル。乗馬コート起源', zh: '双色合股纱斜纹，源自骑马大衣' } },
  { id: 'whipcord', name: { ja: 'ウィップコード', zh: '鞭纹呢' },
    fibers: ['wool'], weaves: ['twill_2_2','gabardine'], neRange: [20, 40], gsmRange: [250, 400], epiRange: [70, 120],
    desc: { ja: '急角度の斜めの畝が特徴。軍服やライディングに', zh: '特征是急角度斜纹，用于军装和骑装' } },
  { id: 'broadcloth_wool', name: { ja: 'ウールブロードクロス', zh: '精纺宽幅呢' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [24, 60], gsmRange: [200, 350], epiRange: [70, 130],
    desc: { ja: '縮絨・プレスした上質毛織物。フォーマルコートに', zh: '缩绒压平的优质毛料，用于正装大衣' } },
  { id: 'bouclé_fabric', name: { ja: 'ブークレ', zh: '圈圈呢' },
    fibers: ['wool','polyester'], weaves: ['plain','twill_2_2'], neRange: [4, 16], gsmRange: [250, 450], epiRange: [30, 70],
    desc: { ja: 'ループヤーンによる凹凸のある織物。ジャケットに', zh: '用环圈纱织成的凹凸织物，用于夹克' } },
  { id: 'loden', name: { ja: 'ローデン', zh: '洛登呢' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [6, 16], gsmRange: [400, 700], epiRange: [40, 70],
    desc: { ja: 'オーストリア伝統の防水毛織物。撥水性あり', zh: '奥地利传统防水毛料，有拨水性' } },
  { id: 'beaver_cloth', name: { ja: 'ビーバー', zh: '海狸绒' },
    fibers: ['wool'], weaves: ['twill_2_2','satin_5'], neRange: [10, 24], gsmRange: [400, 600], epiRange: [50, 90],
    desc: { ja: '高級厚地コート素材。毛並みを寝かせた仕上げ', zh: '高级厚大衣面料，毛羽倒伏整理' } },
  { id: 'duffle', name: { ja: 'ダッフル', zh: '粗呢' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [4, 12], gsmRange: [400, 700], epiRange: [30, 60],
    desc: { ja: '厚手の紡毛織物。ダッフルコートの生地', zh: '厚粗纺织物，用于大衣' } },
  { id: 'moss_crepe_wool', name: { ja: 'モスクレープ', zh: '苔绉呢' },
    fibers: ['wool'], weaves: ['plain'], neRange: [24, 50], gsmRange: [150, 260], epiRange: [60, 110],
    desc: { ja: '苔のような細かいシボのある梳毛織物', zh: '有苔藓般细皱的精纺织物' }, twist: ['high'] },
  { id: 'crepe_wool', name: { ja: 'ウールクレープ', zh: '毛绉' },
    fibers: ['wool'], weaves: ['plain'], neRange: [24, 60], gsmRange: [150, 280], epiRange: [60, 110],
    desc: { ja: '強撚梳毛糸のクレープ。ドレスやスーツに', zh: '强捻精纺纱绉织物，用于礼服和西装' }, twist: ['high'] },
  { id: 'sharkskin_wool', name: { ja: 'シャークスキン', zh: '鲨鱼皮纹呢' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [30, 60], gsmRange: [200, 320], epiRange: [70, 130],
    desc: { ja: '2色使いの小さな綾目模様。ビジネススーツに', zh: '双色小斜纹花纹，用于商务西装' } },
  { id: 'birdseye_wool', name: { ja: 'バーズアイ', zh: '鸟眼纹呢' },
    fibers: ['wool'], weaves: ['twill_2_2','dobby'], neRange: [24, 50], gsmRange: [200, 320], epiRange: [70, 130],
    desc: { ja: '鳥の目のような小さなダイヤ柄。スーツ生地', zh: '鸟眼般的小菱形花纹，西装面料' } },
  { id: 'glen_check', name: { ja: 'グレンチェック', zh: '格伦格子' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [20, 50], gsmRange: [200, 340], epiRange: [60, 120],
    desc: { ja: '千鳥格子の組み合わせ格子。英国調スーツ', zh: '千鸟格组合格子，英式西装' } },
  { id: 'tartan_wool', name: { ja: 'タータンチェック', zh: '格子呢' },
    fibers: ['wool'], weaves: ['twill_2_2'], neRange: [16, 40], gsmRange: [200, 380], epiRange: [50, 100],
    desc: { ja: 'スコットランド伝統の格子柄毛織物', zh: '苏格兰传统格子毛料' } },
  { id: 'albatross_wool', name: { ja: 'アルバトロス', zh: '薄毛绉' },
    fibers: ['wool'], weaves: ['plain'], neRange: [30, 60], gsmRange: [80, 160], epiRange: [50, 90],
    desc: { ja: '薄手のクレープ状毛織物。ドレスに', zh: '薄绉状毛织物，用于礼服' }, twist: ['high'] },
  { id: 'challis_wool', name: { ja: 'シャリス', zh: '薄毛料' },
    fibers: ['wool'], weaves: ['plain'], neRange: [30, 60], gsmRange: [100, 180], epiRange: [50, 100],
    desc: { ja: '柔らかい薄手梳毛平織。プリントにも適する', zh: '柔软薄精纺平纹，也适合印花' } },
  { id: 'wool_muslin', name: { ja: 'ウールモスリン', zh: '毛平纹细布' },
    fibers: ['wool'], weaves: ['plain'], neRange: [30, 60], gsmRange: [80, 150], epiRange: [50, 90],
    desc: { ja: '薄手のウール平織。ドレスやスカーフに', zh: '薄毛料平纹，用于礼服和围巾' } },
  { id: 'lambswool_fabric', name: { ja: 'ラムウール', zh: '羊羔毛织物' },
    fibers: ['wool'], weaves: ['plain','twill_2_2'], neRange: [8, 24], gsmRange: [200, 380], epiRange: [40, 90],
    desc: { ja: '子羊の初刈り毛。柔らかく保温性抜群', zh: '羔羊初剪毛，柔软保暖性好' } },

  // ═══════ 絹織物 追加 ═══════
  { id: 'chirimen', name: { ja: '縮緬（ちりめん）', zh: '绉绸' },
    fibers: ['silk'], weaves: ['plain'], neRange: [40, 120], gsmRange: [60, 150], epiRange: [80, 160],
    desc: { ja: '強撚糸による独特のシボ。和装の代表的素材', zh: '强捻纱产生独特绉纹，和服代表性面料' }, twist: ['warp:high','weft:high'] },
  { id: 'chiffon', name: { ja: 'シフォン', zh: '雪纺' },
    fibers: ['silk','polyester'], weaves: ['plain'], neRange: [60, 200], gsmRange: [20, 60], epiRange: [60, 140],
    desc: { ja: '極薄で透け感のある平織。ドレスやスカーフに', zh: '极薄有透感的平纹，用于礼服和丝巾' }, twist: ['high'] },
  { id: 'georgette', name: { ja: 'ジョーゼット', zh: '乔其纱' },
    fibers: ['silk','polyester'], weaves: ['plain'], neRange: [40, 120], gsmRange: [40, 100], epiRange: [60, 120],
    desc: { ja: '強撚糸のシボのある薄手平織。ドレスに', zh: '强捻纱有绉纹的薄平纹，用于礼服' }, twist: ['warp:high','weft:high'] },
  { id: 'dupioni', name: { ja: 'デュピオニ', zh: '双宫绸' },
    fibers: ['silk'], weaves: ['plain'], neRange: [20, 80], gsmRange: [80, 180], epiRange: [60, 130],
    desc: { ja: '玉繭（二頭蚕）から取った不規則な糸。節があり独特', zh: '双宫茧取丝，有节结独特质感' } },
  { id: 'organza_silk', name: { ja: 'シルクオーガンザ', zh: '丝绸欧根纱' },
    fibers: ['silk'], weaves: ['plain'], neRange: [60, 200], gsmRange: [20, 60], epiRange: [60, 140],
    desc: { ja: '薄く張りのある透明感のある絹織物', zh: '薄而挺括有透感的丝绸' } },
  { id: 'pongee', name: { ja: '紬（つむぎ）', zh: '紬绸' },
    fibers: ['silk'], weaves: ['plain'], neRange: [10, 40], gsmRange: [80, 180], epiRange: [50, 100],
    desc: { ja: '節のある紬糸の平織。カジュアルな和装', zh: '有节结的绢纺平纹，休闲和服' } },
  { id: 'habutae_silk', name: { ja: '本羽二重', zh: '本电力纺' },
    fibers: ['silk'], weaves: ['plain'], neRange: [80, 250], gsmRange: [30, 70], epiRange: [80, 180],
    desc: { ja: '最上質の絹平織。和装の裏地', zh: '最高级丝绸平纹，和服里布' } },
  { id: 'shantung', name: { ja: 'シャンタン', zh: '山东绸' },
    fibers: ['silk','polyester'], weaves: ['plain'], neRange: [20, 80], gsmRange: [60, 160], epiRange: [60, 120],
    desc: { ja: '節のある横糸を使った平織。独特の風合い', zh: '用有节结纬纱的平纹，独特质感' } },
  { id: 'silk_broadcloth', name: { ja: 'シルクブロードクロス', zh: '丝绸府绸' },
    fibers: ['silk'], weaves: ['plain','broadcloth'], neRange: [40, 120], gsmRange: [60, 140], epiRange: [100, 200],
    desc: { ja: '絹の高密度平織。最高級シャツ地', zh: '丝绸高密度平纹，最高级衬衫面料' } },
  { id: 'silk_jacquard', name: { ja: 'シルクジャカード', zh: '丝绸提花' },
    fibers: ['silk'], weaves: ['damask','jacquard'], neRange: [30, 100], gsmRange: [80, 250], epiRange: [80, 200],
    desc: { ja: '絹のジャカード織。帯や高級インテリアに', zh: '丝绸提花，用于和服腰带和高级室内装饰' } },
  { id: 'silk_velvet', name: { ja: 'シルクベルベット', zh: '丝绒' },
    fibers: ['silk'], weaves: ['velvet'], neRange: [20, 80], gsmRange: [200, 400], epiRange: [80, 150],
    desc: { ja: '絹のパイル織物。最高級の光沢と手触り', zh: '丝绸绒织物，最高级光泽和触感' } },

  // ═══════ ポリエステル・ナイロン 追加 ═══════
  { id: 'polyester_chiffon', name: { ja: 'ポリエステルシフォン', zh: '涤纶雪纺' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [60, 200], gsmRange: [20, 60], epiRange: [60, 140],
    desc: { ja: 'ポリエステルの極薄平織。手頃な価格で透け感', zh: '涤纶极薄平纹，价格亲民有透感' }, twist: ['high'] },
  { id: 'polyester_georgette', name: { ja: 'ポリエステルジョーゼット', zh: '涤纶乔其' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [40, 120], gsmRange: [40, 100], epiRange: [60, 120],
    desc: { ja: 'ポリエステルの強撚シボ平織', zh: '涤纶强捻绉平纹' }, twist: ['high'] },
  { id: 'polyester_crepe', name: { ja: 'ポリエステルクレープ', zh: '涤纶绉布' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [30, 80], gsmRange: [80, 180], epiRange: [60, 130],
    desc: { ja: 'ポリエステルのクレープ調。ブラウスに', zh: '涤纶绉感面料，用于女衬衫' }, twist: ['high'] },
  { id: 'polyester_oxford', name: { ja: 'ポリエステルオックス', zh: '涤纶牛津布' },
    fibers: ['polyester'], weaves: ['oxford'], neRange: [20, 50], gsmRange: [120, 250], epiRange: [50, 100],
    desc: { ja: 'ポリエステルのオックスフォード。バッグ素材に', zh: '涤纶牛津布，用于包材料' } },
  { id: 'polyester_pongee', name: { ja: 'ポリエステルポンジー', zh: '涤纶春亚纺' },
    fibers: ['polyester'], weaves: ['plain'], neRange: [30, 100], gsmRange: [40, 100], epiRange: [70, 150],
    desc: { ja: '薄手のポリエステル平織。裏地や旗に', zh: '薄涤纶平纹，用于里布和旗帜' } },
  { id: 'polyester_suede', name: { ja: 'ポリエステルスエード', zh: '涤纶仿麂皮' },
    fibers: ['polyester'], weaves: ['plain','twill_2_2'], neRange: [40, 150], gsmRange: [120, 280], epiRange: [80, 160],
    desc: { ja: '極細糸の起毛仕上げ。スエード調の手触り', zh: '超细纤维起毛整理，仿麂皮触感' } },
  { id: 'nylon_oxford', name: { ja: 'ナイロンオックス', zh: '尼龙牛津布' },
    fibers: ['nylon'], weaves: ['oxford'], neRange: [20, 60], gsmRange: [100, 250], epiRange: [50, 100],
    desc: { ja: 'ナイロンのオックスフォード。ランドセルやバッグに', zh: '尼龙牛津布，用于书包和包' } },
  { id: 'nylon_ripstop', name: { ja: 'ナイロンリップストップ', zh: '尼龙防撕裂' },
    fibers: ['nylon'], weaves: ['plain'], neRange: [40, 150], gsmRange: [20, 80], epiRange: [60, 140],
    desc: { ja: 'ナイロンの軽量リップストップ。パラシュートやダウンに', zh: '尼龙轻量防撕裂，用于降落伞和羽绒服' } },
  { id: 'taslan_fabric', name: { ja: 'タスラン', zh: '塔丝隆' },
    fibers: ['nylon'], weaves: ['plain','twill_2_2'], neRange: [20, 60], gsmRange: [100, 250], epiRange: [50, 100],
    desc: { ja: 'エアー加工ナイロン。天然繊維のような風合い', zh: '空气变形尼龙，天然纤维般质感' } },

  // ═══════ レーヨン・再生繊維 追加 ═══════
  { id: 'rayon_twill', name: { ja: 'レーヨンツイル', zh: '粘胶斜纹' },
    fibers: ['viscose'], weaves: ['twill_2_1','twill_2_2'], neRange: [16, 40], gsmRange: [120, 250], epiRange: [60, 110],
    desc: { ja: 'レーヨンの綾織。ドレープ性に優れたパンツに', zh: '粘胶斜纹，悬垂性好的裤子面料' } },
  { id: 'rayon_satin', name: { ja: 'レーヨンサテン', zh: '粘胶色丁' },
    fibers: ['viscose'], weaves: ['satin_5','sateen'], neRange: [20, 60], gsmRange: [100, 200], epiRange: [80, 160],
    desc: { ja: 'レーヨンの朱子織。光沢のあるドレス素材', zh: '粘胶缎纹，有光泽的礼服面料' } },
  { id: 'rayon_crepe', name: { ja: 'レーヨンクレープ', zh: '粘胶绉布' },
    fibers: ['viscose'], weaves: ['plain'], neRange: [20, 50], gsmRange: [80, 160], epiRange: [50, 100],
    desc: { ja: 'レーヨンの強撚シボ織。夏のワンピースに', zh: '粘胶强捻绉布，用于夏季连衣裙' }, twist: ['high'] },
  { id: 'cupro_fabric', name: { ja: 'キュプラ（ベンベルグ）', zh: '铜氨丝' },
    fibers: ['cupro'], weaves: ['plain','twill_2_1','sateen'], neRange: [40, 120], gsmRange: [50, 130], epiRange: [70, 160],
    desc: { ja: 'コットンリンター由来の再生繊維。高級裏地', zh: '棉短绒再生纤维，高级里布' } },
  { id: 'tencel_plain', name: { ja: 'テンセル平織', zh: '天丝平纹' },
    fibers: ['lyocell'], weaves: ['plain'], neRange: [20, 60], gsmRange: [80, 180], epiRange: [50, 120],
    desc: { ja: 'テンセルの平織。ドレープ性と光沢', zh: '天丝平纹，有悬垂性和光泽' } },
  { id: 'tencel_denim', name: { ja: 'テンセルデニム', zh: '天丝牛仔' },
    fibers: ['lyocell','cotton'], weaves: ['denim'], neRange: [10, 24], gsmRange: [180, 300], epiRange: [60, 100],
    desc: { ja: 'テンセル混のソフトデニム', zh: '天丝混纺柔软牛仔布' }, isBlend: true },
  { id: 'modal_fabric', name: { ja: 'モダール', zh: '莫代尔' },
    fibers: ['modal'], weaves: ['plain','twill_2_1'], neRange: [20, 60], gsmRange: [80, 180], epiRange: [50, 120],
    desc: { ja: 'ブナ材パルプ由来の再生繊維。柔らかくシルキー', zh: '山毛榉浆粕再生纤维，柔软有丝感' } },
  { id: 'acetate_satin', name: { ja: 'アセテートサテン', zh: '醋酸缎' },
    fibers: ['acetate'], weaves: ['satin_5','sateen'], neRange: [30, 100], gsmRange: [80, 180], epiRange: [80, 160],
    desc: { ja: 'アセテートの朱子織。裏地やドレスに', zh: '醋酸缎纹，用于里布和礼服' } },

  // ═══════ 混紡・ブレンド 追加 ═══════
  { id: 'tc_poplin', name: { ja: 'TCポプリン', zh: 'TC府绸' },
    fibers: ['polyester','cotton'], weaves: ['plain','broadcloth'], neRange: [30, 60], gsmRange: [90, 170], epiRange: [80, 150],
    desc: { ja: 'T/C混紡の高密度平織。ユニフォームシャツに', zh: 'T/C混纺高密度平纹，用于工装衬衫' }, isBlend: true },
  { id: 'tc_oxford', name: { ja: 'TCオックスフォード', zh: 'TC牛津布' },
    fibers: ['polyester','cotton'], weaves: ['oxford'], neRange: [16, 40], gsmRange: [130, 220], epiRange: [50, 100],
    desc: { ja: 'T/C混紡のオックスフォード。ビジネスシャツ', zh: 'T/C混纺牛津布，商务衬衫' }, isBlend: true },
  { id: 'cvc_plain', name: { ja: 'CVC平織', zh: 'CVC平纹' },
    fibers: ['cotton','polyester'], weaves: ['plain'], neRange: [20, 50], gsmRange: [90, 180], epiRange: [60, 120],
    desc: { ja: '綿リッチのポリ綿混。肌触り重視', zh: '棉含量较高的涤棉混纺，注重触感' }, isBlend: true },
  { id: 'wool_silk_blend', name: { ja: 'ウールシルク', zh: '毛丝混纺' },
    fibers: ['wool','silk'], weaves: ['twill_2_2','plain'], neRange: [24, 60], gsmRange: [150, 300], epiRange: [60, 130],
    desc: { ja: 'ウールとシルクの混紡。光沢と温かみの両立', zh: '毛丝混纺，光泽和温暖兼具' }, isBlend: true },
  { id: 'wool_cashmere_blend', name: { ja: 'ウールカシミヤ', zh: '毛羊绒混纺' },
    fibers: ['wool','cashmere'], weaves: ['twill_2_2','plain'], neRange: [16, 40], gsmRange: [200, 400], epiRange: [50, 100],
    desc: { ja: 'ウールにカシミヤ混。高級コートやスーツに', zh: '羊毛混羊绒，用于高级大衣和西装' }, isBlend: true },
  { id: 'wool_linen_blend', name: { ja: 'ウールリネン', zh: '毛麻混纺' },
    fibers: ['wool','linen'], weaves: ['plain','twill_2_2'], neRange: [16, 40], gsmRange: [180, 320], epiRange: [50, 110],
    desc: { ja: 'ウールと麻の混紡。夏の軽量スーツに', zh: '毛麻混纺，用于夏季轻量西装' }, isBlend: true },
  { id: 'silk_cotton_blend', name: { ja: 'シルクコットン', zh: '丝棉混纺' },
    fibers: ['silk','cotton'], weaves: ['plain','twill_2_2'], neRange: [20, 60], gsmRange: [80, 200], epiRange: [60, 130],
    desc: { ja: 'シルクとコットンの混紡。光沢と扱いやすさ', zh: '丝棉混纺，光泽与易打理兼具' }, isBlend: true },
  { id: 'cotton_poly_satin', name: { ja: '綿ポリサテン', zh: '棉涤色丁' },
    fibers: ['cotton','polyester'], weaves: ['sateen','satin_5'], neRange: [20, 50], gsmRange: [120, 220], epiRange: [80, 160],
    desc: { ja: '綿ポリ混の朱子織。シーツやブラウスに', zh: '棉涤混纺缎纹，用于床单和女衬衫' }, isBlend: true },
  { id: 'linen_rayon', name: { ja: 'リネンレーヨン', zh: '亚麻粘胶' },
    fibers: ['linen','viscose'], weaves: ['plain'], neRange: [16, 40], gsmRange: [100, 220], epiRange: [50, 100],
    desc: { ja: '麻とレーヨンの混紡。落ち感と涼感', zh: '亚麻与粘胶混纺，有垂感和凉感' }, isBlend: true },
  { id: 'cotton_nylon', name: { ja: '綿ナイロン（グログラン等）', zh: '棉尼混纺' },
    fibers: ['cotton','nylon'], weaves: ['plain','twill_2_2'], neRange: [16, 40], gsmRange: [120, 280], epiRange: [60, 120],
    desc: { ja: '綿ナイロン混。タフで軽量なアウトドア向け', zh: '棉尼混纺，坚韧轻量户外面料' }, isBlend: true },

  // ═══════ ストレッチ系 ═══════
  { id: 'stretch_twill', name: { ja: 'ストレッチツイル', zh: '弹力斜纹' },
    fibers: ['cotton','pu'], weaves: ['twill_2_1','twill_2_2'], neRange: [16, 40], gsmRange: [180, 300], epiRange: [70, 120],
    desc: { ja: 'ポリウレタン入りの伸縮綾織。チノパンに', zh: '含聚氨酯的弹力斜纹，用于卡其裤' }, isBlend: true },
  { id: 'stretch_poplin', name: { ja: 'ストレッチポプリン', zh: '弹力府绸' },
    fibers: ['cotton','pu'], weaves: ['plain','broadcloth'], neRange: [30, 60], gsmRange: [100, 180], epiRange: [80, 150],
    desc: { ja: 'ストレッチ入り平織。シャツやブラウスに', zh: '含弹力的平纹，用于衬衫和女衬衫' }, isBlend: true },
  { id: 'stretch_satin', name: { ja: 'ストレッチサテン', zh: '弹力色丁' },
    fibers: ['polyester','pu'], weaves: ['satin_5','sateen'], neRange: [30, 80], gsmRange: [100, 220], epiRange: [80, 160],
    desc: { ja: '伸縮性のある朱子織。ドレスやフォーマルに', zh: '有弹力的缎纹，用于礼服和正装' }, isBlend: true },

  // ═══════ 加工・仕上げ名称生地 ═══════
  { id: 'peach_skin', name: { ja: 'ピーチスキン', zh: '桃皮绒' },
    fibers: ['polyester'], weaves: ['plain','twill_2_2'], neRange: [40, 120], gsmRange: [80, 180], epiRange: [80, 160],
    desc: { ja: '桃の表面のような微起毛仕上げ', zh: '桃子表面般的微起毛整理' } },
  { id: 'washer_finish', name: { ja: 'ワッシャー加工', zh: '水洗加工' },
    fibers: ['cotton','linen','polyester'], weaves: ['plain','twill_2_1'], neRange: [10, 40], gsmRange: [80, 220], epiRange: [40, 100],
    desc: { ja: 'ウォッシュ加工でナチュラルなシワ感', zh: '水洗加工产生自然皱纹感' } },
  { id: 'garment_dye', name: { ja: '製品染め生地', zh: '成衣染色面料' },
    fibers: ['cotton'], weaves: ['plain','twill_2_1'], neRange: [16, 40], gsmRange: [100, 220], epiRange: [50, 100],
    desc: { ja: '縫製後に染色。独特の退色感', zh: '缝制后染色，独特的褪色感' } },
  { id: 'bonded_fabric', name: { ja: 'ボンディング生地', zh: '复合面料' },
    fibers: ['polyester','wool','cotton'], weaves: ['plain','twill_2_2'], neRange: [16, 60], gsmRange: [200, 500], epiRange: [50, 120],
    desc: { ja: '表裏2枚の生地を接着。コートやジャケットに', zh: '正反两层面料粘合，用于大衣和夹克' } },
  { id: 'oilskin', name: { ja: 'オイルドクロス', zh: '油布' },
    fibers: ['cotton'], weaves: ['plain','twill_2_1'], neRange: [8, 20], gsmRange: [200, 400], epiRange: [50, 80],
    desc: { ja: 'オイル含浸の防水綿布。アウトドアに', zh: '浸油防水棉布，用于户外' } },
  { id: 'laminated', name: { ja: 'ラミネート生地', zh: '覆膜面料' },
    fibers: ['cotton','polyester','nylon'], weaves: ['plain','twill_2_2'], neRange: [16, 60], gsmRange: [150, 400], epiRange: [50, 120],
    desc: { ja: '表面にフィルムを貼った防水生地。レインウェアに', zh: '表面覆膜防水面料，用于雨衣' } },
  { id: 'silicone_wash', name: { ja: 'シリコンウォッシュ', zh: '硅洗面料' },
    fibers: ['cotton'], weaves: ['plain','twill_2_1'], neRange: [16, 40], gsmRange: [100, 220], epiRange: [50, 100],
    desc: { ja: 'シリコン加工でヌメリとしたタッチ', zh: '硅整理产生滑爽触感' } },

  // ═══════ 特殊織物・機能素材 ═══════
  { id: 'gore_tex_type', name: { ja: 'ゴアテックス風3レイヤー', zh: 'Gore-Tex风三层' },
    fibers: ['nylon','polyester'], weaves: ['plain'], neRange: [40, 120], gsmRange: [100, 250], epiRange: [60, 140],
    desc: { ja: '防水透湿メンブレンの3層構造', zh: '防水透湿膜三层结构' } },
  { id: 'coolmax_type', name: { ja: 'クールマックス風吸汗速乾', zh: 'CoolMax风吸湿速干' },
    fibers: ['polyester'], weaves: ['plain','pique'], neRange: [30, 80], gsmRange: [80, 180], epiRange: [60, 130],
    desc: { ja: '異形断面ポリの吸汗速乾素材', zh: '异形截面涤纶吸湿速干面料' } },
  { id: 'kevlar_type', name: { ja: 'アラミド（ケブラー風）', zh: '芳纶(凯夫拉风)' },
    fibers: ['aramid'], weaves: ['plain','twill_2_2'], neRange: [10, 40], gsmRange: [100, 400], epiRange: [40, 100],
    desc: { ja: '超高強力のアラミド繊維織物。防護服に', zh: '超高强力芳纶织物，用于防护服' } },
  { id: 'carbon_fabric', name: { ja: 'カーボンクロス', zh: '碳纤维布' },
    fibers: ['carbon'], weaves: ['plain','twill_2_2'], neRange: [4, 20], gsmRange: [100, 400], epiRange: [20, 60],
    desc: { ja: '炭素繊維の織物。航空宇宙や自動車に', zh: '碳纤维织物，用于航空航天和汽车' } },

  // ═══════ 日本産地名称 ═══════
  { id: 'enshu_cotton', name: { ja: '遠州綿紬', zh: '远州棉紬' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [10, 30], gsmRange: [100, 200], epiRange: [40, 80],
    desc: { ja: '静岡県遠州産の先染め綿織物', zh: '静冈县远州产先染棉织物' } },
  { id: 'banshu_ori', name: { ja: '播州織', zh: '播州织' },
    fibers: ['cotton'], weaves: ['plain','twill_2_2','oxford'], neRange: [16, 50], gsmRange: [80, 200], epiRange: [50, 120],
    desc: { ja: '兵庫県西脇市の先染め綿織物。日本最大産地', zh: '�的库县西�的市的先染棉织物，日本最大产地' } },
  { id: 'bishu_wool', name: { ja: '尾州ウール', zh: '尾州毛料' },
    fibers: ['wool'], weaves: ['twill_2_2','plain','herringbone'], neRange: [16, 60], gsmRange: [150, 400], epiRange: [50, 130],
    desc: { ja: '愛知県尾州産の毛織物。世界的な品質', zh: '爱知县尾州产的毛织物，世界级品质' } },
  { id: 'nishijin_silk', name: { ja: '西陣織', zh: '西阵织' },
    fibers: ['silk'], weaves: ['jacquard','damask'], neRange: [30, 150], gsmRange: [100, 400], epiRange: [80, 250],
    desc: { ja: '京都西陣の伝統絹織物。帯や和装小物', zh: '京都西阵传统丝绸，和服腰带和配饰' } },
  { id: 'hakata_ori', name: { ja: '博多織', zh: '博多织' },
    fibers: ['silk'], weaves: ['plain','twill_2_2'], neRange: [30, 100], gsmRange: [100, 300], epiRange: [80, 200],
    desc: { ja: '福岡博多の経糸密度が高い絹織物。帯の名産', zh: '福冈博多经密度高的丝绸，腰带名产' } },
  { id: 'oshima_tsumugi', name: { ja: '大島紬', zh: '大岛紬' },
    fibers: ['silk'], weaves: ['plain'], neRange: [20, 60], gsmRange: [80, 180], epiRange: [60, 120],
    desc: { ja: '奄美大島の泥染め絹織物。軽くしなやか', zh: '奄美大岛泥染丝绸，轻薄柔软' } },
  { id: 'yuki_tsumugi', name: { ja: '結城紬', zh: '结城紬' },
    fibers: ['silk'], weaves: ['plain'], neRange: [10, 30], gsmRange: [100, 200], epiRange: [40, 80],
    desc: { ja: '茨城県結城市の手紬。ユネスコ無形文化遺産', zh: '茨城县结城市的手紬，联合国教科文组织非遗' } },
  { id: 'kurume_kasuri', name: { ja: '久留米絣', zh: '久留米绞织' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [10, 24], gsmRange: [120, 220], epiRange: [40, 80],
    desc: { ja: '福岡県久留米の括り染め綿織物', zh: '福冈县久留米扎染棉织物' } },
  { id: 'imabari_towel', name: { ja: '今治タオル', zh: '今治毛巾' },
    fibers: ['cotton'], weaves: ['terry'], neRange: [8, 20], gsmRange: [250, 600], epiRange: [40, 80],
    desc: { ja: '愛媛県今治市のタオル。5秒ルール認定品質', zh: '爱媛县今治市的毛巾，5秒规则认证品质' } },

  // ═══════ 世界の産地名称 ═══════
  { id: 'harris_tweed', name: { ja: 'ハリスツイード', zh: '哈里斯花呢' },
    fibers: ['wool'], weaves: ['twill_2_2','herringbone','plain'], neRange: [4, 14], gsmRange: [300, 500], epiRange: [30, 70],
    desc: { ja: 'スコットランド・ハリス島産の手織りツイード', zh: '苏格兰哈里斯岛手织花呢' } },
  { id: 'donegal_tweed', name: { ja: 'ドネガルツイード', zh: '多尼戈尔花呢' },
    fibers: ['wool'], weaves: ['twill_2_2','plain'], neRange: [4, 14], gsmRange: [280, 450], epiRange: [30, 70],
    desc: { ja: 'アイルランド・ドネガル産。ネップ入りツイード', zh: '爱尔兰多尼戈尔产，有竹节花呢' } },
  { id: 'liberty_tana_lawn', name: { ja: 'リバティ（タナローン）', zh: '自由印花棉' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [60, 120], gsmRange: [50, 100], epiRange: [80, 160],
    desc: { ja: '英国リバティ社の極薄高密度プリント綿', zh: '英国Liberty公司极薄高密度印花棉' } },
  { id: 'italian_super', name: { ja: 'イタリアンSuper生地', zh: '意大利Super面料' },
    fibers: ['wool'], weaves: ['twill_2_2','plain'], neRange: [40, 120], gsmRange: [180, 300], epiRange: [70, 150],
    desc: { ja: 'Super100s以上の極細ウール。イタリア産高級スーツ', zh: 'Super100s以上极细毛料，意大利产高级西装' } },
  { id: 'irish_linen', name: { ja: 'アイリッシュリネン', zh: '爱尔兰亚麻' },
    fibers: ['linen'], weaves: ['plain'], neRange: [20, 60], gsmRange: [100, 250], epiRange: [50, 120],
    desc: { ja: 'アイルランド産の上質リネン。伝統と品質', zh: '爱尔兰产优质亚麻，传统与品质' } },
  { id: 'french_linen', name: { ja: 'フレンチリネン', zh: '法国亚麻' },
    fibers: ['linen'], weaves: ['plain'], neRange: [16, 50], gsmRange: [100, 250], epiRange: [40, 100],
    desc: { ja: 'フランス・ノルマンディー産リネン', zh: '法国诺曼底产亚麻' } },
  { id: 'como_silk', name: { ja: 'コモシルク', zh: '科莫丝绸' },
    fibers: ['silk'], weaves: ['plain','twill_2_2','satin_5'], neRange: [40, 150], gsmRange: [40, 180], epiRange: [80, 200],
    desc: { ja: 'イタリア・コモ産の高級シルク。ネクタイやスカーフ', zh: '意大利科莫产高级丝绸，领带和丝巾' } },

  // ═══════ コーティング・防水系 ═══════
  { id: 'waxed_cotton', name: { ja: 'ワックスコットン', zh: '蜡棉' },
    fibers: ['cotton'], weaves: ['plain','twill_2_1'], neRange: [8, 24], gsmRange: [200, 400], epiRange: [50, 90],
    desc: { ja: 'ワックスコーティングの防水綿。バブアー等', zh: '蜡涂层防水棉，Barbour等' } },
  { id: 'ventile', name: { ja: 'ベンタイル', zh: 'Ventile面料' },
    fibers: ['cotton'], weaves: ['plain'], neRange: [40, 60], gsmRange: [180, 300], epiRange: [100, 160],
    desc: { ja: '超高密度綿布。水を通さないほど密', zh: '超高密度棉布，密到不透水' } },

  // ═══════ その他特殊 ═══════
  { id: 'ticking', name: { ja: 'ティッキング（マットレス地）', zh: '条纹被褥布' },
    fibers: ['cotton'], weaves: ['twill_2_1','plain'], neRange: [10, 24], gsmRange: [180, 320], epiRange: [60, 100],
    desc: { ja: '高密度のストライプ生地。マットレスや枕に', zh: '高密度条纹面料，用于床垫和枕头' } },
  { id: 'interlock', name: { ja: 'インターロック（ダブルジャージ風）', zh: '双面针织风' },
    fibers: ['cotton','polyester'], weaves: ['plain','double_cloth'], neRange: [20, 50], gsmRange: [180, 350], epiRange: [60, 120],
    desc: { ja: '二重構造の安定した中厚地', zh: '双层结构稳定中厚面料' } },
  { id: 'grosgrain', name: { ja: 'グログラン', zh: '罗缎' },
    fibers: ['silk','polyester','cotton'], weaves: ['plain'], neRange: [20, 60], gsmRange: [120, 300], epiRange: [80, 160],
    desc: { ja: '太い横畝のある密な平織。リボンやドレスに', zh: '有粗横棱的密平纹，用于缎带和礼服' } },
  { id: 'faille', name: { ja: 'ファイユ', zh: '罗缎' },
    fibers: ['silk','polyester'], weaves: ['plain'], neRange: [30, 80], gsmRange: [100, 220], epiRange: [80, 160],
    desc: { ja: 'やや太い横畝の平織。ドレスやスカートに', zh: '略粗横棱的平纹，用于礼服和裙子' } },
  { id: 'ottoman_fabric', name: { ja: 'オットマン', zh: '奥斯曼织物' },
    fibers: ['cotton','polyester','silk'], weaves: ['plain'], neRange: [10, 40], gsmRange: [200, 400], epiRange: [60, 120],
    desc: { ja: '太い横畝のある厚地平織。コートやスーツに', zh: '有粗横棱的厚平纹，用于大衣和西装' } },
  { id: 'bengaline', name: { ja: 'ベンガリン', zh: '孟加拉绸' },
    fibers: ['silk','polyester','cotton'], weaves: ['plain'], neRange: [20, 60], gsmRange: [120, 260], epiRange: [70, 140],
    desc: { ja: '横畝のある平織。グログランより柔らかい', zh: '有横棱的平纹，比罗缎柔软' } },
  { id: 'rep_fabric', name: { ja: 'レップ', zh: '棱纹织物' },
    fibers: ['cotton','silk','polyester'], weaves: ['plain'], neRange: [20, 60], gsmRange: [120, 280], epiRange: [70, 140],
    desc: { ja: '横方向の畝がある平織。ネクタイに多用', zh: '有横向凸条的平纹，多用于领带' } },
  { id: 'brocade', name: { ja: 'ブロケード', zh: '织锦' },
    fibers: ['silk','polyester'], weaves: ['jacquard','damask'], neRange: [20, 80], gsmRange: [150, 400], epiRange: [80, 200],
    desc: { ja: '多色の浮き糸で模様を出した豪華な織物', zh: '用多色浮纬织出花纹的华丽织物' } },
  { id: 'matelasse', name: { ja: 'マトラッセ', zh: '凸花织物' },
    fibers: ['cotton','polyester','silk'], weaves: ['jacquard','double_cloth'], neRange: [16, 50], gsmRange: [200, 400], epiRange: [60, 130],
    desc: { ja: '表面にキルティング風の凹凸模様', zh: '表面有绗缝风的凹凸花纹' } },
  { id: 'cloque', name: { ja: 'クロッケ', zh: '泡泡织物' },
    fibers: ['polyester','cotton','silk'], weaves: ['jacquard','double_cloth'], neRange: [20, 60], gsmRange: [150, 300], epiRange: [60, 130],
    desc: { ja: '二重織の収縮差で表面に泡状凹凸', zh: '双层织缩率差产生表面泡状凹凸' } },

  // ═══════ サステナブル素材 ═══════
  { id: 'organic_cotton', name: { ja: 'オーガニックコットン', zh: '有机棉' },
    fibers: ['cotton'], weaves: ['plain','twill_2_2','oxford'], neRange: [16, 60], gsmRange: [80, 250], epiRange: [50, 130],
    desc: { ja: '有機栽培綿。農薬不使用で環境配慮', zh: '有机种植棉，不使用农药环保' } },
  { id: 'recycled_poly', name: { ja: 'リサイクルポリエステル', zh: '再生涤纶' },
    fibers: ['polyester'], weaves: ['plain','twill_2_2'], neRange: [20, 80], gsmRange: [80, 250], epiRange: [50, 130],
    desc: { ja: 'ペットボトル等からの再生ポリエステル', zh: 'PET瓶等再生涤纶' } },
  { id: 'recycled_cotton', name: { ja: 'リサイクルコットン', zh: '再生棉' },
    fibers: ['cotton','polyester'], weaves: ['plain','twill_2_1'], neRange: [6, 20], gsmRange: [120, 280], epiRange: [40, 80],
    desc: { ja: '端切れ等を反毛した再生綿。環境配慮素材', zh: '用碎布回收的再生棉，环保材料' }, isBlend: true },
  { id: 'bamboo_fabric', name: { ja: 'バンブーレーヨン', zh: '竹纤维' },
    fibers: ['viscose'], weaves: ['plain','twill_2_1'], neRange: [20, 50], gsmRange: [80, 200], epiRange: [50, 110],
    desc: { ja: '竹を原料とした再生繊維。抗菌性あり', zh: '以竹为原料的再生纤维，有抗菌性' } },

  // ═══════ ネル・起毛系 追加 ═══════
  { id: 'nel_tcr', name: { ja: 'ネル（T/C/Rリサイクル糸）', zh: '法兰绒(T/C/R再生纱)' },
    fibers: ['polyester','cotton','viscose'], weaves: ['twill_2_1','twill_2_2','plain'], neRange: [6, 24], gsmRange: [140, 320], epiRange: [50, 110],
    desc: { ja: 'T/C/R混のリサイクル糸で織ったネル生地。コスト重視', zh: 'T/C/R混纺再生纱织的法兰绒，注重成本' }, isBlend: true },
  { id: 'brushed_twill', name: { ja: '起毛ツイル', zh: '磨毛斜纹' },
    fibers: ['cotton','polyester'], weaves: ['twill_2_1','twill_2_2'], neRange: [10, 30], gsmRange: [160, 300], epiRange: [60, 110],
    desc: { ja: '綾織を起毛仕上げ。暖かみのある秋冬素材', zh: '斜纹起毛整理，温暖的秋冬面料' } },
  { id: 'melange_fabric', name: { ja: 'メランジ（杢調）', zh: '混色纱织物' },
    fibers: ['cotton','polyester','wool'], weaves: ['plain','twill_2_2'], neRange: [10, 40], gsmRange: [120, 280], epiRange: [50, 110],
    desc: { ja: '異色の繊維を混ぜた杢調の表情', zh: '混合不同颜色纤维的混色效果' } },

  // ═══════ インテリア・産業用 ═══════
  { id: 'drapery_fabric', name: { ja: 'ドレープカーテン地', zh: '窗帘布' },
    fibers: ['polyester','cotton'], weaves: ['plain','twill_2_2','jacquard'], neRange: [16, 50], gsmRange: [150, 400], epiRange: [60, 140],
    desc: { ja: 'カーテン用の遮光・防炎生地', zh: '窗帘用遮光防火面料' } },
  { id: 'upholstery', name: { ja: '椅子張り地', zh: '家具面料' },
    fibers: ['polyester','cotton','viscose'], weaves: ['plain','twill_2_2','jacquard'], neRange: [8, 30], gsmRange: [250, 600], epiRange: [40, 100],
    desc: { ja: '家具の張り地。耐摩耗性重視', zh: '家具面料，注重耐磨性' } },
  { id: 'lining_general', name: { ja: '裏地（一般）', zh: '里布（通用）' },
    fibers: ['polyester','cupro','acetate'], weaves: ['plain','twill_2_1','sateen'], neRange: [30, 100], gsmRange: [40, 120], epiRange: [60, 160],
    desc: { ja: 'ジャケットやスカートの裏地全般', zh: '夹克和裙子的通用里布' } },
  { id: 'interlining', name: { ja: '芯地（インターライニング）', zh: '衬布' },
    fibers: ['polyester','cotton'], weaves: ['plain'], neRange: [20, 50], gsmRange: [30, 100], epiRange: [30, 80],
    desc: { ja: '接着芯や増芯。衣服の形状保持', zh: '粘合衬或增强衬，保持服装形状' } },
];

// ============================================================
// 生地名判定エンジン identifyFabric()
// 条件マッチングでスコアを算出し、候補を信頼度付きで返す
// ============================================================
function identifyFabric(config) {
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const weave = getWeave(config.weaveId);
  const gsmData = calcGSM(config);
  if (!warpYarn || !weftYarn || !weave || !gsmData) return { results: [], determined: false };

  const gsm = gsmData.gsm;
  const avgNe = (warpYarn.ne + weftYarn.ne) / 2;
  const avgEpi = (config.epi + config.ppi) / 2;

  // 使用繊維一覧を取得
  const fiberSet = new Set();
  [...warpYarn.comp, ...weftYarn.comp].forEach(c => fiberSet.add(c.f));
  const fibers = [...fiberSet];
  // 主繊維(最大比率)
  const fiberMap = {};
  [...warpYarn.comp, ...weftYarn.comp].forEach(c => {
    fiberMap[c.f] = (fiberMap[c.f] || 0) + c.p;
  });
  const mainFiber = Object.entries(fiberMap).sort((a,b) => b[1] - a[1])[0]?.[0];
  // ブレンドかどうか
  const isBlend = Object.keys(fiberMap).length > 1;

  const candidates = [];

  for (const fabric of FABRIC_NAME_DB) {
    let score = 0;
    let maxScore = 0;
    const matchDetail = [];

    // --- 1. 繊維マッチ (最大30点) ---
    // 経糸と緯糸の繊維を別々に評価し、fabric.fibers との適合度を計算
    maxScore += 30;
    // 経糸の繊維セット（比率付き）
    const warpFibers = warpYarn.comp.map(c => c.f);
    const weftFibers = weftYarn.comp.map(c => c.f);
    // 経糸の繊維がfabricにマッチする割合（比率加重）
    const warpMatchPct = warpYarn.comp.reduce((s, c) => s + (fabric.fibers.includes(c.f) ? c.p : 0), 0) / 100;
    // 緯糸の繊維がfabricにマッチする割合（比率加重）
    const weftMatchPct = weftYarn.comp.reduce((s, c) => s + (fabric.fibers.includes(c.f) ? c.p : 0), 0) / 100;
    // 経緯の平均マッチ率
    const avgFiberMatch = (warpMatchPct + weftMatchPct) / 2;
    // fabricの全fibers要素が使用繊維に存在するか（カバー率）
    const fabricFiberCoverage = fabric.fibers.filter(f => fibers.includes(f)).length / fabric.fibers.length;
    // 総合繊維スコア = 平均マッチ率 × 0.6 + カバー率 × 0.4
    const fiberScore = Math.round(30 * (avgFiberMatch * 0.6 + fabricFiberCoverage * 0.4));
    score += fiberScore;
    if (fiberScore >= 25) matchDetail.push('fiber:strong');
    else if (fiberScore >= 15) matchDetail.push('fiber:partial');
    else if (fiberScore > 0) matchDetail.push('fiber:weak');
    // ブレンド指定のチェック
    if (fabric.isBlend && !isBlend) score -= 10;
    if (!fabric.isBlend && isBlend && fabric.fibers.length === 1) {
      // 単一繊維のfabricに混紡糸を使用 → ペナルティ（ただし繊維が1つでも合ってれば軽減）
      const anyMatch = fabric.fibers.some(f => fibers.includes(f));
      score -= anyMatch ? 3 : 8;
    }

    // --- 2. 織り組織マッチ (最大30点) ---
    maxScore += 30;
    if (fabric.weaves.includes(config.weaveId)) {
      score += 30;
      matchDetail.push('weave:exact');
    } else {
      // 同カテゴリの織りかチェック
      const fabricWeaveCats = fabric.weaves.map(wid => getWeave(wid)?.cat).filter(Boolean);
      if (fabricWeaveCats.includes(weave.cat)) {
        score += 15;
        matchDetail.push('weave:cat');
      }
    }

    // --- 3. 番手マッチ (最大20点) ---
    maxScore += 20;
    if (avgNe >= fabric.neRange[0] && avgNe <= fabric.neRange[1]) {
      score += 20;
      matchDetail.push('ne:in');
    } else {
      // 範囲外でも近い場合に部分点
      const neCenter = (fabric.neRange[0] + fabric.neRange[1]) / 2;
      const neSpan = fabric.neRange[1] - fabric.neRange[0];
      const neDist = Math.abs(avgNe - neCenter) / (neSpan / 2);
      if (neDist < 2) {
        score += Math.round(20 * Math.max(0, 1 - neDist * 0.5));
        matchDetail.push('ne:near');
      }
    }

    // --- 4. GSMマッチ (最大15点) ---
    maxScore += 15;
    if (gsm >= fabric.gsmRange[0] && gsm <= fabric.gsmRange[1]) {
      score += 15;
      matchDetail.push('gsm:in');
    } else {
      const gsmCenter = (fabric.gsmRange[0] + fabric.gsmRange[1]) / 2;
      const gsmSpan = fabric.gsmRange[1] - fabric.gsmRange[0];
      const gsmDist = Math.abs(gsm - gsmCenter) / (gsmSpan / 2);
      if (gsmDist < 2) {
        score += Math.round(15 * Math.max(0, 1 - gsmDist * 0.5));
        matchDetail.push('gsm:near');
      }
    }

    // --- 5. 密度マッチ (最大5点) ---
    maxScore += 5;
    if (config.epi >= fabric.epiRange[0] && config.epi <= fabric.epiRange[1]) {
      score += 5;
      matchDetail.push('epi:in');
    }

      // --- 6. 撚り（twist）マッチ (最大10点) ---
      // fabric 側は撚り条件を持つことがある（例: ['warp_high','weft_high'] など）
      // ここでは経糸・緯糸の撚りを評価して合計で最大10点を与えます。
      maxScore += 10;
      try {
        const warpTw = warpYarn.twist || 'normal';
        const weftTw = weftYarn.twist || 'normal';
        // 布定義が単一文字列または配列で撚り条件を持つ場合にマッチ判定
        if (fabric.twist) {
          // 期待値が配列で渡される場合
          const expected = Array.isArray(fabric.twist) ? fabric.twist : [fabric.twist];
          // warp/ weft 個別条件をサポート: 例 'warp:high' or 'weft:high'
          let twistScore = 0;
          expected.forEach(e => {
            if (e.startsWith('warp:')) {
              if (warpTw === e.split(':')[1]) twistScore += 5;
              else if (warpTw === 'high' && e.split(':')[1] === 'crepe') twistScore += 3;
            } else if (e.startsWith('weft:')) {
              if (weftTw === e.split(':')[1]) twistScore += 5;
              else if (weftTw === 'high' && e.split(':')[1] === 'crepe') twistScore += 3;
            } else {
              // 汎用指定: どちらかが合えば部分点
              if (warpTw === e || weftTw === e) twistScore += 5;
              if (warpTw === e && weftTw === e) twistScore += 10;
            }
          });
          score += Math.min(10, twistScore);
          if (twistScore > 0) matchDetail.push('twist:match');
        }
      } catch (e) {
        // ignore
      }

    // スコアを正規化 (0-100%)
    const confidence = Math.round((score / maxScore) * 100);

    if (confidence >= 30) {
      candidates.push({
        id: fabric.id,
        name: fabric.name,
        desc: fabric.desc,
        confidence,
        matchDetail,
        score,
        maxScore
      });
    }
  }

  // 信頼度順にソート
  candidates.sort((a, b) => b.confidence - a.confidence);

  // 判定結果の分類
  const top = candidates[0];
  let determined = false;
  let certainty = 'unknown'; // 'definite' | 'likely' | 'uncertain' | 'unknown'

  if (top) {
    if (top.confidence >= 85) {
      certainty = 'definite';
      determined = true;
    } else if (top.confidence >= 65) {
      // 2位との差が大きければ確定寄り
      const second = candidates[1];
      if (!second || top.confidence - second.confidence >= 15) {
        certainty = 'likely';
        determined = true;
      } else {
        certainty = 'uncertain';
      }
    } else {
      certainty = 'uncertain';
    }
  }

  return {
    results: candidates.slice(0, 5),
    determined,
    certainty,
    topName: top ? top.name : null,
    topConfidence: top ? top.confidence : 0
  };
}

// ============================================================
// 多言語対応テキスト
// ============================================================
const LANG = {
  ja: {
    title: '先染めシミュレーター V3',
    subtitle: '物理計算ベースのリアルタイムプレビュー',
    tabs: { design: 'デザイン', weave: '織り組織', yarn: '糸選択', specs: '規格', tools: 'ツール' },
    pattern: 'パターン',
    patterns: { check: 'チェック', stripe: 'ストライプ', solid: '無地' },
    checkPreset: 'チェック柄プリセット',
    checkPresetHint: 'カテゴリを選んでプリセットを適用できます',
    applyPreset: '適用',
    selectCheckCat: 'カテゴリを選択',
    allCheckCats: 'すべて',
    warpColor: '経糸の色',
    weftColor: '緯糸の色',
    pitch: '柄ピッチ',
    zoom: 'ズーム',
    weaveCategory: '織りカテゴリ',
    selectWeave: '織り組織を選択',
    yarnCategory: '素材カテゴリ',
    warpYarn: '経糸',
    weftYarn: '緯糸',
    epi: '経糸密度 (EPI)',
    ppi: '緯糸密度 (PPI)',
    gsm: '目付',
    fabricSummary: '生地構成サマリー',
    weaveType: '織り組織',
    difficulty: '難易度',
    savePng: 'PNG保存',
    riskAnalysis: 'リスク分析',
    risks: '件のリスク',
    sellingPoints: '訴求ポイント',
    preview: 'プレビュー',
    quickColors: 'クイックカラー',
    noRisk: 'リスクなし',
    specSheet: '仕様書出力',
    compare: '比較モード',
    glossary: '用語辞典',
    pantone: 'Pantone変換',
    season: '季節判定',
    similar: '類似生地',
    trend: 'トレンドカラー',
    random: 'ランダム生成',
    springSum: '春夏向き',
    autumnWin: '秋冬向き',
    allSeason: 'オールシーズン',
    yarnDiameter: '糸直径',
  yarnTwist: '撚り',
    coverFactor: 'カバーファクター',
    maxDensity: '限界密度',
    thickness: '生地厚み',
    warning: '警告',
    densityWarning: '密度が限界を超えています',
    cfWarning: 'カバーファクターが高すぎます',
    recommended: '推奨範囲',
    physicsInfo: '物理計算情報',
    characteristics: {
      durability: '耐久', drape: 'ドレープ', breathability: '通気',
      wrinkleResistance: '防シワ', shine: '光沢', strength: '強度',
      softness: '柔らかさ', luster: '光沢', elasticity: '弾力', absorbency: '吸湿'
    },
    weaveCategories: {
      plain: '平織系', twill: '綾織系', satin: '朱子織系',
      dobby: 'ドビー', jacquard: 'ジャカード', pile: 'パイル', special: '特殊織'
    },
    fiberCategories: {
      cotton: '綿', linen: '麻', wool: '羊毛', silk: '絹',
      synthetic: '合成', regenerated: '再生', blend: '混紡', specialty: '特殊'
    },
    fibers: {
      cotton: '綿', polyester: 'ポリエステル', wool: 'ウール', linen: '麻',
      silk: 'シルク', nylon: 'ナイロン', viscose: 'レーヨン', spandex: 'スパンデックス',
      modal: 'モダール', lyocell: 'テンセル', cashmere: 'カシミヤ', acrylic: 'アクリル'
    },
    twistValues: { normal: '通常', high: '強撚', low: '甘撚', zero: '無撚', crepe: 'クレープ撚り' },
    riskLevels: { none: 'なし', low: '低', medium: '中', high: '高', critical: '要注意' },
    riskTypes: {
      density: '密度超過',
      coverFactor: 'CF過大',
      yarnBreak: '糸切れ',
      weaving: '織り難度',
      shrinkage: '収縮',
      pilling: 'ピリング',
      abrasion: '摩耗'
    },
    weightCat: { ultraLight: '極薄地', light: '薄地', mediumLight: '中薄地', medium: '中厚地', heavy: '厚地', ultraHeavy: '極厚地' },
    close: '閉じる', download: 'ダウンロード', print: '印刷',
    fabricA: '生地A', fabricB: '生地B', current: '現在の設定',
    nearestPantone: '近似Pantone',
    // 原価計算
    costCalc: '原価計算',
    yarnCostPerKg: '糸単価 ($/kg)',
    weavingCost: '織り工賃 ($/m)',
    dyeingCost: '染色費 ($/m)',
    finishingCost: '加工費 ($/m)',
    fabricWidth: '生地巾 (cm)',
    orderLength: '発注数量 (m)',
    yarnUsage: '糸使用量',
    warpYarnUsage: '経糸使用量',
    weftYarnUsage: '緯糸使用量',
    totalYarnCost: '糸代合計',
    totalCostPerM: '生地m単価',
    totalCostPerYard: '生地yd単価',
    costBreakdown: 'コスト内訳',
    margin: '粗利率 (%)',
    sellingPrice: '販売単価',
    // 素材ライブラリ
    library: '素材ライブラリ',
    saveFabric: '現在の設定を保存',
    fabricName: '素材名',
    savedFabrics: '保存済み素材',
    loadFabric: '読込',
    deleteFabric: '削除',
    noSaved: '保存された素材はありません',
    saveSuccess: '保存しました',
    confirmDelete: '削除しますか？',
    // 組織エディタ
    weaveEditor: '組織エディタ',
    editorSize: 'リピートサイズ',
    editorClear: 'クリア',
    editorInvert: '反転',
    editorApply: '適用',
    editorFill: '塗りつぶし',
    customWeave: 'カスタム組織',
    // 発注シート
    orderSheet: '発注シート',
    orderSheetTitle: '工場向け発注シート',
    warpBeamLength: '経糸整経長 (m)',
    warpEnds: '経糸総本数',
    weftLength: '緯糸所要量 (m)',
    loomWidth: '織機巾 (cm)',
    loomSpeed: '織機回転数 (rpm)',
    estimatedTime: '予想織り時間',
    warpTension: '経糸テンション',
    reedCount: '筬密度',
    drawingIn: '通し方',
    productionNotes: '生産注意事項',
    // エクスポート
    exportMenu: 'エクスポート',
    exportCSV: 'CSV仕様書',
    exportPDF: 'PDF仕様書',
    exportHiRes: '高解像度画像',
    exportCSVDesc: '仕様データをCSV形式でダウンロード',
    exportPDFDesc: '仕様書をPDF形式で保存',
    exportHiResDesc: 'A4印刷品質(300dpi)のPNG画像',
    exporting: '出力中...',
    exportDone: '完了！',
    // 生地名判定
    fabricIdentify: '生地名判定',
    fabricName_definite: '✅ 確定',
    fabricName_likely: '🔵 ほぼ確定',
    fabricName_uncertain: '⚠️ 不確定（複数候補あり）',
    fabricName_unknown: '❓ 判定不能',
    fabricName_confidence: '一致度',
    fabricName_candidates: '候補生地名',
    fabricName_note_uncertain: '※ 条件の組み合わせが複数の生地名に該当します。最終判断は実物の風合い・仕上げによります。',
    fabricName_note_definite: '条件から高い確度で判定できました。',
    // スワッチ保存
    swatchBook: 'スワッチ帳',
    swatchAdd: '新規スワッチ登録',
    swatchName: '生地名',
    swatchWarpNe: '経糸番手 (Ne)',
    swatchWeftNe: '緯糸番手 (Ne)',
    swatchWarpComp: '経糸混率',
    swatchWeftComp: '緯糸混率',
    swatchEpi: '経密度 (EPI)',
    swatchPpi: '緯密度 (PPI)',
    swatchMemo: 'メモ（原産地・加工等）',
    swatchPhoto: '生地写真',
    swatchSave: '保存',
    swatchDelete: '削除',
    swatchApply: '設定に反映',
    swatchNoItems: 'スワッチが登録されていません',
    swatchSaved: '保存しました',
    swatchDeleted: '削除しました',
    swatchPhotoHint: '写真をタップまたはドラッグ＆ドロップ',
    swatchClose: '閉じる',
  yarnTwist: '撚り',
  },
  zh: {
    title: '色织模拟器 V3',
    subtitle: '基于物理计算的实时预览',
    tabs: { design: '设计', weave: '组织', yarn: '纱线', specs: '规格', tools: '工具' },
    pattern: '图案',
    patterns: { check: '格子', stripe: '条纹', solid: '素色' },
    checkPreset: '格纹预设',
    checkPresetHint: '选择类别后选择预设应用',
    applyPreset: '应用',
    selectCheckCat: '选择类别',
    allCheckCats: '全部',
    warpColor: '经纱颜色',
    weftColor: '纬纱颜色',
    pitch: '花纹间距',
    zoom: '缩放',
    weaveCategory: '织物类别',
    selectWeave: '选择织物组织',
    yarnCategory: '材质类别',
    warpYarn: '经纱',
    weftYarn: '纬纱',
    epi: '经密 (EPI)',
    ppi: '纬密 (PPI)',
    gsm: '克重',
    fabricSummary: '面料构成摘要',
    weaveType: '织物组织',
    difficulty: '难度',
    savePng: '保存PNG',
    riskAnalysis: '风险分析',
    risks: '项风险',
    sellingPoints: '卖点',
    preview: '预览',
    quickColors: '快速选色',
    noRisk: '无风险',
    specSheet: '规格书输出',
    compare: '对比模式',
    glossary: '术语词典',
    pantone: 'Pantone转换',
    season: '季节判定',
    similar: '类似面料',
    trend: '趋势色',
    random: '随机生成',
    springSum: '春夏适用',
    autumnWin: '秋冬适用',
    allSeason: '四季适用',
    yarnDiameter: '纱线直径',
    coverFactor: '紧度',
    maxDensity: '极限密度',
    thickness: '面料厚度',
    warning: '警告',
    densityWarning: '密度超过极限',
    cfWarning: '紧度过高',
    recommended: '推荐范围',
    physicsInfo: '物理计算信息',
    characteristics: {
      durability: '耐久', drape: '垂感', breathability: '透气',
      wrinkleResistance: '抗皱', shine: '光泽', strength: '强度',
      softness: '柔软', luster: '光泽', elasticity: '弹性', absorbency: '吸湿'
    },
    weaveCategories: {
      plain: '平纹', twill: '斜纹', satin: '缎纹',
      dobby: '多臂', jacquard: '提花', pile: '毛圈', special: '特殊'
    },
    fiberCategories: {
      cotton: '棉', linen: '麻', wool: '毛', silk: '丝',
      synthetic: '合纤', regenerated: '再生', blend: '混纺', specialty: '特种'
    },
    fibers: {
      cotton: '棉', polyester: '涤纶', wool: '羊毛', linen: '麻',
      silk: '丝绸', nylon: '尼龙', viscose: '粘胶', spandex: '氨纶',
      modal: '莫代尔', lyocell: '天丝', cashmere: '羊绒', acrylic: '腈纶'
    },
    riskLevels: { none: '无', low: '低', medium: '中', high: '高', critical: '需注意' },
    riskTypes: {
      density: '密度超限',
      coverFactor: '紧度过高',
      yarnBreak: '断线',
      weaving: '织造难度',
      shrinkage: '收缩',
      pilling: '起球',
      abrasion: '磨损'
    },
    weightCat: { ultraLight: '极薄', light: '薄型', mediumLight: '中薄', medium: '中厚', heavy: '厚型', ultraHeavy: '极厚' },
    close: '关闭', download: '下载', print: '打印',
    fabricA: '面料A', fabricB: '面料B', current: '当前设置',
    nearestPantone: '近似Pantone',
    // 原价计算
    costCalc: '成本计算',
    yarnCostPerKg: '纱线单价 ($/kg)',
    weavingCost: '织造费 ($/m)',
    dyeingCost: '染色费 ($/m)',
    finishingCost: '加工费 ($/m)',
    fabricWidth: '门幅 (cm)',
    orderLength: '订单数量 (m)',
    yarnUsage: '纱线用量',
    warpYarnUsage: '经纱用量',
    weftYarnUsage: '纬纱用量',
    totalYarnCost: '纱线费合计',
    totalCostPerM: '每米成本',
    totalCostPerYard: '每码成本',
    costBreakdown: '成本明细',
    margin: '毛利率 (%)',
    sellingPrice: '销售单价',
    // 面料库
    library: '面料库',
    saveFabric: '保存当前设置',
    fabricName: '面料名称',
    savedFabrics: '已保存面料',
    loadFabric: '加载',
    deleteFabric: '删除',
    noSaved: '没有已保存的面料',
    saveSuccess: '已保存',
    confirmDelete: '确认删除？',
    // 组织编辑器
    weaveEditor: '组织编辑器',
    editorSize: '循环尺寸',
    editorClear: '清除',
    editorInvert: '反转',
    editorApply: '应用',
    editorFill: '填充',
    customWeave: '自定义组织',
    // 订单表
    orderSheet: '订单表',
    orderSheetTitle: '工厂订单表',
    warpBeamLength: '整经长度 (m)',
    warpEnds: '经纱总根数',
    weftLength: '纬纱需求量 (m)',
    loomWidth: '织机门幅 (cm)',
    loomSpeed: '织机转速 (rpm)',
    estimatedTime: '预估织造时间',
    warpTension: '经纱张力',
    reedCount: '筘密度',
    drawingIn: '穿综方式',
    productionNotes: '生产注意事项',
    // 导出
    exportMenu: '导出',
    exportCSV: 'CSV规格书',
    exportPDF: 'PDF规格书',
    exportHiRes: '高清图片',
    exportCSVDesc: '将规格数据以CSV格式下载',
    exportPDFDesc: '将规格书保存为PDF',
    exportHiResDesc: 'A4打印质量(300dpi)的PNG图片',
    exporting: '导出中...',
    exportDone: '完成！',
    // 面料名称识别
    fabricIdentify: '面料名称识别',
    fabricName_definite: '✅ 确定',
    fabricName_likely: '🔵 基本确定',
    fabricName_uncertain: '⚠️ 不确定（多个候选）',
    fabricName_unknown: '❓ 无法识别',
    fabricName_confidence: '匹配度',
    fabricName_candidates: '候选面料名称',
    fabricName_note_uncertain: '※ 条件组合对应多种面料名称。最终判断需根据实物手感和后整理确定。',
    fabricName_note_definite: '根据条件可高确度识别。',
    // 色样保存
    swatchBook: '色样本',
    swatchAdd: '新建色样',
    swatchName: '面料名称',
    swatchWarpNe: '经纱支数 (Ne)',
    swatchWeftNe: '纬纱支数 (Ne)',
    swatchWarpComp: '经纱混率',
    swatchWeftComp: '纬纱混率',
    swatchEpi: '经密度 (EPI)',
    swatchPpi: '纬密度 (PPI)',
    swatchMemo: '备注（产地・加工等）',
    swatchPhoto: '面料照片',
    swatchSave: '保存',
    swatchDelete: '删除',
    swatchApply: '应用到设置',
    swatchNoItems: '尚未登录色样',
    swatchSaved: '已保存',
    swatchDeleted: '已删除',
    swatchPhotoHint: '点击或拖放照片',
    swatchClose: '关闭',
  yarnTwist: '捻度',
  twistValues: { normal: '常规', high: '强捻', low: '弱捻', zero: '无捻', crepe: '皱绉捻' },
  }
};

// ============================================================
// 織り組織データベース
// ============================================================
function createMatrix(rows, cols, fn) {
  const m = [];
  for (let y = 0; y < rows; y++) {
    const r = [];
    for (let x = 0; x < cols; x++) r.push(fn(x, y));
    m.push(r);
  }
  return m;
}

const WEAVE_DB = [
  { id: 'plain', name: { ja: '平織', zh: '平纹' }, cat: 'plain', matrix: createMatrix(2, 2, (x, y) => (x+y)%2===0), rx: 2, ry: 2, chars: { durability: 5, drape: 2, breathability: 5, wrinkleResistance: 2, shine: 1 }, gsmMult: 1.0, crimp: 1.08, diff: 1, apps: { ja: ['シャツ', 'ハンカチ'], zh: ['衬衫', '手帕'] } },
  { id: 'oxford', name: { ja: 'オックスフォード', zh: '牛津布' }, cat: 'plain', matrix: createMatrix(4, 4, (x, y) => { const px=Math.floor(x/2), py=Math.floor(y/2); return (px+py)%2===0; }), rx: 4, ry: 4, chars: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 2 }, gsmMult: 1.15, crimp: 1.10, diff: 2, apps: { ja: ['カジュアルシャツ'], zh: ['休闲衬衫'] } },
  { id: 'broadcloth', name: { ja: 'ブロード', zh: '府绸' }, cat: 'plain', matrix: createMatrix(2, 2, (x, y) => (x+y)%2===0), rx: 2, ry: 2, chars: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 3 }, gsmMult: 0.95, crimp: 1.06, diff: 2, apps: { ja: ['ドレスシャツ'], zh: ['正装衬衫'] } },
  { id: 'canvas', name: { ja: '帆布', zh: '帆布' }, cat: 'plain', matrix: createMatrix(2, 2, (x, y) => (x+y)%2===0), rx: 2, ry: 2, chars: { durability: 5, drape: 1, breathability: 3, wrinkleResistance: 4, shine: 1 }, gsmMult: 2.0, crimp: 1.05, diff: 2, apps: { ja: ['バッグ', 'テント'], zh: ['包', '帐篷'] } },
  { id: 'twill_2_1', name: { ja: '2/1ツイル', zh: '2/1斜纹' }, cat: 'twill', matrix: createMatrix(3, 3, (x, y) => (x+y)%3<2), rx: 3, ry: 3, chars: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 3, shine: 3 }, gsmMult: 1.05, crimp: 1.07, diff: 2, apps: { ja: ['チノパン'], zh: ['卡其裤'] } },
  { id: 'twill_2_2', name: { ja: '2/2ツイル', zh: '2/2斜纹' }, cat: 'twill', matrix: createMatrix(4, 4, (x, y) => (x+y)%4<2), rx: 4, ry: 4, chars: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 4, shine: 3 }, gsmMult: 1.1, crimp: 1.08, diff: 2, apps: { ja: ['スーツ'], zh: ['西装'] } },
  { id: 'denim', name: { ja: 'デニム', zh: '牛仔布' }, cat: 'twill', matrix: createMatrix(4, 4, (x, y) => (x-y+4)%4<3), rx: 4, ry: 4, chars: { durability: 5, drape: 2, breathability: 3, wrinkleResistance: 3, shine: 2 }, gsmMult: 1.4, crimp: 1.12, diff: 2, apps: { ja: ['ジーンズ'], zh: ['牛仔裤'] } },
  { id: 'herringbone', name: { ja: 'ヘリンボーン', zh: '人字纹' }, cat: 'twill', matrix: createMatrix(8, 8, (x, y) => { const p=4, xM=x%(p*2), off=xM<p?xM:(p*2-1-xM); return ((y+off)%4)<2; }), rx: 8, ry: 8, chars: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 4, shine: 3 }, gsmMult: 1.15, crimp: 1.09, diff: 3, apps: { ja: ['ジャケット'], zh: ['夹克'] } },
  { id: 'gabardine', name: { ja: 'ギャバジン', zh: '华达呢' }, cat: 'twill', matrix: createMatrix(4, 4, (x, y) => (x+y*2)%4<2), rx: 4, ry: 4, chars: { durability: 5, drape: 3, breathability: 3, wrinkleResistance: 5, shine: 4 }, gsmMult: 1.2, crimp: 1.10, diff: 3, apps: { ja: ['コート', 'スラックス'], zh: ['外套', '西裤'] } },
  { id: 'satin_5', name: { ja: '5枚朱子', zh: '五枚缎' }, cat: 'satin', matrix: createMatrix(5, 5, (x, y) => (x+y*2)%5===0), rx: 5, ry: 5, chars: { durability: 2, drape: 5, breathability: 3, wrinkleResistance: 2, shine: 5 }, gsmMult: 1.0, crimp: 1.04, diff: 3, apps: { ja: ['ドレス', '裏地'], zh: ['礼服', '里布'] } },
  { id: 'sateen', name: { ja: 'サテン', zh: '贡缎' }, cat: 'satin', matrix: createMatrix(5, 5, (x, y) => (y+x*2)%5===0), rx: 5, ry: 5, chars: { durability: 3, drape: 5, breathability: 3, wrinkleResistance: 2, shine: 4 }, gsmMult: 1.0, crimp: 1.05, diff: 3, apps: { ja: ['シーツ'], zh: ['床单'] } },
  { id: 'pique', name: { ja: 'ピケ', zh: '珠地布' }, cat: 'dobby', matrix: createMatrix(4, 4, (x, y) => y%2===0), rx: 4, ry: 4, chars: { durability: 4, drape: 2, breathability: 5, wrinkleResistance: 4, shine: 2 }, gsmMult: 1.15, crimp: 1.08, diff: 3, apps: { ja: ['ポロシャツ'], zh: ['Polo衫'] } },
  { id: 'houndstooth', name: { ja: '千鳥格子', zh: '千鸟格' }, cat: 'dobby', matrix: createMatrix(8, 8, (x, y) => { const b=4, bx=Math.floor(x/b), by=Math.floor(y/b), lx=x%b, ly=y%b; return (bx+by)%2===0?(lx<2||ly<2):(lx>=2&&ly>=2); }), rx: 8, ry: 8, chars: { durability: 4, drape: 3, breathability: 3, wrinkleResistance: 4, shine: 2 }, gsmMult: 1.1, crimp: 1.08, diff: 4, apps: { ja: ['ジャケット'], zh: ['夹克'] } },
  { id: 'waffle', name: { ja: 'ワッフル', zh: '华夫格' }, cat: 'dobby', matrix: createMatrix(8, 8, (x, y) => { const z=(Math.floor(x/4)+Math.floor(y/4))%2; return z===0?(x%4<2)===(y%4<2):(x%4>=2)===(y%4>=2); }), rx: 8, ry: 8, chars: { durability: 3, drape: 3, breathability: 5, wrinkleResistance: 2, shine: 1 }, gsmMult: 1.3, crimp: 1.15, diff: 4, apps: { ja: ['タオル', 'カットソー'], zh: ['毛巾', '针织衫'] } },
  { id: 'damask', name: { ja: 'ダマスク', zh: '锦缎' }, cat: 'jacquard', matrix: createMatrix(16, 16, (x, y) => { const cx=Math.abs(x-7.5), cy=Math.abs(y-7.5); return (cx+cy)<6||(x%4===0&&y%4===0); }), rx: 16, ry: 16, chars: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 3, shine: 4 }, gsmMult: 1.2, crimp: 1.10, diff: 5, apps: { ja: ['テーブルクロス'], zh: ['桌布'] } },
  { id: 'velvet', name: { ja: 'ベルベット', zh: '丝绒' }, cat: 'pile', matrix: createMatrix(4, 4, (x, y) => y%2===0), rx: 4, ry: 4, chars: { durability: 3, drape: 4, breathability: 2, wrinkleResistance: 2, shine: 4 }, gsmMult: 1.8, crimp: 1.20, diff: 5, apps: { ja: ['ドレス', 'カーテン'], zh: ['礼服', '窗帘'] } },
  { id: 'corduroy', name: { ja: 'コーデュロイ', zh: '灯芯绒' }, cat: 'pile', matrix: createMatrix(8, 4, (x, y) => x%8<4&&y%2===0), rx: 8, ry: 4, chars: { durability: 4, drape: 3, breathability: 3, wrinkleResistance: 3, shine: 2 }, gsmMult: 1.6, crimp: 1.15, diff: 4, apps: { ja: ['パンツ', 'ジャケット'], zh: ['裤子', '夹克'] } },
  { id: 'terry', name: { ja: 'テリー', zh: '毛圈布' }, cat: 'pile', matrix: createMatrix(4, 4, () => true), rx: 4, ry: 4, chars: { durability: 4, drape: 2, breathability: 5, wrinkleResistance: 2, shine: 1 }, gsmMult: 2.0, crimp: 1.25, diff: 3, apps: { ja: ['タオル', 'バスローブ'], zh: ['毛巾', '浴袍'] } },
  { id: 'seersucker', name: { ja: 'シアサッカー', zh: '泡泡纱' }, cat: 'special', matrix: createMatrix(8, 4, (x, y) => { const z=Math.floor(x/4)%2; return z===0?(x+y)%2===0:y%2===0; }), rx: 8, ry: 4, chars: { durability: 4, drape: 3, breathability: 5, wrinkleResistance: 4, shine: 1 }, gsmMult: 1.0, crimp: 1.08, diff: 4, apps: { ja: ['夏物シャツ', 'パジャマ'], zh: ['夏装衬衫', '睡衣'] } },
  { id: 'double_cloth', name: { ja: '二重織', zh: '双层织' }, cat: 'special', matrix: createMatrix(8, 8, (x, y) => { const l=Math.floor(y/4); return l===0?(x+y)%2===0:(x+y)%2===1; }), rx: 8, ry: 8, chars: { durability: 5, drape: 2, breathability: 2, wrinkleResistance: 4, shine: 2 }, gsmMult: 2.0, crimp: 1.12, diff: 5, apps: { ja: ['コート', 'ブランケット'], zh: ['外套', '毛毯'] } },
];

// ============================================================
// 糸データベース（物理定数追加）
// ============================================================
const YARN_DB = [
  // ── 綿 (cotton) ──────────────────────────
  // twist: 'normal'=通常撚, 'high'=強撚(2000T/m以上), 'low'=甘撚, 'zero'=無撚
  { id: 'cotton_6', name: { ja: 'カード綿 6Ne（太番手）', zh: '普梳棉 6支（粗支）' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 6, twist: 'normal', chars: { strength: 5, softness: 1, luster: 1, elasticity: 2, absorbency: 5, durability: 5 }, price: 1.2 },
  { id: 'cotton_10', name: { ja: 'カード綿 10Ne', zh: '普梳棉 10支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 10, twist: 'normal', chars: { strength: 4, softness: 2, luster: 1, elasticity: 2, absorbency: 5, durability: 5 }, price: 1.5 },
  { id: 'cotton_16', name: { ja: 'カード綿 16Ne', zh: '普梳棉 16支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 16, twist: 'normal', chars: { strength: 4, softness: 2, luster: 2, elasticity: 2, absorbency: 5, durability: 5 }, price: 1.8 },
  { id: 'cotton_20', name: { ja: 'カード綿 20Ne', zh: '普梳棉 20支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 20, twist: 'normal', chars: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 2 },
  { id: 'cotton_30', name: { ja: 'カード綿 30Ne', zh: '普梳棉 30支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 2.5 },
  { id: 'cotton_40', name: { ja: 'カード綿 40Ne', zh: '普梳棉 40支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 3, softness: 4, luster: 2, elasticity: 2, absorbency: 5, durability: 3 }, price: 3 },
  { id: 'cotton_50', name: { ja: 'カード綿 50Ne', zh: '普梳棉 50支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 50, twist: 'normal', chars: { strength: 2, softness: 4, luster: 2, elasticity: 2, absorbency: 5, durability: 3 }, price: 3.5 },
  { id: 'combed_20', name: { ja: 'コーマ綿 20Ne', zh: '精梳棉 20支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 20, twist: 'normal', chars: { strength: 4, softness: 3, luster: 3, elasticity: 2, absorbency: 5, durability: 5 }, price: 3 },
  { id: 'combed_30', name: { ja: 'コーマ綿 30Ne', zh: '精梳棉 30支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 4, softness: 4, luster: 3, elasticity: 2, absorbency: 5, durability: 4 }, price: 3.5 },
  { id: 'combed_40', name: { ja: 'コーマ綿 40Ne', zh: '精梳棉 40支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 4 },
  { id: 'combed_50', name: { ja: 'コーマ綿 50Ne', zh: '精梳棉 50支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 50, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 3 }, price: 4.5 },
  { id: 'combed_60', name: { ja: 'コーマ綿 60Ne', zh: '精梳棉 60支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 3 }, price: 5 },
  { id: 'combed_80', name: { ja: 'コーマ綿 80Ne', zh: '精梳棉 80支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 80, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 3 }, price: 6 },
  { id: 'combed_100', name: { ja: 'コーマ綿 100Ne', zh: '精梳棉 100支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 100, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 8 },
  { id: 'combed_120', name: { ja: 'コーマ綿 120Ne（超長綿）', zh: '精梳棉 120支（超长绒棉）' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 120, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 10 },
  { id: 'mercerized_60', name: { ja: 'シルケット綿 60Ne', zh: '丝光棉 60支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 4, softness: 5, luster: 5, elasticity: 2, absorbency: 4, durability: 4 }, price: 6 },
  { id: 'mercerized_80', name: { ja: 'シルケット綿 80Ne', zh: '丝光棉 80支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 80, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 2, absorbency: 4, durability: 3 }, price: 7 },
  { id: 'organic_30', name: { ja: 'オーガニック綿 30Ne', zh: '有机棉 30支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 3, softness: 4, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 4 },
  { id: 'organic_40', name: { ja: 'オーガニック綿 40Ne', zh: '有机棉 40支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 3, softness: 4, luster: 3, elasticity: 2, absorbency: 5, durability: 3 }, price: 5 },
  { id: 'supima_60', name: { ja: 'スーピマ綿 60Ne', zh: 'Supima棉 60支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 4, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 4 }, price: 7 },
  { id: 'supima_80', name: { ja: 'スーピマ綿 80Ne', zh: 'Supima棉 80支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 80, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 3 }, price: 8 },
  { id: 'giza_80', name: { ja: 'ギザ綿 80Ne', zh: '吉扎棉 80支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 80, twist: 'normal', chars: { strength: 4, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 4 }, price: 9 },
  { id: 'cotton_2ply_40', name: { ja: '双糸綿 40/2Ne', zh: '双股棉 40/2支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 20, twist: 'normal', chars: { strength: 5, softness: 4, luster: 4, elasticity: 2, absorbency: 5, durability: 5 }, price: 5 },
  { id: 'cotton_2ply_60', name: { ja: '双糸綿 60/2Ne', zh: '双股棉 60/2支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 5, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 5 }, price: 6 },
  { id: 'cotton_2ply_80', name: { ja: '双糸綿 80/2Ne', zh: '双股棉 80/2支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 5, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 5 }, price: 7 },
  // ── 綿 強撚・甘撚・無撚 ──────────────────────────
  { id: 'cotton_high_twist_40', name: { ja: '強撚綿 40Ne', zh: '强捻棉 40支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'high', chars: { strength: 3, softness: 2, luster: 3, elasticity: 3, absorbency: 5, durability: 4 }, price: 4.5, special: ['crepe'] },
  { id: 'cotton_high_twist_60', name: { ja: '強撚綿 60Ne', zh: '强捻棉 60支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 60, twist: 'high', chars: { strength: 3, softness: 2, luster: 3, elasticity: 3, absorbency: 5, durability: 4 }, price: 5.5, special: ['crepe'] },
  { id: 'cotton_low_twist_20', name: { ja: '甘撚綿 20Ne（ガーゼ用）', zh: '弱捻棉 20支（纱布用）' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 20, twist: 'low', chars: { strength: 2, softness: 5, luster: 1, elasticity: 1, absorbency: 5, durability: 2 }, price: 2.5 },
  { id: 'cotton_low_twist_30', name: { ja: '甘撚綿 30Ne（起毛用）', zh: '弱捻棉 30支（起绒用）' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 30, twist: 'low', chars: { strength: 2, softness: 5, luster: 1, elasticity: 1, absorbency: 5, durability: 2 }, price: 3.0 },
  { id: 'cotton_zero_twist_40', name: { ja: '無撚糸綿 40Ne', zh: '无捻棉 40支' }, cat: 'cotton', comp: [{ f: 'cotton', p: 100 }], ne: 40, twist: 'zero', chars: { strength: 1, softness: 5, luster: 1, elasticity: 1, absorbency: 5, durability: 1 }, price: 5.0 },
  // ── 麻 (linen) ──────────────────────────
  { id: 'linen_20', name: { ja: 'リネン 20Lea', zh: '亚麻 20支' }, cat: 'linen', comp: [{ f: 'linen', p: 100 }], ne: 12, twist: 'normal', chars: { strength: 5, softness: 1, luster: 3, elasticity: 1, absorbency: 5, durability: 5 }, price: 5 },
  { id: 'linen_40', name: { ja: 'リネン 40Lea', zh: '亚麻 40支' }, cat: 'linen', comp: [{ f: 'linen', p: 100 }], ne: 24, twist: 'normal', chars: { strength: 5, softness: 2, luster: 4, elasticity: 1, absorbency: 5, durability: 5 }, price: 6 },
  { id: 'linen_60', name: { ja: 'リネン 60Lea（高番手）', zh: '亚麻 60支（高支）' }, cat: 'linen', comp: [{ f: 'linen', p: 100 }], ne: 36, twist: 'normal', chars: { strength: 4, softness: 3, luster: 5, elasticity: 1, absorbency: 5, durability: 4 }, price: 8 },
  { id: 'linen_80', name: { ja: 'リネン 80Lea（極細）', zh: '亚麻 80支（极细）' }, cat: 'linen', comp: [{ f: 'linen', p: 100 }], ne: 48, twist: 'normal', chars: { strength: 3, softness: 4, luster: 5, elasticity: 1, absorbency: 5, durability: 3 }, price: 10 },
  { id: 'ramie_40', name: { ja: 'ラミー 40Ne', zh: '苎麻 40支' }, cat: 'linen', comp: [{ f: 'ramie', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 5, softness: 2, luster: 5, elasticity: 1, absorbency: 5, durability: 5 }, price: 5 },
  { id: 'ramie_60', name: { ja: 'ラミー 60Ne', zh: '苎麻 60支' }, cat: 'linen', comp: [{ f: 'ramie', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 4, softness: 3, luster: 5, elasticity: 1, absorbency: 5, durability: 4 }, price: 6 },
  { id: 'hemp_12', name: { ja: 'ヘンプ 12Ne', zh: '大麻 12支' }, cat: 'linen', comp: [{ f: 'linen', p: 100 }], ne: 12, twist: 'normal', chars: { strength: 5, softness: 1, luster: 2, elasticity: 1, absorbency: 5, durability: 5 }, price: 5 },
  // ── 羊毛 (wool) ──────────────────────────
  { id: 'merino_36', name: { ja: 'メリノ 36Nm', zh: '美利奴 36支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 21, twist: 'normal', chars: { strength: 3, softness: 4, luster: 3, elasticity: 5, absorbency: 4, durability: 3 }, price: 4.5 },
  { id: 'merino_48', name: { ja: 'メリノ 48Nm', zh: '美利奴 48支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 28, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 5, absorbency: 4, durability: 3 }, price: 5 },
  { id: 'merino_60', name: { ja: 'メリノ 60Nm', zh: '美利奴 60支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 35, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 5, absorbency: 4, durability: 3 }, price: 6 },
  { id: 'merino_80', name: { ja: 'メリノ 80Nm（スーパー120）', zh: '美利奴 80支（Super120）' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 47, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 5, absorbency: 4, durability: 2 }, price: 8 },
  { id: 'merino_100', name: { ja: 'メリノ 100Nm（スーパー150）', zh: '美利奴 100支（Super150）' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 59, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 5, absorbency: 4, durability: 2 }, price: 10 },
  { id: 'worsted_48', name: { ja: '梳毛 48Nm', zh: '精纺毛 48支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 28, twist: 'normal', chars: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 4, durability: 4 }, price: 5 },
  { id: 'worsted_60', name: { ja: '梳毛 60Nm', zh: '精纺毛 60支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 35, twist: 'normal', chars: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 4, durability: 4 }, price: 6 },
  { id: 'worsted_high_twist_60', name: { ja: '強撚梳毛 60Nm', zh: '强捻精纺毛 60支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 35, twist: 'high', chars: { strength: 4, softness: 3, luster: 4, elasticity: 4, absorbency: 4, durability: 4 }, price: 7, special: ['crepe'] },
  { id: 'woolen_12', name: { ja: '紡毛 12Nm（ツイード用）', zh: '粗纺毛 12支（花呢用）' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 7, twist: 'low', chars: { strength: 3, softness: 3, luster: 2, elasticity: 4, absorbency: 4, durability: 4 }, price: 4 },
  { id: 'woolen_18', name: { ja: '紡毛 18Nm（フランネル用）', zh: '粗纺毛 18支（法兰绒用）' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 10, twist: 'low', chars: { strength: 3, softness: 4, luster: 2, elasticity: 4, absorbency: 4, durability: 3 }, price: 4.5 },
  { id: 'cashmere_48', name: { ja: 'カシミヤ 48Nm', zh: '羊绒 48支' }, cat: 'wool', comp: [{ f: 'cashmere', p: 100 }], ne: 28, twist: 'normal', chars: { strength: 2, softness: 5, luster: 4, elasticity: 4, absorbency: 4, durability: 2 }, price: 9 },
  { id: 'cashmere_60', name: { ja: 'カシミヤ 60Nm', zh: '羊绒 60支' }, cat: 'wool', comp: [{ f: 'cashmere', p: 100 }], ne: 35, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 4, absorbency: 4, durability: 2 }, price: 10 },
  { id: 'alpaca_24', name: { ja: 'アルパカ 24Nm', zh: '羊驼 24支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 14, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 3, absorbency: 3, durability: 3 }, price: 7 },
  { id: 'mohair_48', name: { ja: 'モヘア 48Nm', zh: '马海毛 48支' }, cat: 'wool', comp: [{ f: 'wool', p: 100 }], ne: 28, twist: 'normal', chars: { strength: 3, softness: 4, luster: 5, elasticity: 4, absorbency: 3, durability: 3 }, price: 7 },
  // ── 絹 (silk) ──────────────────────────
  { id: 'silk_14d', name: { ja: '生糸 14D（極薄地用）', zh: '生丝 14D（极薄料用）' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 381, twist: 'low', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 4, durability: 2 }, price: 10 },
  { id: 'silk_21d', name: { ja: '生糸 21D（薄地用）', zh: '生丝 21D（薄料用）' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 254, twist: 'low', chars: { strength: 3, softness: 4, luster: 5, elasticity: 3, absorbency: 4, durability: 3 }, price: 9 },
  { id: 'silk_40d', name: { ja: '生糸 40D', zh: '生丝 40D' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 133, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 3, absorbency: 4, durability: 3 }, price: 8 },
  { id: 'silk_60', name: { ja: '絹紡 60Nm', zh: '绢纺 60支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 35, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 3, absorbency: 4, durability: 3 }, price: 7 },
  { id: 'silk_80', name: { ja: '絹紡 80Nm', zh: '绢纺 80支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 47, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 3, absorbency: 4, durability: 2 }, price: 8 },
  { id: 'silk_120', name: { ja: '絹紡 120Nm', zh: '绢纺 120支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 70, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 3, absorbency: 4, durability: 2 }, price: 10 },
  { id: 'tussah_30', name: { ja: '柞蚕糸 30Nm', zh: '柞蚕丝 30支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 17, twist: 'normal', chars: { strength: 3, softness: 4, luster: 3, elasticity: 2, absorbency: 4, durability: 3 }, price: 5 },
  { id: 'silk_noil', name: { ja: '絹紬糸 20Nm', zh: '绢纺绢丝 20支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 12, twist: 'normal', chars: { strength: 2, softness: 4, luster: 2, elasticity: 2, absorbency: 4, durability: 2 }, price: 4 },
  // ── 絹 強撚（クレープ・ジョーゼット用） ────────────
  { id: 'silk_high_twist_21d', name: { ja: '強撚生糸 21D（シフォン用）', zh: '强捻生丝 21D（雪纺用）' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 254, twist: 'high', chars: { strength: 3, softness: 3, luster: 4, elasticity: 4, absorbency: 4, durability: 3 }, price: 11, special: ['crepe'] },
  { id: 'silk_high_twist_30d', name: { ja: '強撚生糸 30D（ジョーゼット用）', zh: '强捻生丝 30D（乔其用）' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 177, twist: 'high', chars: { strength: 3, softness: 3, luster: 4, elasticity: 4, absorbency: 4, durability: 3 }, price: 10, special: ['crepe'] },
  { id: 'silk_high_twist_40d', name: { ja: '強撚生糸 40D（デシン用）', zh: '强捻生丝 40D（双绉用）' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 133, twist: 'high', chars: { strength: 3, softness: 3, luster: 4, elasticity: 4, absorbency: 4, durability: 3 }, price: 9, special: ['crepe'] },
  { id: 'silk_high_twist_60', name: { ja: '強撚絹紡 60Nm', zh: '强捻绢纺 60支' }, cat: 'silk', comp: [{ f: 'silk', p: 100 }], ne: 35, twist: 'high', chars: { strength: 3, softness: 3, luster: 4, elasticity: 4, absorbency: 4, durability: 3 }, price: 8, special: ['crepe'] },
  // ── 合成 (synthetic) ──────────────────────────
  { id: 'poly_30d', name: { ja: 'ポリエステル 30D', zh: '涤纶 30D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 177, twist: 'normal', chars: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 1, durability: 5 }, price: 2.5 },
  { id: 'poly_50d', name: { ja: 'ポリエステル 50D', zh: '涤纶 50D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 106, twist: 'normal', chars: { strength: 5, softness: 3, luster: 4, elasticity: 4, absorbency: 1, durability: 5 }, price: 2 },
  { id: 'poly_75d', name: { ja: 'ポリエステル 75D', zh: '涤纶 75D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 71, twist: 'normal', chars: { strength: 5, softness: 3, luster: 4, elasticity: 4, absorbency: 1, durability: 5 }, price: 2 },
  { id: 'poly_100d', name: { ja: 'ポリエステル 100D', zh: '涤纶 100D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 53, twist: 'normal', chars: { strength: 5, softness: 2, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 1.8 },
  { id: 'poly_150d', name: { ja: 'ポリエステル 150D', zh: '涤纶 150D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 35, twist: 'normal', chars: { strength: 5, softness: 2, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 1.8 },
  { id: 'poly_300d', name: { ja: 'ポリエステル 300D', zh: '涤纶 300D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 17, twist: 'normal', chars: { strength: 5, softness: 1, luster: 2, elasticity: 3, absorbency: 1, durability: 5 }, price: 1.5 },
  { id: 'poly_dty_75d', name: { ja: 'ポリ DTY 75D', zh: '涤纶DTY 75D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 71, twist: 'normal', chars: { strength: 4, softness: 4, luster: 2, elasticity: 5, absorbency: 1, durability: 5 }, price: 2.5 },
  { id: 'poly_fdy_75d', name: { ja: 'ポリ FDY 75D', zh: '涤纶FDY 75D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 71, twist: 'normal', chars: { strength: 5, softness: 2, luster: 5, elasticity: 3, absorbency: 1, durability: 5 }, price: 2 },
  // ── 合繊 強撚（ポリジョーゼット・ポリクレープ用） ────────
  { id: 'poly_high_twist_50d', name: { ja: '強撚ポリ 50D', zh: '强捻涤纶 50D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 106, twist: 'high', chars: { strength: 4, softness: 3, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 3, special: ['crepe'] },
  { id: 'poly_high_twist_75d', name: { ja: '強撚ポリ 75D', zh: '强捻涤纶 75D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 71, twist: 'high', chars: { strength: 5, softness: 2, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 2.8, special: ['crepe'] },
  { id: 'poly_high_twist_100d', name: { ja: '強撚ポリ 100D', zh: '强捻涤纶 100D' }, cat: 'synthetic', comp: [{ f: 'polyester', p: 100 }], ne: 53, twist: 'high', chars: { strength: 5, softness: 2, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 2.5, special: ['crepe'] },
  { id: 'nylon_40d', name: { ja: 'ナイロン 40D', zh: '尼龙 40D' }, cat: 'synthetic', comp: [{ f: 'nylon', p: 100 }], ne: 133, twist: 'normal', chars: { strength: 5, softness: 5, luster: 4, elasticity: 5, absorbency: 2, durability: 5 }, price: 3.5 },
  { id: 'nylon_70d', name: { ja: 'ナイロン 70D', zh: '尼龙 70D' }, cat: 'synthetic', comp: [{ f: 'nylon', p: 100 }], ne: 76, twist: 'normal', chars: { strength: 5, softness: 4, luster: 4, elasticity: 5, absorbency: 2, durability: 5 }, price: 3 },
  { id: 'nylon_210d', name: { ja: 'ナイロン 210D', zh: '尼龙 210D' }, cat: 'synthetic', comp: [{ f: 'nylon', p: 100 }], ne: 25, twist: 'normal', chars: { strength: 5, softness: 2, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 2.5 },
  { id: 'acrylic_32', name: { ja: 'アクリル 32Nm', zh: '腈纶 32支' }, cat: 'synthetic', comp: [{ f: 'acrylic', p: 100 }], ne: 19, twist: 'normal', chars: { strength: 3, softness: 4, luster: 3, elasticity: 3, absorbency: 1, durability: 4 }, price: 2 },
  { id: 'acrylic_48', name: { ja: 'アクリル 48Nm', zh: '腈纶 48支' }, cat: 'synthetic', comp: [{ f: 'acrylic', p: 100 }], ne: 28, twist: 'normal', chars: { strength: 3, softness: 4, luster: 3, elasticity: 3, absorbency: 1, durability: 4 }, price: 2.5 },
  // ── 再生 (regenerated) ──────────────────────────
  { id: 'viscose_20', name: { ja: 'レーヨン 20Ne', zh: '粘胶 20支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 20, twist: 'normal', chars: { strength: 2, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 2 }, price: 2 },
  { id: 'viscose_30', name: { ja: 'レーヨン 30Ne', zh: '粘胶 30支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 2.5 },
  { id: 'viscose_40', name: { ja: 'レーヨン 40Ne', zh: '粘胶 40支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 3 },
  { id: 'viscose_60', name: { ja: 'レーヨン 60Ne', zh: '粘胶 60支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 3.5 },
  { id: 'viscose_high_twist_40', name: { ja: '強撚レーヨン 40Ne', zh: '强捻粘胶 40支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 40, twist: 'high', chars: { strength: 2, softness: 3, luster: 4, elasticity: 3, absorbency: 5, durability: 2 }, price: 3.5, special: ['crepe'] },
  { id: 'tencel_30', name: { ja: 'テンセル 30Ne', zh: '天丝 30支' }, cat: 'regenerated', comp: [{ f: 'lyocell', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 4.5 },
  { id: 'tencel_40', name: { ja: 'テンセル 40Ne', zh: '天丝 40支' }, cat: 'regenerated', comp: [{ f: 'lyocell', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 5 },
  { id: 'tencel_60', name: { ja: 'テンセル 60Ne', zh: '天丝 60支' }, cat: 'regenerated', comp: [{ f: 'lyocell', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 3 }, price: 6 },
  { id: 'modal_30', name: { ja: 'モダール 30Ne', zh: '莫代尔 30支' }, cat: 'regenerated', comp: [{ f: 'modal', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 3, softness: 5, luster: 4, elasticity: 3, absorbency: 5, durability: 3 }, price: 3.5 },
  { id: 'modal_40', name: { ja: 'モダール 40Ne', zh: '莫代尔 40支' }, cat: 'regenerated', comp: [{ f: 'modal', p: 100 }], ne: 40, twist: 'normal', chars: { strength: 3, softness: 5, luster: 5, elasticity: 3, absorbency: 5, durability: 3 }, price: 4 },
  { id: 'cupro_60', name: { ja: 'キュプラ 60Ne', zh: '铜氨 60支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 60, twist: 'normal', chars: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 6 },
  { id: 'bamboo_30', name: { ja: 'バンブー 30Ne', zh: '竹纤维 30支' }, cat: 'regenerated', comp: [{ f: 'viscose', p: 100 }], ne: 30, twist: 'normal', chars: { strength: 2, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 2 }, price: 3.5 },
  // ── 混紡 (blend) ──────────────────────────
  { id: 'tc_65_35_20', name: { ja: 'TC 65/35 20Ne', zh: 'TC 65/35 20支' }, cat: 'blend', comp: [{ f: 'polyester', p: 65 }, { f: 'cotton', p: 35 }], ne: 20, chars: { strength: 4, softness: 3, luster: 2, elasticity: 3, absorbency: 3, durability: 5 }, price: 2 },
  { id: 'tc_65_35', name: { ja: 'TC 65/35 32Ne', zh: 'TC 65/35 32支' }, cat: 'blend', comp: [{ f: 'polyester', p: 65 }, { f: 'cotton', p: 35 }], ne: 32, chars: { strength: 4, softness: 3, luster: 3, elasticity: 3, absorbency: 3, durability: 5 }, price: 2.5 },
  { id: 'tc_65_35_45', name: { ja: 'TC 65/35 45Ne', zh: 'TC 65/35 45支' }, cat: 'blend', comp: [{ f: 'polyester', p: 65 }, { f: 'cotton', p: 35 }], ne: 45, chars: { strength: 4, softness: 4, luster: 3, elasticity: 3, absorbency: 3, durability: 5 }, price: 3 },
  { id: 'cvc_60_40', name: { ja: 'CVC 60/40 40Ne', zh: 'CVC 60/40 40支' }, cat: 'blend', comp: [{ f: 'cotton', p: 60 }, { f: 'polyester', p: 40 }], ne: 40, chars: { strength: 4, softness: 4, luster: 3, elasticity: 3, absorbency: 4, durability: 5 }, price: 3 },
  { id: 'cvc_60_40_30', name: { ja: 'CVC 60/40 30Ne', zh: 'CVC 60/40 30支' }, cat: 'blend', comp: [{ f: 'cotton', p: 60 }, { f: 'polyester', p: 40 }], ne: 30, chars: { strength: 4, softness: 3, luster: 2, elasticity: 3, absorbency: 4, durability: 5 }, price: 2.5 },
  { id: 'cotton_linen_55_45', name: { ja: '綿麻 55/45 21Ne', zh: '棉麻 55/45 21支' }, cat: 'blend', comp: [{ f: 'cotton', p: 55 }, { f: 'linen', p: 45 }], ne: 21, chars: { strength: 4, softness: 3, luster: 3, elasticity: 2, absorbency: 5, durability: 5 }, price: 4 },
  { id: 'cotton_linen_70_30', name: { ja: '綿麻 70/30 30Ne', zh: '棉麻 70/30 30支' }, cat: 'blend', comp: [{ f: 'cotton', p: 70 }, { f: 'linen', p: 30 }], ne: 30, chars: { strength: 4, softness: 3, luster: 3, elasticity: 2, absorbency: 5, durability: 5 }, price: 3.5 },
  { id: 'wool_poly_55_45', name: { ja: 'ウールポリ 55/45', zh: '毛涤 55/45' }, cat: 'blend', comp: [{ f: 'wool', p: 55 }, { f: 'polyester', p: 45 }], ne: 28, chars: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 3, durability: 5 }, price: 4 },
  { id: 'wool_poly_70_30', name: { ja: 'ウールポリ 70/30', zh: '毛涤 70/30' }, cat: 'blend', comp: [{ f: 'wool', p: 70 }, { f: 'polyester', p: 30 }], ne: 28, chars: { strength: 3, softness: 5, luster: 4, elasticity: 5, absorbency: 4, durability: 4 }, price: 5 },
  { id: 'cotton_spandex_97_3', name: { ja: '綿スパン 97/3 40Ne', zh: '棉氨 97/3 40支' }, cat: 'blend', comp: [{ f: 'cotton', p: 97 }, { f: 'spandex', p: 3 }], ne: 40, chars: { strength: 4, softness: 4, luster: 3, elasticity: 4, absorbency: 4, durability: 4 }, price: 4 },
  { id: 'cotton_spandex_95_5', name: { ja: '綿スパン 95/5 32Ne', zh: '棉氨 95/5 32支' }, cat: 'blend', comp: [{ f: 'cotton', p: 95 }, { f: 'spandex', p: 5 }], ne: 32, chars: { strength: 4, softness: 4, luster: 3, elasticity: 5, absorbency: 4, durability: 4 }, price: 4.5 },
  { id: 'poly_spandex', name: { ja: 'ポリスパン 92/8 75D', zh: '涤氨 92/8 75D' }, cat: 'blend', comp: [{ f: 'polyester', p: 92 }, { f: 'spandex', p: 8 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 3 },
  { id: 'wool_silk', name: { ja: 'ウールシルク 80/20', zh: '毛丝 80/20' }, cat: 'blend', comp: [{ f: 'wool', p: 80 }, { f: 'silk', p: 20 }], ne: 35, chars: { strength: 3, softness: 5, luster: 5, elasticity: 4, absorbency: 4, durability: 3 }, price: 7 },
  { id: 'wool_cashmere', name: { ja: 'ウールカシミヤ 90/10', zh: '毛绒 90/10' }, cat: 'blend', comp: [{ f: 'wool', p: 90 }, { f: 'cashmere', p: 10 }], ne: 28, chars: { strength: 3, softness: 5, luster: 4, elasticity: 5, absorbency: 4, durability: 3 }, price: 6 },
  { id: 'cotton_modal', name: { ja: '綿モダール 50/50 40Ne', zh: '棉莫 50/50 40支' }, cat: 'blend', comp: [{ f: 'cotton', p: 50 }, { f: 'modal', p: 50 }], ne: 40, chars: { strength: 3, softness: 5, luster: 4, elasticity: 3, absorbency: 5, durability: 3 }, price: 4 },
  { id: 'tencel_cotton', name: { ja: 'テンセル綿 60/40 40Ne', zh: '天丝棉 60/40 40支' }, cat: 'blend', comp: [{ f: 'lyocell', p: 60 }, { f: 'cotton', p: 40 }], ne: 40, chars: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 5 },
  { id: 'linen_viscose', name: { ja: '麻レーヨン 55/45 21Ne', zh: '麻粘 55/45 21支' }, cat: 'blend', comp: [{ f: 'linen', p: 55 }, { f: 'viscose', p: 45 }], ne: 21, chars: { strength: 3, softness: 4, luster: 4, elasticity: 2, absorbency: 5, durability: 3 }, price: 4 },
  { id: 'nylon_cotton', name: { ja: 'ナイロン綿 60/40', zh: '锦棉 60/40' }, cat: 'blend', comp: [{ f: 'nylon', p: 60 }, { f: 'cotton', p: 40 }], ne: 40, chars: { strength: 5, softness: 4, luster: 3, elasticity: 4, absorbency: 3, durability: 5 }, price: 3.5 },
  // ── 特殊 (specialty) ──────────────────────────
  { id: 'coolmax_75d', name: { ja: 'クールマックス 75D', zh: 'CoolMax 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 4, special: ['moisture'] },
  { id: 'thermolite', name: { ja: 'サーモライト 75D', zh: 'Thermolite 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 5, softness: 3, luster: 2, elasticity: 4, absorbency: 1, durability: 5 }, price: 4.5, special: ['insulation'] },
  { id: 'supplex', name: { ja: 'サプレックス 70D', zh: 'Supplex 70D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 76, chars: { strength: 5, softness: 4, luster: 3, elasticity: 5, absorbency: 2, durability: 5 }, price: 4, special: ['quick_dry'] },
  { id: 'cordura', name: { ja: 'コーデュラ 500D', zh: 'Cordura 500D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 10, chars: { strength: 5, softness: 1, luster: 1, elasticity: 3, absorbency: 1, durability: 5 }, price: 5, special: ['abrasion_resist'] },
  { id: 'outlast', name: { ja: 'アウトラスト 75D', zh: 'Outlast 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 4, luster: 3, elasticity: 3, absorbency: 2, durability: 4 }, price: 5, special: ['temperature_regulation'] },
  { id: 'solotex', name: { ja: 'ソロテックス 75D', zh: 'SOLOTEX 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 5, luster: 3, elasticity: 5, absorbency: 2, durability: 5 }, price: 4.5, special: ['stretch', 'recovery'] },
  { id: 'ecovero', name: { ja: 'エコヴェロ 30Ne', zh: 'EcoVero 30支' }, cat: 'specialty', comp: [{ f: 'viscose', p: 100 }], ne: 30, chars: { strength: 2, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 2 }, price: 4, special: ['sustainable'] },
  { id: 'recycled_poly_75d', name: { ja: 'リサイクルポリ 75D', zh: '再生涤纶 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 3, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 3, special: ['recycled'] },
  { id: 'washi', name: { ja: '和紙糸 16Ne', zh: '和纸纱 16支' }, cat: 'specialty', comp: [{ f: 'linen', p: 100 }], ne: 16, chars: { strength: 2, softness: 3, luster: 2, elasticity: 1, absorbency: 5, durability: 2 }, price: 6, special: ['antibacterial'] },
  { id: 'silvertech', name: { ja: '銀イオン抗菌 40Ne', zh: '银离子抗菌 40支' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 40, chars: { strength: 4, softness: 3, luster: 3, elasticity: 3, absorbency: 1, durability: 5 }, price: 5, special: ['antibacterial'] },
  // ── ストレッチ系ブランド糸 (stretch branded) ──────────────
  { id: 'lycra_t400_75d', name: { ja: 'LYCRA® T400® 75D', zh: 'LYCRA® T400® 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 63 }, { f: 'ptt', p: 37 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 5, special: ['stretch', 'recovery'] },
  { id: 'lycra_t400_eco', name: { ja: 'LYCRA® T400® EcoMade 75D', zh: 'LYCRA® T400® EcoMade 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 63 }, { f: 'ptt', p: 37 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 5.5, special: ['stretch', 'recovery', 'recycled'] },
  { id: 'sorona_75d', name: { ja: 'SORONA® 75D', zh: 'SORONA® 75D' }, cat: 'specialty', comp: [{ f: 'ptt', p: 100 }], ne: 71, chars: { strength: 4, softness: 5, luster: 3, elasticity: 5, absorbency: 2, durability: 5 }, price: 5, special: ['stretch', 'recovery', 'sustainable'] },
  { id: 'primeflex_75d', name: { ja: 'Primeflex® 75D', zh: 'Primeflex® 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 60 }, { f: 'ptt', p: 40 }], ne: 71, chars: { strength: 4, softness: 4, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 5, special: ['stretch', 'recovery'] },
  { id: 'creora_scy_40d', name: { ja: 'CREORA® SCY 40D', zh: 'CREORA® 包芯纱 40D' }, cat: 'specialty', comp: [{ f: 'polyurethane', p: 5 }, { f: 'polyester', p: 95 }], ne: 133, chars: { strength: 4, softness: 4, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 4.5, special: ['stretch'] },
  { id: 'roica_scy_40d', name: { ja: 'ROICA® SCY 40D', zh: 'ROICA® 包芯纱 40D' }, cat: 'specialty', comp: [{ f: 'polyurethane', p: 5 }, { f: 'polyester', p: 95 }], ne: 133, chars: { strength: 4, softness: 4, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 5, special: ['stretch', 'sustainable'] },
  // ── カバリング・コアスパン (covering/core-spun) ──────────────
  { id: 'pu_covering_pet_75d', name: { ja: 'PUカバリング PET 75D', zh: 'PU包覆 涤纶 75D' }, cat: 'specialty', comp: [{ f: 'polyurethane', p: 5 }, { f: 'polyester', p: 95 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 3.5, special: ['stretch'] },
  { id: 'pu_covering_ny_70d', name: { ja: 'PUカバリング Ny 70D', zh: 'PU包覆 尼龙 70D' }, cat: 'specialty', comp: [{ f: 'polyurethane', p: 5 }, { f: 'nylon', p: 95 }], ne: 76, chars: { strength: 5, softness: 4, luster: 3, elasticity: 5, absorbency: 2, durability: 5 }, price: 4, special: ['stretch'] },
  { id: 'corespun_cotton_pu_32', name: { ja: 'コアスパン綿/PU 32Ne', zh: '包芯纱 棉/PU 32支' }, cat: 'specialty', comp: [{ f: 'cotton', p: 95 }, { f: 'polyurethane', p: 5 }], ne: 32, chars: { strength: 4, softness: 4, luster: 2, elasticity: 5, absorbency: 4, durability: 4 }, price: 4.5, special: ['stretch'] },
  { id: 'corespun_cotton_pu_40', name: { ja: 'コアスパン綿/PU 40Ne', zh: '包芯纱 棉/PU 40支' }, cat: 'specialty', comp: [{ f: 'cotton', p: 95 }, { f: 'polyurethane', p: 5 }], ne: 40, chars: { strength: 3, softness: 4, luster: 3, elasticity: 5, absorbency: 4, durability: 4 }, price: 5, special: ['stretch'] },
  // ── 冷感・速乾系ブランド糸 (cooling/moisture) ──────────────
  { id: 'cool_cotton_75d', name: { ja: 'COOL COTTON 75D', zh: 'COOL COTTON 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 5, softness: 4, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 4, special: ['cooling', 'moisture'] },
  { id: 'ice_oxygen_bar_75d', name: { ja: '冰氧吧 75D', zh: '冰氧吧 75D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 71, chars: { strength: 5, softness: 4, luster: 3, elasticity: 5, absorbency: 2, durability: 5 }, price: 4, special: ['cooling', 'moisture'] },
  { id: 'tactel_70d', name: { ja: 'TACTEL® 70D', zh: 'TACTEL® 70D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 76, chars: { strength: 5, softness: 5, luster: 4, elasticity: 5, absorbency: 2, durability: 5 }, price: 4.5, special: ['quick_dry'] },
  { id: 'brrr_75d', name: { ja: 'brrr°® 75D', zh: 'brrr°® 75D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 71, chars: { strength: 5, softness: 4, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 5.5, special: ['cooling'] },
  // ── サステナブル系ブランド糸 (sustainable) ──────────────
  { id: 'ecopet_75d', name: { ja: 'ECOPET® 75D', zh: 'ECOPET® 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 3, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 3.5, special: ['recycled'] },
  { id: 'econyl_70d', name: { ja: 'ECONYL® 70D', zh: 'ECONYL® 70D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 76, chars: { strength: 5, softness: 4, luster: 4, elasticity: 5, absorbency: 2, durability: 5 }, price: 5, special: ['recycled', 'sustainable'] },
  { id: 'tencel_luxe_75d', name: { ja: 'TENCEL™ Luxe 75D', zh: 'TENCEL™ Luxe 75D' }, cat: 'specialty', comp: [{ f: 'lyocell', p: 100 }], ne: 71, chars: { strength: 4, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 4 }, price: 7, special: ['sustainable'] },
  { id: 'refibra_30', name: { ja: 'REFIBRA™ 30Ne', zh: 'REFIBRA™ 30支' }, cat: 'specialty', comp: [{ f: 'lyocell', p: 100 }], ne: 30, chars: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 5, special: ['recycled', 'sustainable'] },
  // ── 機能・テクスチャー系 (functional/texture) ──────────────
  { id: 'microfiber_pet_75d', name: { ja: 'マイクロファイバーPET 75D', zh: '超细纤维涤纶 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 5, luster: 4, elasticity: 4, absorbency: 2, durability: 5 }, price: 3.5, special: ['peach_skin'] },
  { id: 'cationic_pet_75d', name: { ja: 'カチオン可染PET 75D', zh: '阳离子涤纶 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 4, softness: 3, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 3, special: ['heather'] },
  { id: 'dope_dyed_pet_75d', name: { ja: '原着PET 75D', zh: '原液着色涤纶 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 5, softness: 3, luster: 3, elasticity: 4, absorbency: 1, durability: 5 }, price: 2.5, special: ['colorfastness'] },
  { id: 'taslan_ny_70d', name: { ja: 'タスラン加工Ny 70D', zh: '塔丝隆尼龙 70D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 100 }], ne: 76, chars: { strength: 5, softness: 4, luster: 2, elasticity: 4, absorbency: 2, durability: 5 }, price: 3.5, special: ['cotton_like'] },
  { id: 'high_twist_cotton_80', name: { ja: '強撚綿 80Ne', zh: '强捻棉 80支' }, cat: 'specialty', comp: [{ f: 'cotton', p: 100 }], ne: 80, chars: { strength: 3, softness: 2, luster: 3, elasticity: 3, absorbency: 5, durability: 4 }, price: 7, special: ['crepe', 'seersucker'] },
  { id: 'slub_cotton_20', name: { ja: 'スラブ綿 20Ne', zh: '竹节棉 20支' }, cat: 'specialty', comp: [{ f: 'cotton', p: 100 }], ne: 20, chars: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 3 }, price: 3, special: ['texture'] },
  { id: 'nep_yarn_16', name: { ja: 'ネップ糸 16Ne', zh: '彩点纱 16支' }, cat: 'specialty', comp: [{ f: 'cotton', p: 100 }], ne: 16, chars: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 3 }, price: 3.5, special: ['texture'] },
  { id: 'dacron_75d', name: { ja: 'ダクロン® 75D', zh: 'Dacron® 75D' }, cat: 'specialty', comp: [{ f: 'polyester', p: 100 }], ne: 71, chars: { strength: 5, softness: 3, luster: 4, elasticity: 4, absorbency: 1, durability: 5 }, price: 3, special: [] },
  { id: 'cordura_denim', name: { ja: 'CORDURA® デニム 420D', zh: 'CORDURA® 牛仔 420D' }, cat: 'specialty', comp: [{ f: 'nylon', p: 60 }, { f: 'cotton', p: 40 }], ne: 12, chars: { strength: 5, softness: 2, luster: 2, elasticity: 3, absorbency: 3, durability: 5 }, price: 5.5, special: ['abrasion_resist'] },
  { id: 'dryarn_pp_75d', name: { ja: 'DRYARN® PP 75D', zh: 'DRYARN® 丙纶 75D' }, cat: 'specialty', comp: [{ f: 'polypropylene', p: 100 }], ne: 71, chars: { strength: 4, softness: 3, luster: 2, elasticity: 3, absorbency: 1, durability: 5 }, price: 4, special: ['quick_dry', 'lightweight'] },
];

// ───────────────────────────────────────────────────
// yarnデータの正規化: twist属性が無ければデフォルトで 'normal' を付与
// 既存データを一括で対応させるため、ここで補完します。
YARN_DB.forEach(y => { if (!y.twist) y.twist = 'normal'; });

// ============================================================
// チェック柄プリセットデータベース
// ============================================================
const CHECK_PATTERNS = [
  // ── ギンガム系 ──
  { id: 'gingham_basic', name: { ja: 'ギンガムチェック', zh: '方格布' }, cat: 'gingham',
    warpColors: ['#1d3557','#ffffff'], weftColors: ['#1d3557','#ffffff'], pitch: 20, weaveId: 'plain', desc: { ja: '等間隔の格子。カジュアルシャツの定番', zh: '等间距格子，休闲衬衫经典款' } },
  { id: 'gingham_red', name: { ja: 'ギンガム（赤）', zh: '红色方格' }, cat: 'gingham',
    warpColors: ['#e63946','#ffffff'], weftColors: ['#e63946','#ffffff'], pitch: 20, weaveId: 'plain', desc: { ja: '赤白のギンガム。テーブルクロスにも', zh: '红白方格，桌布也适用' } },
  { id: 'gingham_blue', name: { ja: 'ギンガム（ブルー）', zh: '蓝色方格' }, cat: 'gingham',
    warpColors: ['#3a86ff','#ffffff'], weftColors: ['#3a86ff','#ffffff'], pitch: 18, weaveId: 'plain', desc: { ja: 'ブルーギンガム。爽やかなシャツ地', zh: '蓝色方格，清爽衬衫面料' } },
  { id: 'gingham_black', name: { ja: 'ギンガム（ブラック）', zh: '黑色方格' }, cat: 'gingham',
    warpColors: ['#000000','#ffffff'], weftColors: ['#000000','#ffffff'], pitch: 22, weaveId: 'plain', desc: { ja: 'モノトーンギンガム', zh: '黑白方格' } },
  { id: 'gingham_green', name: { ja: 'ギンガム（グリーン）', zh: '绿色方格' }, cat: 'gingham',
    warpColors: ['#2a9d8f','#ffffff'], weftColors: ['#2a9d8f','#ffffff'], pitch: 20, weaveId: 'plain', desc: { ja: 'グリーンギンガム', zh: '绿色方格' } },
  { id: 'gingham_micro', name: { ja: 'マイクロギンガム', zh: '微格' }, cat: 'gingham',
    warpColors: ['#1d3557','#ffffff'], weftColors: ['#1d3557','#ffffff'], pitch: 10, weaveId: 'plain', desc: { ja: '細かいギンガム。ドレスシャツ向き', zh: '细密方格，适合正装衬衫' } },
  // ── タータン系 ──
  { id: 'tartan_royal', name: { ja: 'ロイヤルスチュアート', zh: '皇家斯图尔特格' }, cat: 'tartan',
    warpColors: ['#e63946','#1d3557','#e63946','#fcbf49','#e63946','#ffffff'], weftColors: ['#e63946','#1d3557','#e63946','#fcbf49','#e63946','#ffffff'], pitch: 14, weaveId: 'twill_2_2', desc: { ja: '最も有名なタータン。赤基調', zh: '最著名的格子呢，红色基调' } },
  { id: 'tartan_blackwatch', name: { ja: 'ブラックウォッチ', zh: '黑卫兵格' }, cat: 'tartan',
    warpColors: ['#1d3557','#1d3557','#2a9d8f','#1d3557','#1d3557','#283618'], weftColors: ['#1d3557','#1d3557','#2a9d8f','#1d3557','#1d3557','#283618'], pitch: 14, weaveId: 'twill_2_2', desc: { ja: 'ダークな紺×緑。フォーマルにも', zh: '深蓝绿格纹，也适合正式场合' } },
  { id: 'tartan_burberry', name: { ja: 'キャメルタータン', zh: '驼色格纹' }, cat: 'tartan',
    warpColors: ['#dda15e','#dda15e','#000000','#e63946','#000000','#dda15e'], weftColors: ['#dda15e','#dda15e','#000000','#e63946','#000000','#dda15e'], pitch: 14, weaveId: 'twill_2_2', desc: { ja: 'キャメル系タータン。上品なチェック', zh: '驼色格纹，优雅经典' } },
  { id: 'tartan_dress_gordon', name: { ja: 'ドレスゴードン', zh: '戈登格纹' }, cat: 'tartan',
    warpColors: ['#283618','#283618','#fcbf49','#ffffff','#fcbf49','#283618'], weftColors: ['#283618','#283618','#fcbf49','#ffffff','#fcbf49','#283618'], pitch: 14, weaveId: 'twill_2_2', desc: { ja: '緑基調のゴードンタータン', zh: '绿色基调的戈登格纹' } },
  // ── グレンチェック系 ──
  { id: 'glen_classic', name: { ja: 'グレンチェック', zh: '威尔士亲王格' }, cat: 'glen',
    warpColors: ['#3d405b','#ffffff','#3d405b','#ffffff'], weftColors: ['#3d405b','#ffffff','#3d405b','#ffffff'], pitch: 16, weaveId: 'twill_2_2', desc: { ja: '千鳥格子の組合せ。スーツ向き', zh: '千鸟格组合，适合西装' } },
  { id: 'glen_prince_of_wales', name: { ja: 'プリンスオブウェールズ', zh: '威尔士亲王格（彩线）' }, cat: 'glen',
    warpColors: ['#3d405b','#ffffff','#3d405b','#ffffff','#3a86ff','#ffffff'], weftColors: ['#3d405b','#ffffff','#3d405b','#ffffff','#3a86ff','#ffffff'], pitch: 14, weaveId: 'twill_2_2', desc: { ja: 'グレンにカラーライン入り', zh: '格伦格加彩色线条' } },
  { id: 'glen_brown', name: { ja: 'ブラウングレン', zh: '棕色威尔士格' }, cat: 'glen',
    warpColors: ['#bc6c25','#f2cc8f','#bc6c25','#f2cc8f'], weftColors: ['#bc6c25','#f2cc8f','#bc6c25','#f2cc8f'], pitch: 16, weaveId: 'twill_2_2', desc: { ja: 'ブラウン系グレン。秋冬向け', zh: '棕色威尔士格，秋冬适用' } },
  // ── 千鳥格子（ハウンドトゥース）系 ──
  { id: 'houndstooth_classic', name: { ja: '千鳥格子', zh: '千鸟格' }, cat: 'houndstooth',
    warpColors: ['#000000','#000000','#ffffff','#ffffff'], weftColors: ['#000000','#000000','#ffffff','#ffffff'], pitch: 12, weaveId: 'twill_2_2', desc: { ja: '伝統的な千鳥格子。ジャケット向き', zh: '传统千鸟格，适合夹克' } },
  { id: 'houndstooth_large', name: { ja: '大柄千鳥格子', zh: '大千鸟格' }, cat: 'houndstooth',
    warpColors: ['#000000','#000000','#ffffff','#ffffff'], weftColors: ['#000000','#000000','#ffffff','#ffffff'], pitch: 24, weaveId: 'twill_2_2', desc: { ja: '大きめの千鳥。コート向き', zh: '大千鸟格，适合大衣' } },
  { id: 'houndstooth_color', name: { ja: 'カラー千鳥格子', zh: '彩色千鸟格' }, cat: 'houndstooth',
    warpColors: ['#e63946','#e63946','#000000','#000000'], weftColors: ['#e63946','#e63946','#000000','#000000'], pitch: 12, weaveId: 'twill_2_2', desc: { ja: '赤×黒の千鳥格子', zh: '红黑千鸟格' } },
  // ── マドラス系 ──
  { id: 'madras_classic', name: { ja: 'マドラスチェック', zh: '马德拉斯格' }, cat: 'madras',
    warpColors: ['#e63946','#fcbf49','#2a9d8f','#1d3557'], weftColors: ['#f4a261','#e76f51','#264653','#81b29a'], pitch: 24, weaveId: 'plain', desc: { ja: '多色のインド格子。夏シャツの定番', zh: '多色印度格子，夏季衬衫经典' } },
  { id: 'madras_sunset', name: { ja: 'マドラス（サンセット）', zh: '马德拉斯（日落）' }, cat: 'madras',
    warpColors: ['#fb5607','#ff006e','#ffbe0b','#ffffff'], weftColors: ['#e76f51','#f4a261','#fcbf49','#ffffff'], pitch: 28, weaveId: 'plain', desc: { ja: '暖色系マドラス', zh: '暖色系马德拉斯格' } },
  { id: 'madras_ocean', name: { ja: 'マドラス（オーシャン）', zh: '马德拉斯（海洋）' }, cat: 'madras',
    warpColors: ['#023e8a','#0077b6','#90e0ef','#ffffff'], weftColors: ['#0077b6','#90e0ef','#caf0f8','#ffffff'], pitch: 24, weaveId: 'plain', desc: { ja: '海色マドラス。リゾート感', zh: '海洋色马德拉斯格' } },
  // ── ウィンドウペン系 ──
  { id: 'windowpane_navy', name: { ja: 'ウィンドウペン（ネイビー）', zh: '窗格纹（藏蓝）' }, cat: 'windowpane',
    warpColors: ['#ffffff','#ffffff','#ffffff','#1d3557'], weftColors: ['#ffffff','#ffffff','#ffffff','#1d3557'], pitch: 30, weaveId: 'plain', desc: { ja: '大きな窓格子。モダンなスーツ', zh: '大窗格纹，现代西装' } },
  { id: 'windowpane_brown', name: { ja: 'ウィンドウペン（ブラウン）', zh: '窗格纹（棕色）' }, cat: 'windowpane',
    warpColors: ['#f2cc8f','#f2cc8f','#f2cc8f','#bc6c25'], weftColors: ['#f2cc8f','#f2cc8f','#f2cc8f','#bc6c25'], pitch: 32, weaveId: 'plain', desc: { ja: 'ブラウンのウィンドウペン', zh: '棕色窗格纹' } },
  { id: 'windowpane_grey', name: { ja: 'ウィンドウペン（グレー）', zh: '窗格纹（灰色）' }, cat: 'windowpane',
    warpColors: ['#e0e0e0','#e0e0e0','#e0e0e0','#3d405b'], weftColors: ['#e0e0e0','#e0e0e0','#e0e0e0','#3d405b'], pitch: 28, weaveId: 'plain', desc: { ja: 'グレーのウィンドウペン', zh: '灰色窗格纹' } },
  // ── ブロックチェック系 ──
  { id: 'block_buffalo', name: { ja: 'バッファローチェック', zh: '水牛格' }, cat: 'block',
    warpColors: ['#e63946','#000000'], weftColors: ['#e63946','#000000'], pitch: 40, weaveId: 'plain', desc: { ja: '大柄な赤黒チェック。アウトドア', zh: '大红黑格子，户外风' } },
  { id: 'block_lumberjack', name: { ja: 'ランバージャック', zh: '伐木工格' }, cat: 'block',
    warpColors: ['#e63946','#283618'], weftColors: ['#e63946','#283618'], pitch: 36, weaveId: 'twill_2_2', desc: { ja: '赤×深緑の大格子', zh: '红绿大格子' } },
  { id: 'block_bw', name: { ja: 'ブロックチェック（白黒）', zh: '黑白方块格' }, cat: 'block',
    warpColors: ['#000000','#ffffff'], weftColors: ['#000000','#ffffff'], pitch: 32, weaveId: 'plain', desc: { ja: 'モノトーンブロック', zh: '黑白方块格' } },
  // ── オンブレ・シャドーチェック ──
  { id: 'ombre', name: { ja: 'オンブレチェック', zh: '渐变格' }, cat: 'ombre',
    warpColors: ['#1d3557','#457b9d','#a8dadc','#457b9d'], weftColors: ['#1d3557','#457b9d','#a8dadc','#457b9d'], pitch: 20, weaveId: 'plain', desc: { ja: '色がグラデーションで変化', zh: '颜色渐变变化' } },
  { id: 'shadow_check', name: { ja: 'シャドーチェック', zh: '暗格' }, cat: 'ombre',
    warpColors: ['#1d3557','#264653'], weftColors: ['#1d3557','#264653'], pitch: 24, weaveId: 'twill_2_2', desc: { ja: '同系色の控えめチェック。ビジネス向', zh: '同色系暗格纹，商务场合适用' } },
  { id: 'tone_on_tone', name: { ja: 'トーンオントーン', zh: '同色调格' }, cat: 'ombre',
    warpColors: ['#457b9d','#a8dadc'], weftColors: ['#457b9d','#a8dadc'], pitch: 22, weaveId: 'twill_2_2', desc: { ja: '同系色の濃淡チェック', zh: '同色系深浅格纹' } },
  // ── その他の定番 ──
  { id: 'tattersall', name: { ja: 'タッターソール', zh: '双线格' }, cat: 'other_check',
    warpColors: ['#ffffff','#ffffff','#ffffff','#e63946','#ffffff','#ffffff','#ffffff','#3a86ff'], weftColors: ['#ffffff','#ffffff','#ffffff','#e63946','#ffffff','#ffffff','#ffffff','#3a86ff'], pitch: 12, weaveId: 'plain', desc: { ja: '白地に二色のライン', zh: '白底双色线条格' } },
  { id: 'graph_check', name: { ja: 'グラフチェック', zh: '细线格' }, cat: 'other_check',
    warpColors: ['#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#3d405b'], weftColors: ['#ffffff','#ffffff','#ffffff','#ffffff','#ffffff','#3d405b'], pitch: 10, weaveId: 'plain', desc: { ja: '方眼紙のような細い線', zh: '方格纸般的细线格' } },
  { id: 'overcheck', name: { ja: 'オーバーチェック', zh: '叠加格' }, cat: 'other_check',
    warpColors: ['#e0e0e0','#e0e0e0','#e0e0e0','#e0e0e0','#e0e0e0','#e63946'], weftColors: ['#e0e0e0','#e0e0e0','#e0e0e0','#e0e0e0','#e0e0e0','#e63946'], pitch: 10, weaveId: 'twill_2_2', desc: { ja: '地の上にアクセントライン', zh: '底色上的点缀线条' } },
  { id: 'plaid_school', name: { ja: 'スクールチェック', zh: '校园格' }, cat: 'other_check',
    warpColors: ['#1d3557','#e63946','#1d3557','#ffffff'], weftColors: ['#1d3557','#e63946','#1d3557','#ffffff'], pitch: 18, weaveId: 'twill_2_2', desc: { ja: '制服・スカート向けの正統派', zh: '校服用的正统格纹' } },
  { id: 'argyle_inspired', name: { ja: 'アーガイル風', zh: '菱形格风' }, cat: 'other_check',
    warpColors: ['#1d3557','#e63946','#ffffff','#e63946'], weftColors: ['#1d3557','#ffffff','#e63946','#ffffff'], pitch: 22, weaveId: 'twill_2_2', desc: { ja: 'アーガイル柄のイメージ', zh: '菱形格纹风格' } },
];

// チェック柄カテゴリ名
const CHECK_CATEGORIES = {
  gingham:     { ja: 'ギンガム系', zh: '方格系' },
  tartan:      { ja: 'タータン系', zh: '格纹呢系' },
  glen:        { ja: 'グレンチェック系', zh: '威尔士格系' },
  houndstooth: { ja: '千鳥格子系', zh: '千鸟格系' },
  madras:      { ja: 'マドラス系', zh: '马德拉斯系' },
  windowpane:  { ja: 'ウィンドウペン系', zh: '窗格纹系' },
  block:       { ja: 'ブロック系', zh: '方块格系' },
  ombre:       { ja: 'シャドー・オンブレ系', zh: '渐变暗格系' },
  other_check: { ja: 'その他チェック', zh: '其他格纹' },
};

// カラーパレット
const SWATCHES = [
  "#000000","#ffffff","#1d3557","#457b9d","#a8dadc","#e63946","#f1faee",
  "#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51","#6a4c93","#8338ec",
  "#3a86ff","#fb5607","#ff006e","#ffbe0b","#3d405b","#81b29a","#f2cc8f",
  "#023e8a","#0077b6","#90e0ef","#caf0f8","#d62828","#f77f00","#fcbf49",
  "#606c38","#283618","#bc6c25","#dda15e"
];

// ============================================================
// ユーティリティ関数
// ============================================================
function hexToRgb(hex) {
  const c = hex.replace('#','');
  const bigint = parseInt(c.length === 3 ? c.split('').map(x=>x+x).join('') : c, 16);
  return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
}

function rgbToHex(r, g, b) {
  return '#' + [r, g, b].map(x => Math.round(x).toString(16).padStart(2, '0')).join('');
}

function blendColors(c1, c2, ratio) {
  const rgb1 = hexToRgb(c1), rgb2 = hexToRgb(c2);
  return rgbToHex(
    rgb1.r * ratio + rgb2.r * (1 - ratio),
    rgb1.g * ratio + rgb2.g * (1 - ratio),
    rgb1.b * ratio + rgb2.b * (1 - ratio)
  );
}

function lightenColor(hex, amount) {
  const rgb = hexToRgb(hex);
  return rgbToHex(
    Math.min(255, rgb.r + amount),
    Math.min(255, rgb.g + amount),
    Math.min(255, rgb.b + amount)
  );
}

function darkenColor(hex, amount) {
  const rgb = hexToRgb(hex);
  return rgbToHex(
    Math.max(0, rgb.r - amount),
    Math.max(0, rgb.g - amount),
    Math.max(0, rgb.b - amount)
  );
}

function colorDistance(hex1, hex2) {
  const c1 = hexToRgb(hex1), c2 = hexToRgb(hex2);
  return Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2));
}

function findNearestPantone(hex) {
  let nearest = PANTONE_DB[0], minDist = Infinity;
  PANTONE_DB.forEach(p => { const d = colorDistance(hex, p.hex); if (d < minDist) { minDist = d; nearest = p; } });
  return nearest;
}

function getWeave(id) { return WEAVE_DB.find(w => w.id === id); }
function getYarn(id) { return YARN_DB.find(y => y.id === id); }

function getComp(yarn, lang) {
  if (!yarn) return '-';
  return yarn.comp.map(c => `${LANG[lang].fibers[c.f]||c.f} ${c.p}%`).join('/');
}

function getFiberDensity(yarn) {
  if (!yarn) return 1.54;
  let totalDensity = 0;
  yarn.comp.forEach(c => {
    const fc = FIBER_CONSTANTS[c.f];
    totalDensity += (fc?.density || 1.5) * (c.p / 100);
  });
  return totalDensity;
}

// ============================================================
// 物理計算を活用した分析関数
// ============================================================

// GSM計算（正確版）
function calcGSM(config) {
  const weave = getWeave(config.weaveId);
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  if (!weave || !warpYarn || !weftYarn) return null;

  const gsm = calcGSMAccurate(
    config.epi, config.ppi,
    warpYarn.ne, weftYarn.ne,
    weave.gsmMult || 1.0,
    weave.crimp || 1.08
  );

  let cat;
  if (gsm < 80) cat = 'ultraLight';
  else if (gsm < 130) cat = 'light';
  else if (gsm < 180) cat = 'mediumLight';
  else if (gsm < 250) cat = 'medium';
  else if (gsm < 350) cat = 'heavy';
  else cat = 'ultraHeavy';

  return { gsm, cat };
}

// 物理情報を計算
function calcPhysicsInfo(config) {
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const weave = getWeave(config.weaveId);
  if (!warpYarn || !weftYarn || !weave) return null;

  const warpDensity = getFiberDensity(warpYarn);
  const weftDensity = getFiberDensity(weftYarn);

  const warpDiameter = calcYarnDiameter(warpYarn.ne, warpDensity);
  const weftDiameter = calcYarnDiameter(weftYarn.ne, weftDensity);

  const warpCF = calcCoverFactor(config.epi, warpYarn.ne);
  const weftCF = calcCoverFactor(config.ppi, weftYarn.ne);
  const totalCF = warpCF + weftCF;

  const warpMaxDensity = calcMaxDensity(warpYarn.ne, warpDensity);
  const weftMaxDensity = calcMaxDensity(weftYarn.ne, weftDensity);

  const thickness = calcFabricThickness(warpYarn.ne, weftYarn.ne, weave.cat, (warpDensity + weftDensity) / 2);

  return {
    warpDiameter: warpDiameter.toFixed(3),
    weftDiameter: weftDiameter.toFixed(3),
    warpCF: warpCF.toFixed(1),
    weftCF: weftCF.toFixed(1),
    totalCF: totalCF.toFixed(1),
    warpMaxDensity,
    weftMaxDensity,
    thickness: thickness.toFixed(2),
    warpOverLimit: config.epi > warpMaxDensity,
    weftOverLimit: config.ppi > weftMaxDensity,
    cfOverLimit: totalCF > 28
  };
}

// 季節判定（改善版）
function judgeSeason(config) {
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const weave = getWeave(config.weaveId);
  const gsmData = calcGSM(config);
  if (!warpYarn || !weave || !gsmData) return 'all';

  const gsm = gsmData.gsm;
  const breathability = weave.chars.breathability;

  // 繊維の季節適性をスコア化
  let summerScore = 0, winterScore = 0;

  [warpYarn, weftYarn].forEach(yarn => {
    yarn.comp.forEach(c => {
      if (['linen', 'ramie'].includes(c.f)) summerScore += c.p * 2;
      if (['cotton', 'lyocell', 'modal'].includes(c.f)) summerScore += c.p;
      if (['wool', 'cashmere'].includes(c.f)) winterScore += c.p * 2;
      if (['acrylic', 'polyester'].includes(c.f) && gsm > 200) winterScore += c.p;
    });
  });

  // GSMによる補正
  if (gsm < 120) summerScore += 100;
  else if (gsm < 180) summerScore += 50;
  else if (gsm > 280) winterScore += 100;
  else if (gsm > 220) winterScore += 50;

  // 通気性による補正
  if (breathability >= 4) summerScore += 50;
  if (breathability <= 2) winterScore += 30;

  if (summerScore > winterScore + 80) return 'ss';
  if (winterScore > summerScore + 80) return 'aw';
  return 'all';
}

// 類似生地検索（改善版）
function findSimilar(config) {
  const weave = getWeave(config.weaveId);
  const warpYarn = getYarn(config.warpYarnId);
  const gsmData = calcGSM(config);
  if (!weave || !warpYarn || !gsmData) return [];

  return SIMILAR_FABRICS.filter(f => {
    let score = 0;

    // 織り組織マッチ
    if (f.weave === config.weaveId) score += 3;
    else if (weave.cat === (getWeave(f.weave)?.cat)) score += 1;

    // 素材マッチ
    if (warpYarn.comp.some(c => c.f === f.yarn)) score += 2;

    // 密度マッチ
    if (config.epi >= f.epiRange[0] && config.epi <= f.epiRange[1]) score += 2;

    // GSMマッチ
    if (gsmData.gsm >= f.gsmRange[0] && gsmData.gsm <= f.gsmRange[1]) score += 2;

    // 番手マッチ
    if (f.neRange && warpYarn.ne >= f.neRange[0] && warpYarn.ne <= f.neRange[1]) score += 2;

    return score >= 4;
  }).slice(0, 5);
}

// リスク分析（大幅拡充）
function analyzeRisks(config, lang) {
  const weave = getWeave(config.weaveId);
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const physics = calcPhysicsInfo(config);
  const L = LANG[lang];
  const risks = [];

  if (!weave || !warpYarn || !weftYarn || !physics) return { risks: [], level: 'none' };

  // 1. 密度超過リスク
  if (physics.warpOverLimit) {
    risks.push({
      icon: '⚠️',
      type: 'density',
      title: L.riskTypes.density,
      detail: lang === 'ja'
        ? `経糸密度${config.epi}が限界${physics.warpMaxDensity}を超過`
        : `经密${config.epi}超过极限${physics.warpMaxDensity}`,
      level: 'critical'
    });
  }
  if (physics.weftOverLimit) {
    risks.push({
      icon: '⚠️',
      type: 'density',
      title: L.riskTypes.density,
      detail: lang === 'ja'
        ? `緯糸密度${config.ppi}が限界${physics.weftMaxDensity}を超過`
        : `纬密${config.ppi}超过极限${physics.weftMaxDensity}`,
      level: 'critical'
    });
  }

  // 2. カバーファクター過大
  if (physics.cfOverLimit) {
    risks.push({
      icon: '📊',
      type: 'coverFactor',
      title: L.riskTypes.coverFactor,
      detail: lang === 'ja'
        ? `CF合計${physics.totalCF}が標準上限28を超過。織り難度上昇。`
        : `总紧度${physics.totalCF}超过标准上限28，织造难度增加。`,
      level: 'high'
    });
  } else if (parseFloat(physics.totalCF) > 25) {
    risks.push({
      icon: '📊',
      type: 'coverFactor',
      title: L.riskTypes.coverFactor,
      detail: lang === 'ja'
        ? `CF合計${physics.totalCF}がやや高め。注意が必要。`
        : `总紧度${physics.totalCF}偏高，需要注意。`,
      level: 'medium'
    });
  }

  // 3. 糸切れリスク
  if (warpYarn.ne > 60 && config.epi > 100) {
    risks.push({
      icon: '🧵',
      type: 'yarnBreak',
      title: L.riskTypes.yarnBreak,
      detail: lang === 'ja'
        ? `高番手(${warpYarn.ne}Ne)×高密度で糸切れリスク高`
        : `高支数(${warpYarn.ne}Ne)×高密度断线风险高`,
      level: 'high'
    });
  } else if (warpYarn.ne > 50 && config.epi > 90) {
    risks.push({
      icon: '🧵',
      type: 'yarnBreak',
      title: L.riskTypes.yarnBreak,
      detail: lang === 'ja' ? '糸切れに注意' : '注意断线',
      level: 'medium'
    });
  }

  // 4. 織り難度
  if (weave.diff >= 5) {
    risks.push({
      icon: '🔧',
      type: 'weaving',
      title: L.riskTypes.weaving,
      detail: lang === 'ja'
        ? `${weave.name[lang]}は高難度組織。熟練工が必要。`
        : `${weave.name[lang]}是高难度组织，需要熟练工人。`,
      level: 'high'
    });
  } else if (weave.diff >= 4) {
    risks.push({
      icon: '🔧',
      type: 'weaving',
      title: L.riskTypes.weaving,
      detail: lang === 'ja' ? '中難度組織' : '中等难度组织',
      level: 'medium'
    });
  }

  // 5. 収縮リスク
  let maxShrinkage = 0;
  [warpYarn, weftYarn].forEach(y => {
    y.comp.forEach(c => {
      const fc = FIBER_CONSTANTS[c.f];
      if (fc) maxShrinkage = Math.max(maxShrinkage, fc.shrinkage * (c.p / 100));
    });
  });
  if (maxShrinkage > 0.08) {
    risks.push({
      icon: '📏',
      type: 'shrinkage',
      title: L.riskTypes.shrinkage,
      detail: lang === 'ja'
        ? `収縮率${(maxShrinkage*100).toFixed(0)}%以上の可能性。防縮加工推奨。`
        : `收缩率可能超过${(maxShrinkage*100).toFixed(0)}%，建议预缩处理。`,
      level: 'high'
    });
  } else if (maxShrinkage > 0.05) {
    risks.push({
      icon: '📏',
      type: 'shrinkage',
      title: L.riskTypes.shrinkage,
      detail: lang === 'ja' ? '若干の収縮あり' : '有轻微收缩',
      level: 'low'
    });
  }

  // 6. ピリングリスク
  let maxPilling = 0;
  [warpYarn, weftYarn].forEach(y => {
    y.comp.forEach(c => {
      const fc = FIBER_CONSTANTS[c.f];
      if (fc) maxPilling = Math.max(maxPilling, fc.pilling * (c.p / 100));
    });
  });
  if (maxPilling > 3) {
    risks.push({
      icon: '🔴',
      type: 'pilling',
      title: L.riskTypes.pilling,
      detail: lang === 'ja'
        ? 'ピリング（毛玉）が発生しやすい組み合わせ'
        : '容易起球的组合',
      level: 'medium'
    });
  }

  // 7. 摩耗リスク（朱子織など）
  if (weave.cat === 'satin' && weave.chars.durability <= 3) {
    risks.push({
      icon: '👗',
      type: 'abrasion',
      title: L.riskTypes.abrasion,
      detail: lang === 'ja'
        ? '朱子織は浮きが長く摩耗に弱い。用途注意。'
        : '缎纹浮线长，耐磨性差，注意用途。',
      level: 'medium'
    });
  }

  const level = risks.some(r => r.level === 'critical') ? 'critical'
    : risks.some(r => r.level === 'high') ? 'high'
    : risks.some(r => r.level === 'medium') ? 'medium'
    : risks.length ? 'low' : 'none';

  return { risks, level };
}

// ============================================================
// 原価計算ロジック
// ============================================================
function calcCost(config) {
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const weave = getWeave(config.weaveId);
  if (!warpYarn || !weftYarn || !weave) return null;

  const widthM = (config.costFabricWidth || 150) / 100; // cm→m
  const orderLen = config.costOrderLength || 3000;

  // 経糸使用量 (kg/m): EPI × 幅(inch) × tex / 1000000 × 織り縮み
  const widthInch = widthM * 39.37;
  const warpTexVal = neToTex(warpYarn.ne);
  const weftTexVal = neToTex(weftYarn.ne);
  const crimp = weave.crimp || 1.08;

  const warpKgPerM = (config.epi * widthInch * warpTexVal * crimp) / 1000000;
  const weftKgPerM = (config.ppi * widthInch * weftTexVal * 1.03) / 1000000; // 緯糸縮み3%

  // 繊維別の実勢ベース糸単価 (USD/kg)
  const FIBER_PRICE_BASE = {
    cotton: 3.5, linen: 7, ramie: 6, wool: 8, cashmere: 60, silk: 25,
    polyester: 2, nylon: 4, viscose: 3, lyocell: 5.5, modal: 4.5,
    spandex: 8, acrylic: 2.5, ptt: 4, polyurethane: 7, polypropylene: 2.5,
    pbt: 3.5, aramid: 15, cupro: 6, paper: 3
  };
  function yarnPricePerKg(yarn) {
    let base = 0;
    yarn.comp.forEach(c => { base += (FIBER_PRICE_BASE[c.f] || 3) * (c.p / 100); });
    const qualityMult = 1 + (yarn.price - 3) * 0.25;
    return Math.max(1.5, base * qualityMult);
  }
  const warpPriceKg = yarnPricePerKg(warpYarn);
  const weftPriceKg = yarnPricePerKg(weftYarn);

  const warpCostPerM = warpKgPerM * warpPriceKg;
  const weftCostPerM = weftKgPerM * weftPriceKg;
  const yarnCostPerM = warpCostPerM + weftCostPerM;

  // 工賃（組織難度で補正）
  const diffMultiplier = 1 + (weave.diff - 1) * 0.15;
  const weavingCost = (config.costWeavingPerM || 1.5) * diffMultiplier;
  const dyeingCost = config.costDyeingPerM || 0.8;
  const finishingCost = config.costFinishingPerM || 0.5;

  const totalCostPerM = yarnCostPerM + weavingCost + dyeingCost + finishingCost;
  const totalCostPerYd = totalCostPerM * 0.9144;
  const margin = config.costMargin || 30;
  const sellingPrice = totalCostPerM / (1 - margin / 100);

  return {
    warpKgPerM: warpKgPerM.toFixed(4),
    weftKgPerM: weftKgPerM.toFixed(4),
    warpCostPerM: warpCostPerM.toFixed(2),
    weftCostPerM: weftCostPerM.toFixed(2),
    yarnCostPerM: yarnCostPerM.toFixed(2),
    weavingCost: weavingCost.toFixed(2),
    dyeingCost: dyeingCost.toFixed(2),
    finishingCost: finishingCost.toFixed(2),
    totalCostPerM: totalCostPerM.toFixed(2),
    totalCostPerYd: totalCostPerYd.toFixed(2),
    sellingPrice: sellingPrice.toFixed(2),
    totalOrderCost: (totalCostPerM * orderLen).toFixed(0),
    warpTotalKg: (warpKgPerM * orderLen).toFixed(1),
    weftTotalKg: (weftKgPerM * orderLen).toFixed(1),
  };
}

// ============================================================
// 素材ライブラリ（localStorage） - Improvement #4: エラーハンドリング強化
// ============================================================
function getLibrary() {
  try {
    const raw = localStorage.getItem('jyuko_fabric_library');
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch(e) {
    console.warn('Library load failed:', e);
    return [];
  }
}
function saveToLibrary(name) {
  try {
    const lib = getLibrary();
    const entry = {
      id: Date.now(),
      name: String(name || '').slice(0, 100),
      date: new Date().toISOString().slice(0, 10),
      config: {
        pattern: state.pattern,
        weaveId: state.weaveId, weaveCat: state.weaveCat,
        warpColors: [...state.warpColors], weftColors: [...state.weftColors],
        warpYarnId: state.warpYarnId, weftYarnId: state.weftYarnId,
        yarnCat: state.yarnCat, pitch: state.pitch, zoom: state.zoom,
        epi: state.epi, ppi: state.ppi,
        editorMatrix: state.editorMatrix, editorSize: state.editorSize,
      }
    };
    lib.unshift(entry);
    const data = JSON.stringify(lib.slice(0, 50));
    localStorage.setItem('jyuko_fabric_library', data);
    return true;
  } catch(e) {
    console.warn('Library save failed:', e);
    if (e.name === 'QuotaExceededError') {
      try {
        const lib = getLibrary().slice(0, 20);
        localStorage.setItem('jyuko_fabric_library', JSON.stringify(lib));
      } catch(e2) { /* storage full, ignore */ }
    }
    return false;
  }
}
function loadFromLibrary(id) {
  try {
    const lib = getLibrary();
    const entry = lib.find(e => e.id === id);
    if (entry && entry.config) {
      const safe = {};
      const allowedKeys = ['pattern','weaveId','weaveCat','warpColors','weftColors','warpYarnId','weftYarnId','yarnCat','pitch','zoom','epi','ppi','editorMatrix','editorSize'];
      for (const k of allowedKeys) {
        if (entry.config[k] !== undefined) safe[k] = entry.config[k];
      }
      setState({ ...safe, modal: null });
    }
  } catch(e) { console.warn('Library load entry failed:', e); }
}
function deleteFromLibrary(id) {
  try {
    const lib = getLibrary().filter(e => e.id !== id);
    localStorage.setItem('jyuko_fabric_library', JSON.stringify(lib));
  } catch(e) { console.warn('Library delete failed:', e); }
  setState({});
}

// ============================================================
// 発注シート計算
// ============================================================
function calcOrderSheet(config) {
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  const weave = getWeave(config.weaveId);
  if (!warpYarn || !weftYarn || !weave) return null;

  const widthCm = config.costFabricWidth || 150;
  const orderLen = config.costOrderLength || 3000;
  const crimp = weave.crimp || 1.08;

  // 経糸総本数 = EPI × 幅(inch) + 耳糸
  const widthInch = widthCm / 2.54;
  const warpEnds = Math.ceil(config.epi * widthInch) + 24; // 左右耳12本ずつ

  // 整経長 = 発注m + ロス (3-5%)
  const lossRate = weave.diff >= 4 ? 0.05 : 0.03;
  const warpBeamLength = Math.ceil(orderLen * crimp * (1 + lossRate));

  // 緯糸所要量 (m単位の長さ) = PPI × 発注m × 39.37(inch/m) × 幅(m) × 1.03(縮み)
  const weftLengthM = (config.ppi * orderLen * 39.37 * (widthCm / 100) * 1.03);
  const weftLengthKm = weftLengthM / 1000;

  // 織機回転数から時間概算
  const loomRpm = 200; // 標準レピア
  const pickPerMin = loomRpm * (weave.diff >= 4 ? 0.7 : 0.85); // 効率
  const totalPicks = config.ppi * orderLen * 39.37;
  const estimatedMinutes = totalPicks / pickPerMin;
  const estimatedHours = estimatedMinutes / 60;
  const estimatedDays = estimatedHours / 20; // 20h/日稼働

  // 筬密度 = EPI / 入れ本数
  const dentersPerDent = weave.cat === 'plain' ? 2 : weave.cat === 'twill' ? 2 : 2;
  const reedCount = Math.ceil(config.epi / dentersPerDent);

  // 通し方
  const drawingInMap = {
    plain: '順通し (1-2)', oxford: '順通し (1-2-1-2)',
    twill_2_1: '順通し (1-2-3)', twill_2_2: '順通し (1-2-3-4)',
    denim: '順通し (1-2-3-4)', herringbone: '山形通し',
    satin_5: '飛び通し (1-3-5-2-4)', sateen: '飛び通し',
    houndstooth: '順通し (8枚)', damask: 'ジャカード',
  };
  const drawingIn = drawingInMap[config.weaveId] || `順通し (${weave.ry}枚)`;

  // 生産注意事項
  const notes = [];
  if (warpYarn.ne > 50) notes.push('高番手経糸 → サイジング強化・低速運転推奨');
  if (weave.diff >= 4) notes.push('高難度組織 → 試織り必須');
  if (warpYarn.comp[0]?.f === 'silk') notes.push('シルク素材 → 温湿度管理徹底');
  if (warpYarn.comp[0]?.f === 'linen') notes.push('麻素材 → ネップ・節の許容基準確認');
  const physics = calcPhysicsInfo(config);
  if (physics?.warpOverLimit) notes.push('⚠️ 経糸密度が限界超過 → 設計見直し推奨');
  if (physics?.cfOverLimit) notes.push('⚠️ カバーファクター過大 → 織り縮みに注意');

  return {
    warpEnds,
    warpBeamLength,
    weftLengthKm: weftLengthKm.toFixed(1),
    estimatedHours: estimatedHours.toFixed(1),
    estimatedDays: estimatedDays.toFixed(1),
    reedCount,
    drawingIn,
    notes,
    heddleFrames: weave.ry,
    widthCm,
    orderLen,
  };
}

// ランダム生成（物理制約を考慮）
function randomGenerate() {
  const weave = WEAVE_DB[Math.floor(Math.random() * WEAVE_DB.length)];
  const yarn = YARN_DB[Math.floor(Math.random() * YARN_DB.length)];

  // 糸番手に基づいた適正密度を計算
  const fiberDensity = getFiberDensity(yarn);
  const maxDens = calcMaxDensity(yarn.ne, fiberDensity);
  const minDens = Math.max(40, Math.floor(maxDens * 0.4));
  const epi = minDens + Math.floor(Math.random() * (maxDens * 0.7 - minDens));
  const ppi = minDens + Math.floor(Math.random() * (maxDens * 0.6 - minDens));

  const warpColors = [SWATCHES[Math.floor(Math.random() * SWATCHES.length)]];
  const weftColors = [SWATCHES[Math.floor(Math.random() * SWATCHES.length)]];
  if (Math.random() > 0.5) warpColors.push(SWATCHES[Math.floor(Math.random() * SWATCHES.length)]);
  if (Math.random() > 0.5) weftColors.push(SWATCHES[Math.floor(Math.random() * SWATCHES.length)]);

  return {
    weaveId: weave.id,
    weaveCat: weave.cat,
    warpYarnId: yarn.id,
    weftYarnId: yarn.id,
    yarnCat: yarn.cat,
    warpColors,
    weftColors,
    pattern: ['check', 'stripe', 'solid'][Math.floor(Math.random() * 3)],
    epi,
    ppi,
  };
}

// ============================================================
// 描画（物理計算ベース） - Improvement #3: パターンキャッシュ最適化
// ============================================================
let _tileCache = null;
let _tileCacheKey = '';
const _gradientCache = new Map();
const GRADIENT_CACHE_MAX = 200;

function _getCachedGradient(ctx, color, isVertical, x1, y1, x2, y2) {
  const key = color + (isVertical ? 'V' : 'H');
  if (_gradientCache.has(key)) {
    const cached = _gradientCache.get(key);
    return cached;
  }
  const g = ctx.createLinearGradient(x1, y1, x2, y2);
  g.addColorStop(0, lightenColor(color, 30));
  g.addColorStop(0.5, color);
  g.addColorStop(1, darkenColor(color, 30));
  if (_gradientCache.size > GRADIENT_CACHE_MAX) _gradientCache.clear();
  _gradientCache.set(key, { stops: [lightenColor(color, 30), color, darkenColor(color, 30)] });
  return null;
}

function _makeTileCacheKey(config) {
  return JSON.stringify({
    w: config.weaveId, wc: config.warpColors, fc: config.weftColors,
    wy: config.warpYarnId, fy: config.weftYarnId,
    e: config.epi, p: config.ppi, pt: config.pitch, z: config.zoom,
    pa: config.pattern, wa: config.warpArrangement, fa: config.weftArrangement,
  });
}

function drawFabric(ctx, w, h, config, withLogo = false) {
  const weave = getWeave(config.weaveId);
  const warpYarn = getYarn(config.warpYarnId);
  const weftYarn = getYarn(config.weftYarnId);
  if (!weave || !warpYarn || !weftYarn) {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#f8f6f2';
    ctx.fillRect(0, 0, w, h);
    return;
  }

  const warpFiberDensity = getFiberDensity(warpYarn);
  const weftFiberDensity = getFiberDensity(weftYarn);
  const warpDiameter_mm = calcYarnDiameter(warpYarn.ne, warpFiberDensity);
  const weftDiameter_mm = calcYarnDiameter(weftYarn.ne, weftFiberDensity);

  const baseScale = config.zoom * 3;
  const warpWidth = Math.max(1, warpDiameter_mm * baseScale);
  const weftHeight = Math.max(1, weftDiameter_mm * baseScale);
  const warpSpacing = (25.4 / config.epi) * baseScale;
  const weftSpacing = (25.4 / config.ppi) * baseScale;
  const patternPitch = config.pitch * config.zoom;
  const { matrix, rx, ry } = weave;

  const cacheKey = _makeTileCacheKey(config);
  const colorsPerRepeat = Math.max(config.warpColors.length, config.weftColors.length);
  const tileWarpCount = rx * colorsPerRepeat;
  const tileWeftCount = ry * colorsPerRepeat;
  const tileW = Math.ceil(tileWarpCount * warpSpacing) || 100;
  const tileH = Math.ceil(tileWeftCount * weftSpacing) || 100;

  if (_tileCacheKey !== cacheKey || !_tileCache) {
    const offscreen = document.createElement('canvas');
    const tw = Math.min(tileW, 800);
    const th = Math.min(tileH, 800);
    offscreen.width = tw;
    offscreen.height = th;
    const tCtx = offscreen.getContext('2d');
    tCtx.fillStyle = '#f8f6f2';
    tCtx.fillRect(0, 0, tw, th);

    for (let y = 0; y < th + weftSpacing; y += weftSpacing) {
      const yIndex = Math.floor(y / weftSpacing);
      let weftColor;
      if (config.pattern === 'solid' || config.pattern === 'stripe') {
        weftColor = config.weftColors[0];
      } else {
        weftColor = getArrangementColor(config.weftArrangement, config.weftColors, yIndex, patternPitch, y);
      }
      for (let x = 0; x < tw; x += warpSpacing) {
        const xIndex = Math.floor(x / warpSpacing);
        const mx = xIndex % rx;
        const my = yIndex % ry;
        if (!(matrix[my]?.[mx] ?? true)) {
          const gradient = tCtx.createLinearGradient(x, y - weftHeight/2, x, y + weftHeight/2);
          gradient.addColorStop(0, lightenColor(weftColor, 30));
          gradient.addColorStop(0.5, weftColor);
          gradient.addColorStop(1, darkenColor(weftColor, 30));
          tCtx.fillStyle = gradient;
          tCtx.fillRect(x, y - weftHeight/2, warpSpacing + 1, weftHeight);
        }
      }
    }
    for (let x = 0; x < tw + warpSpacing; x += warpSpacing) {
      const xIndex = Math.floor(x / warpSpacing);
      let warpColor;
      if (config.pattern === 'solid') {
        warpColor = config.warpColors[0];
      } else {
        warpColor = getArrangementColor(config.warpArrangement, config.warpColors, xIndex, patternPitch, x);
      }
      for (let y = 0; y < th; y += weftSpacing) {
        const yIndex = Math.floor(y / weftSpacing);
        const mx = xIndex % rx;
        const my = yIndex % ry;
        if (matrix[my]?.[mx] ?? true) {
          const gradient = tCtx.createLinearGradient(x - warpWidth/2, y, x + warpWidth/2, y);
          gradient.addColorStop(0, lightenColor(warpColor, 30));
          gradient.addColorStop(0.5, warpColor);
          gradient.addColorStop(1, darkenColor(warpColor, 30));
          tCtx.fillStyle = gradient;
          tCtx.fillRect(x - warpWidth/2, y, warpWidth, weftSpacing + 1);
        }
      }
    }
    tCtx.globalCompositeOperation = 'multiply';
    tCtx.globalAlpha = 0.08;
    for (let y = 0; y < th; y += weftSpacing) {
      for (let x = 0; x < tw; x += warpSpacing) {
        const warpC = config.pattern === 'solid'
          ? config.warpColors[0]
          : config.warpColors[Math.floor(x / patternPitch) % config.warpColors.length];
        const weftC = (config.pattern === 'solid' || config.pattern === 'stripe')
          ? config.weftColors[0]
          : config.weftColors[Math.floor(y / patternPitch) % config.weftColors.length];
        tCtx.fillStyle = blendColors(warpC, weftC, 0.5);
        tCtx.fillRect(x - warpWidth/2, y - weftHeight/2, warpWidth, weftHeight);
      }
    }
    tCtx.globalCompositeOperation = 'source-over';
    tCtx.globalAlpha = 1.0;

    try {
      _tileCache = ctx.createPattern(offscreen, 'repeat');
    } catch(e) {
      _tileCache = null;
    }
    _tileCacheKey = cacheKey;
  }

  ctx.clearRect(0, 0, w, h);
  if (_tileCache) {
    ctx.fillStyle = _tileCache;
    ctx.fillRect(0, 0, w, h);
  } else {
    ctx.fillStyle = '#f8f6f2';
    ctx.fillRect(0, 0, w, h);
  }

  if (withLogo) {
    ctx.save();
    ctx.font = 'bold 18px Arial';
    ctx.fillStyle = '#7cb342';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'bottom';
    ctx.fillText('JYUKO co.,ltd', w - 10, h - 10);
    ctx.restore();
  }
}

// ============================================================
// アプリケーション状態
// ============================================================
const app = document.getElementById('app');
let state = {
  lang: 'ja',
  pattern: 'check',
  checkPresetId: null,
  checkPresetCat: null,
  weaveId: 'oxford',
  weaveCat: 'plain',
  warpColors: ['#1d3557', '#e76f51'],
  weftColors: ['#ffffff', '#e9c46a'],
  warpYarnId: 'combed_40',
  weftYarnId: 'combed_40',
  yarnCat: 'cotton',
  warpYarnCat: 'cotton',
  weftYarnCat: 'cotton',
  pitch: 28,
  zoom: 1,
  epi: 100,
  ppi: 80,
  tab: 'design',
  modal: null,
  editColor: null,
  compareMode: false,
  savedConfig: null,
  // 原価計算
  costWeavingPerM: 1.5,
  costDyeingPerM: 0.8,
  costFinishingPerM: 0.5,
  costFabricWidth: 150,
  costOrderLength: 3000,
  costMargin: 30,
  // 組織エディタ
  editorSize: 8,
  editorMatrix: null,
  // 糸配列パターン（本数指定）
  warpArrangement: null,  // null=均等, [{color,count},...]=カスタム
  weftArrangement: null,
  // Undo/Redo
  undoStack: [],
  redoStack: [],
};

// 配列パターンから糸インデックスに対応する色を取得
function getArrangementColor(arrangement, colors, index, patternPitch, pos) {
  if (arrangement && arrangement.length > 0) {
    // 配列パターンの総本数
    const totalCount = arrangement.reduce((s, a) => s + a.count, 0);
    const mod = ((index % totalCount) + totalCount) % totalCount;
    let acc = 0;
    for (const a of arrangement) {
      acc += a.count;
      if (mod < acc) return a.color;
    }
    return arrangement[0].color;
  }
  // 従来の均等分割
  return colors[Math.floor(pos / patternPitch) % colors.length];
}

// 配列パターンをcolorsから自動生成（各色1本）
function autoArrangement(colors) {
  return colors.map(c => ({ color: c, count: 1 }));
}

function setState(ns) {
  // Undo用スナップショット保存（UIのみの変更はスキップ）
  const uiOnly = Object.keys(ns).every(k => ['tab','modal','editColor','undoStack','redoStack','compareMode','savedConfig'].includes(k));
  if (!uiOnly && !ns._noUndo) {
    const snap = {};
    for (const k of ['pattern','checkPresetId','weaveId','weaveCat','warpColors','weftColors','warpYarnId','weftYarnId','yarnCat','warpYarnCat','weftYarnCat','pitch','zoom','epi','ppi','warpArrangement','weftArrangement']) {
      snap[k] = Array.isArray(state[k]) ? [...state[k]] : state[k];
    }
    state.undoStack = [...(state.undoStack||[]).slice(-29), snap];
    state.redoStack = [];
  }
  delete ns._noUndo;
  Object.assign(state, ns);
  // 糸カテゴリ変更時：選択中の糸がフィルタ外なら先頭に自動切替
  if (ns.warpYarnCat !== undefined) {
    const catYarns = YARN_DB.filter(y => y.cat === state.warpYarnCat);
    if (catYarns.length > 0) {
      const ids = catYarns.map(y => y.id);
      if (!ids.includes(state.warpYarnId)) state.warpYarnId = catYarns[0].id;
    }
  }
  if (ns.weftYarnCat !== undefined) {
    const catYarns = YARN_DB.filter(y => y.cat === state.weftYarnCat);
    if (catYarns.length > 0) {
      const ids = catYarns.map(y => y.id);
      if (!ids.includes(state.weftYarnId)) state.weftYarnId = catYarns[0].id;
    }
  }
  // 旧yarnCat互換：両方同時に変更
  if (ns.yarnCat !== undefined) {
    state.warpYarnCat = state.yarnCat;
    state.weftYarnCat = state.yarnCat;
    const catYarns = YARN_DB.filter(y => y.cat === state.yarnCat);
    if (catYarns.length > 0) {
      const ids = catYarns.map(y => y.id);
      if (!ids.includes(state.warpYarnId)) state.warpYarnId = catYarns[0].id;
      if (!ids.includes(state.weftYarnId)) state.weftYarnId = catYarns[0].id;
    }
  }
  scheduleRender();
}

// ============================================================
// レンダリング関数 - Improvement #2: デバウンス＋部分更新
// ============================================================
let _renderRAF = null;
let _lastCanvasKey = '';

function scheduleRender() {
  if (_renderRAF) cancelAnimationFrame(_renderRAF);
  _renderRAF = requestAnimationFrame(() => {
    _renderRAF = null;
    render();
  });
}

function renderCanvas() {
  try {
    if (state.compareMode && state.savedConfig) {
      const cA = document.getElementById('canvasA');
      const cB = document.getElementById('canvasB');
      if (cA && cB) {
        [cA, cB].forEach((c, i) => {
          const dpr = window.devicePixelRatio || 1;
          const container = c.parentElement;
          const cw = container ? Math.min(container.clientWidth / 2 - 8, 300) : 280;
          const w = Math.max(150, cw), h = w;
          c.width = w * dpr; c.height = h * dpr;
          c.style.width = w + 'px'; c.style.height = h + 'px';
          const ctx = c.getContext('2d');
          ctx.scale(dpr, dpr);
          drawFabric(ctx, w, h, i === 0 ? state : state.savedConfig, true);
        });
      }
    } else {
      const canvas = document.getElementById('canvas');
      if (canvas) {
        const dpr = window.devicePixelRatio || 1;
        const container = canvas.parentElement;
        const maxW = container ? Math.min(container.clientWidth - 16, 600) : 500;
        const w = Math.max(200, maxW), h = w;
        canvas.width = w * dpr; canvas.height = h * dpr;
        canvas.style.width = '100%'; canvas.style.maxWidth = w + 'px';
        canvas.style.height = 'auto'; canvas.style.aspectRatio = '1';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        drawFabric(ctx, w, h, state, true);
      }
    }
  } catch(e) {
    console.warn('Canvas rendering failed:', e);
  }
}

function render() {
  const L = LANG[state.lang];
  const weave = getWeave(state.weaveId);
  const warpYarn = getYarn(state.warpYarnId);
  const weftYarn = getYarn(state.weftYarnId);
  const risks = analyzeRisks(state, state.lang);
  const gsm = calcGSM(state);
  const physics = calcPhysicsInfo(state);
  const season = judgeSeason(state);
  const similar = findSimilar(state);
  const fabricId = identifyFabric(state);
  const riskColors = { none: '#10B981', low: '#84CC16', medium: '#F59E0B', high: '#EF4444', critical: '#DC2626' };

  app.innerHTML = `
    <!-- ヘッダー -->
    <header class="mb-6 no-print animate-in">
      <div class="header-accent h-1 rounded-full mb-4"></div>
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
          </div>
          <div>
            <h1 class="text-xl font-bold tracking-tight text-white">${L.title}</h1>
            <p class="text-xs text-slate-400 tracking-wide">${L.subtitle}</p>
          </div>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <button onclick="setState({lang: state.lang === 'ja' ? 'zh' : 'ja'})" class="btn-ghost px-3 py-1.5 rounded-lg text-sm font-medium" aria-label="${state.lang === 'ja' ? '中国語に切替' : '切换到日语'}">
            ${state.lang === 'ja' ? '🇨🇳 中文' : '🇯🇵 日本語'}
          </button>
          ${risks.risks.length > 0 ? `<button onclick="setState({modal:'risk'})" class="px-3 py-1.5 rounded-lg text-white text-sm font-medium" style="background:${riskColors[risks.level]};box-shadow:0 2px 8px ${riskColors[risks.level]}40" aria-label="${risks.risks.length} ${L.risks}">${risks.risks.length} ${L.risks}</button>` : `<span class="px-3 py-1.5 rounded-lg bg-emerald-500/10 text-emerald-400 text-sm border border-emerald-500/20" role="status">${L.noRisk}</span>`}
          <button onclick="setState({modal:'selling'})" class="btn-primary px-3 py-1.5 rounded-lg text-sm font-medium" aria-label="${L.sellingPoints}">${L.sellingPoints}</button>
        </div>
      </div>
    </header>

    <!-- タブ -->
    <nav class="tab-bar flex gap-1 mb-5 p-1 rounded-xl w-fit flex-wrap no-print" role="tablist" aria-label="${state.lang === 'ja' ? '設定タブ' : '设置选项卡'}">
      ${['design', 'weave', 'yarn', 'specs', 'tools'].map(t => `
        <button onclick="setState({tab:'${t}'})" class="tab-item px-5 py-2 rounded-lg text-sm font-medium ${state.tab === t ? 'active' : ''}" role="tab" aria-selected="${state.tab === t}" aria-controls="panel-${t}">${L.tabs[t]}</button>
      `).join('')}
    </nav>

    <!-- メインコンテンツ -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 animate-in">
      <section class="lg:col-span-5 glass rounded-2xl p-5 space-y-4 no-print" role="tabpanel" id="panel-${state.tab}">
        ${state.tab === 'design' ? renderDesign(L) : ''}
        ${state.tab === 'weave' ? renderWeave(L, weave) : ''}
        ${state.tab === 'yarn' ? renderYarn(L, warpYarn, weftYarn) : ''}
        ${state.tab === 'specs' ? renderSpecs(L, weave, warpYarn, weftYarn, gsm, physics, season, similar, fabricId) : ''}
        ${state.tab === 'tools' ? renderTools(L) : ''}
      </section>

      <section class="lg:col-span-7 glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium text-white">${L.preview}</h2>
          <div class="flex items-center gap-2">
            ${physics && (physics.warpOverLimit || physics.weftOverLimit) ? `<span class="px-2 py-1 bg-red-500/10 text-red-400 text-xs rounded-lg border border-red-500/20">${L.warning}: ${L.densityWarning}</span>` : ''}
            ${fabricId && fabricId.topName ? `<span class="px-2 py-1 ${fabricId.certainty === 'definite' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : fabricId.certainty === 'likely' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-amber-500/10 text-amber-400 border-amber-500/20'} text-xs rounded-lg border font-medium">${fabricId.topName[state.lang]}</span>` : ''}
            <span class="text-sm text-slate-400">${weave?.name[state.lang] || ''}</span>
          </div>
        </div>

        ${state.compareMode && state.savedConfig ? `
          <div class="grid grid-cols-2 gap-2 mb-2 items-center">
            <div class="text-center text-sm font-medium text-slate-300">${L.fabricA} (${L.current})</div>
            <div class="text-center text-sm font-medium text-slate-300">${L.fabricB}</div>
          </div>
          <div class="flex justify-center mb-2">
            <button onclick="swapCompare()" class="px-3 py-1 rounded-lg text-xs btn-ghost flex items-center gap-1">⇄ ${state.lang==='ja'?'A↔B 入替':'A↔B swap'}</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <canvas id="canvasA" class="rounded-xl border border-slate-700/50 shadow-inner w-full"></canvas>
            <canvas id="canvasB" class="rounded-xl border border-slate-700/50 shadow-inner w-full"></canvas>
          </div>
        ` : `
          <div class="flex justify-center">
            <canvas id="canvas" class="rounded-xl border border-slate-700/50 shadow-2xl shadow-black/20" style="max-width:100%;width:100%" role="img" aria-label="${state.lang === 'ja' ? '生地プレビュー' : '面料预览'}"></canvas>
          </div>
        `}

        ${physics ? `
          <div class="mt-4 info-card" aria-live="polite" aria-atomic="true">
            <h4 class="font-medium text-sm mb-3 text-slate-300">${L.physicsInfo}</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
              <div>
                <div class="text-slate-500">${L.yarnDiameter} (${L.warpYarn})</div>
                <div class="font-bold text-white">${physics.warpDiameter} mm</div>
              </div>
              <div>
                <div class="text-slate-500">${L.yarnDiameter} (${L.weftYarn})</div>
                <div class="font-bold text-white">${physics.weftDiameter} mm</div>
              </div>
              <div>
                <div class="text-slate-500">${L.coverFactor}</div>
                <div class="font-bold ${parseFloat(physics.totalCF) > 28 ? 'text-red-400' : 'text-white'}">${physics.totalCF}</div>
              </div>
              <div>
                <div class="text-slate-500">${L.thickness}</div>
                <div class="font-bold text-white">${physics.thickness} mm</div>
              </div>
              <div>
                <div class="text-slate-500">${L.maxDensity} (${L.warpYarn})</div>
                <div class="font-bold ${physics.warpOverLimit ? 'text-red-400' : 'text-white'}">${physics.warpMaxDensity}/in</div>
              </div>
              <div>
                <div class="text-slate-500">${L.maxDensity} (${L.weftYarn})</div>
                <div class="font-bold ${physics.weftOverLimit ? 'text-red-400' : 'text-white'}">${physics.weftMaxDensity}/in</div>
              </div>
              <div>
                <div class="text-slate-500">CF (${L.warpYarn})</div>
                <div class="font-bold text-white">${physics.warpCF}</div>
              </div>
              <div>
                <div class="text-slate-500">CF (${L.weftYarn})</div>
                <div class="font-bold text-white">${physics.weftCF}</div>
              </div>
            </div>
          </div>
        ` : ''}

        <div class="mt-4 no-print">
          <label class="block text-sm font-medium mb-2 text-slate-300">${L.quickColors}</label>
          <div class="flex flex-wrap gap-1.5">
            ${SWATCHES.map(hex => `<button class="color-swatch w-6 h-6 rounded-md" style="background:${hex}" onclick="quickColor('${hex}')" title="${hex}" aria-label="${state.lang === 'ja' ? '色を適用' : '应用颜色'}: ${hex}"></button>`).join('')}
          </div>
        </div>
      </section>
    </div>

    <!-- フッター -->
    <footer class="mt-8 py-4 text-center no-print">
      <div class="text-xs text-slate-500">先染めシミュレーター V3 — Yarn-Dyed Fabric Simulator</div>
    </footer>

    ${state.modal === 'arrangement' ? renderArrangementModal(L) : ''}
    ${state.modal === 'risk' ? renderRiskModal(L, risks, riskColors) : ''}
    ${state.modal === 'selling' ? renderSellingModal(L) : ''}
    ${state.modal === 'spec' ? renderSpecModal(L, weave, warpYarn, weftYarn, gsm, physics, season) : ''}
    ${state.modal === 'glossary' ? renderGlossaryModal(L) : ''}
    ${state.modal === 'pantone' ? renderPantoneModal(L) : ''}
    ${state.modal === 'trend' ? renderTrendModal(L) : ''}
    ${state.modal === 'cost' ? renderCostModal(L) : ''}
    ${state.modal === 'library' ? renderLibraryModal(L) : ''}
    ${state.modal === 'weaveEditor' ? renderWeaveEditorModal(L) : ''}
    ${state.modal === 'orderSheet' ? renderOrderSheetModal(L) : ''}
    ${state.modal === 'export' ? renderExportModal(L) : ''}
    ${state.modal === 'swatch' ? renderSwatchModal(L) : ''}
  `;

  setTimeout(renderCanvas, 0);
}

function renderDesign(L) {
  const checkPresetPanel = state.pattern === 'check' ? (() => {
    const catKeys = Object.keys(CHECK_CATEGORIES);
    const activeCat = state.checkPresetCat;
    const filteredPatterns = activeCat ? CHECK_PATTERNS.filter(p => p.cat === activeCat) : [];
    const activePreset = state.checkPresetId ? CHECK_PATTERNS.find(p => p.id === state.checkPresetId) : null;
    return `
    <div class="mt-3 p-3 glass-light rounded-xl">
      <div class="flex items-center justify-between mb-2">
        <label class="text-sm font-medium text-slate-300">${L.checkPreset}</label>
        ${activePreset ? `<span class="text-xs px-2 py-0.5 bg-indigo-500/20 text-indigo-300 rounded-full border border-indigo-500/30">${activePreset.name[state.lang]}</span>` : ''}
      </div>
      <p class="text-xs text-slate-500 mb-2">${L.checkPresetHint}</p>
      <!-- カテゴリ横スクロールタブ -->
      <div class="flex gap-1.5 overflow-x-auto pb-1 mb-2 scrollbar-hide">
        ${catKeys.map(k => {
          const cnt = CHECK_PATTERNS.filter(p => p.cat === k).length;
          return `<button onclick="toggleCheckCat('${k}')" class="flex-shrink-0 px-2.5 py-1 rounded-full text-xs font-medium border transition-all whitespace-nowrap ${activeCat === k ? 'btn-ghost active' : 'btn-ghost'}">${CHECK_CATEGORIES[k][state.lang]} <span class="opacity-60">${cnt}</span></button>`;
        }).join('')}
      </div>
      <!-- カテゴリ選択時のプリセット一覧 -->
      ${activeCat ? `
        <div class="grid grid-cols-1 gap-1.5 max-h-52 overflow-y-auto pr-1">
          ${filteredPatterns.map(p => `
            <button onclick="applyCheckPreset('${p.id}')" class="flex items-center gap-2 px-2.5 py-2 rounded-lg border text-left text-xs transition-all ${state.checkPresetId === p.id ? 'bg-indigo-500/20 text-indigo-200 border-indigo-500/30' : 'btn-ghost hover:border-slate-500'}">
              <span class="flex gap-0.5 flex-shrink-0">${p.warpColors.slice(0,6).map(c => `<span class="inline-block w-3 h-3 rounded-sm border border-white/10" style="background:${c}"></span>`).join('')}</span>
              <span class="font-medium flex-shrink-0">${p.name[state.lang]}</span>
              <span class="truncate ${state.checkPresetId === p.id ? 'text-indigo-400' : 'text-slate-500'}">${p.desc[state.lang]}</span>
            </button>
          `).join('')}
        </div>
      ` : ''}
    </div>
  `;
  })() : '';
  return `
    <div>
      <label class="block text-sm font-medium mb-2 text-slate-300">${L.pattern}</label>
      <div class="flex gap-2 flex-wrap">
        ${['check', 'stripe', 'solid'].map(p => `<button onclick="setState({pattern:'${p}'})" class="px-4 py-2 rounded-lg text-sm btn-ghost ${state.pattern === p ? 'active' : ''}">${L.patterns[p]}</button>`).join('')}
      </div>
      ${checkPresetPanel}
    </div>
    ${renderColorMgr('warp', L.warpColor, state.warpColors, L)}
    <div class="flex justify-center gap-2">
      <button onclick="setState({weftColors:[...state.warpColors]})" class="px-3 py-1.5 rounded-lg text-xs btn-ghost flex items-center gap-1.5 hover:text-indigo-300" title="${state.lang==='ja'?'経糸の配色を緯糸にコピー':'将经纱配色复制到纬纱'}">
        <span>↓</span> ${state.lang==='ja'?'経→緯 配色コピー':'经→纬 复制配色'}
      </button>
      <button onclick="setState({modal:'arrangement'})" class="px-3 py-1.5 rounded-lg text-xs btn-ghost flex items-center gap-1.5 hover:text-indigo-300">
        <span>🧵</span> ${state.lang==='ja'?'配列本数':'排列本数'}
      </button>
    </div>
    ${renderColorMgr('weft', L.weftColor, state.weftColors, L)}
    <div>
      <label class="block text-sm font-medium mb-1 text-slate-300">${L.pitch}: <span class="font-bold text-white">${state.pitch}px</span></label>
      <input type="range" min="8" max="80" value="${state.pitch}" onchange="setState({pitch:+this.value})" class="w-full">
    </div>
    <div>
      <label class="block text-sm font-medium mb-1 text-slate-300">${L.zoom}: <span class="font-bold text-white">${state.zoom.toFixed(1)}x</span></label>
      <input type="range" min="0.5" max="3" step="0.1" value="${state.zoom}" onchange="setState({zoom:+this.value})" class="w-full">
      <div class="flex gap-2 mt-1">${[0.5,1,1.5,2,3].map(z => `<button onclick="setState({zoom:${z}})" class="px-2 py-1 text-xs rounded btn-ghost ${state.zoom===z?'active':''}">${z}x</button>`).join('')}</div>
    </div>
  `;
}

function renderColorMgr(type, label, colors, L) {
  return `
    <div>
      <label class="block text-sm font-medium mb-2 text-slate-300 tooltip" data-tip="${type === 'warp' ? (state.lang === 'ja' ? '縦方向の糸' : '纵向纱线') : (state.lang === 'ja' ? '横方向の糸' : '横向纱线')}">${label}</label>
      <div class="flex flex-wrap gap-2 items-center">
        ${colors.map((c, i) => `
          <div class="relative group">
            <button class="w-10 h-10 rounded-lg border-2 border-white/10 shadow-lg hover:border-white/30 hover:scale-105 transition-all" style="background:${c};box-shadow:0 2px 10px ${c}40" onclick="toggleEdit('${type}',${i})" aria-label="${state.lang==='ja'?'色を編集':'编辑颜色'}: ${c}"></button>
            ${colors.length > 1 ? `<button onclick="removeColor('${type}',${i})" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity" aria-label="${state.lang==='ja'?'この色を削除':'删除此颜色'}">×</button>` : ''}
            ${state.editColor === type + i ? `
              <div class="absolute top-12 z-20 glass rounded-xl shadow-2xl p-3 border border-slate-600/30" style="min-width:180px;right:0;transform:translateX(min(0px, calc(100vw - 100% - 16px)))">
                <input type="color" value="${c}" onchange="updColor('${type}',${i},this.value)" class="w-full h-8 mb-2 rounded-lg">
                <div class="grid grid-cols-5 gap-1">${SWATCHES.slice(0,15).map(hex => `<button class="color-swatch w-6 h-6 rounded-md" style="background:${hex}" onclick="updColor('${type}',${i},'${hex}');setState({editColor:null})"></button>`).join('')}</div>
              </div>
            ` : ''}
          </div>
        `).join('')}
        ${colors.length < 8 ? `<button onclick="addColor('${type}')" class="w-10 h-10 rounded-lg border-2 border-dashed border-slate-500 text-slate-500 hover:border-indigo-400 hover:text-indigo-400 transition-colors" aria-label="${state.lang==='ja'?'色を追加':'添加颜色'}">+</button>` : ''}
      </div>
    </div>
  `;
}

// 織り組織ミニプレビュー付きボタン
function renderWeaveButton(w, state, L) {
  const sz = Math.min(w.rx, 8);
  const sy = Math.min(w.ry, 8);
  let svgCells = '';
  for (let r = 0; r < sy; r++) {
    for (let c = 0; c < sz; c++) {
      const on = w.matrix[r % w.ry]?.[c % w.rx];
      svgCells += '<rect x="'+(c*4)+'" y="'+(r*4)+'" width="3.5" height="3.5" rx="0.5" fill="'+(on ? '#94a3b8' : '#1e293b')+'"/>';
    }
  }
  const isActive = state.weaveId === w.id;
  return '<button onclick="setState({weaveId:\''+w.id+'\'})" class="p-2 rounded-lg text-left btn-ghost flex items-center gap-2 '+(isActive?'active':'')+'">'
    + '<svg viewBox="0 0 '+(sz*4)+' '+(sy*4)+'" class="w-8 h-8 flex-shrink-0 rounded border border-slate-600/30" style="background:#0f172a">'+svgCells+'</svg>'
    + '<div><div class="font-medium text-xs">'+w.name[state.lang]+'</div><div class="text-xs '+(isActive?'text-indigo-300':'text-slate-500')+'">'+'★'.repeat(w.diff)+'</div></div>'
    + '</button>';
}

function renderWeave(L, weave) {
  const filtered = WEAVE_DB.filter(w => w.cat === state.weaveCat);
  return `
    <div>
      <label class="block text-sm font-medium mb-2 text-slate-300">${L.weaveCategory}</label>
      <div class="flex flex-wrap gap-2">
        ${Object.keys(L.weaveCategories).map(c => `<button onclick="setWeaveCat('${c}')" class="px-3 py-1.5 rounded-lg text-sm btn-ghost ${state.weaveCat===c?'active':''}">${L.weaveCategories[c]}</button>`).join('')}
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium mb-2 text-slate-300">${L.selectWeave}</label>
      <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
        ${filtered.map(w => renderWeaveButton(w, state, L)).join('')}
      </div>
    </div>
    ${weave ? `
      <div class="info-card">
        <h4 class="font-medium mb-2 text-white">${weave.name[state.lang]}</h4>
        <div class="grid grid-cols-5 gap-1 text-xs">
          ${Object.entries(weave.chars).map(([k,v]) => `<div class="text-center"><div class="font-medium text-white">${v}/5</div><div class="text-slate-500">${L.characteristics[k]||k}</div></div>`).join('')}
        </div>
        <div class="mt-2 flex flex-wrap gap-1">${(weave.apps[state.lang]||[]).map(a => `<span class="px-2 py-0.5 bg-slate-600/50 rounded text-xs text-slate-300">${a}</span>`).join('')}</div>
      </div>
    ` : ''}
  `;
}

function renderYarn(L, warpYarn, weftYarn) {
  const warpFiltered = YARN_DB.filter(y => y.cat === state.warpYarnCat);
  const weftFiltered = YARN_DB.filter(y => y.cat === state.weftYarnCat);
  const physics = calcPhysicsInfo(state);

  return `
    <!-- 経糸セクション -->
    <div class="border border-slate-600/30 rounded-xl p-4 space-y-3">
      <h4 class="font-medium text-sm text-indigo-300 flex items-center gap-2"><span>🧵</span> ${L.warpYarn}</h4>
      <div>
        <label class="block text-xs font-medium mb-1.5 text-slate-400">${L.yarnCategory}</label>
        <div class="flex flex-wrap gap-1.5">
          ${Object.keys(L.fiberCategories).map(c => `<button onclick="setState({warpYarnCat:'${c}'})" class="px-2.5 py-1 rounded-lg text-xs btn-ghost ${state.warpYarnCat===c?'active':''}">${L.fiberCategories[c]}</button>`).join('')}
        </div>
      </div>
      <div>
        <select onchange="setState({warpYarnId:this.value})" class="w-full p-2 rounded-lg text-sm">
          ${warpFiltered.map(y => `<option value="${y.id}" ${state.warpYarnId===y.id?'selected':''}>${y.name[state.lang]} (${y.ne}Ne)</option>`).join('')}
        </select>
        ${warpYarn ? `<div class="text-xs text-slate-500 mt-1">${L.yarnDiameter}: ${physics?.warpDiameter || '-'}mm | ${L.maxDensity}: ${physics?.warpMaxDensity || '-'}/in</div>` : ''}
      </div>
      ${warpYarn ? `
        <div class="info-card">
          <div class="text-xs text-slate-400 mb-2">${getComp(warpYarn, state.lang)}</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            ${Object.entries(warpYarn.chars).slice(0,6).map(([k,v]) => `<div><div class="font-medium text-white">${v}/5</div><div class="text-slate-500">${L.characteristics[k]||k}</div></div>`).join('')}
          </div>
          <div class="mt-2 text-xs text-slate-400">${L.yarnTwist}: <span class="font-medium text-slate-200">${L.twistValues?.[warpYarn.twist] || warpYarn.twist}</span></div>
        </div>
      ` : ''}
    </div>

    <!-- 緯糸セクション -->
    <div class="border border-slate-600/30 rounded-xl p-4 space-y-3">
      <h4 class="font-medium text-sm text-amber-300 flex items-center gap-2"><span>🪡</span> ${L.weftYarn}</h4>
      <div>
        <label class="block text-xs font-medium mb-1.5 text-slate-400">${L.yarnCategory}</label>
        <div class="flex flex-wrap gap-1.5">
          ${Object.keys(L.fiberCategories).map(c => `<button onclick="setState({weftYarnCat:'${c}'})" class="px-2.5 py-1 rounded-lg text-xs btn-ghost ${state.weftYarnCat===c?'active':''}">${L.fiberCategories[c]}</button>`).join('')}
        </div>
      </div>
      <div>
        <select onchange="setState({weftYarnId:this.value})" class="w-full p-2 rounded-lg text-sm">
          ${weftFiltered.map(y => `<option value="${y.id}" ${state.weftYarnId===y.id?'selected':''}>${y.name[state.lang]} (${y.ne}Ne)</option>`).join('')}
        </select>
        ${weftYarn ? `<div class="text-xs text-slate-500 mt-1">${L.yarnDiameter}: ${physics?.weftDiameter || '-'}mm | ${L.maxDensity}: ${physics?.weftMaxDensity || '-'}/in</div>` : ''}
      </div>
      ${weftYarn ? `
        <div class="info-card">
          <div class="text-xs text-slate-400 mb-2">${getComp(weftYarn, state.lang)}</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            ${Object.entries(weftYarn.chars).slice(0,6).map(([k,v]) => `<div><div class="font-medium text-white">${v}/5</div><div class="text-slate-500">${L.characteristics[k]||k}</div></div>`).join('')}
          </div>
          <div class="mt-2 text-xs text-slate-400">${L.yarnTwist}: <span class="font-medium text-slate-200">${L.twistValues?.[weftYarn.twist] || weftYarn.twist}</span></div>
        </div>
      ` : ''}
    </div>
  `;
}

function renderSpecs(L, weave, warpYarn, weftYarn, gsm, physics, season, similar, fabricId) {
  const seasonLabel = season === 'ss' ? L.springSum : season === 'aw' ? L.autumnWin : L.allSeason;
  const seasonColor = season === 'ss' ? 'bg-orange-500/10 text-orange-400 border-orange-500/20' : season === 'aw' ? 'bg-indigo-500/100/10 text-blue-400 border-blue-500/20' : 'bg-slate-500/10 text-slate-400 border-slate-500/20';

  // 密度スライダーの適正範囲
  const warpMax = physics?.warpMaxDensity || 200;
  const weftMax = physics?.weftMaxDensity || 200;

  // 生地名判定パネル
  const fabricIdPanel = (() => {
    if (!fabricId || !fabricId.results || fabricId.results.length === 0) return '';
    const top = fabricId.results[0];
    const certLabel = L['fabricName_' + (fabricId.certainty || 'unknown')];
    const certColor = fabricId.certainty === 'definite' ? 'from-emerald-500/20 to-emerald-600/10 border-emerald-500/30'
      : fabricId.certainty === 'likely' ? 'from-blue-500/20 to-blue-600/10 border-blue-500/30'
      : fabricId.certainty === 'uncertain' ? 'from-amber-500/20 to-amber-600/10 border-amber-500/30'
      : 'from-slate-500/20 to-slate-600/10 border-slate-500/30';
    const certTextColor = fabricId.certainty === 'definite' ? 'text-emerald-300'
      : fabricId.certainty === 'likely' ? 'text-blue-300'
      : fabricId.certainty === 'uncertain' ? 'text-amber-300'
      : 'text-slate-400';
    const confBar = (conf) => {
      const color = conf >= 85 ? '#10b981' : conf >= 65 ? '#3b82f6' : conf >= 45 ? '#f59e0b' : '#94a3b8';
      return '<div style="height:6px;background:rgba(148,163,184,0.15);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+conf+'%;background:'+color+';border-radius:3px;transition:width 0.3s"></div></div>';
    };

    let html = '<div class="info-card bg-gradient-to-br '+certColor+' border" style="border-radius:16px;padding:16px">';
    html += '<div class="flex items-center justify-between mb-3">';
    html += '<h4 class="font-bold text-white flex items-center gap-2"><span class="text-lg">🏷️</span> '+L.fabricIdentify+'</h4>';
    html += '<span class="px-2.5 py-1 rounded-full text-xs font-bold '+certTextColor+' border" style="border-color:currentColor;opacity:0.9">'+certLabel+'</span>';
    html += '</div>';

    // メイン候補（大きく表示）
    html += '<div class="mb-3">';
    html += '<div class="text-2xl font-bold text-white mb-1" style="letter-spacing:0.02em">'+top.name[state.lang]+'</div>';
    html += '<div class="flex items-center gap-3 mb-2">';
    html += '<span class="text-xs '+certTextColor+'">'+L.fabricName_confidence+': '+top.confidence+'%</span>';
    html += '<div class="flex-1">'+confBar(top.confidence)+'</div>';
    html += '</div>';
    html += '<div class="text-xs text-slate-400 leading-relaxed">'+top.desc[state.lang]+'</div>';
    html += '</div>';

    // 2位以下の候補（不確定時に表示）
    if (fabricId.results.length > 1 && (fabricId.certainty === 'uncertain' || fabricId.certainty === 'likely')) {
      html += '<div class="border-t border-white/10 pt-3 mt-2">';
      html += '<div class="text-xs font-medium text-slate-400 mb-2">'+L.fabricName_candidates+'</div>';
      html += '<div class="space-y-1.5">';
      fabricId.results.slice(1, 4).forEach(r => {
        html += '<div class="flex items-center gap-2">';
        html += '<span class="text-sm font-medium text-slate-200 flex-shrink-0" style="min-width:120px">'+r.name[state.lang]+'</span>';
        html += '<div class="flex-1">'+confBar(r.confidence)+'</div>';
        html += '<span class="text-xs text-slate-500 flex-shrink-0 w-10 text-right">'+r.confidence+'%</span>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    // 注記
    if (fabricId.certainty === 'uncertain') {
      html += '<div class="mt-3 px-3 py-2 rounded-lg text-xs text-amber-300/80" style="background:rgba(245,158,11,0.08)">' + L.fabricName_note_uncertain + '</div>';
    } else if (fabricId.certainty === 'definite') {
      html += '<div class="mt-3 px-3 py-2 rounded-lg text-xs text-emerald-300/80" style="background:rgba(16,185,129,0.08)">' + L.fabricName_note_definite + '</div>';
    }

    html += '</div>';
    return html;
  })();

  return `
    ${fabricIdPanel}

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300 tooltip" data-tip="Ends Per Inch">${L.epi}</label>
        <div class="flex items-center gap-2">
          <input type="range" min="30" max="${Math.min(250, warpMax + 20)}" value="${state.epi}" oninput="setState({epi:+this.value})" class="flex-1">
          <input type="number" min="30" max="250" value="${state.epi}" onchange="setState({epi:Math.max(30,Math.min(250,+this.value))})" class="w-16 px-2 py-1 rounded-lg text-sm text-center font-bold ${physics?.warpOverLimit ? 'text-red-400 border-red-500/50' : 'text-white'}" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
        </div>
        <div class="text-xs text-slate-500">${L.recommended}: 40-${warpMax}</div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300 tooltip" data-tip="Picks Per Inch">${L.ppi}</label>
        <div class="flex items-center gap-2">
          <input type="range" min="30" max="${Math.min(250, weftMax + 20)}" value="${state.ppi}" oninput="setState({ppi:+this.value})" class="flex-1">
          <input type="number" min="30" max="250" value="${state.ppi}" onchange="setState({ppi:Math.max(30,Math.min(250,+this.value))})" class="w-16 px-2 py-1 rounded-lg text-sm text-center font-bold ${physics?.weftOverLimit ? 'text-red-400 border-red-500/50' : 'text-white'}" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
        </div>
        <div class="text-xs text-slate-500">${L.recommended}: 40-${weftMax}</div>
      </div>
    </div>

    ${gsm ? `
      <div class="info-card">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg font-bold text-white tooltip" data-tip="Grams per Square Meter">${gsm.gsm} <span class="text-sm font-normal text-slate-400">gsm</span></div>
            <div class="text-sm text-slate-400">${L.weightCat[gsm.cat]}</div>
          </div>
          <div class="px-3 py-1 rounded-full text-sm border ${seasonColor}">${L.season}: ${seasonLabel}</div>
        </div>
      </div>
    ` : ''}

    <div class="info-card space-y-2">
      <h4 class="font-medium text-white">${L.fabricSummary}</h4>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><div class="text-slate-500">${L.weaveType}</div><div class="font-medium text-slate-200">${weave?.name[state.lang]||'-'}</div></div>
        <div><div class="text-slate-500">${L.difficulty}</div><div class="font-medium text-amber-400">${'★'.repeat(weave?.diff||1)}</div></div>
        <div><div class="text-slate-500">${L.warpYarn}</div><div class="font-medium text-slate-200">${warpYarn?.name[state.lang]||'-'}</div></div>
        <div><div class="text-slate-500">${L.weftYarn}</div><div class="font-medium text-slate-200">${weftYarn?.name[state.lang]||'-'}</div></div>
        <div><div class="text-slate-500">${L.coverFactor}</div><div class="font-medium ${parseFloat(physics?.totalCF) > 28 ? 'text-red-400' : 'text-slate-200'}">${physics?.totalCF || '-'}</div></div>
        <div><div class="text-slate-500">${L.thickness}</div><div class="font-medium text-slate-200">${physics?.thickness || '-'} mm</div></div>
      </div>
    </div>

    ${similar.length > 0 ? `
      <div class="info-card" style="background:rgba(99,102,241,0.08);border-color:rgba(99,102,241,0.15)">
        <h4 class="font-medium text-sm mb-2 text-indigo-300">${L.similar}</h4>
        <div class="flex flex-wrap gap-2">
          ${similar.map(s => `<span class="px-2 py-1 bg-indigo-500/10 text-indigo-300 rounded-lg text-xs border border-indigo-500/20">${s.name[state.lang]}</span>`).join('')}
        </div>
      </div>
    ` : ''}

    <div class="flex gap-2">
      <button onclick="downloadPng()" class="flex-1 px-4 py-2 rounded-xl btn-ghost text-sm font-medium hover:bg-slate-600/50">${L.savePng}</button>
      <button onclick="setState({modal:'export'})" class="flex-1 px-4 py-2 rounded-xl btn-ghost text-sm font-medium hover:bg-emerald-600/30 text-emerald-300">📤 ${L.exportMenu}</button>
      <button onclick="setState({modal:'spec'})" class="flex-1 px-4 py-2 rounded-xl btn-primary text-sm font-medium">${L.specSheet}</button>
    </div>
  `;
}

function renderTools(L) {
  return `
    <div class="grid grid-cols-2 gap-3">
      <button onclick="setState({modal:'cost'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">💰</div>
        <div class="font-medium text-sm">${L.costCalc}</div>
      </button>
      <button onclick="setState({modal:'library'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">📚</div>
        <div class="font-medium text-sm">${L.library}</div>
      </button>
      <button onclick="setState({modal:'weaveEditor'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">✏️</div>
        <div class="font-medium text-sm">${L.weaveEditor}</div>
      </button>
      <button onclick="setState({modal:'orderSheet'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">📋</div>
        <div class="font-medium text-sm">${L.orderSheet}</div>
      </button>
      <button onclick="setState({modal:'spec'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">📄</div>
        <div class="font-medium text-sm">${L.specSheet}</div>
      </button>
      <button onclick="toggleCompare()" class="p-4 rounded-xl btn-ghost text-left group ${state.compareMode ? 'active' : ''}">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">⚖️</div>
        <div class="font-medium text-sm">${L.compare}</div>
      </button>
      <button onclick="setState({modal:'glossary'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">📖</div>
        <div class="font-medium text-sm">${L.glossary}</div>
      </button>
      <button onclick="setState({modal:'pantone'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">🎨</div>
        <div class="font-medium text-sm">${L.pantone}</div>
      </button>
      <button onclick="setState({modal:'trend'})" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">✨</div>
        <div class="font-medium text-sm">${L.trend}</div>
      </button>
      <button onclick="applyRandom()" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">🎲</div>
        <div class="font-medium text-sm">${L.random}</div>
      </button>
      <button onclick="shareURL()" id="shareBtn" class="p-4 rounded-xl btn-ghost text-left group">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">🔗</div>
        <div class="font-medium text-sm">${state.lang==='ja'?'URL共有':'URL分享'}</div>
      </button>
      <button onclick="setState({modal:'export'})" class="p-4 rounded-xl btn-ghost text-left group">
              <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">📤</div>
              <div class="font-medium text-sm">${L.exportMenu}</div>
      </button>
      <button onclick="setState({modal:'swatch'})" class="p-4 rounded-xl btn-ghost text-left group">
              <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">🧾</div>
              <div class="font-medium text-sm">${L.swatchBook}</div>
      </button>
      <button onclick="undoState()" class="p-4 rounded-xl btn-ghost text-left group ${(state.undoStack||[]).length===0?'opacity-30':''}">
        <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">↩️</div>
        <div class="font-medium text-sm">Undo</div>
      </button>
    </div>
  `;
}

// 配列パターンエディタモーダル
function renderArrangementModal(L) {
  const ja = state.lang === 'ja';
  const warpArr = state.warpArrangement || autoArrangement(state.warpColors);
  const weftArr = state.weftArrangement || autoArrangement(state.weftColors);
  
  function renderArrEditor(type, arr, label) {
    const total = arr.reduce((s, a) => s + a.count, 0);
    const barWidth = 200;
    let barHtml = '';
    let offset = 0;
    for (const a of arr) {
      const w = (a.count / total) * barWidth;
      barHtml += '<div style="width:'+w+'px;height:20px;background:'+a.color+'" class="inline-block border-r border-white/20" title="'+a.count+(ja?'本':'根')+'"></div>';
    }
    return '<div class="mb-4"><h4 class="text-sm font-medium text-slate-300 mb-2">'+label+' ('+total+(ja?'本リピート':'根循环')+')</h4>'
      + '<div class="flex rounded overflow-hidden mb-2" style="width:'+barWidth+'px">'+barHtml+'</div>'
      + '<div class="space-y-1.5">'
      + arr.map((a, i) => '<div class="flex items-center gap-2"><div class="w-6 h-6 rounded border border-white/20" style="background:'+a.color+'"></div>'
        + '<button onclick="changeArrCount(\''+type+'\','+i+',-1)" class="w-6 h-6 rounded btn-ghost text-xs">−</button>'
        + '<span class="text-sm font-bold text-white w-8 text-center">'+a.count+'</span>'
        + '<button onclick="changeArrCount(\''+type+'\','+i+',1)" class="w-6 h-6 rounded btn-ghost text-xs">+</button>'
        + '<span class="text-xs text-slate-500">'+(ja?'本':'根')+'</span>'
        + (arr.length > 1 ? '<button onclick="removeArrItem(\''+type+'\','+i+')" class="text-red-400 text-xs ml-auto">✕</button>' : '')
        + '</div>').join('')
      + '</div>'
      + '<button onclick="addArrItem(\''+type+'\')" class="mt-2 px-2 py-1 text-xs btn-ghost rounded">+ '+(ja?'色追加':'添加颜色')+'</button>'
      + '</div>';
  }
  
  return '<div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">'
    + '<div class="modal-content rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden animate-in" role="dialog" aria-modal="true" aria-labelledby="modal-arr-title">'
    + '<div class="p-4 border-b border-slate-700/50 flex items-center justify-between">'
    + '<h3 id="modal-arr-title" class="font-bold text-white">'+(ja?'🧵 糸配列パターンエディタ':'🧵 纱线排列编辑器')+'</h3>'
    + '<button onclick="setState({modal:null})" class="text-slate-400 hover:text-white text-xl" aria-label="'+(ja?'閉じる':'关闭')+'">✕</button>'
    + '</div>'
    + '<div class="p-4 overflow-y-auto space-y-4">'
    + '<p class="text-xs text-slate-400">'+(ja?'各色の本数を指定してリピートパターンを設定します':'指定每种颜色的根数来设定循环')+'</p>'
    + renderArrEditor('warp', warpArr, ja ? '経糸 (タテ)' : '经纱 (纵)')
    + renderArrEditor('weft', weftArr, ja ? '緯糸 (ヨコ)' : '纬纱 (横)')
    + '<div class="flex gap-2 pt-2">'
    + '<button onclick="applyArrangement()" class="flex-1 px-4 py-2 rounded-xl btn-primary text-sm">'+(ja?'適用':'应用')+'</button>'
    + '<button onclick="resetArrangement()" class="px-4 py-2 rounded-xl btn-ghost text-sm">'+(ja?'均等に戻す':'恢复均等')+'</button>'
    + '</div>'
    + '</div></div></div>';
}

function renderRiskModal(L, risks, colors) {
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden animate-in" role="dialog" aria-modal="true" aria-labelledby="modal-risk-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-risk-title" class="font-bold text-lg text-white">${L.riskAnalysis}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[60vh]">
          ${risks.risks.length === 0 ? `<p class="text-center py-8 text-slate-500">${L.noRisk}</p>` : `
            <div class="space-y-3">
              ${risks.risks.map(r => `
                <div class="p-3 rounded-lg border-l-4" style="border-color:${colors[r.level]};background:${colors[r.level]}10">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-lg">${r.icon}</span>
                    <span class="font-medium text-slate-200">${r.title}</span>
                    <span class="px-2 py-0.5 rounded text-xs text-white" style="background:${colors[r.level]}">${L.riskLevels[r.level]}</span>
                  </div>
                  <div class="text-sm text-slate-400">${r.detail || ''}</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

function renderSellingModal(L) {
  const yarn = getYarn(state.warpYarnId);
  const weave = getWeave(state.weaveId);
  const gsm = calcGSM(state);
  const physics = calcPhysicsInfo(state);
  const season = judgeSeason(state);
  const points = [];

  // 素材系
  if (yarn?.comp[0]?.f === 'cotton') {
    if (yarn.id.includes('combed')) {
      points.push({ cat: state.lang==='ja'?'素材':'材质', title: state.lang==='ja'?'上質なコーマ綿使用':'采用优质精梳棉', desc: state.lang==='ja'?'毛羽が少なく光沢があり、肌触りが良い':'毛羽少、有光泽、手感好' });
    } else {
      points.push({ cat: state.lang==='ja'?'素材':'材质', title: state.lang==='ja'?'天然コットンの心地よさ':'天然棉花的舒适感', desc: state.lang==='ja'?'吸湿性に優れ、肌に優しい':'吸湿性优异，亲肤' });
    }
  }
  if (yarn?.comp[0]?.f === 'silk') points.push({ cat: state.lang==='ja'?'素材':'材质', title: state.lang==='ja'?'シルクの上品な光沢':'丝绸的优雅光泽', desc: state.lang==='ja'?'なめらかな肌触りと高級感':'顺滑的手感和高级感' });
  if (yarn?.comp[0]?.f === 'linen') points.push({ cat: state.lang==='ja'?'素材':'材质', title: state.lang==='ja'?'リネンの清涼感':'亚麻的清凉感', desc: state.lang==='ja'?'夏に最適な天然素材':'夏季最佳天然材质' });
  if (yarn?.comp[0]?.f === 'wool') points.push({ cat: state.lang==='ja'?'素材':'材质', title: state.lang==='ja'?'ウールの保温性':'羊毛的保暖性', desc: state.lang==='ja'?'自然な温かさと弾力性':'自然的温暖和弹性' });

  // 織り系
  if (weave?.chars.drape >= 4) points.push({ cat: state.lang==='ja'?'織り':'织物', title: state.lang==='ja'?'優美なドレープ性':'优美的垂感', desc: state.lang==='ja'?'自然で美しいシルエットを実現':'实现自然美丽的轮廓' });
  if (weave?.chars.durability >= 4) points.push({ cat: state.lang==='ja'?'織り':'织物', title: state.lang==='ja'?'高い耐久性':'高耐久性', desc: state.lang==='ja'?'長期間美しさを保つ':'长期保持美观' });
  if (weave?.chars.breathability >= 4) points.push({ cat: state.lang==='ja'?'織り':'织物', title: state.lang==='ja'?'優れた通気性':'优异的透气性', desc: state.lang==='ja'?'一日中快適な着心地':'全天舒适的穿着感' });
  if (weave?.chars.shine >= 4) points.push({ cat: state.lang==='ja'?'織り':'织物', title: state.lang==='ja'?'上品な光沢':'优雅的光泽', desc: state.lang==='ja'?'高級感のある表面':'有高级感的表面' });

  // 季節系
  if (season === 'ss') points.push({ cat: state.lang==='ja'?'季節':'季节', title: state.lang==='ja'?'春夏シーズンに最適':'春夏季节最佳', desc: state.lang==='ja'?'軽量で涼しい着心地':'轻量凉爽的穿着感' });
  if (season === 'aw') points.push({ cat: state.lang==='ja'?'季節':'季节', title: state.lang==='ja'?'秋冬シーズンに最適':'秋冬季节最佳', desc: state.lang==='ja'?'暖かく快適':'温暖舒适' });

  // 物理特性系
  if (physics && parseFloat(physics.totalCF) >= 20 && parseFloat(physics.totalCF) <= 25) {
    points.push({ cat: state.lang==='ja'?'品質':'品质', title: state.lang==='ja'?'バランスの良い織り密度':'平衡的织造密度', desc: state.lang==='ja'?'適度なハリと柔らかさ':'适度的挺括和柔软' });
  }

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-selling-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-selling-title" class="font-bold text-lg text-white">${L.sellingPoints}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[60vh] space-y-3">
          ${points.map(p => `
            <div class="p-3 glass-light rounded-lg">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 bg-indigo-500/10 text-indigo-400 rounded text-xs">${p.cat}</span>
                <span class="font-medium">${p.title}</span>
              </div>
              <div class="text-sm text-slate-400">${p.desc}</div>
            </div>
          `).join('')}
          ${points.length === 0 ? `<p class="text-center py-8 text-slate-400">...</p>` : ''}
        </div>
      </div>
    </div>
  `;
}

function renderSpecModal(L, weave, warpYarn, weftYarn, gsm, physics, season) {
  const seasonLabel = season === 'ss' ? L.springSum : season === 'aw' ? L.autumnWin : L.allSeason;
  const date = new Date().toLocaleDateString(state.lang === 'ja' ? 'ja-JP' : 'zh-CN');

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-2xl w-full max-h-[90vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-spec-title">
        <div class="flex items-center justify-between p-4 border-b no-print">
          <h3 id="modal-spec-title" class="font-bold text-lg text-white">${L.specSheet}</h3>
          <div class="flex gap-2">
            <button onclick="window.print()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm" aria-label="${L.print}">${L.print}</button>
            <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
          </div>
        </div>
        <div class="p-6 overflow-y-auto" id="specContent">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h2 class="text-xl font-bold">${state.lang === 'ja' ? '生地仕様書' : '面料规格书'}</h2>
              <p class="text-sm text-slate-400">${date}</p>
            </div>
            <div class="text-right">
              <div class="font-bold text-lg" style="color:#7cb342">JYUKO co.,ltd</div>
            </div>
          </div>

          <table class="w-full border-collapse text-sm mb-6">
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400 w-1/3">${L.weaveType}</td><td class="py-2 font-medium">${weave?.name[state.lang]||'-'}</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.warpYarn}</td><td class="py-2 font-medium">${warpYarn?.name[state.lang]||'-'} (${getComp(warpYarn, state.lang)})</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.weftYarn}</td><td class="py-2 font-medium">${weftYarn?.name[state.lang]||'-'} (${getComp(weftYarn, state.lang)})</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.epi}</td><td class="py-2 font-medium">${state.epi} ${physics?.warpOverLimit ? '<span class="text-red-400">(⚠️ '+L.warning+')</span>' : ''}</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.ppi}</td><td class="py-2 font-medium">${state.ppi} ${physics?.weftOverLimit ? '<span class="text-red-400">(⚠️ '+L.warning+')</span>' : ''}</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.gsm}</td><td class="py-2 font-medium">${gsm?.gsm || '-'} g/m² (${L.weightCat[gsm?.cat]||'-'})</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.coverFactor}</td><td class="py-2 font-medium">${physics?.totalCF || '-'} (${L.warpYarn}: ${physics?.warpCF || '-'}, ${L.weftYarn}: ${physics?.weftCF || '-'})</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.yarnDiameter}</td><td class="py-2 font-medium">${L.warpYarn}: ${physics?.warpDiameter || '-'}mm, ${L.weftYarn}: ${physics?.weftDiameter || '-'}mm</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.thickness}</td><td class="py-2 font-medium">${physics?.thickness || '-'} mm</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.season}</td><td class="py-2 font-medium">${seasonLabel}</td></tr>
            <tr class="border-b border-slate-700/50"><td class="py-2 text-slate-400">${L.difficulty}</td><td class="py-2 font-medium">${'★'.repeat(weave?.diff||1)}</td></tr>
          </table>

          <div class="mb-4">
            <h4 class="font-medium mb-2">${state.lang === 'ja' ? '使用色' : '使用颜色'}</h4>
            <div class="flex gap-4">
              <div>
                <div class="text-xs text-slate-400 mb-1">${L.warpColor}</div>
                <div class="flex gap-1">
                  ${state.warpColors.map(c => {
                    const p = findNearestPantone(c);
                    return `<div class="text-center"><div class="w-8 h-8 rounded border" style="background:${c}"></div><div class="text-xs mt-1">${p.code}</div></div>`;
                  }).join('')}
                </div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-1">${L.weftColor}</div>
                <div class="flex gap-1">
                  ${state.weftColors.map(c => {
                    const p = findNearestPantone(c);
                    return `<div class="text-center"><div class="w-8 h-8 rounded border" style="background:${c}"></div><div class="text-xs mt-1">${p.code}</div></div>`;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>

          <div class="text-center text-xs text-slate-500 mt-8">
            Generated by JYUKO Fabric Simulator V3
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderGlossaryModal(L) {
  const terms = GLOSSARY[state.lang] || GLOSSARY.ja;
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-glossary-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-glossary-title" class="font-bold text-lg text-white">${L.glossary}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[60vh] space-y-3">
          ${Object.entries(terms).map(([term, def]) => `
            <div class="p-3 glass-light rounded-lg">
              <div class="font-bold text-sm mb-1">${term}</div>
              <div class="text-sm text-slate-400">${def}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderPantoneModal(L) {
  const allColors = [...state.warpColors, ...state.weftColors];
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-pantone-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-pantone-title" class="font-bold text-lg text-white">${L.pantone}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto space-y-4">
          <p class="text-sm text-slate-400">${L.nearestPantone}</p>
          ${allColors.map(c => {
            const p = findNearestPantone(c);
            return `
              <div class="flex items-center gap-4 p-3 glass-light rounded-lg">
                <div class="w-12 h-12 rounded-lg border" style="background:${c}"></div>
                <div class="flex-1">
                  <div class="text-xs text-slate-400">HEX: ${c.toUpperCase()}</div>
                  <div class="font-bold">${p.code}</div>
                  <div class="text-sm">${p.name}</div>
                </div>
                <div class="w-12 h-12 rounded-lg border" style="background:${p.hex}"></div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderTrendModal(L) {
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-trend-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-trend-title" class="font-bold text-lg text-white">${L.trend} 2025</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto space-y-4">
          <div>
            <h4 class="font-medium mb-2">${L.springSum}</h4>
            <div class="grid grid-cols-3 gap-2">
              ${TREND_COLORS_2025.ss.map(c => `
                <button onclick="applyTrendColor('${c.hex}')" class="p-2 rounded-lg border hover:border-slate-500 text-center">
                  <div class="w-full h-10 rounded mb-1" style="background:${c.hex}"></div>
                  <div class="text-xs font-medium">${c.name[state.lang]}</div>
                  <div class="text-xs text-slate-400">${c.pantone}</div>
                </button>
              `).join('')}
            </div>
          </div>
          <div>
            <h4 class="font-medium mb-2">${L.autumnWin}</h4>
            <div class="grid grid-cols-3 gap-2">
              ${TREND_COLORS_2025.aw.map(c => `
                <button onclick="applyTrendColor('${c.hex}')" class="p-2 rounded-lg border hover:border-slate-500 text-center">
                  <div class="w-full h-10 rounded mb-1" style="background:${c.hex}"></div>
                  <div class="text-xs font-medium">${c.name[state.lang]}</div>
                  <div class="text-xs text-slate-400">${c.pantone}</div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// 原価計算モーダル
// ============================================================
function renderCostModal(L) {
  const cost = calcCost(state);
  const warpYarn = getYarn(state.warpYarnId);
  const weftYarn = getYarn(state.weftYarnId);

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-2xl w-full max-h-[90vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-cost-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-cost-title" class="font-bold text-lg text-white">💰 ${L.costCalc}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[75vh] space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-400">${L.weavingCost}</label>
              <input type="number" step="0.1" value="${state.costWeavingPerM}" onchange="setState({costWeavingPerM:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div>
              <label class="text-xs text-slate-400">${L.dyeingCost}</label>
              <input type="number" step="0.1" value="${state.costDyeingPerM}" onchange="setState({costDyeingPerM:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div>
              <label class="text-xs text-slate-400">${L.finishingCost}</label>
              <input type="number" step="0.1" value="${state.costFinishingPerM}" onchange="setState({costFinishingPerM:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div>
              <label class="text-xs text-slate-400">${L.fabricWidth}</label>
              <input type="number" value="${state.costFabricWidth}" onchange="setState({costFabricWidth:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div>
              <label class="text-xs text-slate-400">${L.orderLength}</label>
              <input type="number" value="${state.costOrderLength}" onchange="setState({costOrderLength:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div>
              <label class="text-xs text-slate-400">${L.margin}</label>
              <input type="number" value="${state.costMargin}" onchange="setState({costMargin:+this.value})" class="w-full p-2 border rounded-lg text-sm">
            </div>
          </div>

          ${cost ? `
            <div class="glass-light rounded-xl p-4">
              <h4 class="font-bold text-sm mb-3">${L.costBreakdown}</h4>
              <table class="w-full text-sm">
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.warpYarnUsage}</td><td class="py-1.5 text-right">${cost.warpKgPerM} kg/m (${warpYarn?.name[state.lang]||''})</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.weftYarnUsage}</td><td class="py-1.5 text-right">${cost.weftKgPerM} kg/m (${weftYarn?.name[state.lang]||''})</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${state.lang==='ja'?'経糸コスト':'经纱费用'}</td><td class="py-1.5 text-right">$${cost.warpCostPerM}/m</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${state.lang==='ja'?'緯糸コスト':'纬纱费用'}</td><td class="py-1.5 text-right">$${cost.weftCostPerM}/m</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.totalYarnCost}</td><td class="py-1.5 text-right font-medium">$${cost.yarnCostPerM}/m</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.weavingCost}</td><td class="py-1.5 text-right">$${cost.weavingCost}/m</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.dyeingCost}</td><td class="py-1.5 text-right">$${cost.dyeingCost}/m</td></tr>
                <tr class="border-b border-slate-700/50"><td class="py-1.5 text-slate-400">${L.finishingCost}</td><td class="py-1.5 text-right">$${cost.finishingCost}/m</td></tr>
              </table>
            </div>
            <div class="grid grid-cols-3 gap-3 text-center">
              <div class="bg-indigo-500/10 rounded-xl p-3">
                <div class="text-xs text-blue-600 mb-1">${L.totalCostPerM}</div>
                <div class="text-xl font-bold text-indigo-400">$${cost.totalCostPerM}</div>
              </div>
              <div class="bg-green-50 rounded-xl p-3">
                <div class="text-xs text-green-600 mb-1">${L.sellingPrice}</div>
                <div class="text-xl font-bold text-green-700">$${cost.sellingPrice}</div>
              </div>
              <div class="bg-orange-50 rounded-xl p-3">
                <div class="text-xs text-orange-600 mb-1">${state.lang==='ja'?'発注総額':'订单总额'}</div>
                <div class="text-xl font-bold text-orange-400">$${cost.totalOrderCost}</div>
              </div>
            </div>
            <div class="info-card rounded-xl p-3 text-xs text-slate-400">
              <div class="mb-1 font-medium">${state.lang==='ja'?'発注時の糸所要量':'订单纱线需求量'}:</div>
              <div>${L.warpYarn}: ${cost.warpTotalKg} kg | ${L.weftYarn}: ${cost.weftTotalKg} kg</div>
            </div>
          ` : '<p class="text-center text-slate-500 py-4">-</p>'}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// 素材ライブラリモーダル
// ============================================================
function renderLibraryModal(L) {
  const lib = getLibrary();
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-library-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-library-title" class="font-bold text-lg text-white">📚 ${L.library}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[65vh] space-y-4">
          <div class="flex gap-2">
            <input id="libNameInput" type="text" placeholder="${L.fabricName}" class="flex-1 p-2 border rounded-lg text-sm" value="">
            <button onclick="doSaveLibrary()" class="px-4 py-2 btn-ghost active rounded-lg text-sm font-medium">${L.saveFabric}</button>
          </div>
          <div id="libSaveMsg" class="hidden text-sm text-green-600 text-center">${L.saveSuccess}</div>

          <h4 class="font-medium text-sm border-b pb-1">${L.savedFabrics}</h4>
          ${lib.length === 0 ? `<p class="text-center text-slate-500 py-4">${L.noSaved}</p>` : `
            <div class="space-y-2">
              ${lib.map(entry => `
                <div class="flex items-center gap-3 p-3 glass-light rounded-lg">
                  <div class="flex gap-0.5">
                    ${(entry.config.warpColors||[]).map(c => `<div class="w-4 h-4 rounded" style="background:${c}"></div>`).join('')}
                    ${(entry.config.weftColors||[]).map(c => `<div class="w-4 h-4 rounded border" style="background:${c}"></div>`).join('')}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm truncate">${entry.name}</div>
                    <div class="text-xs text-slate-400">${entry.date} | ${entry.config.weaveId} | EPI:${entry.config.epi} PPI:${entry.config.ppi}</div>
                  </div>
                  <button onclick="loadFromLibrary(${entry.id})" class="px-2 py-1 btn-primary rounded text-xs">${L.loadFabric}</button>
                  <button onclick="if(confirm('${L.confirmDelete}'))deleteFromLibrary(${entry.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs">${L.deleteFabric}</button>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// 織り組織エディタモーダル
// ============================================================
function renderWeaveEditorModal(L) {
  const size = state.editorSize || 8;
  // 初期化: editorMatrixがなければ現在の織りからコピー
  if (!state.editorMatrix) {
    const weave = getWeave(state.weaveId);
    if (weave) {
      const m = [];
      for (let y = 0; y < size; y++) {
        const row = [];
        for (let x = 0; x < size; x++) row.push(weave.matrix[y % weave.ry]?.[x % weave.rx] ? 1 : 0);
        m.push(row);
      }
      state.editorMatrix = m;
    } else {
      state.editorMatrix = Array.from({length: size}, () => Array(size).fill(0));
    }
  }
  const matrix = state.editorMatrix;

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-lg w-full max-h-[90vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-editor-title">
        <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
          <h3 id="modal-editor-title" class="font-bold text-lg text-white">✏️ ${L.weaveEditor}</h3>
          <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[75vh] space-y-4">
          <div class="flex items-center gap-3 flex-wrap">
            <label class="text-sm">${L.editorSize}:</label>
            ${[4,6,8,10,12,16].map(s => `<button onclick="resizeEditor(${s})" class="px-3 py-2 text-xs rounded ${size===s?'btn-ghost active':'info-card'}" style="min-width:44px;min-height:44px" aria-label="${s}×${s}">${s}×${s}</button>`).join('')}
          </div>

          <div class="flex justify-center">
            <div class="inline-grid border border-slate-600" style="grid-template-columns: repeat(${size}, 1fr);" role="grid" aria-label="${state.lang==='ja'?'織り組織グリッド':'织物组织网格'}">
              ${matrix.map((row, y) => row.map((cell, x) => `
                <button onclick="toggleEditorCell(${x},${y})"
                  class="border border-neutral-200 ${cell ? 'bg-neutral-900' : 'bg-white'} hover:opacity-70"
                  style="width:max(28px, min(44px, calc((100vw - 64px) / ${size})));height:max(28px, min(44px, calc((100vw - 64px) / ${size})))"
                  title="(${x},${y})" aria-label="${state.lang==='ja'?'セル':'单元'} ${x},${y}: ${cell?'経糸':'緯糸'}" role="gridcell" aria-pressed="${!!cell}"></button>
              `).join('')).join('')}
            </div>
          </div>

          <div class="flex items-center gap-1 text-xs text-slate-400">
            <div class="w-4 h-4 bg-neutral-900 rounded-sm"></div> = ${state.lang==='ja'?'経糸が上':'经纱浮'}
            <div class="w-4 h-4 bg-white border rounded-sm ml-2"></div> = ${state.lang==='ja'?'緯糸が上':'纬纱浮'}
          </div>

          <div class="flex gap-2 flex-wrap">
            <button onclick="editorClear()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm">${L.editorClear}</button>
            <button onclick="editorInvert()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm">${L.editorInvert}</button>
            <button onclick="editorFillPlain()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm">${state.lang==='ja'?'平織':'平纹'}</button>
            <button onclick="editorFillTwill()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm">${state.lang==='ja'?'綾織':'斜纹'}</button>
            <button onclick="editorFillSatin()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm">${state.lang==='ja'?'朱子':'缎纹'}</button>
          </div>

          <button onclick="applyCustomWeave()" class="w-full px-4 py-2.5 rounded-xl btn-primary text-sm font-medium">${L.editorApply} → ${L.customWeave}</button>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// 発注シートモーダル
// ============================================================
function renderOrderSheetModal(L) {
  const order = calcOrderSheet(state);
  const weave = getWeave(state.weaveId);
  const warpYarn = getYarn(state.warpYarnId);
  const weftYarn = getYarn(state.weftYarnId);
  const gsm = calcGSM(state);
  const date = new Date().toLocaleDateString(state.lang === 'ja' ? 'ja-JP' : 'zh-CN');

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" role="presentation">
      <div class="modal-content rounded-2xl shadow-2xl animate-in max-w-2xl w-full max-h-[90vh] overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modal-order-title">
        <div class="flex items-center justify-between p-4 border-b no-print">
          <h3 id="modal-order-title" class="font-bold text-lg text-white">📋 ${L.orderSheet}</h3>
          <div class="flex gap-2">
            <button onclick="window.print()" class="px-3 py-1.5 rounded-lg bg-slate-600/50 text-sm" aria-label="${L.print}">${L.print}</button>
            <button onclick="setState({modal:null})" class="w-8 h-8 rounded-full hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors" aria-label="${L.close}">×</button>
          </div>
        </div>
        <div class="p-6 overflow-y-auto max-h-[75vh]">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h2 class="text-xl font-bold">${L.orderSheetTitle}</h2>
              <p class="text-sm text-slate-400">${date}</p>
            </div>
            <div class="text-right">
              <div class="font-bold text-lg" style="color:#7cb342">JYUKO co.,ltd</div>
            </div>
          </div>

          ${order ? `
            <table class="w-full border-collapse text-sm mb-6">
              <tr class="border-b glass-light"><td colspan="2" class="py-2 px-3 font-bold">${state.lang==='ja'?'■ 素材構成':'■ 面料构成'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400 w-2/5">${L.weaveType}</td><td class="py-2 px-3 font-medium">${weave?.name[state.lang]||'-'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.warpYarn}</td><td class="py-2 px-3 font-medium">${warpYarn?.name[state.lang]||'-'} (${getComp(warpYarn, state.lang)})</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.weftYarn}</td><td class="py-2 px-3 font-medium">${weftYarn?.name[state.lang]||'-'} (${getComp(weftYarn, state.lang)})</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.epi} / ${L.ppi}</td><td class="py-2 px-3 font-medium">${state.epi} / ${state.ppi}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.gsm}</td><td class="py-2 px-3 font-medium">${gsm?.gsm||'-'} g/m²</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.fabricWidth}</td><td class="py-2 px-3 font-medium">${order.widthCm} cm</td></tr>

              <tr class="border-b glass-light"><td colspan="2" class="py-2 px-3 font-bold">${state.lang==='ja'?'■ 織機設定':'■ 织机设置'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.warpEnds}</td><td class="py-2 px-3 font-medium">${order.warpEnds} ${state.lang==='ja'?'本':'根'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.warpBeamLength}</td><td class="py-2 px-3 font-medium">${order.warpBeamLength} m</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.weftLength}</td><td class="py-2 px-3 font-medium">${order.weftLengthKm} km</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.reedCount}</td><td class="py-2 px-3 font-medium">${order.reedCount} ${state.lang==='ja'?'羽/inch':'齿/英寸'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.drawingIn}</td><td class="py-2 px-3 font-medium">${order.drawingIn} (${order.heddleFrames}${state.lang==='ja'?'枚綜絖':'片综框'})</td></tr>

              <tr class="border-b glass-light"><td colspan="2" class="py-2 px-3 font-bold">${state.lang==='ja'?'■ 生産計画':'■ 生产计划'}</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.orderLength}</td><td class="py-2 px-3 font-medium">${order.orderLen} m</td></tr>
              <tr class="border-b border-slate-700/50"><td class="py-2 px-3 text-slate-400">${L.estimatedTime}</td><td class="py-2 px-3 font-medium">${order.estimatedHours} h (≈${order.estimatedDays} ${state.lang==='ja'?'日':'天'})</td></tr>
            </table>

            ${order.notes.length > 0 ? `
              <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
                <h4 class="font-bold text-sm text-amber-700 mb-2">${L.productionNotes}</h4>
                <ul class="text-sm text-amber-800 space-y-1">
                  ${order.notes.map(n => `<li>• ${n}</li>`).join('')}
                </ul>
              </div>
            ` : ''}

            <div class="grid grid-cols-2 gap-3 mb-4">
              <div>
                <div class="text-xs text-slate-400 mb-1">${L.warpColor}</div>
                <div class="flex gap-1">${state.warpColors.map(c => `<div class="w-6 h-6 rounded border" style="background:${c}"></div>`).join('')}</div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-1">${L.weftColor}</div>
                <div class="flex gap-1">${state.weftColors.map(c => `<div class="w-6 h-6 rounded border" style="background:${c}"></div>`).join('')}</div>
              </div>
            </div>

            <div class="text-center text-xs text-slate-500 mt-6">
              Generated by JYUKO Fabric Simulator V3 | ${date}
            </div>
          ` : '<p class="text-center text-slate-500 py-8">-</p>'}
        </div>
      </div>
    </div>
  `;
}


// ============================================================
// Phase 3b: スワッチ帳 (生地写真+スペック localStorage保存)
// ============================================================

/* --- localStorage helpers --- */
function getSwatches() {
  try { return JSON.parse(localStorage.getItem('fabricSwatches') || '[]'); }
  catch(e) { return []; }
}
function saveSwatchList(list) {
  localStorage.setItem('fabricSwatches', JSON.stringify(list));
}

/* --- window functions for onclick --- */
window.handleSwatchPhoto = function(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) {
    alert(state.lang === 'ja' ? '画像は5MB以下にしてください' : '图片请控制在5MB以内');
    ev.target.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    window._swatchPhotoData = e.target.result;
    const preview = document.getElementById('swatchPhotoPreview');
    if (preview) {
      preview.src = e.target.result;
      preview.classList.remove('hidden');
    }
  };
  reader.readAsDataURL(file);
};

window.saveSwatch = function() {
  const name = document.getElementById('swatchName')?.value?.trim();
  if (!name) {
    alert(state.lang === 'ja' ? '名称を入力してください' : '请输入名称');
    return;
  }
  const swatch = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    name: name,
    warpNe: document.getElementById('swatchWarpNe')?.value?.trim() || '',
    weftNe: document.getElementById('swatchWeftNe')?.value?.trim() || '',
    warpComp: document.getElementById('swatchWarpComp')?.value?.trim() || '',
    weftComp: document.getElementById('swatchWeftComp')?.value?.trim() || '',
    epi: document.getElementById('swatchEpi')?.value?.trim() || '',
    ppi: document.getElementById('swatchPpi')?.value?.trim() || '',
    memo: document.getElementById('swatchMemo')?.value?.trim() || '',
    photo: window._swatchPhotoData || '',
    createdAt: new Date().toISOString()
  };
  const list = getSwatches();
  list.unshift(swatch);
  saveSwatchList(list);
  window._swatchPhotoData = null;
  scheduleRender();
};

window.deleteSwatch = function(id) {
  const L = LANG[state.lang];
  if (!confirm(state.lang === 'ja' ? '削除しますか？' : '确定删除？')) return;
  const list = getSwatches().filter(s => s.id !== id);
  saveSwatchList(list);
  scheduleRender();
};

window.applySwatch = function(id) {
  const swatch = getSwatches().find(s => s.id === id);
  if (!swatch) return;
  const updates = {};
  // EPI / PPI
  if (swatch.epi && !isNaN(Number(swatch.epi))) updates.epi = Number(swatch.epi);
  if (swatch.ppi && !isNaN(Number(swatch.ppi))) updates.ppi = Number(swatch.ppi);
  // Try to find matching yarn by Ne
  if (swatch.warpNe) {
    const ne = parseFloat(swatch.warpNe);
    if (!isNaN(ne)) {
      const found = YARN_DB.find(y => Math.abs(y.ne - ne) < 0.5);
      if (found) updates.warpYarnId = found.id;
    }
  }
  if (swatch.weftNe) {
    const ne = parseFloat(swatch.weftNe);
    if (!isNaN(ne)) {
      const found = YARN_DB.find(y => Math.abs(y.ne - ne) < 0.5);
      if (found) updates.weftYarnId = found.id;
    }
  }
  if (Object.keys(updates).length > 0) {
    setState(updates);
    setState({ modal: null });
  } else {
    setState({ modal: null });
  }
};

/* --- Swatch Modal Renderer --- */
function renderSwatchModal(L) {
  const ja = state.lang === 'ja';
  const swatches = getSwatches();
  const listHtml = swatches.length === 0
    ? `<div class="text-center text-slate-400 py-6">${L.swatchNoItems}</div>`
    : swatches.map(s => `
      <div class="bg-slate-700/40 rounded-xl p-3 flex gap-3 items-start">
        ${s.photo
          ? `<img src="${s.photo}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0 border border-slate-600 cursor-pointer" onclick="window.open(this.src)" title="${ja ? 'クリックで拡大' : '点击放大'}">`
          : `<div class="w-20 h-20 rounded-lg flex-shrink-0 bg-slate-600/50 flex items-center justify-center text-2xl text-slate-500">📷</div>`}
        <div class="flex-1 min-w-0 text-xs space-y-1">
          <div class="font-bold text-white text-sm truncate">${s.name}</div>
          ${s.warpNe || s.weftNe ? `<div class="text-slate-300">🧵 ${ja?'経':'经'}:${s.warpNe||'-'}Ne / ${ja?'緯':'纬'}:${s.weftNe||'-'}Ne</div>` : ''}
          ${s.warpComp || s.weftComp ? `<div class="text-slate-300">🔬 ${ja?'経':'经'}:${s.warpComp||'-'} / ${ja?'緯':'纬'}:${s.weftComp||'-'}</div>` : ''}
          ${s.epi || s.ppi ? `<div class="text-slate-300">📐 EPI:${s.epi||'-'} PPI:${s.ppi||'-'}</div>` : ''}
          ${s.memo ? `<div class="text-slate-400 truncate">📝 ${s.memo}</div>` : ''}
          <div class="text-slate-500">${new Date(s.createdAt).toLocaleDateString()}</div>
          <div class="flex gap-2 mt-1">
            <button onclick="applySwatch('${s.id}')" class="px-2 py-0.5 rounded bg-cyan-600/30 text-cyan-300 hover:bg-cyan-600/50 text-xs">📥 ${L.swatchApply}</button>
            <button onclick="deleteSwatch('${s.id}')" class="px-2 py-0.5 rounded bg-red-600/30 text-red-300 hover:bg-red-600/50 text-xs">🗑 ${L.swatchDelete}</button>
          </div>
        </div>
      </div>
    `).join('');

  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})" style="background:rgba(0,0,0,.55);backdrop-filter:blur(6px)">
      <div class="modal-content rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden animate-in" style="max-height:90vh;display:flex;flex-direction:column">
        <!-- Header -->
        <div class="p-4 border-b border-slate-700/50 flex items-center justify-between flex-shrink-0">
          <h3 class="font-bold text-white text-lg">🧾 ${L.swatchBook}</h3>
          <button onclick="setState({modal:null})" class="text-slate-400 hover:text-white text-xl">✕</button>
        </div>

        <div class="overflow-y-auto flex-1 p-4 space-y-4">
          <!-- New Swatch Form -->
          <details class="group" open>
            <summary class="cursor-pointer font-bold text-cyan-300 flex items-center gap-2 mb-3 select-none">
              <span class="transition-transform group-open:rotate-90">▶</span> ➕ ${L.swatchAdd}
            </summary>
            <div class="space-y-2 bg-slate-800/60 rounded-xl p-3">
              <!-- Photo Upload -->
              <div>
                <label class="block text-xs text-slate-400 mb-1">📷 ${L.swatchPhoto}</label>
                <input type="file" accept="image/*" onchange="handleSwatchPhoto(event)" class="w-full text-xs text-slate-300 file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-cyan-600/30 file:text-cyan-300 hover:file:bg-cyan-600/50">
                <img id="swatchPhotoPreview" class="hidden mt-2 w-32 h-32 object-cover rounded-lg border border-slate-600">
                <div class="text-xs text-slate-500 mt-1">${L.swatchPhotoHint}</div>
              </div>
              <!-- Name -->
              <div>
                <label class="block text-xs text-slate-400 mb-1">${L.swatchName}</label>
                <input id="swatchName" type="text" placeholder="${ja ? '例: フランネル C/T/R' : '例: 法兰绒 C/T/R'}" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
              </div>
              <!-- Yarn Ne Row -->
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchWarpNe}</label>
                  <input id="swatchWarpNe" type="text" placeholder="19" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchWeftNe}</label>
                  <input id="swatchWeftNe" type="text" placeholder="19" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
              </div>
              <!-- Composition Row -->
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchWarpComp}</label>
                  <input id="swatchWarpComp" type="text" placeholder="${ja ? '例: T/C/R 混紡' : '例: T/C/R 混纺'}" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchWeftComp}</label>
                  <input id="swatchWeftComp" type="text" placeholder="${ja ? '例: 綿100%' : '例: 棉100%'}" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
              </div>
              <!-- EPI PPI Row -->
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchEpi}</label>
                  <input id="swatchEpi" type="text" placeholder="100" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">${L.swatchPpi}</label>
                  <input id="swatchPpi" type="text" placeholder="90" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none">
                </div>
              </div>
              <!-- Memo -->
              <div>
                <label class="block text-xs text-slate-400 mb-1">${L.swatchMemo}</label>
                <textarea id="swatchMemo" rows="2" placeholder="${ja ? '中国リサイクル糸、起毛仕上げ等' : '中国再生纱、起毛处理等'}" class="w-full px-3 py-1.5 rounded-lg bg-slate-700/60 border border-slate-600 text-white text-sm placeholder-slate-500 focus:border-cyan-500 focus:outline-none resize-none"></textarea>
              </div>
              <!-- Save Button -->
              <button onclick="saveSwatch()" class="w-full py-2 rounded-xl font-bold text-sm bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white shadow-lg transition-all">💾 ${L.swatchSave}</button>
            </div>
          </details>

          <!-- Saved Swatches List -->
          <div>
            <h4 class="font-bold text-slate-300 mb-2 text-sm">${ja ? '📚 保存済みスワッチ' : '📚 已保存色卡'} (${swatches.length})</h4>
            <div class="space-y-2">${listHtml}</div>
          </div>
        </div>

        <!-- Footer -->
        <div class="p-3 border-t border-slate-700/50 flex-shrink-0">
          <button onclick="setState({modal:null})" class="w-full py-2 rounded-xl btn-ghost text-slate-300 hover:text-white text-sm">${L.swatchClose}</button>
        </div>
      </div>
    </div>
  `;
}


// ============================================================
// Phase 3: エクスポート機能 (CSV / PDF / 高解像度画像)
// ============================================================
function renderExportModal(L) {
  const ja = state.lang === 'ja';
  return `
    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)setState({modal:null})">
      <div class="modal-content rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-in">
        <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
          <h3 class="font-bold text-white text-lg">📤 ${L.exportMenu}</h3>
          <button onclick="setState({modal:null})" class="text-slate-400 hover:text-white text-xl">✕</button>
        </div>
        <div class="p-5 space-y-3">
          <button onclick="exportCSV()" class="w-full p-4 rounded-xl btn-ghost text-left flex items-center gap-4 hover:bg-slate-600/30 group">
            <div class="text-3xl group-hover:scale-110 transition-transform">📊</div>
            <div>
              <div class="font-bold text-white">${L.exportCSV}</div>
              <div class="text-xs text-slate-400 mt-0.5">${L.exportCSVDesc}</div>
            </div>
          </button>
          <button onclick="exportPDF()" id="pdfBtn" class="w-full p-4 rounded-xl btn-ghost text-left flex items-center gap-4 hover:bg-slate-600/30 group">
            <div class="text-3xl group-hover:scale-110 transition-transform">📄</div>
            <div>
              <div class="font-bold text-white">${L.exportPDF}</div>
              <div class="text-xs text-slate-400 mt-0.5">${L.exportPDFDesc}</div>
            </div>
          </button>
          <button onclick="exportHiRes()" id="hiResBtn" class="w-full p-4 rounded-xl btn-ghost text-left flex items-center gap-4 hover:bg-slate-600/30 group">
            <div class="text-3xl group-hover:scale-110 transition-transform">🖼️</div>
            <div>
              <div class="font-bold text-white">${L.exportHiRes}</div>
              <div class="text-xs text-slate-400 mt-0.5">${L.exportHiResDesc}</div>
            </div>
          </button>
        </div>
      </div>
    </div>
  `;
}

// CSV仕様書エクスポート
function exportCSV() {
  const L = LANG[state.lang];
  const weave = getWeave(state.weaveId);
  const warpYarn = getYarn(state.warpYarnId);
  const weftYarn = getYarn(state.weftYarnId);
  const physics = calcPhysics();
  const gsm = calcGSM();
  const season = judgeSeason(gsm);
  const ja = state.lang === 'ja';

  const rows = [
    [ja ? '項目' : '项目', ja ? '値' : '值'],
    [ja ? '織り組織' : '织物组织', weave?.name[state.lang] || state.weaveId],
    [ja ? '経糸' : '经纱', warpYarn?.name[state.lang] || state.warpYarnId],
    [ja ? '緯糸' : '纬纱', weftYarn?.name[state.lang] || state.weftYarnId],
    [ja ? '経糸番手' : '经纱支数', warpYarn ? warpYarn.ne + 'Ne' : '-'],
    [ja ? '緯糸番手' : '纬纱支数', weftYarn ? weftYarn.ne + 'Ne' : '-'],
    ['EPI', state.epi],
    ['PPI', state.ppi],
    [ja ? '目付 (GSM)' : '克重 (GSM)', gsm ? gsm.toFixed(1) : '-'],
    [ja ? '季節' : '季节', season],
    [ja ? '経糸径 (mm)' : '经纱直径 (mm)', physics?.warpDiameter?.toFixed(3) || '-'],
    [ja ? '緯糸径 (mm)' : '纬纱直径 (mm)', physics?.weftDiameter?.toFixed(3) || '-'],
    [ja ? '経糸カバー率' : '经纱覆盖率', physics?.warpCoverage ? (physics.warpCoverage * 100).toFixed(1) + '%' : '-'],
    [ja ? '緯糸カバー率' : '纬纱覆盖率', physics?.weftCoverage ? (physics.weftCoverage * 100).toFixed(1) + '%' : '-'],
    [ja ? '柄ピッチ' : '花纹间距', state.pitch],
    [ja ? 'パターン' : '图案', state.pattern],
    [ja ? '経糸色' : '经纱颜色', state.warpColors.join(', ')],
    [ja ? '緯糸色' : '纬纱颜色', state.weftColors.join(', ')],
  ];

  // CSV生成 (BOM付きUTF-8)
  const csvContent = '\uFEFF' + rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'JYUKO_spec_' + state.weaveId + '_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// PDF仕様書エクスポート
async function exportPDF() {
  const btn = document.getElementById('pdfBtn');
  const L = LANG[state.lang];
  if (btn) btn.querySelector('.font-bold').textContent = L.exporting;

  try {
    // 仕様書モーダルを一時的に表示してキャプチャ
    const weave = getWeave(state.weaveId);
    const warpYarn = getYarn(state.warpYarnId);
    const weftYarn = getYarn(state.weftYarnId);
    const physics = calcPhysics();
    const gsm = calcGSM();
    const season = judgeSeason(gsm);
    const ja = state.lang === 'ja';

    // PDF用の一時的なHTML要素を作成
    const tmpDiv = document.createElement('div');
    tmpDiv.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:794px;padding:40px;background:white;color:black;font-family:sans-serif;font-size:14px;';
    tmpDiv.innerHTML = `
      <div style="border-bottom:3px solid #1e40af;padding-bottom:12px;margin-bottom:20px;">
        <h1 style="font-size:22px;font-weight:bold;color:#1e40af;margin:0;">${ja ? '先染め生地 仕様書' : '色织面料 规格书'}</h1>
        <p style="color:#666;font-size:11px;margin:4px 0 0;">JYUKO Textile Simulator — ${new Date().toLocaleDateString()}</p>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <tr style="background:#f1f5f9;"><th style="text-align:left;padding:8px;border:1px solid #e2e8f0;width:40%;">${ja ? '項目' : '项目'}</th><th style="text-align:left;padding:8px;border:1px solid #e2e8f0;">${ja ? '値' : '值'}</th></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '織り組織' : '织物组织'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${weave?.name[state.lang] || '-'}</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '経糸' : '经纱'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${warpYarn?.name[state.lang] || '-'} (${warpYarn?.ne || '-'}Ne)</td></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '緯糸' : '纬纱'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${weftYarn?.name[state.lang] || '-'} (${weftYarn?.ne || '-'}Ne)</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">EPI / PPI</td><td style="padding:8px;border:1px solid #e2e8f0;">${state.epi} / ${state.ppi}</td></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '目付' : '克重'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${gsm ? gsm.toFixed(1) + ' g/m²' : '-'}</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '季節' : '季节'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${season}</td></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '経糸径' : '经纱直径'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${physics?.warpDiameter?.toFixed(3) || '-'} mm</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '緯糸径' : '纬纱直径'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${physics?.weftDiameter?.toFixed(3) || '-'} mm</td></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? 'カバー率 (経/緯)' : '覆盖率 (经/纬)'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${physics?.warpCoverage ? (physics.warpCoverage*100).toFixed(1)+'%' : '-'} / ${physics?.weftCoverage ? (physics.weftCoverage*100).toFixed(1)+'%' : '-'}</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? 'パターン' : '图案'}</td><td style="padding:8px;border:1px solid #e2e8f0;">${state.pattern} (pitch: ${state.pitch})</td></tr>
        <tr><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '経糸色' : '经纱颜色'}</td><td style="padding:8px;border:1px solid #e2e8f0;"><span style="display:inline-flex;gap:4px;">${state.warpColors.map(c => '<span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:'+c+';border:1px solid #ccc;" title="'+c+'"></span>').join('')}</span> ${state.warpColors.join(', ')}</td></tr>
        <tr style="background:#f8fafc;"><td style="padding:8px;border:1px solid #e2e8f0;">${ja ? '緯糸色' : '纬纱颜色'}</td><td style="padding:8px;border:1px solid #e2e8f0;"><span style="display:inline-flex;gap:4px;">${state.weftColors.map(c => '<span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:'+c+';border:1px solid #ccc;" title="'+c+'"></span>').join('')}</span> ${state.weftColors.join(', ')}</td></tr>
      </table>
      <div style="margin-top:16px;">
        <h3 style="font-size:14px;font-weight:bold;margin-bottom:8px;">${ja ? 'プレビュー' : '预览'}</h3>
        <canvas id="pdfCanvas" width="400" height="400" style="border:1px solid #e2e8f0;border-radius:8px;"></canvas>
      </div>
      <div style="margin-top:20px;padding-top:12px;border-top:1px solid #e2e8f0;color:#999;font-size:10px;">
        Generated by JYUKO Yarn-Dyed Fabric Simulator V3 — ${new Date().toISOString()}
      </div>
    `;
    document.body.appendChild(tmpDiv);

    // キャンバスにプレビューを描画
    const srcCanvas = document.getElementById('canvas') || document.getElementById('canvasA');
    const pdfCanvas = tmpDiv.querySelector('#pdfCanvas');
    if (srcCanvas && pdfCanvas) {
      const ctx = pdfCanvas.getContext('2d');
      ctx.drawImage(srcCanvas, 0, 0, 400, 400);
    }

    await new Promise(r => setTimeout(r, 100));

    const canvas = await html2canvas(tmpDiv, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfW = pdf.internal.pageSize.getWidth();
    const pdfH = pdf.internal.pageSize.getHeight();
    const imgW = pdfW - 20;
    const imgH = (canvas.height / canvas.width) * imgW;

    if (imgH > pdfH - 20) {
      const scale = (pdfH - 20) / imgH;
      pdf.addImage(imgData, 'JPEG', 10, 10, imgW * scale, imgH * scale);
    } else {
      pdf.addImage(imgData, 'JPEG', 10, 10, imgW, imgH);
    }

    pdf.save('JYUKO_spec_' + state.weaveId + '_' + new Date().toISOString().slice(0,10) + '.pdf');
    document.body.removeChild(tmpDiv);

    if (btn) btn.querySelector('.font-bold').textContent = L.exportDone;
    setTimeout(() => { if (btn) btn.querySelector('.font-bold').textContent = L.exportPDF; }, 2000);
  } catch (err) {
    console.error('PDF export error:', err);
    if (btn) btn.querySelector('.font-bold').textContent = 'Error: ' + err.message;
    setTimeout(() => { if (btn) btn.querySelector('.font-bold').textContent = L.exportPDF; }, 3000);
  }
}

// 高解像度画像エクスポート (A4 300dpi相当: 2480×3508px)
function exportHiRes() {
  const btn = document.getElementById('hiResBtn');
  const L = LANG[state.lang];
  if (btn) btn.querySelector('.font-bold').textContent = L.exporting;

  try {
    const srcCanvas = document.getElementById('canvas') || document.getElementById('canvasA');
    if (!srcCanvas) throw new Error('Canvas not found');

    // A4 300dpi = 2480 x 3508 px, 生地プレビューは正方形で大きく
    const hiResSize = 2400;
    const hiCanvas = document.createElement('canvas');
    hiCanvas.width = hiResSize;
    hiCanvas.height = hiResSize;
    const ctx = hiCanvas.getContext('2d');

    // 白背景
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, hiResSize, hiResSize);

    // 高品質リサンプリング
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    // ソースキャンバスを高解像度で再描画
    ctx.drawImage(srcCanvas, 0, 0, hiResSize, hiResSize);

    // ダウンロード
    hiCanvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'JYUKO_fabric_HiRes_' + state.weaveId + '_' + new Date().toISOString().slice(0,10) + '.png';
      a.click();
      URL.revokeObjectURL(url);

      if (btn) btn.querySelector('.font-bold').textContent = L.exportDone;
      setTimeout(() => { if (btn) btn.querySelector('.font-bold').textContent = L.exportHiRes; }, 2000);
    }, 'image/png');
  } catch (err) {
    console.error('HiRes export error:', err);
    if (btn) btn.querySelector('.font-bold').textContent = 'Error: ' + err.message;
    setTimeout(() => { if (btn) btn.querySelector('.font-bold').textContent = L.exportHiRes; }, 3000);
  }
}

// ============================================================
// グローバル関数
// ============================================================
window.setState = setState;
window.toggleEdit = (t, i) => setState({ editColor: state.editColor === t + i ? null : t + i });
window.updColor = (t, i, c) => { const arr = t === 'warp' ? [...state.warpColors] : [...state.weftColors]; arr[i] = c; setState(t === 'warp' ? { warpColors: arr } : { weftColors: arr }); };
window.addColor = t => { const arr = t === 'warp' ? [...state.warpColors] : [...state.weftColors]; if (arr.length < 8) arr.push(SWATCHES[Math.floor(Math.random() * SWATCHES.length)]); setState(t === 'warp' ? { warpColors: arr } : { weftColors: arr }); };
window.removeColor = (t, i) => { const arr = t === 'warp' ? [...state.warpColors] : [...state.weftColors]; if (arr.length > 1) arr.splice(i, 1); setState(t === 'warp' ? { warpColors: arr } : { weftColors: arr }); };
window.quickColor = hex => { const arr = state.warpColors.length < 2 ? [...state.warpColors, hex] : [state.warpColors[0], hex]; setState({ warpColors: arr }); };
window.setWeaveCat = c => { const first = WEAVE_DB.find(w => w.cat === c); setState({ weaveCat: c, weaveId: first?.id || state.weaveId }); };
window.shareURL = () => {
  const params = new URLSearchParams();
  params.set('p', state.pattern);
  params.set('w', state.weaveId);
  params.set('wc', state.warpColors.join(','));
  params.set('fc', state.weftColors.join(','));
  params.set('wy', state.warpYarnId);
  params.set('fy', state.weftYarnId);
  params.set('e', state.epi);
  params.set('pp', state.ppi);
  params.set('pt', state.pitch);
  params.set('z', state.zoom);
  if (state.warpArrangement) params.set('wa', JSON.stringify(state.warpArrangement));
  if (state.weftArrangement) params.set('fa', JSON.stringify(state.weftArrangement));
  const url = location.origin + location.pathname + '?' + params.toString();
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('shareBtn');
    if (btn) { btn.textContent = state.lang === 'ja' ? '✅ コピー済み' : '✅ 已复制'; setTimeout(() => { btn.textContent = state.lang === 'ja' ? '🔗 URL共有' : '🔗 URL分享'; }, 2000); }
  });
};
window.undoState = () => {
  if (state.undoStack && state.undoStack.length > 0) {
    const snap = state.undoStack[state.undoStack.length - 1];
    const redoSnap = {};
    for (const k of Object.keys(snap)) { redoSnap[k] = Array.isArray(state[k]) ? [...state[k]] : state[k]; }
    state.undoStack = state.undoStack.slice(0, -1);
    state.redoStack = [...(state.redoStack||[]), redoSnap];
    Object.assign(state, snap, { _noUndo: true });
    scheduleRender();
  }
};
window.redoState = () => {
  if (state.redoStack && state.redoStack.length > 0) {
    const snap = state.redoStack[state.redoStack.length - 1];
    const undoSnap = {};
    for (const k of Object.keys(snap)) { undoSnap[k] = Array.isArray(state[k]) ? [...state[k]] : state[k]; }
    state.redoStack = state.redoStack.slice(0, -1);
    state.undoStack = [...(state.undoStack||[]), undoSnap];
    Object.assign(state, snap, { _noUndo: true });
    scheduleRender();
  }
};
window.exportCSV = exportCSV;
window.exportPDF = exportPDF;
window.exportHiRes = exportHiRes;
window.downloadPng = () => { const c = document.getElementById('canvas') || document.getElementById('canvasA'); if (c) { const l = document.createElement('a'); l.download = `JYUKO_fabric_${state.weaveId}.png`; l.href = c.toDataURL('image/png'); l.click(); } };
window.toggleCompare = () => { if (!state.compareMode) { setState({ compareMode: true, savedConfig: { ...state } }); } else { setState({ compareMode: false, savedConfig: null }); } };
window.swapCompare = () => {
  if (state.compareMode && state.savedConfig) {
    const currentMain = { pattern: state.pattern, weaveId: state.weaveId, weaveCat: state.weaveCat, warpColors: [...state.warpColors], weftColors: [...state.weftColors], warpYarnId: state.warpYarnId, weftYarnId: state.weftYarnId, yarnCat: state.yarnCat, warpYarnCat: state.warpYarnCat, weftYarnCat: state.weftYarnCat, epi: state.epi, ppi: state.ppi, pitch: state.pitch, zoom: state.zoom };
    const saved = state.savedConfig;
    setState({ ...currentMain, pattern: saved.pattern, weaveId: saved.weaveId, weaveCat: saved.weaveCat, warpColors: [...(saved.warpColors||[])], weftColors: [...(saved.weftColors||[])], warpYarnId: saved.warpYarnId, weftYarnId: saved.weftYarnId, yarnCat: saved.yarnCat, warpYarnCat: saved.warpYarnCat || saved.yarnCat, weftYarnCat: saved.weftYarnCat || saved.yarnCat, epi: saved.epi, ppi: saved.ppi, pitch: saved.pitch, zoom: saved.zoom, savedConfig: currentMain });
  }
};
window.applyRandom = () => setState(randomGenerate());
window.changeArrCount = (type, idx, delta) => {
  const key = type + 'Arrangement';
  const colors = type === 'warp' ? state.warpColors : state.weftColors;
  const arr = [...(state[key] || autoArrangement(colors))];
  arr[idx] = { ...arr[idx], count: Math.max(1, arr[idx].count + delta) };
  setState({ [key]: arr, _noUndo: true });
};
window.removeArrItem = (type, idx) => {
  const key = type + 'Arrangement';
  const colors = type === 'warp' ? state.warpColors : state.weftColors;
  const arr = [...(state[key] || autoArrangement(colors))];
  if (arr.length > 1) arr.splice(idx, 1);
  setState({ [key]: arr, _noUndo: true });
};
window.addArrItem = (type) => {
  const key = type + 'Arrangement';
  const colors = type === 'warp' ? state.warpColors : state.weftColors;
  const arr = [...(state[key] || autoArrangement(colors))];
  arr.push({ color: SWATCHES[Math.floor(Math.random() * SWATCHES.length)], count: 1 });
  // 色も追加
  const colKey = type + 'Colors';
  const newColors = [...state[colKey], arr[arr.length-1].color];
  setState({ [key]: arr, [colKey]: newColors, _noUndo: true });
};
window.applyArrangement = () => {
  const warpArr = state.warpArrangement || autoArrangement(state.warpColors);
  const weftArr = state.weftArrangement || autoArrangement(state.weftColors);
  setState({ warpArrangement: warpArr, weftArrangement: weftArr, warpColors: warpArr.map(a=>a.color), weftColors: weftArr.map(a=>a.color), modal: null });
};
window.resetArrangement = () => setState({ warpArrangement: null, weftArrangement: null, modal: null });
window.applyTrendColor = hex => { setState({ warpColors: [state.warpColors[0] || '#1d3557', hex], modal: null }); };

// チェック柄プリセット適用
window.toggleCheckCat = cat => {
  setState({ checkPresetCat: state.checkPresetCat === cat ? null : cat });
};
window.applyCheckPreset = id => {
  const preset = CHECK_PATTERNS.find(p => p.id === id);
  if (!preset) return;
  setState({
    checkPresetId: id,
    pattern: 'check',
    warpColors: [...preset.warpColors],
    weftColors: [...preset.weftColors],
    pitch: preset.pitch,
    weaveId: preset.weaveId,
    weaveCat: WEAVE_DB.find(w => w.id === preset.weaveId)?.cat || state.weaveCat,
  });
};

// 素材ライブラリ
window.loadFromLibrary = loadFromLibrary;
window.deleteFromLibrary = deleteFromLibrary;
window.doSaveLibrary = () => {
  const input = document.getElementById('libNameInput');
  const name = input?.value?.trim() || `${getWeave(state.weaveId)?.name[state.lang]||''} ${state.epi}×${state.ppi}`;
  saveToLibrary(name);
  const msg = document.getElementById('libSaveMsg');
  if (msg) { msg.classList.remove('hidden'); setTimeout(() => msg.classList.add('hidden'), 2000); }
  setState({ modal: 'library' }); // re-render to show new entry
};

// 組織エディタ
window.toggleEditorCell = (x, y) => {
  const m = state.editorMatrix.map(r => [...r]);
  m[y][x] = m[y][x] ? 0 : 1;
  setState({ editorMatrix: m });
};
window.resizeEditor = (s) => {
  const weave = getWeave(state.weaveId);
  const m = [];
  for (let y = 0; y < s; y++) {
    const row = [];
    for (let x = 0; x < s; x++) {
      // 既存マトリクスからコピー、なければ織りパターンからコピー
      if (state.editorMatrix && y < state.editorMatrix.length && x < state.editorMatrix[0].length) {
        row.push(state.editorMatrix[y][x]);
      } else if (weave) {
        row.push(weave.matrix[y % weave.ry]?.[x % weave.rx] ? 1 : 0);
      } else {
        row.push(0);
      }
    }
    m.push(row);
  }
  setState({ editorSize: s, editorMatrix: m });
};
window.editorClear = () => {
  const s = state.editorSize;
  setState({ editorMatrix: Array.from({length: s}, () => Array(s).fill(0)) });
};
window.editorInvert = () => {
  setState({ editorMatrix: state.editorMatrix.map(r => r.map(c => c ? 0 : 1)) });
};
window.editorFillPlain = () => {
  const s = state.editorSize;
  setState({ editorMatrix: Array.from({length: s}, (_, y) => Array.from({length: s}, (_, x) => (x + y) % 2 === 0 ? 1 : 0)) });
};
window.editorFillTwill = () => {
  const s = state.editorSize;
  setState({ editorMatrix: Array.from({length: s}, (_, y) => Array.from({length: s}, (_, x) => (x + y) % 4 < 2 ? 1 : 0)) });
};
window.editorFillSatin = () => {
  const s = state.editorSize;
  setState({ editorMatrix: Array.from({length: s}, (_, y) => Array.from({length: s}, (_, x) => (x + y * 2) % 5 === 0 ? 1 : 0)) });
};
window.applyCustomWeave = () => {
  const s = state.editorSize;
  const m = state.editorMatrix;
  // WEAVE_DBにカスタム組織を追加（既存のcustomがあれば上書き）
  const existing = WEAVE_DB.findIndex(w => w.id === 'custom');
  const boolMatrix = m.map(r => r.map(c => !!c));
  const customWeave = {
    id: 'custom',
    name: { ja: 'カスタム組織', zh: '自定义组织' },
    cat: 'special',
    matrix: boolMatrix,
    rx: s, ry: s,
    chars: { durability: 3, drape: 3, breathability: 3, wrinkleResistance: 3, shine: 3 },
    gsmMult: 1.0, crimp: 1.08, diff: 3,
    apps: { ja: ['カスタム'], zh: ['自定义'] }
  };
  if (existing >= 0) WEAVE_DB[existing] = customWeave;
  else WEAVE_DB.push(customWeave);
  setState({ weaveId: 'custom', weaveCat: customWeave.cat, modal: null });
};

// ============================================================
// 初期化 - Improvement #4: URL パラメータバリデーション強化
// ============================================================
(function loadFromURL() {
  try {
    const p = new URLSearchParams(location.search);
    const validPatterns = ['check', 'stripe', 'solid'];
    if (p.has('p') && validPatterns.includes(p.get('p'))) state.pattern = p.get('p');
    if (p.has('w') && getWeave(p.get('w'))) state.weaveId = p.get('w');
    if (p.has('wc')) {
      const colors = p.get('wc').split(',').filter(c => /^#[0-9a-fA-F]{6}$/.test(c));
      if (colors.length > 0 && colors.length <= 8) state.warpColors = colors;
    }
    if (p.has('fc')) {
      const colors = p.get('fc').split(',').filter(c => /^#[0-9a-fA-F]{6}$/.test(c));
      if (colors.length > 0 && colors.length <= 8) state.weftColors = colors;
    }
    if (p.has('wy') && getYarn(p.get('wy'))) state.warpYarnId = p.get('wy');
    if (p.has('fy') && getYarn(p.get('fy'))) state.weftYarnId = p.get('fy');
    if (p.has('e')) { const v = +p.get('e'); if (v >= 30 && v <= 250) state.epi = v; }
    if (p.has('pp')) { const v = +p.get('pp'); if (v >= 30 && v <= 250) state.ppi = v; }
    if (p.has('pt')) { const v = +p.get('pt'); if (v >= 8 && v <= 80) state.pitch = v; }
    if (p.has('z')) { const v = +p.get('z'); if (v >= 0.5 && v <= 3) state.zoom = v; }
    if (p.has('wa')) try {
      const arr = JSON.parse(p.get('wa'));
      if (Array.isArray(arr) && arr.every(a => a.color && a.count > 0)) state.warpArrangement = arr;
    } catch(e) {}
    if (p.has('fa')) try {
      const arr = JSON.parse(p.get('fa'));
      if (Array.isArray(arr) && arr.every(a => a.color && a.count > 0)) state.weftArrangement = arr;
    } catch(e) {}
    const w = getWeave(state.weaveId); if (w) state.weaveCat = w.cat;
    const y = getYarn(state.warpYarnId); if (y) state.yarnCat = y.cat;
  } catch(e) {
    console.warn('URL parameter loading failed:', e);
  }
})();

// Improvement #5: キーボードショートカット＋Escape でモーダル閉じる
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undoState(); }
  if ((e.metaKey || e.ctrlKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redoState(); }
  if (e.key === 'Escape' && state.modal) { setState({ modal: null }); }
});

// Improvement #6: リサイズ時にCanvasを再描画
let _resizeTimer = null;
window.addEventListener('resize', () => {
  clearTimeout(_resizeTimer);
  _resizeTimer = setTimeout(() => {
    _tileCache = null;
    _tileCacheKey = '';
    renderCanvas();
  }, 150);
});

render();
</script>
</body>
</html>
