<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…ˆæŸ“ã‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ | è‰²ç»‡æ¨¡æ‹Ÿå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", "Noto Sans JP", sans-serif; }
    .color-swatch { transition: transform 0.1s; }
    .color-swatch:hover { transform: scale(1.1); }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900 min-h-screen">

<div id="app" class="max-w-7xl mx-auto p-4"></div>

<script>
// ============================================================
// å¤šè¨€èªå¯¾å¿œãƒ†ã‚­ã‚¹ãƒˆ
// ============================================================
const LANG = {
  ja: {
    title: 'å…ˆæŸ“ã‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼',
    subtitle: 'ç¹”ã‚Šçµ„ç¹” Ã— ç³¸ Ã— è‰²ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
    tabs: { design: 'ãƒ‡ã‚¶ã‚¤ãƒ³', weave: 'ç¹”ã‚Šçµ„ç¹”', yarn: 'ç³¸é¸æŠ', specs: 'è¦æ ¼' },
    pattern: 'ãƒ‘ã‚¿ãƒ¼ãƒ³',
    patterns: { check: 'ãƒã‚§ãƒƒã‚¯', stripe: 'ã‚¹ãƒˆãƒ©ã‚¤ãƒ—', solid: 'ç„¡åœ°(ç¹”ç›®ã®ã¿)' },
    warpColor: 'çµŒç³¸ï¼ˆãŸã¦ç³¸ï¼‰ã®è‰²',
    weftColor: 'ç·¯ç³¸ï¼ˆã‚ˆã“ç³¸ï¼‰ã®è‰²',
    pitch: 'æŸ„ãƒ”ãƒƒãƒ',
    zoom: 'ã‚ºãƒ¼ãƒ ',
    weaveCategory: 'ç¹”ã‚Šã‚«ãƒ†ã‚´ãƒª',
    selectWeave: 'ç¹”ã‚Šçµ„ç¹”ã‚’é¸æŠ',
    yarnCategory: 'ç´ æã‚«ãƒ†ã‚´ãƒª',
    warpYarn: 'çµŒç³¸ï¼ˆãŸã¦ç³¸ï¼‰',
    weftYarn: 'ç·¯ç³¸ï¼ˆã‚ˆã“ç³¸ï¼‰',
    customYarn: '+ ã‚«ã‚¹ã‚¿ãƒ ç³¸',
    epi: 'çµŒç³¸å¯†åº¦ (EPI)',
    ppi: 'ç·¯ç³¸å¯†åº¦ (PPI)',
    gsm: 'ç›®ä»˜',
    fabricSummary: 'ç”Ÿåœ°æ§‹æˆã‚µãƒãƒªãƒ¼',
    weaveType: 'ç¹”ã‚Šçµ„ç¹”',
    difficulty: 'é›£æ˜“åº¦',
    savePng: 'PNGä¿å­˜',
    riskAnalysis: 'ãƒªã‚¹ã‚¯åˆ†æ',
    risks: 'ä»¶ã®ãƒªã‚¹ã‚¯',
    sellingPoints: 'è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆ',
    preview: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
    quickColors: 'ã‚¯ã‚¤ãƒƒã‚¯ã‚«ãƒ©ãƒ¼',
    riskTitle: 'ç”Ÿç”£ãƒªã‚¹ã‚¯åˆ†æ',
    overallRisk: 'å…¨ä½“ãƒªã‚¹ã‚¯',
    noRisk: 'ç‰¹ç­†ã™ã¹ããƒªã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“',
    recommendations: 'æ¨å¥¨å¯¾ç­–',
    sellingPointsTitle: 'è²©å£²è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆ',
    copyText: 'ã‚³ãƒ”ãƒ¼æ–‡æ¡ˆ',
    copy: 'ã‚³ãƒ”ãƒ¼',
    keywords: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰',
    customYarnTitle: 'ã‚«ã‚¹ã‚¿ãƒ ç³¸ã‚’ä½œæˆ',
    yarnName: 'ç³¸ã®åå‰',
    yarnNamePlaceholder: 'ä¾‹: ã‚ªãƒªã‚¸ãƒŠãƒ«æ··ç´¡ç³¸',
    count: 'ç•ªæ‰‹',
    composition: 'ç´ ææ§‹æˆ',
    addFiber: '+ ç´ æè¿½åŠ ',
    total: 'åˆè¨ˆ',
    needHundred: '(100%ã«ã—ã¦ãã ã•ã„)',
    cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    save: 'ä¿å­˜',
    delete: 'å‰Šé™¤',
    characteristics: {
      durability: 'è€ä¹…', drape: 'ãƒ‰ãƒ¬ãƒ¼ãƒ—', breathability: 'é€šæ°—',
      wrinkleResistance: 'é˜²ã‚·ãƒ¯', shine: 'å…‰æ²¢',
      strength: 'å¼·åº¦', softness: 'æŸ”ã‚‰ã‹ã•', luster: 'å…‰æ²¢',
      elasticity: 'å¼¾åŠ›', absorbency: 'å¸æ¹¿'
    },
    weaveCategories: {
      plain: 'å¹³ç¹”ç³»', twill: 'ç¶¾ç¹”ç³»', satin: 'æœ±å­ç¹”ç³»',
      dobby: 'ãƒ‰ãƒ“ãƒ¼ç¹”', jacquard: 'ã‚¸ãƒ£ã‚«ãƒ¼ãƒ‰', pile: 'ãƒ‘ã‚¤ãƒ«ç¹”', special: 'ç‰¹æ®Šç¹”'
    },
    fiberCategories: {
      cotton: 'ç¶¿', linen: 'éº»', wool: 'ç¾Šæ¯›', silk: 'çµ¹',
      synthetic: 'åˆæˆç¹Šç¶­', regenerated: 'å†ç”Ÿç¹Šç¶­', blend: 'æ··ç´¡', specialty: 'ç‰¹æ®Šç¹Šç¶­'
    },
    fibers: {
      cotton: 'ç¶¿', polyester: 'ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«', wool: 'ã‚¦ãƒ¼ãƒ«', linen: 'éº»',
      silk: 'ã‚·ãƒ«ã‚¯', nylon: 'ãƒŠã‚¤ãƒ­ãƒ³', viscose: 'ãƒ¬ãƒ¼ãƒ¨ãƒ³', spandex: 'ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹',
      modal: 'ãƒ¢ãƒ€ãƒ¼ãƒ«', lyocell: 'ãƒ†ãƒ³ã‚»ãƒ«', cashmere: 'ã‚«ã‚·ãƒŸãƒ¤', acrylic: 'ã‚¢ã‚¯ãƒªãƒ«'
    },
    riskLevels: { none: 'ãªã—', low: 'ä½', medium: 'ä¸­', high: 'é«˜', critical: 'è¦æ³¨æ„' },
    weightCategories: {
      ultraLight: 'æ¥µè–„åœ°', light: 'è–„åœ°', mediumLight: 'ä¸­è–„åœ°',
      medium: 'ä¸­åšåœ°', heavy: 'åšåœ°', ultraHeavy: 'æ¥µåšåœ°'
    }
  },
  zh: {
    title: 'è‰²ç»‡æ¨¡æ‹Ÿå™¨',
    subtitle: 'ç»‡ç‰©ç»„ç»‡ Ã— çº±çº¿ Ã— é¢œè‰²çš„å®æ—¶é¢„è§ˆ',
    tabs: { design: 'è®¾è®¡', weave: 'ç»‡ç‰©ç»„ç»‡', yarn: 'çº±çº¿é€‰æ‹©', specs: 'è§„æ ¼' },
    pattern: 'å›¾æ¡ˆ',
    patterns: { check: 'æ ¼å­', stripe: 'æ¡çº¹', solid: 'ç´ è‰²(ä»…ç»‡çº¹)' },
    warpColor: 'ç»çº±é¢œè‰²',
    weftColor: 'çº¬çº±é¢œè‰²',
    pitch: 'èŠ±çº¹é—´è·',
    zoom: 'ç¼©æ”¾',
    weaveCategory: 'ç»‡ç‰©ç±»åˆ«',
    selectWeave: 'é€‰æ‹©ç»‡ç‰©ç»„ç»‡',
    yarnCategory: 'æè´¨ç±»åˆ«',
    warpYarn: 'ç»çº±',
    weftYarn: 'çº¬çº±',
    customYarn: '+ è‡ªå®šä¹‰çº±çº¿',
    epi: 'ç»å¯† (EPI)',
    ppi: 'çº¬å¯† (PPI)',
    gsm: 'å…‹é‡',
    fabricSummary: 'é¢æ–™æ„æˆæ‘˜è¦',
    weaveType: 'ç»‡ç‰©ç»„ç»‡',
    difficulty: 'éš¾åº¦',
    savePng: 'ä¿å­˜PNG',
    riskAnalysis: 'é£é™©åˆ†æ',
    risks: 'é¡¹é£é™©',
    sellingPoints: 'å–ç‚¹',
    preview: 'é¢„è§ˆ',
    quickColors: 'å¿«é€Ÿé€‰è‰²',
    riskTitle: 'ç”Ÿäº§é£é™©åˆ†æ',
    overallRisk: 'æ•´ä½“é£é™©',
    noRisk: 'æ²¡æœ‰éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é£é™©',
    recommendations: 'å»ºè®®æªæ–½',
    sellingPointsTitle: 'é”€å”®å–ç‚¹',
    copyText: 'æ–‡æ¡ˆ',
    copy: 'å¤åˆ¶',
    keywords: 'å…³é”®è¯',
    customYarnTitle: 'åˆ›å»ºè‡ªå®šä¹‰çº±çº¿',
    yarnName: 'çº±çº¿åç§°',
    yarnNamePlaceholder: 'ä¾‹: åŸåˆ›æ··çººçº±',
    count: 'æ”¯æ•°',
    composition: 'æˆåˆ†æ„æˆ',
    addFiber: '+ æ·»åŠ æˆåˆ†',
    total: 'åˆè®¡',
    needHundred: '(éœ€è¦100%)',
    cancel: 'å–æ¶ˆ',
    save: 'ä¿å­˜',
    delete: 'åˆ é™¤',
    characteristics: {
      durability: 'è€ä¹…', drape: 'å‚æ„Ÿ', breathability: 'é€æ°”',
      wrinkleResistance: 'æŠ—çš±', shine: 'å…‰æ³½',
      strength: 'å¼ºåº¦', softness: 'æŸ”è½¯åº¦', luster: 'å…‰æ³½',
      elasticity: 'å¼¹æ€§', absorbency: 'å¸æ¹¿'
    },
    weaveCategories: {
      plain: 'å¹³çº¹ç³»', twill: 'æ–œçº¹ç³»', satin: 'ç¼çº¹ç³»',
      dobby: 'å¤šè‡‚ç»‡', jacquard: 'æèŠ±', pile: 'æ¯›åœˆç»‡', special: 'ç‰¹æ®Šç»‡'
    },
    fiberCategories: {
      cotton: 'æ£‰', linen: 'éº»', wool: 'ç¾Šæ¯›', silk: 'ä¸ç»¸',
      synthetic: 'åˆæˆçº¤ç»´', regenerated: 'å†ç”Ÿçº¤ç»´', blend: 'æ··çºº', specialty: 'ç‰¹ç§çº¤ç»´'
    },
    fibers: {
      cotton: 'æ£‰', polyester: 'æ¶¤çº¶', wool: 'ç¾Šæ¯›', linen: 'éº»',
      silk: 'ä¸ç»¸', nylon: 'å°¼é¾™', viscose: 'ç²˜èƒ¶', spandex: 'æ°¨çº¶',
      modal: 'è«ä»£å°”', lyocell: 'å¤©ä¸', cashmere: 'ç¾Šç»’', acrylic: 'è…ˆçº¶'
    },
    riskLevels: { none: 'æ— ', low: 'ä½', medium: 'ä¸­', high: 'é«˜', critical: 'éœ€æ³¨æ„' },
    weightCategories: {
      ultraLight: 'æè–„', light: 'è–„å‹', mediumLight: 'ä¸­è–„',
      medium: 'ä¸­åš', heavy: 'åšå‹', ultraHeavy: 'æåš'
    }
  }
};

// ============================================================
// ç¹”ã‚Šçµ„ç¹”ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
// ============================================================
function createMatrix(rows, cols, pattern) {
  const matrix = [];
  for (let y = 0; y < rows; y++) {
    const row = [];
    for (let x = 0; x < cols; x++) { row.push(pattern(x, y)); }
    matrix.push(row);
  }
  return matrix;
}

const WEAVE_DATABASE = [
  // å¹³ç¹”ç³»
  { id: 'plain', name: { ja: 'å¹³ç¹”', zh: 'å¹³çº¹' }, category: 'plain',
    matrix: createMatrix(2, 2, (x, y) => (x + y) % 2 === 0), repeatX: 2, repeatY: 2,
    characteristics: { durability: 5, drape: 2, breathability: 5, wrinkleResistance: 2, shine: 1 },
    gsmModifier: 1.0, difficulty: 1, applications: { ja: ['ã‚·ãƒ£ãƒ„', 'ãƒ–ãƒ©ã‚¦ã‚¹'], zh: ['è¡¬è¡«', 'å¥³è¡¬è¡«'] } },
  { id: 'oxford', name: { ja: 'ã‚ªãƒƒã‚¯ã‚¹ãƒ•ã‚©ãƒ¼ãƒ‰', zh: 'ç‰›æ´¥å¸ƒ' }, category: 'plain',
    matrix: createMatrix(4, 4, (x, y) => { const px = Math.floor(x/2), py = Math.floor(y/2); return (px+py)%2===0; }),
    repeatX: 4, repeatY: 4, characteristics: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 2 },
    gsmModifier: 1.15, difficulty: 2, applications: { ja: ['ãƒœã‚¿ãƒ³ãƒ€ã‚¦ãƒ³ã‚·ãƒ£ãƒ„'], zh: ['çº½æ‰£é¢†è¡¬è¡«'] } },
  { id: 'broadcloth', name: { ja: 'ãƒ–ãƒ­ãƒ¼ãƒ‰', zh: 'åºœç»¸' }, category: 'plain',
    matrix: createMatrix(2, 2, (x, y) => (x + y) % 2 === 0), repeatX: 2, repeatY: 2,
    characteristics: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 3 },
    gsmModifier: 0.95, difficulty: 2, applications: { ja: ['ãƒ‰ãƒ¬ã‚¹ã‚·ãƒ£ãƒ„'], zh: ['æ­£è£…è¡¬è¡«'] } },
  { id: 'poplin', name: { ja: 'ãƒãƒ—ãƒªãƒ³', zh: 'ç»†å¸ƒ' }, category: 'plain',
    matrix: createMatrix(2, 2, (x, y) => (x + y) % 2 === 0), repeatX: 2, repeatY: 2,
    characteristics: { durability: 4, drape: 4, breathability: 4, wrinkleResistance: 3, shine: 3 },
    gsmModifier: 0.9, difficulty: 2, applications: { ja: ['ã‚¹ãƒ¼ãƒ„', 'ã‚³ãƒ¼ãƒˆ'], zh: ['è¥¿è£…', 'å¤–å¥—'] } },
  { id: 'canvas', name: { ja: 'å¸†å¸ƒ', zh: 'å¸†å¸ƒ' }, category: 'plain',
    matrix: createMatrix(2, 2, (x, y) => (x + y) % 2 === 0), repeatX: 2, repeatY: 2,
    characteristics: { durability: 5, drape: 1, breathability: 3, wrinkleResistance: 4, shine: 1 },
    gsmModifier: 2.0, difficulty: 2, applications: { ja: ['ãƒãƒƒã‚°', 'ãƒ†ãƒ³ãƒˆ'], zh: ['åŒ…', 'å¸ç¯·'] } },
  { id: 'ripstop', name: { ja: 'ãƒªãƒƒãƒ—ã‚¹ãƒˆãƒƒãƒ—', zh: 'é˜²æ’•è£‚å¸ƒ' }, category: 'plain',
    matrix: createMatrix(8, 8, (x, y) => { if (x%8===0||y%8===0) return true; return (x+y)%2===0; }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 5, drape: 3, breathability: 4, wrinkleResistance: 4, shine: 2 },
    gsmModifier: 1.1, difficulty: 3, applications: { ja: ['ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢'], zh: ['æˆ·å¤–æœè£…'] } },

  // ç¶¾ç¹”ç³»
  { id: 'twill_2_1', name: { ja: '2/1ãƒ„ã‚¤ãƒ«', zh: '2/1æ–œçº¹' }, category: 'twill',
    matrix: createMatrix(3, 3, (x, y) => (x + y) % 3 < 2), repeatX: 3, repeatY: 3,
    characteristics: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 3, shine: 3 },
    gsmModifier: 1.05, difficulty: 2, applications: { ja: ['ãƒãƒãƒ‘ãƒ³'], zh: ['å¡å…¶è£¤'] } },
  { id: 'twill_2_2', name: { ja: '2/2ãƒ„ã‚¤ãƒ«', zh: '2/2æ–œçº¹' }, category: 'twill',
    matrix: createMatrix(4, 4, (x, y) => (x + y) % 4 < 2), repeatX: 4, repeatY: 4,
    characteristics: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 4, shine: 3 },
    gsmModifier: 1.1, difficulty: 2, applications: { ja: ['ã‚¹ãƒ¼ãƒ„'], zh: ['è¥¿è£…'] } },
  { id: 'twill_3_1', name: { ja: '3/1ãƒ„ã‚¤ãƒ«', zh: '3/1æ–œçº¹' }, category: 'twill',
    matrix: createMatrix(4, 4, (x, y) => (x + y) % 4 < 3), repeatX: 4, repeatY: 4,
    characteristics: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 4, shine: 4 },
    gsmModifier: 1.1, difficulty: 2, applications: { ja: ['ãƒ‡ãƒ‹ãƒ '], zh: ['ç‰›ä»”å¸ƒ'] } },
  { id: 'denim', name: { ja: 'ãƒ‡ãƒ‹ãƒ ', zh: 'ç‰›ä»”å¸ƒ' }, category: 'twill',
    matrix: createMatrix(4, 4, (x, y) => (x - y + 4) % 4 < 3), repeatX: 4, repeatY: 4,
    characteristics: { durability: 5, drape: 2, breathability: 3, wrinkleResistance: 3, shine: 2 },
    gsmModifier: 1.4, difficulty: 2, applications: { ja: ['ã‚¸ãƒ¼ãƒ³ã‚º'], zh: ['ç‰›ä»”è£¤'] } },
  { id: 'herringbone', name: { ja: 'ãƒ˜ãƒªãƒ³ãƒœãƒ¼ãƒ³', zh: 'äººå­—çº¹' }, category: 'twill',
    matrix: createMatrix(8, 8, (x, y) => { const p=4, xM=x%(p*2), off=xM<p?xM:(p*2-1-xM); return ((y+off)%4)<2; }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 4, shine: 3 },
    gsmModifier: 1.15, difficulty: 3, applications: { ja: ['ã‚¸ãƒ£ã‚±ãƒƒãƒˆ', 'ã‚³ãƒ¼ãƒˆ'], zh: ['å¤¹å…‹', 'å¤–å¥—'] } },
  { id: 'gabardine', name: { ja: 'ã‚®ãƒ£ãƒã‚¸ãƒ³', zh: 'åè¾¾å‘¢' }, category: 'twill',
    matrix: createMatrix(4, 4, (x, y) => (x + y * 2) % 4 < 2), repeatX: 4, repeatY: 4,
    characteristics: { durability: 5, drape: 3, breathability: 3, wrinkleResistance: 5, shine: 4 },
    gsmModifier: 1.2, difficulty: 3, applications: { ja: ['ãƒˆãƒ¬ãƒ³ãƒã‚³ãƒ¼ãƒˆ'], zh: ['é£è¡£'] } },
  { id: 'cavalry', name: { ja: 'ã‚«ãƒãƒ«ãƒªãƒ¼ãƒ„ã‚¤ãƒ«', zh: 'éª‘å…µæ–œçº¹' }, category: 'twill',
    matrix: createMatrix(6, 6, (x, y) => (x * 2 + y) % 6 < 4), repeatX: 6, repeatY: 6,
    characteristics: { durability: 5, drape: 3, breathability: 3, wrinkleResistance: 5, shine: 3 },
    gsmModifier: 1.25, difficulty: 4, applications: { ja: ['ä¹—é¦¬ãƒ‘ãƒ³ãƒ„'], zh: ['é©¬è£¤'] } },

  // æœ±å­ç¹”ç³»
  { id: 'satin_5', name: { ja: '5æšæœ±å­', zh: 'äº”æšç¼' }, category: 'satin',
    matrix: createMatrix(5, 5, (x, y) => (x + y * 2) % 5 === 0), repeatX: 5, repeatY: 5,
    characteristics: { durability: 2, drape: 5, breathability: 3, wrinkleResistance: 2, shine: 5 },
    gsmModifier: 1.0, difficulty: 3, applications: { ja: ['ãƒ‰ãƒ¬ã‚¹', 'ã‚¹ã‚«ãƒ¼ãƒ•'], zh: ['ç¤¼æœ', 'ä¸å·¾'] } },
  { id: 'satin_8', name: { ja: '8æšæœ±å­', zh: 'å…«æšç¼' }, category: 'satin',
    matrix: createMatrix(8, 8, (x, y) => (x + y * 3) % 8 === 0), repeatX: 8, repeatY: 8,
    characteristics: { durability: 2, drape: 5, breathability: 3, wrinkleResistance: 2, shine: 5 },
    gsmModifier: 1.05, difficulty: 4, applications: { ja: ['ã‚¤ãƒ–ãƒ‹ãƒ³ã‚°ãƒ‰ãƒ¬ã‚¹'], zh: ['æ™šç¤¼æœ'] } },
  { id: 'sateen', name: { ja: 'ã‚µãƒ†ãƒ³', zh: 'è´¡ç¼' }, category: 'satin',
    matrix: createMatrix(5, 5, (x, y) => (y + x * 2) % 5 === 0), repeatX: 5, repeatY: 5,
    characteristics: { durability: 3, drape: 5, breathability: 3, wrinkleResistance: 2, shine: 4 },
    gsmModifier: 1.0, difficulty: 3, applications: { ja: ['ã‚·ãƒ¼ãƒ„'], zh: ['åºŠå•'] } },

  // ãƒ‰ãƒ“ãƒ¼ç¹”
  { id: 'dobby_diamond', name: { ja: 'ãƒ‰ãƒ“ãƒ¼ãƒ€ã‚¤ãƒ¤', zh: 'å¤šè‡‚è±å½¢' }, category: 'dobby',
    matrix: createMatrix(8, 8, (x, y) => { const cx=Math.abs(x-3.5), cy=Math.abs(y-3.5); return (cx+cy)<3; }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 2 },
    gsmModifier: 1.05, difficulty: 4, applications: { ja: ['ã‚·ãƒ£ãƒ„'], zh: ['è¡¬è¡«'] } },
  { id: 'pique', name: { ja: 'ãƒ”ã‚±', zh: 'ç åœ°å¸ƒ' }, category: 'dobby',
    matrix: createMatrix(4, 4, (x, y) => y % 2 === 0), repeatX: 4, repeatY: 4,
    characteristics: { durability: 4, drape: 2, breathability: 5, wrinkleResistance: 4, shine: 2 },
    gsmModifier: 1.15, difficulty: 3, applications: { ja: ['ãƒãƒ­ã‚·ãƒ£ãƒ„'], zh: ['Poloè¡«'] } },
  { id: 'waffle', name: { ja: 'ãƒ¯ãƒƒãƒ•ãƒ«', zh: 'åå¤«æ ¼' }, category: 'dobby',
    matrix: createMatrix(8, 8, (x, y) => { const z=(Math.floor(x/4)+Math.floor(y/4))%2; return z===0?(x%4<2)===(y%4<2):(x%4>=2)===(y%4>=2); }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 3, drape: 3, breathability: 5, wrinkleResistance: 2, shine: 1 },
    gsmModifier: 1.3, difficulty: 4, applications: { ja: ['ã‚¿ã‚ªãƒ«'], zh: ['æ¯›å·¾'] } },
  { id: 'houndstooth', name: { ja: 'åƒé³¥æ ¼å­', zh: 'åƒé¸Ÿæ ¼' }, category: 'dobby',
    matrix: createMatrix(8, 8, (x, y) => { const b=4, bx=Math.floor(x/b), by=Math.floor(y/b), lx=x%b, ly=y%b; return (bx+by)%2===0?(lx<2||ly<2):(lx>=2&&ly>=2); }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 4, drape: 3, breathability: 3, wrinkleResistance: 4, shine: 2 },
    gsmModifier: 1.1, difficulty: 4, applications: { ja: ['ã‚¸ãƒ£ã‚±ãƒƒãƒˆ'], zh: ['å¤¹å…‹'] } },
  { id: 'birds_eye', name: { ja: 'ãƒãƒ¼ã‚ºã‚¢ã‚¤', zh: 'é¸Ÿçœ¼çº¹' }, category: 'dobby',
    matrix: createMatrix(4, 4, (x, y) => (x%4===1||x%4===2)&&(y%4===1||y%4===2)), repeatX: 4, repeatY: 4,
    characteristics: { durability: 4, drape: 3, breathability: 4, wrinkleResistance: 3, shine: 2 },
    gsmModifier: 1.05, difficulty: 3, applications: { ja: ['ã‚¿ã‚ªãƒ«'], zh: ['æ¯›å·¾'] } },

  // ã‚¸ãƒ£ã‚«ãƒ¼ãƒ‰
  { id: 'damask', name: { ja: 'ãƒ€ãƒã‚¹ã‚¯', zh: 'é”¦ç¼' }, category: 'jacquard',
    matrix: createMatrix(16, 16, (x, y) => { const cx=Math.abs(x-7.5), cy=Math.abs(y-7.5); return (cx+cy)<6||(x%4===0&&y%4===0); }),
    repeatX: 16, repeatY: 16, characteristics: { durability: 4, drape: 4, breathability: 3, wrinkleResistance: 3, shine: 4 },
    gsmModifier: 1.2, difficulty: 5, applications: { ja: ['ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¯ãƒ­ã‚¹'], zh: ['æ¡Œå¸ƒ'] } },
  { id: 'brocade', name: { ja: 'ãƒ–ãƒ­ã‚±ãƒ¼ãƒ‰', zh: 'ç»‡é”¦' }, category: 'jacquard',
    matrix: createMatrix(12, 12, (x, y) => Math.sin(x*0.8)*Math.cos(y*0.8)>0.3||(x+y)%3===0),
    repeatX: 12, repeatY: 12, characteristics: { durability: 3, drape: 3, breathability: 2, wrinkleResistance: 4, shine: 5 },
    gsmModifier: 1.4, difficulty: 5, applications: { ja: ['ãƒ•ã‚©ãƒ¼ãƒãƒ«ã‚¦ã‚§ã‚¢'], zh: ['æ­£è£…'] } },

  // ãƒ‘ã‚¤ãƒ«ç¹”
  { id: 'velvet', name: { ja: 'ãƒ™ãƒ«ãƒ™ãƒƒãƒˆ', zh: 'ä¸ç»’' }, category: 'pile',
    matrix: createMatrix(4, 4, (x, y) => y % 2 === 0), repeatX: 4, repeatY: 4,
    characteristics: { durability: 3, drape: 4, breathability: 2, wrinkleResistance: 2, shine: 4 },
    gsmModifier: 1.8, difficulty: 5, applications: { ja: ['ãƒ‰ãƒ¬ã‚¹'], zh: ['ç¤¼æœ'] } },
  { id: 'corduroy', name: { ja: 'ã‚³ãƒ¼ãƒ‡ãƒ¥ãƒ­ã‚¤', zh: 'ç¯èŠ¯ç»’' }, category: 'pile',
    matrix: createMatrix(8, 4, (x, y) => x % 8 < 4 && y % 2 === 0), repeatX: 8, repeatY: 4,
    characteristics: { durability: 4, drape: 3, breathability: 3, wrinkleResistance: 3, shine: 2 },
    gsmModifier: 1.6, difficulty: 4, applications: { ja: ['ãƒ‘ãƒ³ãƒ„'], zh: ['è£¤å­'] } },
  { id: 'terry', name: { ja: 'ãƒ†ãƒªãƒ¼', zh: 'æ¯›åœˆå¸ƒ' }, category: 'pile',
    matrix: createMatrix(4, 4, () => true), repeatX: 4, repeatY: 4,
    characteristics: { durability: 4, drape: 2, breathability: 5, wrinkleResistance: 2, shine: 1 },
    gsmModifier: 2.0, difficulty: 3, applications: { ja: ['ã‚¿ã‚ªãƒ«', 'ãƒã‚¹ãƒ­ãƒ¼ãƒ–'], zh: ['æ¯›å·¾', 'æµ´è¢'] } },

  // ç‰¹æ®Šç¹”
  { id: 'leno', name: { ja: 'çµ¡ã¿ç¹”', zh: 'çº±ç½—ç»‡' }, category: 'special',
    matrix: createMatrix(4, 4, (x) => x % 2 === 0), repeatX: 4, repeatY: 4,
    characteristics: { durability: 3, drape: 4, breathability: 5, wrinkleResistance: 2, shine: 2 },
    gsmModifier: 0.7, difficulty: 4, applications: { ja: ['ã‚«ãƒ¼ãƒ†ãƒ³'], zh: ['çª—å¸˜'] } },
  { id: 'double_cloth', name: { ja: 'äºŒé‡ç¹”', zh: 'åŒå±‚ç»‡' }, category: 'special',
    matrix: createMatrix(8, 8, (x, y) => { const l=Math.floor(y/4); return l===0?(x+y)%2===0:(x+y)%2===1; }),
    repeatX: 8, repeatY: 8, characteristics: { durability: 5, drape: 2, breathability: 2, wrinkleResistance: 4, shine: 2 },
    gsmModifier: 2.0, difficulty: 5, applications: { ja: ['ã‚³ãƒ¼ãƒˆ'], zh: ['å¤–å¥—'] } },
  { id: 'seersucker', name: { ja: 'ã‚·ã‚¢ã‚µãƒƒã‚«ãƒ¼', zh: 'æ³¡æ³¡çº±' }, category: 'special',
    matrix: createMatrix(8, 4, (x, y) => { const z=Math.floor(x/4)%2; return z===0?(x+y)%2===0:y%2===0; }),
    repeatX: 8, repeatY: 4, characteristics: { durability: 4, drape: 3, breathability: 5, wrinkleResistance: 4, shine: 1 },
    gsmModifier: 1.0, difficulty: 4, applications: { ja: ['å¤ç‰©ã‚¹ãƒ¼ãƒ„'], zh: ['å¤å­£è¥¿è£…'] } },
  { id: 'honeycomb', name: { ja: 'ãƒãƒ‹ã‚«ãƒ ', zh: 'èœ‚å·¢ç»‡' }, category: 'special',
    matrix: createMatrix(12, 12, (x, y) => { const hx=x%6, hy=y%6, off=Math.floor(y/6)%2===0?0:3, ax=(x+off)%6; return !((ax===2||ax===3)&&(hy===2||hy===3)); }),
    repeatX: 12, repeatY: 12, characteristics: { durability: 4, drape: 3, breathability: 5, wrinkleResistance: 3, shine: 1 },
    gsmModifier: 1.2, difficulty: 4, applications: { ja: ['ã‚¿ã‚ªãƒ«'], zh: ['æ¯›å·¾'] } },
];

// ============================================================
// ç³¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
// ============================================================
const YARN_DATABASE = [
  // ç¶¿
  { id: 'cotton_20', name: { ja: 'ã‚«ãƒ¼ãƒ‰ç¶¿ç³¸ 20ç•ªæ‰‹', zh: 'æ™®æ¢³æ£‰çº± 20æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 20 },
    characteristics: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 2 },
  { id: 'cotton_30', name: { ja: 'ã‚«ãƒ¼ãƒ‰ç¶¿ç³¸ 30ç•ªæ‰‹', zh: 'æ™®æ¢³æ£‰çº± 30æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 30 },
    characteristics: { strength: 3, softness: 3, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 2 },
  { id: 'cotton_40', name: { ja: 'ã‚«ãƒ¼ãƒ‰ç¶¿ç³¸ 40ç•ªæ‰‹', zh: 'æ™®æ¢³æ£‰çº± 40æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 3, softness: 4, luster: 2, elasticity: 2, absorbency: 5, durability: 3 }, price: 3,
    risks: { ja: ['é«˜é€Ÿç¹”æ©Ÿã§ç³¸åˆ‡ã‚Œãƒªã‚¹ã‚¯'], zh: ['é«˜é€Ÿç»‡æœºæ˜“æ–­çº¿'] } },
  { id: 'combed_40', name: { ja: 'ã‚³ãƒ¼ãƒç¶¿ç³¸ 40ç•ªæ‰‹', zh: 'ç²¾æ¢³æ£‰çº± 40æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 4 },
  { id: 'combed_60', name: { ja: 'ã‚³ãƒ¼ãƒç¶¿ç³¸ 60ç•ªæ‰‹', zh: 'ç²¾æ¢³æ£‰çº± 60æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 60 },
    characteristics: { strength: 3, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 3 }, price: 5,
    risks: { ja: ['ç¹”æ©Ÿé€Ÿåº¦åˆ¶é™', 'ç³¸åˆ‡ã‚Œæ³¨æ„'], zh: ['éœ€é™åˆ¶ç»‡æœºé€Ÿåº¦', 'æ³¨æ„æ–­çº¿'] } },
  { id: 'combed_80', name: { ja: 'ã‚³ãƒ¼ãƒç¶¿ç³¸ 80ç•ªæ‰‹', zh: 'ç²¾æ¢³æ£‰çº± 80æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 80 },
    characteristics: { strength: 3, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 3 }, price: 6,
    risks: { ja: ['ç³¸åˆ‡ã‚Œé »ç™ºãƒªã‚¹ã‚¯'], zh: ['æ–­çº¿é£é™©é«˜'] } },
  { id: 'mercerized_60', name: { ja: 'ãƒãƒ¼ã‚»ãƒ©ã‚¤ã‚ºç¶¿ 60ç•ªæ‰‹', zh: 'ä¸å…‰æ£‰ 60æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100 }], count: { ne: 60 },
    characteristics: { strength: 5, softness: 5, luster: 5, elasticity: 3, absorbency: 4, durability: 5 }, price: 5 },
  { id: 'organic_30', name: { ja: 'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ã‚³ãƒƒãƒˆãƒ³ 30ç•ªæ‰‹', zh: 'æœ‰æœºæ£‰ 30æ”¯' }, category: 'cotton',
    composition: [{ fiber: 'cotton', pct: 100, organic: true }], count: { ne: 30 },
    characteristics: { strength: 3, softness: 4, luster: 2, elasticity: 2, absorbency: 5, durability: 4 }, price: 5,
    certifications: ['GOTS'] },

  // éº»
  { id: 'linen_wet_40', name: { ja: 'ãƒªãƒãƒ³æ¹¿å¼ 40ç•ªæ‰‹', zh: 'æ¹¿çººäºšéº» 40æ”¯' }, category: 'linen',
    composition: [{ fiber: 'linen', pct: 100 }], count: { ne: 24 },
    characteristics: { strength: 5, softness: 2, luster: 4, elasticity: 1, absorbency: 5, durability: 5 }, price: 6,
    risks: { ja: ['ä¹¾ç‡¥ã§ç³¸åˆ‡ã‚Œ'], zh: ['å¹²ç‡¥æ˜“æ–­çº¿'] } },
  { id: 'linen_dry_20', name: { ja: 'ãƒªãƒãƒ³ä¹¾å¼ 20ç•ªæ‰‹', zh: 'å¹²çººäºšéº» 20æ”¯' }, category: 'linen',
    composition: [{ fiber: 'linen', pct: 100 }], count: { ne: 12 },
    characteristics: { strength: 5, softness: 1, luster: 3, elasticity: 1, absorbency: 5, durability: 5 }, price: 4 },
  { id: 'ramie_40', name: { ja: 'ãƒ©ãƒŸãƒ¼ 40ç•ªæ‰‹', zh: 'è‹éº» 40æ”¯' }, category: 'linen',
    composition: [{ fiber: 'ramie', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 5, softness: 2, luster: 5, elasticity: 1, absorbency: 5, durability: 5 }, price: 5 },

  // ç¾Šæ¯›
  { id: 'merino_60', name: { ja: 'ãƒ¡ãƒªãƒã‚¦ãƒ¼ãƒ« 60ç•ªæ‰‹', zh: 'ç¾åˆ©å¥´ç¾Šæ¯› 60æ”¯' }, category: 'wool',
    composition: [{ fiber: 'wool', pct: 100 }], count: { nm: 60 },
    characteristics: { strength: 3, softness: 5, luster: 4, elasticity: 5, absorbency: 4, durability: 3 }, price: 6,
    risks: { ja: ['è™«å®³æ³¨æ„', 'ãƒ”ãƒªãƒ³ã‚°'], zh: ['æ³¨æ„è™«è›€', 'èµ·çƒ'] } },
  { id: 'merino_80', name: { ja: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ³ãƒ¡ãƒªãƒ 80ç•ªæ‰‹', zh: 'è¶…ç»†ç¾åˆ©å¥´ 80æ”¯' }, category: 'wool',
    composition: [{ fiber: 'wool', pct: 100 }], count: { nm: 80 },
    characteristics: { strength: 2, softness: 5, luster: 5, elasticity: 5, absorbency: 4, durability: 3 }, price: 7 },
  { id: 'worsted_48', name: { ja: 'æ¢³æ¯›ç³¸ 48ç•ªæ‰‹', zh: 'ç²¾çººæ¯›çº± 48æ”¯' }, category: 'wool',
    composition: [{ fiber: 'wool', pct: 100 }], count: { nm: 48 },
    characteristics: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 4, durability: 4 }, price: 5 },
  { id: 'cashmere_60', name: { ja: 'ã‚«ã‚·ãƒŸãƒ¤ 60ç•ªæ‰‹', zh: 'ç¾Šç»’ 60æ”¯' }, category: 'wool',
    composition: [{ fiber: 'cashmere', pct: 100 }], count: { nm: 60 },
    characteristics: { strength: 2, softness: 5, luster: 5, elasticity: 4, absorbency: 4, durability: 2 }, price: 8,
    risks: { ja: ['ãƒ”ãƒªãƒ³ã‚°é »ç™º', 'è™«å®³æ³¨æ„'], zh: ['æ˜“èµ·çƒ', 'æ³¨æ„è™«è›€'] } },
  { id: 'alpaca_36', name: { ja: 'ã‚¢ãƒ«ãƒ‘ã‚« 36ç•ªæ‰‹', zh: 'ç¾Šé©¼æ¯› 36æ”¯' }, category: 'wool',
    composition: [{ fiber: 'alpaca', pct: 100 }], count: { nm: 36 },
    characteristics: { strength: 4, softness: 5, luster: 5, elasticity: 3, absorbency: 3, durability: 5 }, price: 6 },

  // çµ¹
  { id: 'silk_21d', name: { ja: 'ç”Ÿç³¸ 21ãƒ‡ãƒ‹ãƒ¼ãƒ«', zh: 'ç”Ÿä¸ 21æ—¦' }, category: 'silk',
    composition: [{ fiber: 'silk', pct: 100 }], count: { denier: 126 },
    characteristics: { strength: 5, softness: 5, luster: 5, elasticity: 4, absorbency: 4, durability: 4 }, price: 7,
    risks: { ja: ['ç´«å¤–ç·šåŠ£åŒ–', 'è™«å®³'], zh: ['ç´«å¤–çº¿æ˜“æŸ', 'è™«è›€'] } },
  { id: 'spun_silk_60', name: { ja: 'çµ¹ç´¡ç³¸ 60ç•ªæ‰‹', zh: 'ç»¢çººçº± 60æ”¯' }, category: 'silk',
    composition: [{ fiber: 'silk', pct: 100 }], count: { nm: 60 },
    characteristics: { strength: 3, softness: 5, luster: 4, elasticity: 3, absorbency: 4, durability: 3 }, price: 6 },

  // åˆæˆç¹Šç¶­
  { id: 'polyester_75d', name: { ja: 'ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ« 75D', zh: 'æ¶¤çº¶ 75D' }, category: 'synthetic',
    composition: [{ fiber: 'polyester', pct: 100 }], count: { denier: 75 },
    characteristics: { strength: 5, softness: 3, luster: 4, elasticity: 4, absorbency: 1, durability: 5 }, price: 2,
    risks: { ja: ['é™é›»æ°—', 'ç†±ã«æ³¨æ„'], zh: ['é™ç”µ', 'æ³¨æ„çƒ­'] } },
  { id: 'polyester_spun_30', name: { ja: 'ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«ã‚¹ãƒ‘ãƒ³ 30ç•ªæ‰‹', zh: 'æ¶¤çº¶çŸ­çº¤ 30æ”¯' }, category: 'synthetic',
    composition: [{ fiber: 'polyester', pct: 100 }], count: { ne: 30 },
    characteristics: { strength: 5, softness: 3, luster: 3, elasticity: 3, absorbency: 1, durability: 5 }, price: 1 },
  { id: 'nylon_70d', name: { ja: 'ãƒŠã‚¤ãƒ­ãƒ³ 70D', zh: 'å°¼é¾™ 70D' }, category: 'synthetic',
    composition: [{ fiber: 'nylon', pct: 100 }], count: { denier: 70 },
    characteristics: { strength: 5, softness: 4, luster: 4, elasticity: 5, absorbency: 2, durability: 5 }, price: 3 },
  { id: 'acrylic_32', name: { ja: 'ã‚¢ã‚¯ãƒªãƒ« 32ç•ªæ‰‹', zh: 'è…ˆçº¶ 32æ”¯' }, category: 'synthetic',
    composition: [{ fiber: 'acrylic', pct: 100 }], count: { nm: 32 },
    characteristics: { strength: 3, softness: 4, luster: 3, elasticity: 3, absorbency: 1, durability: 4 }, price: 2 },
  { id: 'spandex_40d', name: { ja: 'ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 40D', zh: 'æ°¨çº¶ 40D' }, category: 'synthetic',
    composition: [{ fiber: 'spandex', pct: 100 }], count: { denier: 40 },
    characteristics: { strength: 3, softness: 4, luster: 2, elasticity: 5, absorbency: 1, durability: 3 }, price: 4 },

  // å†ç”Ÿç¹Šç¶­
  { id: 'viscose_40', name: { ja: 'ãƒ“ã‚¹ã‚³ãƒ¼ã‚¹ãƒ¬ãƒ¼ãƒ¨ãƒ³ 40ç•ªæ‰‹', zh: 'ç²˜èƒ¶äººä¸ 40æ”¯' }, category: 'regenerated',
    composition: [{ fiber: 'viscose', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 2, softness: 5, luster: 5, elasticity: 2, absorbency: 5, durability: 2 }, price: 3,
    risks: { ja: ['æ¹¿æ½¤æ™‚å¼·åº¦ä½ä¸‹', 'åç¸®'], zh: ['æ¹¿å¼ºä½', 'æ˜“ç¼©æ°´'] } },
  { id: 'modal_50', name: { ja: 'ãƒ¢ãƒ€ãƒ¼ãƒ« 50ç•ªæ‰‹', zh: 'è«ä»£å°” 50æ”¯' }, category: 'regenerated',
    composition: [{ fiber: 'modal', pct: 100 }], count: { ne: 50 },
    characteristics: { strength: 3, softness: 5, luster: 4, elasticity: 3, absorbency: 5, durability: 4 }, price: 4 },
  { id: 'tencel_40', name: { ja: 'ãƒ†ãƒ³ã‚»ãƒ« 40ç•ªæ‰‹', zh: 'å¤©ä¸ 40æ”¯' }, category: 'regenerated',
    composition: [{ fiber: 'lyocell', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 5,
    certifications: ['FSC'] },
  { id: 'cupro_60', name: { ja: 'ã‚­ãƒ¥ãƒ—ãƒ© 60ç•ªæ‰‹', zh: 'é“œæ°¨ä¸ 60æ”¯' }, category: 'regenerated',
    composition: [{ fiber: 'cupro', pct: 100 }], count: { ne: 60 },
    characteristics: { strength: 3, softness: 5, luster: 5, elasticity: 3, absorbency: 5, durability: 3 }, price: 5 },

  // æ··ç´¡
  { id: 'tc_65_35_30', name: { ja: 'TC 65/35 30ç•ªæ‰‹', zh: 'TC 65/35 30æ”¯' }, category: 'blend',
    composition: [{ fiber: 'cotton', pct: 65 }, { fiber: 'polyester', pct: 35 }], count: { ne: 30 },
    characteristics: { strength: 4, softness: 4, luster: 3, elasticity: 3, absorbency: 4, durability: 5 }, price: 3,
    advantages: { ja: ['ã‚·ãƒ¯ã«ãªã‚Šã«ãã„', 'é€Ÿä¹¾æ€§'], zh: ['ä¸æ˜“çš±', 'é€Ÿå¹²'] } },
  { id: 'cvc_65_35_45', name: { ja: 'CVC 65/35 45ç•ªæ‰‹', zh: 'CVC 65/35 45æ”¯' }, category: 'blend',
    composition: [{ fiber: 'polyester', pct: 65 }, { fiber: 'cotton', pct: 35 }], count: { ne: 45 },
    characteristics: { strength: 5, softness: 3, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 2 },
  { id: 'cotton_linen', name: { ja: 'ã‚³ãƒƒãƒˆãƒ³ãƒªãƒãƒ³ 55/45', zh: 'æ£‰éº» 55/45' }, category: 'blend',
    composition: [{ fiber: 'cotton', pct: 55 }, { fiber: 'linen', pct: 45 }], count: { ne: 30 },
    characteristics: { strength: 4, softness: 3, luster: 3, elasticity: 2, absorbency: 5, durability: 5 }, price: 4 },
  { id: 'wool_poly', name: { ja: 'ã‚¦ãƒ¼ãƒ«ãƒãƒª 55/45', zh: 'æ¯›æ¶¤ 55/45' }, category: 'blend',
    composition: [{ fiber: 'wool', pct: 55 }, { fiber: 'polyester', pct: 45 }], count: { nm: 48 },
    characteristics: { strength: 4, softness: 4, luster: 4, elasticity: 4, absorbency: 3, durability: 5 }, price: 4 },
  { id: 'wool_silk', name: { ja: 'ã‚¦ãƒ¼ãƒ«ã‚·ãƒ«ã‚¯ 70/30', zh: 'æ¯›ä¸ 70/30' }, category: 'blend',
    composition: [{ fiber: 'wool', pct: 70 }, { fiber: 'silk', pct: 30 }], count: { nm: 60 },
    characteristics: { strength: 3, softness: 5, luster: 5, elasticity: 4, absorbency: 4, durability: 3 }, price: 7 },
  { id: 'cotton_modal', name: { ja: 'ã‚³ãƒƒãƒˆãƒ³ãƒ¢ãƒ€ãƒ¼ãƒ« 50/50', zh: 'æ£‰è«ä»£å°” 50/50' }, category: 'blend',
    composition: [{ fiber: 'cotton', pct: 50 }, { fiber: 'modal', pct: 50 }], count: { ne: 40 },
    characteristics: { strength: 4, softness: 5, luster: 4, elasticity: 3, absorbency: 5, durability: 4 }, price: 4 },
  { id: 'cotton_spandex', name: { ja: 'ã‚³ãƒƒãƒˆãƒ³ã‚¹ãƒˆãƒ¬ãƒƒãƒ 97/3', zh: 'æ£‰æ°¨ 97/3' }, category: 'blend',
    composition: [{ fiber: 'cotton', pct: 97 }, { fiber: 'spandex', pct: 3 }], count: { ne: 40 },
    characteristics: { strength: 4, softness: 4, luster: 3, elasticity: 4, absorbency: 4, durability: 4 }, price: 4,
    risks: { ja: ['å¡©ç´ æ¼‚ç™½ä¸å¯'], zh: ['ä¸å¯æ°¯æ¼‚'] } },
  { id: 'tencel_cotton', name: { ja: 'ãƒ†ãƒ³ã‚»ãƒ«ã‚³ãƒƒãƒˆãƒ³ 60/40', zh: 'å¤©ä¸æ£‰ 60/40' }, category: 'blend',
    composition: [{ fiber: 'lyocell', pct: 60 }, { fiber: 'cotton', pct: 40 }], count: { ne: 30 },
    characteristics: { strength: 4, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 4 }, price: 5,
    certifications: ['FSC'] },
  { id: 'nylon_spandex', name: { ja: 'ãƒŠã‚¤ãƒ­ãƒ³ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 85/15', zh: 'é”¦æ°¨ 85/15' }, category: 'blend',
    composition: [{ fiber: 'nylon', pct: 85 }, { fiber: 'spandex', pct: 15 }], count: { denier: 40 },
    characteristics: { strength: 5, softness: 4, luster: 3, elasticity: 5, absorbency: 1, durability: 5 }, price: 4 },

  // ç‰¹æ®Š
  { id: 'coolmax', name: { ja: 'ã‚¯ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹', zh: 'CoolMaxå¸æ¹¿æ’æ±—' }, category: 'specialty',
    composition: [{ fiber: 'polyester', pct: 100, tech: 'CoolMax' }], count: { denier: 75 },
    characteristics: { strength: 5, softness: 3, luster: 3, elasticity: 4, absorbency: 2, durability: 5 }, price: 4,
    special: ['moisture_wicking', 'quick_dry'] },
  { id: 'thermolite', name: { ja: 'ã‚µãƒ¼ãƒ¢ãƒ©ã‚¤ãƒˆ', zh: 'Thermoliteä¿æš–' }, category: 'specialty',
    composition: [{ fiber: 'polyester', pct: 100, tech: 'Thermolite' }], count: { denier: 100 },
    characteristics: { strength: 5, softness: 4, luster: 2, elasticity: 3, absorbency: 1, durability: 5 }, price: 5,
    special: ['insulation'] },
  { id: 'bamboo', name: { ja: 'ãƒãƒ³ãƒ–ãƒ¼ãƒ¬ãƒ¼ãƒ¨ãƒ³ 40ç•ªæ‰‹', zh: 'ç«¹çº¤ç»´ 40æ”¯' }, category: 'specialty',
    composition: [{ fiber: 'bamboo', pct: 100 }], count: { ne: 40 },
    characteristics: { strength: 3, softness: 5, luster: 4, elasticity: 2, absorbency: 5, durability: 3 }, price: 4,
    special: ['antibacterial'] },
];

// ============================================================
// ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
// ============================================================
const SWATCHES = [
  "#000000","#ffffff","#c1121f","#2a6f97","#1d3557","#457b9d","#e9c46a","#f4a261","#e76f51","#264653",
  "#4f772d","#90a955","#8a5a44","#6a4c93","#b5179e","#7209b7","#560bad","#480ca8","#3a0ca3","#4361ee",
  "#4895ef","#4cc9f0","#118ab2","#06d6a0","#ffd166","#ef476f","#073b4c","#f72585","#3a5a40","#bc6c25"
];

// ============================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
function hexToRgb(hex) {
  const c = hex.replace('#','');
  const bigint = parseInt(c.length === 3 ? c.split('').map(x=>x+x).join('') : c, 16);
  return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
}

function withAlpha(hex, a) {
  const { r, g, b } = hexToRgb(hex);
  return `rgba(${r},${g},${b},${a})`;
}

function getWeaveById(id) { return WEAVE_DATABASE.find(w => w.id === id); }
function getYarnById(id) { return YARN_DATABASE.find(y => y.id === id); }

function getComposition(yarn, lang) {
  return yarn.composition.map(c => {
    const name = LANG[lang].fibers[c.fiber] || c.fiber;
    return `${name} ${c.pct}%`;
  }).join(' / ');
}

// ============================================================
// ãƒªã‚¹ã‚¯åˆ†æ
// ============================================================
function analyzeRisks(config, lang) {
  const { weaveId, warpYarnId, weftYarnId, epi } = config;
  const weave = getWeaveById(weaveId);
  const warpYarn = getYarnById(warpYarnId);
  const weftYarn = getYarnById(weftYarnId);
  const risks = [];
  const L = LANG[lang];

  if (!weave || !warpYarn) return { risks: [], level: 'none' };

  const warpNe = warpYarn.count?.ne || 30;

  // ç³¸åˆ‡ã‚Œãƒªã‚¹ã‚¯
  if (warpNe > 60 && epi > 120) {
    risks.push({
      icon: 'ğŸ§µ',
      title: lang === 'ja' ? 'çµŒç³¸åˆ‡ã‚Œãƒªã‚¹ã‚¯ï¼ˆé«˜ï¼‰' : 'ç»çº±æ–­çº¿é£é™©ï¼ˆé«˜ï¼‰',
      desc: lang === 'ja'
        ? `ç´°ç•ªæ‰‹ï¼ˆ${warpNe}Neï¼‰ã¨é«˜å¯†åº¦ï¼ˆEPI ${epi}ï¼‰ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šç³¸åˆ‡ã‚ŒãŒç™ºç”Ÿã—ã‚„ã™ã„`
        : `ç»†æ”¯çº±ï¼ˆ${warpNe}Neï¼‰ä¸é«˜å¯†åº¦ï¼ˆEPI ${epi}ï¼‰ç»„åˆå®¹æ˜“æ–­çº¿`,
      level: 'high',
      recs: lang === 'ja'
        ? ['ç¹”æ©Ÿé€Ÿåº¦ã‚’20-30%ä½ä¸‹ã•ã›ã‚‹', 'çµŒç³¸ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’ç´°ã‹ãèª¿æ•´', 'æ¹¿åº¦ç®¡ç†ã‚’60-65%ã«ç¶­æŒ']
        : ['ç»‡æœºé€Ÿåº¦é™ä½20-30%', 'ç²¾ç»†è°ƒæ•´ç»çº±å¼ åŠ›', 'ä¿æŒæ¹¿åº¦60-65%']
    });
  } else if (warpNe > 50 && epi > 100) {
    risks.push({
      icon: 'ğŸ§µ',
      title: lang === 'ja' ? 'çµŒç³¸åˆ‡ã‚Œãƒªã‚¹ã‚¯ï¼ˆä¸­ï¼‰' : 'ç»çº±æ–­çº¿é£é™©ï¼ˆä¸­ï¼‰',
      desc: lang === 'ja' ? 'ç´°ç•ªæ‰‹ç³¸ã®ãŸã‚é€šå¸¸ã‚ˆã‚Šç³¸åˆ‡ã‚Œã«æ³¨æ„ãŒå¿…è¦' : 'ç»†æ”¯çº±éœ€æ³¨æ„æ–­çº¿',
      level: 'medium',
      recs: lang === 'ja' ? ['ç¹”æ©Ÿé€Ÿåº¦ã‚’10-15%ä½ä¸‹'] : ['ç»‡æœºé€Ÿåº¦é™ä½10-15%']
    });
  }

  // ç¹”ã‚Šé›£åº¦
  if (weave.difficulty >= 5) {
    risks.push({
      icon: 'ğŸ”§',
      title: lang === 'ja' ? 'é«˜é›£åº¦ç¹”ã‚Šçµ„ç¹”' : 'é«˜éš¾åº¦ç»‡ç‰©ç»„ç»‡',
      desc: lang === 'ja' ? `${weave.name[lang]}ã¯ç†Ÿç·´ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨å°‚é–€æ©Ÿæ¢°ãŒå¿…è¦` : `${weave.name[lang]}éœ€è¦ç†Ÿç»ƒå·¥äººå’Œä¸“ä¸šè®¾å¤‡`,
      level: 'high',
      recs: lang === 'ja' ? ['å°‚é–€å·¥å ´ã¸ã®å¤–æ³¨ã‚’æ¤œè¨', 'ååˆ†ãªãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚’ç¢ºä¿'] : ['è€ƒè™‘å¤–åŒ…ç»™ä¸“ä¸šå·¥å‚', 'ç¡®ä¿å……è¶³äº¤æœŸ']
    });
  } else if (weave.difficulty >= 4) {
    risks.push({
      icon: 'ğŸ”§',
      title: lang === 'ja' ? 'ä¸­é›£åº¦ç¹”ã‚Šçµ„ç¹”' : 'ä¸­ç­‰éš¾åº¦ç»‡ç‰©ç»„ç»‡',
      desc: lang === 'ja' ? 'ä¸€å®šã®æŠ€è¡“ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ãªç¹”ã‚Šçµ„ç¹”' : 'éœ€è¦ä¸€å®šæŠ€æœ¯æ°´å¹³çš„ç»‡ç‰©ç»„ç»‡',
      level: 'medium',
      recs: lang === 'ja' ? ['äº‹å‰ã«å·¥å ´ã¨æ‰“ã¡åˆã‚ã›'] : ['æå‰ä¸å·¥å‚æ²Ÿé€š']
    });
  }

  // ç³¸ã®ãƒªã‚¹ã‚¯
  if (warpYarn.risks) {
    const yarnRisks = warpYarn.risks[lang] || [];
    yarnRisks.forEach(r => {
      risks.push({
        icon: 'âš ï¸',
        title: lang === 'ja' ? 'ç´ æå›ºæœ‰ã®ãƒªã‚¹ã‚¯' : 'ææ–™å›ºæœ‰é£é™©',
        desc: r,
        level: 'low',
        recs: []
      });
    });
  }

  // ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  const hasSpandex = warpYarn.composition.some(c => c.fiber === 'spandex') ||
                     weftYarn?.composition.some(c => c.fiber === 'spandex');
  if (hasSpandex) {
    risks.push({
      icon: 'âš ï¸',
      title: lang === 'ja' ? 'ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç†±ãƒ»å¡©ç´ åŠ£åŒ–' : 'æ°¨çº¶çš„çƒ­/æ°¯æŸä¼¤',
      desc: lang === 'ja' ? 'é«˜æ¸©ã‚„å¡©ç´ ç³»æ¼‚ç™½å‰¤ã§ã‚¹ãƒˆãƒ¬ãƒƒãƒæ€§èƒ½ãŒä½ä¸‹' : 'é«˜æ¸©æˆ–æ°¯æ¼‚ä¼šé™ä½å¼¹æ€§',
      level: 'medium',
      recs: lang === 'ja' ? ['ä½æ¸©ä¹¾ç‡¥ãƒ»ã‚¢ã‚¤ãƒ­ãƒ³', 'å¡©ç´ ç³»æ¼‚ç™½å‰¤ä¸å¯ã®è¡¨ç¤º'] : ['ä½æ¸©çƒ˜å¹²ç†¨çƒ«', 'æ ‡æ³¨ä¸å¯æ°¯æ¼‚']
    });
  }

  // ãƒ¬ãƒ™ãƒ«åˆ¤å®š
  const highCount = risks.filter(r => r.level === 'high').length;
  const medCount = risks.filter(r => r.level === 'medium').length;
  let level = 'none';
  if (highCount >= 2) level = 'critical';
  else if (highCount >= 1) level = 'high';
  else if (medCount >= 1) level = 'medium';
  else if (risks.length > 0) level = 'low';

  return { risks, level };
}

// ============================================================
// è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ
// ============================================================
function generateSellingPoints(config, lang) {
  const { weaveId, warpYarnId } = config;
  const weave = getWeaveById(weaveId);
  const yarn = getYarnById(warpYarnId);
  const points = [];
  const keywords = new Set();

  if (!weave || !yarn) return { points: [], keywords: [], copy: '' };

  // ç´ æ
  const mainFiber = yarn.composition[0]?.fiber;
  if (mainFiber === 'silk') {
    points.push({
      cat: lang === 'ja' ? 'ç´ æ' : 'æè´¨',
      title: lang === 'ja' ? 'ã‚·ãƒ«ã‚¯ã®ä¸Šè³ªãªå…‰æ²¢' : 'ä¸ç»¸çš„é«˜çº§å…‰æ³½',
      desc: lang === 'ja' ? 'å¤©ç„¶ã‚·ãƒ«ã‚¯ãªã‚‰ã§ã¯ã®ç¾ã—ã„å…‰æ²¢ã¨æ»‘ã‚‰ã‹ãªè‚Œè§¦ã‚Š' : 'å¤©ç„¶ä¸ç»¸ç‹¬æœ‰çš„ç¾ä¸½å…‰æ³½ä¸ä¸æ»‘è§¦æ„Ÿ'
    });
    keywords.add(lang === 'ja' ? 'ã‚·ãƒ«ã‚¯' : 'ä¸ç»¸');
  }
  if (mainFiber === 'cashmere') {
    points.push({
      cat: lang === 'ja' ? 'ç´ æ' : 'æè´¨',
      title: lang === 'ja' ? 'ã‚«ã‚·ãƒŸãƒ¤ã®æ¥µä¸Šã®æŸ”ã‚‰ã‹ã•' : 'ç¾Šç»’çš„æè‡´æŸ”è½¯',
      desc: lang === 'ja' ? 'ã€Œç¹Šç¶­ã®å®çŸ³ã€ã¨å‘¼ã°ã‚Œã‚‹ã‚«ã‚·ãƒŸãƒ¤ã®è´…æ²¢ãªé¢¨åˆã„' : '"çº¤ç»´å®çŸ³"ç¾Šç»’çš„å¥¢åè´¨æ„Ÿ'
    });
    keywords.add(lang === 'ja' ? 'ã‚«ã‚·ãƒŸãƒ¤' : 'ç¾Šç»’');
  }
  if (['cotton', 'linen', 'wool', 'silk'].includes(mainFiber)) {
    points.push({
      cat: lang === 'ja' ? 'ç´ æ' : 'æè´¨',
      title: lang === 'ja' ? 'å¤©ç„¶ç´ æã®å¿ƒåœ°ã‚ˆã•' : 'å¤©ç„¶æè´¨çš„èˆ’é€‚æ„Ÿ',
      desc: lang === 'ja' ? 'å¤©ç„¶ç¹Šç¶­ãªã‚‰ã§ã¯ã®é€šæ°—æ€§ã¨å¿«é©ãªç€ç”¨æ„Ÿ' : 'å¤©ç„¶çº¤ç»´ç‹¬æœ‰çš„é€æ°”æ€§ä¸èˆ’é€‚ç©¿ç€æ„Ÿ'
    });
    keywords.add(lang === 'ja' ? 'å¤©ç„¶ç´ æ' : 'å¤©ç„¶æè´¨');
  }

  // ç¹”ã‚Š
  const chars = weave.characteristics;
  if (chars.drape >= 4) {
    points.push({
      cat: lang === 'ja' ? 'ç¹”ã‚Š' : 'ç»‡ç‰©',
      title: lang === 'ja' ? 'å„ªç¾ãªãƒ‰ãƒ¬ãƒ¼ãƒ—æ€§' : 'ä¼˜ç¾çš„å‚æ„Ÿ',
      desc: lang === 'ja' ? 'ç¾ã—ãæµã‚Œè½ã¡ã‚‹ãƒ‰ãƒ¬ãƒ¼ãƒ—ã§ä¸Šå“ãªã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚’æ¼”å‡º' : 'ä¼˜ç¾å‚å å‘ˆç°ä¼˜é›…è½®å»“'
    });
  }
  if (chars.durability >= 4) {
    points.push({
      cat: lang === 'ja' ? 'ç¹”ã‚Š' : 'ç»‡ç‰©',
      title: lang === 'ja' ? 'é•·ãæ„›ã›ã‚‹ä¸ˆå¤«ã•' : 'ç»ä¹…è€ç”¨',
      desc: lang === 'ja' ? 'è€ä¹…æ€§ã«å„ªã‚ŒãŸç¹”ã‚Šæ§‹é€ ã§é•·ãã”ä½¿ç”¨ã„ãŸã ã‘ã¾ã™' : 'è€ä¹…çš„ç»‡ç‰©ç»“æ„å¯é•¿æœŸä½¿ç”¨'
    });
  }
  if (chars.shine >= 4) {
    points.push({
      cat: lang === 'ja' ? 'ç¹”ã‚Š' : 'ç»‡ç‰©',
      title: lang === 'ja' ? 'ä¸Šå“ãªå…‰æ²¢æ„Ÿ' : 'ä¼˜é›…çš„å…‰æ³½',
      desc: lang === 'ja' ? 'ç¹”ã‚Šæ§‹é€ ãŒç”Ÿã¿å‡ºã™ç¾ã—ã„å…‰æ²¢' : 'ç»‡ç‰©ç»“æ„å‘ˆç°çš„ç¾ä¸½å…‰æ³½'
    });
  }

  // ã‚¹ãƒ‘ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  if (yarn.composition.some(c => c.fiber === 'spandex')) {
    points.push({
      cat: lang === 'ja' ? 'æ©Ÿèƒ½' : 'åŠŸèƒ½',
      title: lang === 'ja' ? 'å¿«é©ãªã‚¹ãƒˆãƒ¬ãƒƒãƒæ€§' : 'èˆ’é€‚çš„å¼¹æ€§',
      desc: lang === 'ja' ? 'å‹•ãã‚„ã™ã•ã‚’è¿½æ±‚ã—ãŸã‚¹ãƒˆãƒ¬ãƒƒãƒç´ æ' : 'è¿½æ±‚æ´»åŠ¨è‡ªå¦‚çš„å¼¹åŠ›é¢æ–™'
    });
    keywords.add(lang === 'ja' ? 'ã‚¹ãƒˆãƒ¬ãƒƒãƒ' : 'å¼¹åŠ›');
  }

  // èªè¨¼
  if (yarn.certifications?.includes('GOTS')) {
    points.push({
      cat: lang === 'ja' ? 'ã‚µã‚¹ãƒ†ãƒŠãƒ“ãƒªãƒ†ã‚£' : 'å¯æŒç»­æ€§',
      title: lang === 'ja' ? 'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯èªè¨¼å–å¾—' : 'æœ‰æœºè®¤è¯',
      desc: lang === 'ja' ? 'ç’°å¢ƒã«é…æ…®ã—ãŸã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ç´ æã‚’ä½¿ç”¨' : 'ä½¿ç”¨ç¯ä¿æœ‰æœºææ–™'
    });
    keywords.add(lang === 'ja' ? 'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯' : 'æœ‰æœº');
  }
  if (yarn.certifications?.includes('FSC')) {
    points.push({
      cat: lang === 'ja' ? 'ã‚µã‚¹ãƒ†ãƒŠãƒ“ãƒªãƒ†ã‚£' : 'å¯æŒç»­æ€§',
      title: lang === 'ja' ? 'FSCèªè¨¼ç´ æ' : 'FSCè®¤è¯ææ–™',
      desc: lang === 'ja' ? 'æŒç¶šå¯èƒ½ãªæ£®æ—è³‡æºã‹ã‚‰ç”Ÿã¾ã‚ŒãŸç´ æ' : 'æºè‡ªå¯æŒç»­æ£®æ—èµ„æºçš„ææ–™'
    });
    keywords.add(lang === 'ja' ? 'ã‚µã‚¹ãƒ†ãƒŠãƒ–ãƒ«' : 'å¯æŒç»­');
  }

  keywords.add(weave.name[lang]);
  keywords.add(LANG[lang].fibers[mainFiber] || mainFiber);

  // ã‚³ãƒ”ãƒ¼æ–‡
  let copy = '';
  if (mainFiber === 'silk') copy += lang === 'ja' ? 'è´…æ²¢ãªã‚·ãƒ«ã‚¯ã®è¼ãã‚’ã¾ã¨ã†ã€‚' : 'ç©¿ä¸Šå¥¢åä¸ç»¸çš„å…‰èŠ’ã€‚';
  else if (mainFiber === 'cashmere') copy += lang === 'ja' ? 'æ¥µä¸Šã®ã‚«ã‚·ãƒŸãƒ¤ã«åŒ…ã¾ã‚Œã‚‹å–œã³ã€‚' : 'è¢«æè‡´ç¾Šç»’åŒ…è£¹çš„å–œæ‚¦ã€‚';
  else if (mainFiber === 'cotton') copy += lang === 'ja' ? 'ã‚³ãƒƒãƒˆãƒ³ã®å¿ƒåœ°ã‚ˆã•ã‚’æ—¥å¸¸ã«ã€‚' : 'å°†æ£‰èŠ±çš„èˆ’é€‚èå…¥æ—¥å¸¸ã€‚';
  copy += `${weave.name[lang]}${lang === 'ja' ? 'ãªã‚‰ã§ã¯ã®' : 'ç‰¹æœ‰çš„'}`;
  if (chars.shine >= 4) copy += lang === 'ja' ? 'ç¾ã—ã„å…‰æ²¢ã¨' : 'ç¾ä¸½å…‰æ³½ä¸';
  copy += lang === 'ja' ? 'é­…åŠ›ã€‚' : 'é­…åŠ›ã€‚';

  return { points, keywords: Array.from(keywords), copy };
}

// ============================================================
// GSMè¨ˆç®—
// ============================================================
function calculateGSM(config) {
  const { weaveId, warpYarnId, epi, ppi } = config;
  const weave = getWeaveById(weaveId);
  const yarn = getYarnById(warpYarnId);
  if (!weave || !yarn) return null;

  const ne = yarn.count?.ne || yarn.count?.nm / 1.693 || 30;
  const tex = 590.5 / ne;
  const coverFactor = 0.4;
  let gsm = (epi * tex * 0.0254 + ppi * tex * 0.0254) * coverFactor * (weave.gsmModifier || 1);

  let cat;
  if (gsm < 100) cat = 'ultraLight';
  else if (gsm < 150) cat = 'light';
  else if (gsm < 200) cat = 'mediumLight';
  else if (gsm < 280) cat = 'medium';
  else if (gsm < 350) cat = 'heavy';
  else cat = 'ultraHeavy';

  return { gsm: Math.round(gsm), weight: Math.round(gsm * 0.0295), category: cat };
}

// ============================================================
// æç”»é–¢æ•°
// ============================================================
function drawFabric(ctx, w, h, config) {
  const { pattern, pitch, warpColors, weftColors, weaveId, zoom } = config;
  const weave = getWeaveById(weaveId);
  if (!weave) return;

  ctx.clearRect(0, 0, w, h);
  const scaledPitch = pitch * zoom;
  const { matrix, repeatX, repeatY } = weave;
  const cellW = scaledPitch / repeatX;
  const cellH = scaledPitch / repeatY;

  for (let y = 0; y < h; y += cellH) {
    for (let x = 0; x < w; x += cellW) {
      let warpColor, weftColor;

      if (pattern === 'solid') {
        warpColor = warpColors[0];
        weftColor = weftColors[0];
      } else if (pattern === 'stripe') {
        const stripeIdx = Math.floor(x / scaledPitch) % warpColors.length;
        warpColor = warpColors[stripeIdx];
        weftColor = weftColors[0];
      } else { // check
        const warpIdx = Math.floor(x / scaledPitch) % warpColors.length;
        const weftIdx = Math.floor(y / scaledPitch) % weftColors.length;
        warpColor = warpColors[warpIdx];
        weftColor = weftColors[weftIdx];
      }

      const mx = Math.floor((x / cellW) % repeatX);
      const my = Math.floor((y / cellH) % repeatY);
      const isWarp = matrix[my]?.[mx] ?? true;

      ctx.fillStyle = isWarp ? warpColor : weftColor;
      ctx.fillRect(x, y, cellW + 0.5, cellH + 0.5);
      ctx.fillStyle = isWarp ? withAlpha(weftColor, 0.1) : withAlpha(warpColor, 0.1);
      ctx.fillRect(x, y, cellW + 0.5, cellH + 0.5);
    }
  }
}

// ============================================================
// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
// ============================================================
const app = document.getElementById('app');
let state = {
  lang: 'ja',
  pattern: 'check',
  weaveId: 'oxford',
  weaveCategory: 'plain',
  warpColors: ['#1d3557', '#e76f51'],
  weftColors: ['#ffffff', '#e9c46a'],
  warpYarnId: 'combed_40',
  weftYarnId: 'combed_40',
  yarnCategory: 'cotton',
  pitch: 28,
  zoom: 1,
  epi: 110,
  ppi: 90,
  activeTab: 'design',
  showRiskModal: false,
  showSellingModal: false,
  showCustomYarnModal: false,
  customYarnTarget: null,
  editingColorIdx: null,
  editingColorType: null
};

function setState(newState) {
  Object.assign(state, newState);
  render();
}

function render() {
  const L = LANG[state.lang];
  const weave = getWeaveById(state.weaveId);
  const warpYarn = getYarnById(state.warpYarnId);
  const weftYarn = getYarnById(state.weftYarnId);
  const riskAnalysis = analyzeRisks(state, state.lang);
  const selling = generateSellingPoints(state, state.lang);
  const gsmData = calculateGSM(state);

  const filteredWeaves = WEAVE_DATABASE.filter(w => w.category === state.weaveCategory);
  const filteredYarns = YARN_DATABASE.filter(y => y.category === state.yarnCategory);

  const riskColors = { none: '#10B981', low: '#84CC16', medium: '#F59E0B', high: '#EF4444', critical: '#DC2626' };

  app.innerHTML = `
    <header class="mb-4 flex items-center justify-between flex-wrap gap-2">
      <div>
        <h1 class="text-2xl font-bold">${L.title}</h1>
        <p class="text-sm text-neutral-500">${L.subtitle}</p>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="setState({lang: state.lang === 'ja' ? 'zh' : 'ja'})"
          class="px-3 py-1.5 rounded-lg bg-neutral-200 text-sm font-medium">
          ${state.lang === 'ja' ? 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡' : 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª'}
        </button>
        ${riskAnalysis.risks.length > 0 ? `
          <button onclick="setState({showRiskModal: true})"
            class="px-3 py-1.5 rounded-lg text-sm font-medium text-white"
            style="background:${riskColors[riskAnalysis.level]}">
            ${riskAnalysis.risks.length} ${L.risks}
          </button>
        ` : ''}
        <button onclick="setState({showSellingModal: true})"
          class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium">
          ${L.sellingPoints}
        </button>
      </div>
    </header>

    <div class="flex gap-1 mb-4 bg-neutral-200 p-1 rounded-xl w-fit flex-wrap">
      ${['design', 'weave', 'yarn', 'specs'].map(tab => `
        <button onclick="setState({activeTab: '${tab}'})"
          class="px-4 py-2 rounded-lg text-sm font-medium transition ${state.activeTab === tab ? 'bg-white shadow' : 'hover:bg-neutral-100'}">
          ${L.tabs[tab]}
        </button>
      `).join('')}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <section class="lg:col-span-5 bg-white rounded-2xl shadow p-4 space-y-4">
        ${state.activeTab === 'design' ? renderDesignTab(L) : ''}
        ${state.activeTab === 'weave' ? renderWeaveTab(L, filteredWeaves, weave) : ''}
        ${state.activeTab === 'yarn' ? renderYarnTab(L, filteredYarns, warpYarn, weftYarn) : ''}
        ${state.activeTab === 'specs' ? renderSpecsTab(L, weave, warpYarn, weftYarn, gsmData) : ''}
      </section>

      <section class="lg:col-span-7 bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium">${L.preview}</h2>
          <div class="text-sm text-neutral-500">${weave?.name[state.lang] || ''} | ${warpYarn?.name[state.lang]?.split(' ')[0] || ''}</div>
        </div>
        <div class="flex justify-center">
          <canvas id="canvas" class="rounded-xl border shadow-inner" style="max-width:100%"></canvas>
        </div>
        <div class="mt-4">
          <label class="block text-sm font-medium mb-2">${L.quickColors}</label>
          <div class="flex flex-wrap gap-1">
            ${SWATCHES.map(hex => `
              <button class="w-7 h-7 rounded-md border border-neutral-300 color-swatch"
                style="background:${hex}" onclick="quickColor('${hex}')" title="${hex}"></button>
            `).join('')}
          </div>
        </div>
      </section>
    </div>

    ${state.showRiskModal ? renderRiskModal(L, riskAnalysis, riskColors) : ''}
    ${state.showSellingModal ? renderSellingModal(L, selling) : ''}
    ${state.showCustomYarnModal ? renderCustomYarnModal(L) : ''}
  `;

  // Canvasæç”»
  setTimeout(() => {
    const canvas = document.getElementById('canvas');
    if (canvas) {
      const dpr = window.devicePixelRatio || 1;
      const w = 500, h = 500;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      drawFabric(ctx, w, h, state);
    }
  }, 0);
}

function renderDesignTab(L) {
  return `
    <div>
      <label class="block text-sm font-medium mb-2">${L.pattern}</label>
      <div class="flex gap-2 flex-wrap">
        ${['check', 'stripe', 'solid'].map(p => `
          <button onclick="setState({pattern: '${p}'})"
            class="px-4 py-2 rounded-lg border text-sm transition ${state.pattern === p ? 'bg-neutral-900 text-white border-neutral-900' : 'hover:border-neutral-400'}">
            ${L.patterns[p]}
          </button>
        `).join('')}
      </div>
    </div>
    ${renderColorManager('warp', L.warpColor, state.warpColors)}
    ${renderColorManager('weft', L.weftColor, state.weftColors)}
    <div>
      <label class="block text-sm font-medium mb-1">${L.pitch}: <span class="font-bold">${state.pitch}px</span></label>
      <input type="range" min="8" max="80" value="${state.pitch}" onchange="setState({pitch: parseInt(this.value)})"
        class="w-full accent-neutral-900">
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">${L.zoom}: <span class="font-bold">${state.zoom.toFixed(1)}x</span></label>
      <input type="range" min="0.5" max="3" step="0.1" value="${state.zoom}" onchange="setState({zoom: parseFloat(this.value)})"
        class="w-full accent-neutral-900">
      <div class="flex gap-2 mt-1">
        ${[0.5, 1, 1.5, 2, 3].map(z => `
          <button onclick="setState({zoom: ${z}})"
            class="px-2 py-1 text-xs rounded ${state.zoom === z ? 'bg-neutral-900 text-white' : 'bg-neutral-100'}">
            ${z}x
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function renderColorManager(type, label, colors) {
  return `
    <div>
      <label class="block text-sm font-medium mb-2">${label}</label>
      <div class="flex flex-wrap gap-2 items-center">
        ${colors.map((c, i) => `
          <div class="relative group">
            <button class="w-10 h-10 rounded-lg border-2 border-neutral-300 shadow-sm hover:border-neutral-500 transition"
              style="background:${c}" onclick="toggleColorEdit('${type}', ${i})"></button>
            ${colors.length > 1 ? `
              <button onclick="removeColor('${type}', ${i})"
                class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition">Ã—</button>
            ` : ''}
            ${state.editingColorType === type && state.editingColorIdx === i ? `
              <div class="absolute top-12 left-0 z-20 bg-white rounded-lg shadow-xl p-2 border">
                <input type="color" value="${c}" onchange="updateColor('${type}', ${i}, this.value)" class="w-full h-8 mb-2">
                <div class="grid grid-cols-5 gap-1">
                  ${SWATCHES.slice(0, 15).map(hex => `
                    <button class="w-6 h-6 rounded border" style="background:${hex}"
                      onclick="updateColor('${type}', ${i}, '${hex}'); setState({editingColorType: null, editingColorIdx: null})"></button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `).join('')}
        ${colors.length < 8 ? `
          <button onclick="addColor('${type}')"
            class="w-10 h-10 rounded-lg border-2 border-dashed border-neutral-300 text-neutral-400 hover:border-neutral-500 hover:text-neutral-600 transition flex items-center justify-center">+</button>
        ` : ''}
      </div>
    </div>
  `;
}

function renderWeaveTab(L, filteredWeaves, currentWeave) {
  return `
    <div>
      <label class="block text-sm font-medium mb-2">${L.weaveCategory}</label>
      <div class="flex flex-wrap gap-2">
        ${Object.keys(LANG.ja.weaveCategories).map(cat => `
          <button onclick="setWeaveCategory('${cat}')"
            class="px-3 py-1.5 rounded-lg border text-sm transition ${state.weaveCategory === cat ? 'bg-neutral-900 text-white' : 'hover:border-neutral-400'}">
            ${L.weaveCategories[cat]}
          </button>
        `).join('')}
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium mb-2">${L.selectWeave}</label>
      <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
        ${filteredWeaves.map(w => `
          <button onclick="setState({weaveId: '${w.id}'})"
            class="p-3 rounded-lg border text-left transition ${state.weaveId === w.id ? 'border-neutral-900 bg-neutral-50' : 'hover:border-neutral-400'}">
            <div class="font-medium text-sm">${w.name[state.lang]}</div>
          </button>
        `).join('')}
      </div>
    </div>
    ${currentWeave ? `
      <div class="bg-neutral-50 rounded-xl p-3">
        <h4 class="font-medium mb-2">${currentWeave.name[state.lang]}</h4>
        <div class="grid grid-cols-5 gap-1 text-xs">
          ${Object.entries(currentWeave.characteristics).map(([k, v]) => `
            <div class="text-center">
              <div class="font-medium">${v}/5</div>
              <div class="text-neutral-500">${L.characteristics[k] || k}</div>
            </div>
          `).join('')}
        </div>
        <div class="mt-2 flex flex-wrap gap-1">
          ${(currentWeave.applications[state.lang] || []).map(app => `
            <span class="px-2 py-0.5 bg-neutral-200 rounded text-xs">${app}</span>
          `).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

function renderYarnTab(L, filteredYarns, warpYarn, weftYarn) {
  return `
    <div>
      <label class="block text-sm font-medium mb-2">${L.yarnCategory}</label>
      <div class="flex flex-wrap gap-2">
        ${Object.keys(LANG.ja.fiberCategories).map(cat => `
          <button onclick="setState({yarnCategory: '${cat}'})"
            class="px-3 py-1.5 rounded-lg border text-sm transition ${state.yarnCategory === cat ? 'bg-neutral-900 text-white' : 'hover:border-neutral-400'}">
            ${L.fiberCategories[cat]}
          </button>
        `).join('')}
      </div>
    </div>
    <div>
      <div class="flex items-center justify-between mb-2">
        <label class="text-sm font-medium">${L.warpYarn}</label>
      </div>
      <select value="${state.warpYarnId}" onchange="setState({warpYarnId: this.value})" class="w-full p-2 border rounded-lg text-sm">
        ${filteredYarns.map(y => `
          <option value="${y.id}" ${state.warpYarnId === y.id ? 'selected' : ''}>${y.name[state.lang]}</option>
        `).join('')}
      </select>
    </div>
    <div>
      <label class="text-sm font-medium mb-2 block">${L.weftYarn}</label>
      <select value="${state.weftYarnId}" onchange="setState({weftYarnId: this.value})" class="w-full p-2 border rounded-lg text-sm">
        ${filteredYarns.map(y => `
          <option value="${y.id}" ${state.weftYarnId === y.id ? 'selected' : ''}>${y.name[state.lang]}</option>
        `).join('')}
      </select>
    </div>
    ${warpYarn ? `
      <div class="bg-neutral-50 rounded-xl p-3">
        <h4 class="font-medium text-sm mb-2">${L.warpYarn}: ${warpYarn.name[state.lang]}</h4>
        <div class="text-xs text-neutral-600 mb-2">${getComposition(warpYarn, state.lang)}</div>
        <div class="grid grid-cols-3 gap-2 text-xs">
          ${Object.entries(warpYarn.characteristics).slice(0, 6).map(([k, v]) => `
            <div>
              <div class="font-medium">${v}/5</div>
              <div class="text-neutral-500">${L.characteristics[k] || k}</div>
            </div>
          `).join('')}
        </div>
        ${warpYarn.risks ? `
          <div class="mt-2 text-xs text-amber-600">
            ${(warpYarn.risks[state.lang] || []).map(r => `<div>* ${r}</div>`).join('')}
          </div>
        ` : ''}
      </div>
    ` : ''}
  `;
}

function renderSpecsTab(L, weave, warpYarn, weftYarn, gsmData) {
  return `
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">${L.epi}: <span class="font-bold">${state.epi}</span></label>
        <input type="range" min="40" max="200" value="${state.epi}" onchange="setState({epi: parseInt(this.value)})"
          class="w-full accent-neutral-900">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">${L.ppi}: <span class="font-bold">${state.ppi}</span></label>
        <input type="range" min="40" max="200" value="${state.ppi}" onchange="setState({ppi: parseInt(this.value)})"
          class="w-full accent-neutral-900">
      </div>
    </div>
    ${gsmData ? `
      <div class="bg-neutral-100 rounded-xl p-4">
        <div class="text-lg font-bold">${gsmData.gsm} gsm</div>
        <div class="text-sm text-neutral-600">${L.weightCategories[gsmData.category]}</div>
        <div class="text-xs text-neutral-500 mt-1">â‰ˆ ${gsmData.weight} oz/ydÂ²</div>
      </div>
    ` : ''}
    <div class="bg-neutral-50 rounded-xl p-4 space-y-2">
      <h4 class="font-medium">${L.fabricSummary}</h4>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><div class="text-neutral-500">${L.weaveType}</div><div class="font-medium">${weave?.name[state.lang] || '-'}</div></div>
        <div><div class="text-neutral-500">${L.difficulty}</div><div class="font-medium">${'â˜…'.repeat(weave?.difficulty || 1)}</div></div>
        <div><div class="text-neutral-500">${L.warpYarn}</div><div class="font-medium">${warpYarn?.name[state.lang] || '-'}</div></div>
        <div><div class="text-neutral-500">${L.weftYarn}</div><div class="font-medium">${weftYarn?.name[state.lang] || '-'}</div></div>
      </div>
    </div>
    <div class="flex gap-2">
      <button onclick="downloadPng()" class="flex-1 px-4 py-2 rounded-xl bg-neutral-900 text-white text-sm font-medium">${L.savePng}</button>
      <button onclick="setState({showRiskModal: true})" class="flex-1 px-4 py-2 rounded-xl bg-amber-500 text-white text-sm font-medium">${L.riskAnalysis}</button>
    </div>
  `;
}

function renderRiskModal(L, riskAnalysis, riskColors) {
  return `
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) setState({showRiskModal: false})">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="font-bold text-lg">${L.riskTitle}</h3>
          <button onclick="setState({showRiskModal: false})" class="w-8 h-8 rounded-full hover:bg-neutral-100 flex items-center justify-center">Ã—</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[calc(80vh-60px)]">
          <div class="flex items-center gap-3 p-4 rounded-xl mb-4" style="background:${riskColors[riskAnalysis.level]}20">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold" style="background:${riskColors[riskAnalysis.level]}">${riskAnalysis.risks.length}</div>
            <div>
              <div class="font-bold">${L.overallRisk}: ${L.riskLevels[riskAnalysis.level]}</div>
            </div>
          </div>
          ${riskAnalysis.risks.length === 0 ? `<div class="text-center py-8 text-neutral-500">${L.noRisk}</div>` : `
            <div class="space-y-3">
              ${riskAnalysis.risks.map(r => `
                <div class="p-4 rounded-xl border-l-4" style="border-color:${riskColors[r.level]};background:${riskColors[r.level]}10">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">${r.icon}</span>
                    <span class="font-medium">${r.title}</span>
                    <span class="px-2 py-0.5 rounded text-xs text-white" style="background:${riskColors[r.level]}">${L.riskLevels[r.level]}</span>
                  </div>
                  <p class="text-sm text-neutral-600 mb-2">${r.desc}</p>
                  ${r.recs.length > 0 ? `
                    <div class="mt-2">
                      <div class="text-xs font-medium text-neutral-500 mb-1">${L.recommendations}:</div>
                      <ul class="text-sm space-y-1">
                        ${r.recs.map(rec => `<li class="flex items-start gap-2"><span class="text-green-600">âœ“</span>${rec}</li>`).join('')}
                      </ul>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

function renderSellingModal(L, selling) {
  return `
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) setState({showSellingModal: false})">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="font-bold text-lg">${L.sellingPointsTitle}</h3>
          <button onclick="setState({showSellingModal: false})" class="w-8 h-8 rounded-full hover:bg-neutral-100 flex items-center justify-center">Ã—</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[calc(80vh-60px)] space-y-4">
          ${selling.copy ? `
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl">
              <div class="text-xs font-medium text-neutral-500 mb-2">${L.copyText}</div>
              <p class="text-lg leading-relaxed">${selling.copy}</p>
              <button onclick="navigator.clipboard.writeText('${selling.copy.replace(/'/g, "\\'")}')" class="mt-2 text-sm text-blue-600 hover:underline">${L.copy}</button>
            </div>
          ` : ''}
          ${selling.keywords.length > 0 ? `
            <div>
              <div class="text-sm font-medium mb-2">${L.keywords}</div>
              <div class="flex flex-wrap gap-2">
                ${selling.keywords.map(kw => `<span class="px-3 py-1 bg-neutral-100 rounded-full text-sm">#${kw}</span>`).join('')}
              </div>
            </div>
          ` : ''}
          <div class="space-y-3">
            ${selling.points.map(p => `
              <div class="p-4 bg-neutral-50 rounded-xl">
                <div class="flex items-center gap-2 mb-1">
                  <span class="px-2 py-0.5 bg-neutral-200 rounded text-xs">${p.cat}</span>
                  <span class="font-medium">${p.title}</span>
                </div>
                <p class="text-sm text-neutral-600">${p.desc}</p>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderCustomYarnModal(L) {
  return `
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) setState({showCustomYarnModal: false})">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="font-bold text-lg">${L.customYarnTitle}</h3>
          <button onclick="setState({showCustomYarnModal: false})" class="w-8 h-8 rounded-full hover:bg-neutral-100 flex items-center justify-center">Ã—</button>
        </div>
        <div class="p-4">
          <p class="text-neutral-500 text-sm">(${state.lang === 'ja' ? 'é–‹ç™ºä¸­' : 'å¼€å‘ä¸­'})</p>
        </div>
      </div>
    </div>
  `;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
window.setState = setState;
window.toggleColorEdit = (type, idx) => {
  if (state.editingColorType === type && state.editingColorIdx === idx) {
    setState({ editingColorType: null, editingColorIdx: null });
  } else {
    setState({ editingColorType: type, editingColorIdx: idx });
  }
};
window.updateColor = (type, idx, color) => {
  const colors = type === 'warp' ? [...state.warpColors] : [...state.weftColors];
  colors[idx] = color;
  setState(type === 'warp' ? { warpColors: colors } : { weftColors: colors });
};
window.addColor = (type) => {
  const colors = type === 'warp' ? [...state.warpColors] : [...state.weftColors];
  if (colors.length < 8) {
    colors.push(SWATCHES[Math.floor(Math.random() * SWATCHES.length)]);
    setState(type === 'warp' ? { warpColors: colors } : { weftColors: colors });
  }
};
window.removeColor = (type, idx) => {
  const colors = type === 'warp' ? [...state.warpColors] : [...state.weftColors];
  if (colors.length > 1) {
    colors.splice(idx, 1);
    setState(type === 'warp' ? { warpColors: colors } : { weftColors: colors });
  }
};
window.quickColor = (hex) => {
  const colors = state.warpColors.length < 2 ? [...state.warpColors, hex] : [state.warpColors[0], hex];
  setState({ warpColors: colors });
};
window.setWeaveCategory = (cat) => {
  const firstWeave = WEAVE_DATABASE.find(w => w.category === cat);
  setState({ weaveCategory: cat, weaveId: firstWeave?.id || state.weaveId });
};
window.downloadPng = () => {
  const canvas = document.getElementById('canvas');
  if (canvas) {
    const link = document.createElement('a');
    link.download = `fabric_${state.pattern}_${state.weaveId}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }
};

// åˆæœŸæç”»
render();
</script>

</body>
</html>
